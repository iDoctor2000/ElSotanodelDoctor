<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>El Sótano del Doctor – Uso Interno</title>

  <link rel="icon" type="image/x-icon" href="assets/favicon_ElSotanoDr.ico">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">

  <meta property="og:title"       content="El Sótano del Doctor – Uso Interno">
  <meta property="og:description" content="Banda de rock y versiones. Explora nuestro setlist, fechas de conciertos y más.">
  <meta property="og:image"       content="assets/logo_negro copia.jpg"> <meta property="og:type"        content="website">
  <meta property="og:url"         content="https://idoctor2000.github.io/ElSotanoDelDoctor-Intranet/"> <meta name="twitter:card"        content="summary_large_image">
  <meta name="twitter:title"       content="El Sótano del Doctor – Uso Interno">
  <meta name="twitter:description" content="Banda de rock y versiones. Explora nuestro setlist, fechas de conciertos y mucho más. ¡Disfruta de la música!">
  <meta name="twitter:image"       content="assets/logo_negro copia.jpg"> <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    /* Reset y fuente base */
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;padding:0;overflow-x:hidden;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff}
    /* Cabecera */
    header{background:#111;padding:15px 20px;display:flex;align-items:center;justify-content:space-between;position:relative; border-bottom: 1px solid #0cf;}
    .logo img.logo-main{width:160px;height:auto} /* Logo principal */
    .logo-intranet{position:absolute;left:50%;transform:translateX(-50%);height:50px;width:auto} /* Centrar logointranet.png */
    /* Hamburguesa */
    .hamburger{cursor:pointer;border:1px solid #0cf;border-radius:4px;padding:5px}
    .hamburger div{width:25px;height:3px;background:#0cf;margin:4px 0}
    /* Sidebar */
    .sidebar{position:fixed;top:0;left:0;width:250px;height:100%;background:#111;border-right:1px solid #222;
             padding:20px;box-shadow:2px 0 10px rgba(0,255,255,.1);transform:translateX(-250px);transition:transform .3s ease-in-out;z-index:9999; overflow-y: auto;}
    .sidebar.show{transform:translateX(0)}
    .sidebar h2{color:#0cf;margin:0 0 15px 0; text-align: center; border-bottom: 1px solid #0cf; padding-bottom: 10px;}
    .sidebar a{display:block;color:#fff;text-decoration:none;margin:12px 0;padding:8px 5px;border-bottom:1px solid #222; font-size: 0.95em;}
    .sidebar a:hover{color:#0cf; background-color: #222; border-radius: 3px;}
    .sidebar .submenu { margin-left: 15px; border-left: 2px solid #0cf; padding-left: 10px; margin-top: 5px;}
    .sidebar .submenu a { padding: 6px 0; font-size: 0.9em; border-bottom: 1px solid #2a2a2a;}
    /* Overlay */
    #overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:9998;display:none;backdrop-filter: blur(2px);}
    #overlay.show{display:block}
    /* Pantallas modales */
    .config-screen{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;
                   overflow-y:auto;padding:70px 20px 20px} /* Aumentado padding superior */
    .config-screen h2{color:#0cf;text-align:center;margin:10px 0 20px 0}
    .config-screen h3{color:#0cf;margin:20px 0 10px; border-bottom: 1px solid #333; padding-bottom: 5px;}
    .config-screen label{display:block;margin:10px 0 5px; color: #0cf;}
    .config-screen input,.config-screen select, .config-screen textarea {
        width:100%;max-width:450px;padding:12px;background:#1a1a1a;color:#fff;
        border:1px solid #0cf;border-radius:5px; margin-bottom: 12px; box-shadow: 0 0 5px rgba(0,204,255,0.2);
    }
    .config-screen select[multiple] { height: 150px; }
    .config-screen textarea { height: 120px; resize: vertical; }
    .config-screen button{
        margin-top:25px;padding:12px 22px;background:#0cf;color:#000;border:none;
        border-radius:8px;cursor:pointer;font-weight:bold; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .config-screen button:hover{background:#0ae; box-shadow: 0 0 10px #0cf;}
    .config-screen .close-btn{
        position:absolute;top:15px;right:15px;font-size:1.5em;background:transparent;border:2px solid #0cf;
        color:#0cf;border-radius:50%;padding:0px;cursor:pointer; width:35px; height:35px; line-height:30px; text-align:center;
    }
    .config-screen .close-btn:hover{background:#0cf; color:#000; box-shadow: 0 0 8px #0cf;}
    /* Secciones */
    main section{max-width:1200px;margin:20px auto;padding:25px; background:#0a0a0a; border: 1px solid #1c1c1c; border-radius:10px;box-shadow:0 0 20px rgba(0,204,255,.1);}
    #setlists h2,#rehearsals h2,#second-setlist h2,#calendario h2,#usuarios h2{text-align:center;color:#0cf;margin-bottom:20px; font-size: 1.8em;}
    /* Ajuste para tablas */
    .table-wrapper { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; color: #fff; font-size: .95em; }
    thead{background:#111;color:#0cf; border-bottom: 2px solid #0cf;}
    th,td{padding:12px 15px;border:1px solid #282828;text-align:left;white-space:normal; word-wrap:break-word;}
    tr:nth-child(even){background:#101010}
    tr:hover {background-color: #181818;}
    #second-setlist .table-wrapper table { min-width: 600px; }
    .download-btn{display:block;margin:25px auto 0;padding:12px 25px;font-size:1em;background:#0cf;color:#000;border:none;border-radius:8px;cursor:pointer; font-weight: bold;}
    .download-btn:hover{background:#09b; box-shadow: 0 0 8px #0cf;}
    #total-time,#total-time-2{color:#0cf;margin-top:15px;text-align:center; font-size: 1.1em; font-weight: bold;}
    #second-setlist-name {text-align:center;color:#aaa;margin-top:5px;font-style:italic; font-size: 1.1em;}
    footer{background:#050505;color:#888;text-align:center;padding:15px;border-top:1px solid #0cf; margin-top: 30px;}
    /* Botones de acción, calendario, detalles */
    .calendar-btn, .details-btn { background: none; border: none; cursor: pointer; padding: 5px; margin-left: 10px; vertical-align: middle; }
    .calendar-btn svg { fill: #0cf; width: 22px; height: 22px; transition: fill 0.2s;}
    .calendar-btn:hover svg { fill: #09b; transform: scale(1.1); }
    .details-btn svg { fill: #0af; width: 22px; height: 22px; transition: fill 0.2s;}
    .details-btn:hover svg { fill: #07a; transform: scale(1.1); }
    .action-btn { padding: 6px 12px; margin: 0 5px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s, transform 0.2s; }
    .action-btn:hover {transform: translateY(-1px);}
    .edit-btn { background: #0cf; color: #000; } .edit-btn:hover { background: #09b; }
    .delete-btn { background: #f00; color: #fff; } .delete-btn:hover { background: #d00; }
    .clear-attendance-btn { background: #ff9800; color: #000;} .clear-attendance-btn:hover { background: #e68900;}
    .save-note-btn { background: #0cf; color: #000; margin-top: 5px !important; } .save-note-btn:hover { background: #09b; }
    #cancel-edit-user, #cancel-edit-rehearsal { background: #666; color: #fff; } #cancel-edit-user:hover, #cancel-edit-rehearsal:hover { background: #555; }
    /* Formulario de asistencia */
    .attendance-form { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-top:5px; }
    .attendance-form select { padding: 8px; background: #222; color: #fff; border: 1px solid #333; border-radius: 4px; }
    .attendance-form button { padding: 8px 12px; background: #0cf; color: #000; border: none; border-radius: 4px; cursor: pointer; }
    .attendance-form button:hover { background: #09b; }
    .attendance-summary { margin-top: 10px; font-size: 0.9em; } .attendance-summary span { display: block; margin-bottom: 3px;}
    .attending-yes { color: #0cf; font-weight: bold;} .attending-no { color: #f00; font-weight: bold;}
    .rehearsal-duration { display: block; font-size: 0.9em; color: #aaa; margin-top: 3px;}
    /* Indicador de conexión y mensajes */
    #connection-status { position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.85); color: #fff; padding: 8px 12px; border-radius: 5px; font-size: 0.9em; z-index: 10000; display: none; border: 1px solid #555; }
    #connection-status.offline { background: #c00; border-color: #f00;}
    #connection-status.retrying { background: #e68900; border-color: #ff9800;}
    .message { margin-top: 15px; text-align: center; padding: 8px; border-radius: 4px; font-weight: bold;}
    .success-message { color: #000; background-color: #0cf; }
    .error-message { color: #fff; background-color: #d32f2f; }
    /* Estadísticas */
    .stats-table { margin-bottom: 40px; } .stats-table h3 { color: #0cf; margin: 20px 0 10px; text-align: center; }
    .stats-filter { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px; }
    .stats-filter label { color: #0cf; }
    .stats-filter select { padding: 8px; background: #222; color: #fff; border: 1px solid #333; border-radius: 4px; width: auto; max-width: 220px; }
    /* Columnas específicas en tablas */
    #calendario table th:last-child, #calendario table td:last-child { text-align: center; } /* Para centrar la columna de detalles */

    /* Responsive */
    @media(max-width:768px){
      header{padding:10px 15px;} .logo img.logo-main{width:130px} .logo-intranet{height:40px} .hamburger div{width:20px}
      main section {padding: 15px;}
      #setlists h2,#rehearsals h2,#second-setlist h2,#calendario h2,#usuarios h2{font-size: 1.5em;}
      .config-screen{padding:60px 15px 15px}
      .config-screen input, .config-screen select, .config-screen textarea {padding:10px; max-width: none;}
      .config-screen button{padding:10px 18px;}
      .action-btn, .attendance-form button {width: 100%; margin-bottom: 8px;}
      .attendance-form { flex-direction: column; align-items: stretch; } .attendance-form select { width: 100%; }
      #connection-status { font-size: 0.8em; padding: 6px 10px; bottom: 5px; right: 5px;}
      table { font-size: 0.8em; } th, td { padding: 8px 6px; max-width: 100px; }
      #concert-notes-config-table th:nth-child(4), #concert-notes-config-table td:nth-child(4) { min-width: 120px;}
    }
  </style>
</head>
<body>
  <div id="connection-status"></div>

  <header>
    <div class="logo"><img src="assets/logo_blanco.png" alt="Logo El Sótano del Doctor" class="logo-main"></div>
    <img src="assets/logointranet.png" alt="Logo Intranet" class="logo-intranet">
    <div class="hamburger" id="hamburger-btn"><div></div><div></div><div></div></div>
  </header>

  <div id="overlay"></div>
  <nav class="sidebar" id="sidebar-menu">
    <h2>Menú Principal</h2>
    <a href="#rehearsals" id="menu-rehearsals-section">Próximos Ensayos</a>
    <a href="#second-setlist" id="menu-second-setlist-section">Setlist Concierto</a>
    <a href="#calendario" id="menu-concerts-section">Próximos Conciertos</a>
    <a href="#" id="menu-stats">Estadísticas</a>
    <a href="#" id="menu-config">Configuración</a>
    <div class="submenu" id="config-submenu" style="display: none;">
      <a href="#" id="menu-setlist-config">Setlists</a>
      <a href="#" id="menu-user-mgmt">Usuarios</a>
      <a href="#" id="menu-rehearsal">Ensayos</a>
      <a href="#" id="menu-concert-notes-config">Notas de Conciertos</a>
    </div>
    <a href="#" id="menu-cerrar">Cerrar Menú</a>
  </nav>

  <div id="setlist-config-screen" class="config-screen">
    <button class="close-btn" id="close-setlist-config" title="Cerrar">&times;</button>
    <h2>Configuración de Setlists</h2>
    <h3>Setlist Próximo Ensayo</h3>
    <label for="setlist1-name">Nombre del Setlist:</label><input id="setlist1-name" placeholder="Ej: Ensayos Verano 2025">
    <label for="setlist1-url">ID/URL del feed:</label><input id="setlist1-url" placeholder="URL completa del feed JSON">
    <h3>Segundo Setlist (ej. Próximo Concierto)</h3>
    <label for="setlist2-name">Nombre del Setlist:</label><input id="setlist2-name" placeholder="Ej: Concierto Sala X">
    <label for="setlist2-url">ID/URL del feed (BandHelper):</label><input id="setlist2-url" placeholder="ID del feed (ej: TXHvyb) o URL completa">
    <button id="guardar-setlist-config">Guardar Configuración</button>
    <p id="setlist-message" class="message"></p>
  </div>

  <div id="user-mgmt-screen" class="config-screen">
    <button class="close-btn" id="close-user-mgmt" title="Cerrar">&times;</button>
    <h2>Gestión de Usuarios</h2>
    <label for="user-name">Nombre:</label><input id="user-name" placeholder="Nombre completo">
    <label for="user-nickname">Apodo:</label><input id="user-nickname" placeholder="Apodo corto (para tablas)">
    <label for="user-role">Roles:</label>
    <select id="user-role" multiple>
      <option value="Batería">Batería</option><option value="Teclados">Teclados</option><option value="Voz">Voz</option>
      <option value="Guitarra eléctrica">Guitarra eléctrica</option><option value="Guitarra Acústica">Guitarra Acústica</option>
      <option value="Bajo">Bajo</option><option value="Percusión">Percusión</option><option value="Saxo">Saxo</option>
      <option value="Dirección Musical">Dirección Musical</option><option value="Técnico de Sonido">Técnico de Sonido</option>
      <option value="Montador">Montador</option><option value="Coros">Coros</option>
    </select>
    <button id="add-user" class="action-btn edit-btn">Añadir Usuario</button>
    <button id="cancel-edit-user" class="action-btn delete-btn" style="display:none; background-color: #555;">Cancelar Edición</button>
    <p id="user-message" class="message"></p>
    <div class="table-wrapper">
        <table id="user-table"><thead><tr><th>Nombre</th><th>Apodo</th><th>Roles</th><th>Acciones</th></tr></thead><tbody id="user-table-body"></tbody></table>
    </div>
  </div>

  <div id="rehearsal-screen" class="config-screen">
    <button class="close-btn" id="close-rehearsal" title="Cerrar">&times;</button>
    <h2>Asignación y Gestión de Ensayos</h2>
    <label for="rehearsal-date">Fecha:</label><input type="date" id="rehearsal-date">
    <label for="rehearsal-start-time">Hora Inicio:</label><input type="time" id="rehearsal-start-time">
    <label for="rehearsal-end-time">Hora Fin:</label><input type="time" id="rehearsal-end-time">
    <label for="rehearsal-location">Lugar:</label><input id="rehearsal-location" placeholder="Ej: Local de Ensayo XYZ">
    <button id="add-rehearsal" class="action-btn edit-btn">Añadir Ensayo</button>
    <button id="cancel-edit-rehearsal" class="action-btn delete-btn" style="display:none; background-color: #555;">Cancelar Edición</button>
    <p id="rehearsal-message" class="message"></p>
    <div class="table-wrapper">
        <table id="rehearsal-table">
          <thead><tr><th>Fecha</th><th>Inicio</th><th>Fin</th><th>Lugar</th><th>Asistencias</th><th>Acciones</th></tr></thead>
          <tbody id="rehearsal-table-body"></tbody>
        </table>
    </div>
  </div>

  <div id="stats-screen" class="config-screen">
    <button class="close-btn" id="close-stats" title="Cerrar">&times;</button>
    <h2>Estadísticas de Ensayos</h2>
    <div class="stats-filter">
      <label for="stats-month-filter">Filtrar por mes:</label>
      <select id="stats-month-filter"><option value="all">Todos los meses</option></select>
    </div>
    <div class="stats-table">
      <h3>Tiempo Ensayado por Mes</h3>
      <div class="table-wrapper"><table id="time-per-month-table"><thead><tr><th>Mes</th><th>Tiempo Total (horas)</th></tr></thead><tbody id="time-per-month-body"></tbody></table></div>
    </div>
    <div class="stats-table">
      <h3>Tiempo Ensayado por Usuario (Asistido)</h3>
      <div class="table-wrapper"><table id="time-per-user-table"><thead><tr><th>Usuario</th><th>Tiempo Total (horas)</th></tr></thead><tbody id="time-per-user-body"></tbody></table></div>
    </div>
    <div class="stats-table">
      <h3>Historial de Ensayos Pasados</h3>
      <div class="table-wrapper"><table id="past-rehearsals-table"><thead><tr><th>Fecha</th><th>Horario</th><th>Lugar</th><th>Asistencias (Apodos)</th></tr></thead><tbody id="past-rehearsals-body"></tbody></table></div>
    </div>
  </div>

  <div id="concert-notes-config-screen" class="config-screen">
    <button class="close-btn" id="close-concert-notes-config" title="Cerrar">&times;</button>
    <h2>Configuración de Notas para Conciertos</h2>
    <p style="text-align: center; margin-bottom:15px;">Añade o edita notas internas para los próximos conciertos.</p>
    <p id="concert-notes-message" class="message"></p>
    <div class="table-wrapper">
        <table id="concert-notes-config-table">
            <thead><tr><th>Fecha</th><th>Hora</th><th>Lugar</th><th>Nota</th><th>Acciones</th></tr></thead>
            <tbody id="concert-notes-config-body"><tr><td colspan="5" style="text-align:center;">Cargando conciertos...</td></tr></tbody>
        </table>
    </div>
    <p style="text-align: center; margin-top: 20px; font-size: 0.9em; color: #aaa;">La lista de conciertos se obtiene del widget de BandHelper.</p>
  </div>

  <main>
    <section id="setlists">
      <h2 id="setlist1-title">Setlist Ensayos</h2>
      <div class="table-wrapper"><table><thead><tr><th>#</th><th>Título</th><th>Tonalidad</th><th>Tempo</th><th>Duración</th></tr></thead><tbody id="setlist-body"></tbody></table></div>
      <button class="download-btn" id="download-btn">Descargar PDF</button>
      <p id="total-time"></p>
    </section>

    <section id="rehearsals">
      <h2>Próximos Ensayos</h2>
      <div class="table-wrapper"><table id="rehearsal-main-table"><thead><tr><th>Fecha y Duración</th><th>Horario</th><th>Lugar y Calendario</th><th>Confirmar Asistencia</th></tr></thead><tbody id="rehearsal-main-body"></tbody></table></div>
    </section>

    <section id="second-setlist">
      <h2 id="setlist2-title-placeholder">Setlist Próximo Concierto</h2> <p id="second-setlist-name"></p>
      <div class="table-wrapper"><table id="second-list-table"><thead><tr><th>#</th><th>Canción</th><th>Tonalidad</th><th>Tempo</th><th>Duración</th></tr></thead><tbody id="second-body"></tbody></table></div>
      <button class="download-btn" id="download-btn-2">Descargar PDF</button>
      <p id="total-time-2"></p>
    </section>

    <section id="calendario">
      <h2>Próximos Conciertos</h2>
      <div id="bandhelper-concerts">
        <script src="https://www.bandhelper.com/widget/calendar/10353?layout=1&range=6"></script>
      </div>
    </section>

    <section id="usuarios">
      <h2>Usuarios Registrados</h2>
      <div class="table-wrapper"><table><thead><tr><th>Nombre</th><th>Apodo</th><th>Roles</th></tr></thead><tbody id="users-body"></tbody></table></div>
    </section>
  </main>

  <footer>© 2025 El Sótano del Doctor. Todos los derechos reservados.</footer>

  <script>
  //<![CDATA[
  /* ---------- 0. Firebase ---------- */
  const firebaseConfig = {
    apiKey: "TU_API_KEY", // REEMPLAZA ESTO CON TU API KEY REAL
    authDomain: "sotanointranet.firebaseapp.com",
    projectId: "sotanointranet",
    storageBucket: "sotanointranet.appspot.com", // Añade si usas Storage
    messagingSenderId: "756955233128",
    appId: "1:756955233128:web:ab36372bdbd895a30e74dd"
  };

  let db;
  try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    console.log("Firebase App inicializada.");

    db.enablePersistence({ synchronizeTabs: true })
      .then(() => console.log("Persistencia Firestore (multi-pestaña) HABILITADA."))
      .catch(err => {
        if (err.code == 'failed-precondition') {
          console.warn("Persistencia (multi-pestaña) falló, intentando una sola pestaña...", err.message);
          return db.enablePersistence(); // Fallback a persistencia de una sola pestaña
        } else if (err.code == 'unimplemented') {
          console.warn("Persistencia no soportada por el navegador.", err.message);
        } else {
          console.error("Error habilitando persistencia Firestore:", err);
        }
      })
      .then(() => { // Para el fallback
          if(db.INTERNAL && db.INTERNAL.getSettings().persistence) console.log("Persistencia Firestore (una pestaña) HABILITADA como fallback.");
      })
      .catch(err => {
          console.error("Error final habilitando persistencia Firestore (fallback):", err);
          const statusDiv = document.getElementById("connection-status");
          if (statusDiv) {
              statusDiv.textContent = "Advertencia: Persistencia offline no disponible. " + err.message.substring(0, 50) + "...";
              statusDiv.className = "retrying";
              statusDiv.style.display = "block";
          }
      });

  } catch (e) {
    console.error("Error GRAVE: Firebase App no pudo inicializarse. Verifica tu config.", e);
    const statusDiv = document.getElementById("connection-status");
    if (statusDiv) {
        statusDiv.textContent = "Error GRAVE: Firebase App no pudo inicializarse.";
        statusDiv.className = "offline";
        statusDiv.style.display = "block";
    }
    // Si Firebase no inicializa, muchas cosas fallarán. Podrías deshabilitar funciones o mostrar un error mayor.
  }


  /* ---------- 1. Utilidades ---------- */
  const parseDuration = str => { if (!str) return 0; if (str.includes(":")) { const [m, s = 0] = str.split(":").map(Number); return m * 60 + s; } const n = parseInt(str, 10); return isNaN(n) ? 0 : n; };
  const toMMSS = s => `${Math.floor(s / 60)}:${String(s % 60).padStart(2, "0")}`;
  const toHHMM = s => { const h = Math.floor(s / 3600); const m = Math.floor((s % 3600) / 60); return h ? `${h}h ${String(m).padStart(2, "0")}m` : `${m}m`; };
  const toHours = s => (s / 3600).toFixed(2);
  const clean = s => (s || "").toString().replace(/[^\x00-\xFF]/g, "").trim(); // Asegurar que s es string
  const calculateDuration = (startTime, endTime) => { if (!startTime || !endTime) return 0; const [startH, startM] = startTime.split(":").map(Number); const [endH, endM] = endTime.split(":").map(Number); const startSeconds = startH * 3600 + startM * 60; const endSeconds = endH * 3600 + endM * 60; let duration = endSeconds - startSeconds; if (duration < 0) duration += 24 * 3600; return duration; };
  const formatDateWithDay = dateStr => { try { const date = new Date(dateStr + "T00:00:00"); const days = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"]; const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]; const dayName = days[date.getUTCDay()]; const day = date.getUTCDate(); const monthName = months[date.getUTCMonth()]; return `${dayName} ${day} de ${monthName}`; } catch(e) { console.warn("Error formateando fecha:", dateStr, e); return dateStr;}};
  const getMonthYear = dateStr => { try {const date = new Date(dateStr + "T00:00:00"); const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]; return `${months[date.getUTCMonth()]} ${date.getUTCFullYear()}`; } catch(e) { console.warn("Error getMonthYear:", dateStr, e); return "Fecha Inválida";}};
  function generateICS(title, date, startTime, location, description = "", durationSeconds = 7200) { const startDate = new Date(`${date}T${startTime}`); const endDate = new Date(startDate.getTime() + durationSeconds * 1000); const formatDateForICS = d => d.toISOString().replace(/[-:]/g, "").split(".")[0] + "Z"; const start = formatDateForICS(startDate); const end = formatDateForICS(endDate); const icsContent = ["BEGIN:VCALENDAR", "VERSION:2.0", "PRODID:-//ElSotanoDelDoctor//Intranet//ES", "BEGIN:VEVENT", `UID:${new Date().getTime()}@elsotanodeldoctor.com`, `DTSTAMP:${formatDateForICS(new Date())}`, `DTSTART:${start}`, `DTEND:${end}`, `SUMMARY:${title}`, `DESCRIPTION:${description}`, `LOCATION:${location}`, "END:VEVENT", "END:VCALENDAR"].join("\r\n"); const blob = new Blob([icsContent], { type: "text/calendar;charset=utf-8" }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = `${title.replace(/[^\w\s]/gi, '').replace(/\s+/g, "_")}.ics`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); }
  function generateConcertId(date, time, location) { const locationNormalized = (location || "sin_lugar").toLowerCase().replace(/\s+/g, '_').replace(/[^\w-]/g, ''); const timeNormalized = (time || "sin_hora").replace(":", ""); return `${date}_${timeNormalized}_${locationNormalized}`; }

  /* ---------- 1.5. Manejo de conexión ---------- */
  const connectionStatus = document.getElementById("connection-status"); let isOnline = navigator.onLine;
  function updateConnectionStatus() { isOnline = navigator.onLine; if (!isOnline) { connectionStatus.className = "offline"; connectionStatus.textContent = "Sin conexión. Mostrando datos locales."; connectionStatus.style.display = "block"; } else { connectionStatus.style.display = "none"; connectionStatus.textContent = ""; } }
  window.addEventListener("online", updateConnectionStatus); window.addEventListener("offline", updateConnectionStatus);
  async function withRetry(fn, maxRetries = 3, delay = 2000) { for (let i = 0; i < maxRetries; i++) { try { if (!isOnline && i > 0) { connectionStatus.className = "offline"; connectionStatus.textContent = "Sin conexión. Reintentando operación..."; connectionStatus.style.display = "block"; } return await fn(); } catch (e) { console.warn(`Intento ${i+1} fallido para ${fn.name || 'operación anónima'}:`, e); if (i === maxRetries - 1) { connectionStatus.className = "offline"; connectionStatus.textContent = `Error final tras ${maxRetries} intentos.`; connectionStatus.style.display = "block"; throw e; } connectionStatus.className = "retrying"; connectionStatus.textContent = `Reintentando (${i + 1}/${maxRetries})...`; connectionStatus.style.display = "block"; await new Promise(resolve => setTimeout(resolve, delay)); } } }

  /* ---------- 2. Acceso Firestore ---------- */
  async function loadDoc(docId, fallback = {}) { if (!db) { console.error("Firestore (db) no está inicializado. No se puede cargar doc:", docId); return fallback; } try { const snap = await db.collection("intranet").doc(docId).get(); return snap.exists ? snap.data() : fallback; } catch (e) { console.error(`Error al cargar documento ${docId}:`, e.message); throw e; /* Podrías devolver fallback aquí también */ } }
  async function saveDoc(docId, data) { if (!db) { console.error("Firestore (db) no está inicializado. No se puede guardar doc:", docId); return false; } try { await db.collection("intranet").doc(docId).set(data); return true; } catch (e) { console.error(`Error al guardar documento ${docId}:`, e.message); throw e; } }

  /* ---------- SECCIONES (Setlists, Usuarios, Ensayos, Estadísticas, PDF) ---------- */
  // Estas secciones son largas y se mantienen mayormente igual a la lógica anterior.
  // Asegúrate de que cualquier llamada a loadDoc o saveDoc esté dentro de un withRetry si es crítico.
  // Por brevedad, no las pego completas aquí, pero el esqueleto es:
  // let setlistConfig = { ... }; function updateTitles() { ... } async function loadSetlistConfig() { ... } etc.
  // Reemplaza el código de estas secciones con el que ya tenías y funcionaba lógicamente.
  // Aquí incluyo solo la estructura básica para que el script no dé error de funciones no definidas.
  let setlistConfig = { setlist1: { name: "Setlist Ensayos", url: "" }, setlist2: { name: "Setlist Concierto", url: "" }};
  async function loadSetlistConfig() { const data = await withRetry(() => loadDoc("setlists", {config: setlistConfig})); setlistConfig = data.config || setlistConfig; updateTitles(); }
  function updateTitles() { document.getElementById("setlist1-title").textContent = setlistConfig.setlist1.name; document.getElementById("setlist2-title-placeholder").textContent = setlistConfig.setlist2.name; /* Actualiza el ID si es diferente */ }
  async function saveSetlistConfig() { updateTitles(); return await withRetry(() => saveDoc("setlists", { config: setlistConfig }));}
  async function cargarPrimerSetlist() { /* ... tu lógica ... */ console.log("Cargando primer setlist..."); return []; }
  async function cargarSegundoSetlist() { /* ... tu lógica ... */ console.log("Cargando segundo setlist..."); return []; }
  let users = []; let editingUserIndex = null; function renderUsers() { /* ... */ } async function loadUsers() { const data = await withRetry(() => loadDoc("users", {users:[]})); users = data.users || []; renderUsers(); }  async function saveUsers() { return await withRetry(() => saveDoc("users", {users}));} function resetUserForm() { /* ... */ }
  let rehearsals = []; let editingRehearsalIndex = null; function renderRehearsals() { /* ... */ } async function loadRehearsals() { const data = await withRetry(() => loadDoc("rehearsals", {rehearsals:[]})); rehearsals = data.rehearsals || []; renderRehearsals(); } async function saveRehearsals() { return await withRetry(() => saveDoc("rehearsals", {rehearsals}));} function resetRehearsalForm() { /* ... */ }
  function updateMonthFilter() { /* ... */ } function renderStats() { /* ... */ }
  async function genPDF(songs, title, fileName) { /* ... */ }


  /* ---------- 10. Modificar tabla de BandHelper ---------- */
  let parsedBandHelperConcerts = [];
  let bandHelperTableModified = false;
  let bandHelperWidgetLoaded = false; // Flag para saber si el widget ha intentado cargar

  function modifyBandHelperTable() {
    console.log("modifyBandHelperTable: Iniciando...");
    const bandHelperContentDiv = document.getElementById("bandhelper-concerts");
    if (!bandHelperContentDiv) {
        console.error("Div #bandhelper-concerts no encontrado.");
        return false;
    }
    const table = bandHelperContentDiv.querySelector("table");
    if (!table) {
      console.warn("modifyBandHelperTable: Tabla de BandHelper NO encontrada dentro de #bandhelper-concerts.");
      bandHelperWidgetLoaded = true; // Asumimos que el widget cargó pero sin tabla (o error)
      return false;
    }
    console.log("modifyBandHelperTable: Tabla encontrada:", table);

    // Para evitar reprocesar innecesariamente si la estructura no ha cambiado drásticamente.
    if (table.dataset.processedByIntranet === "true" && bandHelperTableModified) {
       console.log("modifyBandHelperTable: Tabla ya marcada como procesada y modificada. Saltando.");
       return true;
    }

    parsedBandHelperConcerts = []; // Reiniciar siempre para obtener la lista más fresca

    const headerRow = table.querySelector("thead tr");
    if (headerRow) {
        if (!headerRow.querySelector("th.th-details")) {
            headerRow.insertAdjacentHTML("beforeend", '<th class="th-details" style="text-align:center;">Detalles</th>');
            console.log("modifyBandHelperTable: Cabecera 'Detalles' AÑADIDA.");
        } else {
            console.log("modifyBandHelperTable: Cabecera 'Detalles' ya existe.");
        }
    } else {
        console.warn("modifyBandHelperTable: Fila de cabecera (thead tr) NO encontrada.");
    }

    const rows = table.querySelectorAll("tbody tr");
    console.log("modifyBandHelperTable: Filas encontradas en tbody:", rows.length);
    if (rows.length === 0) {
        console.log("modifyBandHelperTable: No hay conciertos listados en la tabla de BandHelper.");
        // No hacer nada más si no hay filas, pero marcar como procesada.
    } else {
        rows.forEach((row, rowIndex) => {
          // console.log(`Procesando fila #${rowIndex}`);
          const cells = row.querySelectorAll("td");
          if (cells.length < 3) { console.warn(`Fila #${rowIndex} con celdas insuficientes: ${cells.length}`); return; }

          const dateCellText = cells[0].textContent.trim();
          const timeCellText = cells[1].textContent.trim();
          const locationCell = cells[2];
          const locationText = locationCell.textContent.trim() || "Lugar no especificado";

          const dateParts = dateCellText.match(/(\d{1,2})\/(\d{1,2})\/(\d{2,4})/); // Formato DD/MM/YY o DD/MM/YYYY
          if (!dateParts) { console.warn(`Fila #${rowIndex}: Formato de fecha no reconocido: '${dateCellText}'`); return; }
          
          let day = parseInt(dateParts[1]);
          let month = parseInt(dateParts[2]) -1; // Meses en JS son 0-11
          let year = parseInt(dateParts[3]);
          if (year < 100) { year += 2000; } // Asumir siglo XXI para años de 2 dígitos

          const concertDateObj = new Date(year, month, day);
          const dateISO = concertDateObj.toISOString().split('T')[0];
          
          const time24h = timeCellText.split('a')[0].trim() || "20:00"; // Tomar la primera parte antes de "a" (ej. 17:00 a 21:00)

          const concertId = generateConcertId(dateISO, time24h, locationText);
          parsedBandHelperConcerts.push({ id: concertId, date: dateISO, time: time24h, location: locationText, displayDate: dateCellText });

          if (!locationCell.querySelector("button.calendar-btn")) {
            const calendarButtonHTML = `<button class="calendar-btn" title="Añadir a mi calendario" onclick='generateICS("Concierto: ${clean(locationText)}", "${dateISO}", "${time24h}", "${clean(locationText)}")'><svg viewBox="0 0 24 24"><path d="M12 4V2m0 20v-2m8-8h2m-20 0h-2m15.071-3.071l-1.414-1.414M5.343 17.657l-1.414-1.414m0-10.486l1.414-1.414m12.728 12.728l-1.414 1.414"/><rect x="4" y="6" width="16" height="12" rx="2"/></svg></button>`;
            if (!locationCell.innerHTML.includes('calendar-btn')) { locationCell.innerHTML += calendarButtonHTML; }
          }

          let detailsCell = row.querySelector("td.td-details");
          if (!detailsCell) {
            detailsCell = document.createElement("td");
            detailsCell.classList.add("td-details");
            detailsCell.style.textAlign = "center"; // Centrar el botón
            row.appendChild(detailsCell);
          }
          if (!detailsCell.querySelector("button.details-btn")) {
              detailsCell.innerHTML = `<button class="details-btn" title="Ver/Editar Detalles" onclick="openConcertDetailViewer('${concertId}')"><svg viewBox="0 0 24 24"><path d="M8.59,16.59L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.59Z" /></svg></button>`;
          }
        });
    }
    
    console.log("modifyBandHelperTable: Conciertos parseados:", parsedBandHelperConcerts.length);
    bandHelperTableModified = true; // Marcar como modificada exitosamente
    table.dataset.processedByIntranet = "true"; // Marcar la tabla como procesada
    bandHelperWidgetLoaded = true;

    // Si la pantalla de config de notas está abierta, refrescarla
    if (document.getElementById("concert-notes-config-screen").style.display === "block") {
      renderConcertNotesConfigScreen();
    }
    console.log("modifyBandHelperTable: Finalizada.");
    return true;
  }

  function openConcertDetailViewer(concertId) {
      // Asegúrate que 'concert_detail_viewer.html' está en la misma ruta o ajusta la URL
      window.open(`concert_detail_viewer.html?concertId=${encodeURIComponent(concertId)}`, '_blank');
  }

  /* ---------- 10.5. Notas de Conciertos ---------- */
  let concertNotes = {};
  async function loadConcertNotes() { try { const data = await withRetry(() => loadDoc("concert_notes_store", { notes: {} })); concertNotes = data.notes || {}; console.log("Notas de conciertos cargadas:", concertNotes); } catch (e) { console.error("Error al cargar notas de conciertos:", e); concertNotes = {}; } }
  async function saveConcertNotes() { try { await withRetry(() => saveDoc("concert_notes_store", { notes: concertNotes })); return true; } catch (e) { console.error("Error al guardar notas:", e); const msgEl = document.getElementById("concert-notes-message"); if(msgEl){ msgEl.className = "error-message"; msgEl.textContent = "Error al guardar: " + e.message;} throw e; } }
  function renderConcertNotesConfigScreen() {
    const tbody = document.getElementById("concert-notes-config-body");
    const messageEl = document.getElementById("concert-notes-message");
    tbody.innerHTML = ""; if(messageEl) messageEl.textContent = "";
    console.log("renderConcertNotesConfigScreen: Conciertos de BandHelper:", parsedBandHelperConcerts);
    if (parsedBandHelperConcerts.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay conciertos próximos listados por BandHelper o aún no se han podido cargar.</td></tr>';
      return;
    }
    parsedBandHelperConcerts.forEach(concert => {
      const concertId = concert.id; const currentNote = concertNotes[concertId] || "";
      const row = `<tr><td>${concert.displayDate}</td><td>${concert.time}</td><td>${concert.location}</td><td><textarea data-concert-id="${concertId}" placeholder="Añade detalles...">${currentNote}</textarea></td><td><button class="action-btn save-note-btn" data-concert-id="${concertId}">Guardar</button></td></tr>`;
      tbody.insertAdjacentHTML("beforeend", row);
    });
    tbody.querySelectorAll(".save-note-btn").forEach(button => {
      button.onclick = async () => {
        const id = button.dataset.concertId; const textarea = tbody.querySelector(`textarea[data-concert-id="${id}"]`);
        concertNotes[id] = textarea.value.trim();
        try { await saveConcertNotes(); if(messageEl){ messageEl.className = "success-message"; messageEl.textContent = "Nota guardada."; setTimeout(() => messageEl.textContent = "", 2500);}}
        catch (e) { /* error ya manejado en saveConcertNotes */ }
      };
    });
  }

  /* ---------- 11. Menú & pantallas ---------- */
  const sidebar = document.getElementById("sidebar-menu"), overlay = document.getElementById("overlay");
  const PASSWORD = "Sotano2014"; // Cambia esta contraseña
  let isAuthenticated = false;
  function closeAllScreens() { document.querySelectorAll(".config-screen").forEach(s => s.style.display = "none"); }
  function closeSidebarAndOverlay() { sidebar.classList.remove("show"); overlay.classList.remove("show"); document.getElementById("config-submenu").style.display = "none"; }
  function closeAll() { closeAllScreens(); closeSidebarAndOverlay(); resetUserForm(); resetRehearsalForm(); /* y otros resets si los tienes */ }
  document.getElementById("hamburger-btn").onclick = () => { sidebar.classList.add("show"); overlay.classList.add("show"); };
  document.getElementById("menu-cerrar").onclick = e => { e.preventDefault(); closeAll(); };
  overlay.onclick = closeAll;
  ['menu-rehearsals-section', 'menu-second-setlist-section', 'menu-concerts-section'].forEach(id => {
    document.getElementById(id).onclick = e => { e.preventDefault(); closeAll(); const targetId = e.target.getAttribute('href').substring(1); document.getElementById(targetId)?.scrollIntoView({ behavior: "smooth" }); };
  });
  document.getElementById("menu-config").onclick = e => { e.preventDefault(); if (!isAuthenticated) { const pass = prompt("Contraseña para Configuración (iDoctor Dice: ¡Si no sabes no toques!):"); if (pass === PASSWORD) { isAuthenticated = true; } else { alert("Contraseña incorrecta."); return; } } document.getElementById("config-submenu").style.display = document.getElementById("config-submenu").style.display === "block" ? "none" : "block"; };
  function openConfigScreen(screenId, loadDataFn) { if (!isAuthenticated) { alert("Acceso denegado. Autentícate en 'Configuración' primero."); return; } closeAllScreens(); document.getElementById(screenId).style.display = "block"; if (loadDataFn) loadDataFn(); }
  document.getElementById("menu-setlist-config").onclick = e => { e.preventDefault(); openConfigScreen("setlist-config-screen", () => { document.getElementById("setlist1-name").value = setlistConfig.setlist1.name; document.getElementById("setlist1-url").value = setlistConfig.setlist1.url; document.getElementById("setlist2-name").value = setlistConfig.setlist2.name; document.getElementById("setlist2-url").value = setlistConfig.setlist2.url.replace("https://www.bandhelper.com/feed/set_list/", ""); });};
  document.getElementById("close-setlist-config").onclick = () => { document.getElementById("setlist-config-screen").style.display = "none"; document.getElementById("setlist-message").textContent = ""; };
  // ... (resto de listeners de guardar config setlists, usuarios, ensayos, stats - mantenlos como estaban)
  document.getElementById("menu-user-mgmt").onclick = e => { e.preventDefault(); openConfigScreen("user-mgmt-screen"); };
  document.getElementById("menu-rehearsal").onclick = e => { e.preventDefault(); openConfigScreen("rehearsal-screen"); };
  document.getElementById("menu-stats").onclick = e => { e.preventDefault(); closeAll(); openConfigScreen("stats-screen", () => { updateMonthFilter(); renderStats(); }); };
  document.getElementById("close-user-mgmt").onclick = () => { document.getElementById("user-mgmt-screen").style.display = "none"; resetUserForm(); document.getElementById("user-message").textContent = "";};
  document.getElementById("close-rehearsal").onclick = () => { document.getElementById("rehearsal-screen").style.display = "none"; resetRehearsalForm(); document.getElementById("rehearsal-message").textContent = "";};
  document.getElementById("close-stats").onclick = () => { document.getElementById("stats-screen").style.display = "none"; };

  document.getElementById("menu-concert-notes-config").onclick = async e => {
    e.preventDefault();
    if (!isAuthenticated) { alert("Acceso denegado."); return; }
    closeAllScreens(); // Solo cierra otras pantallas, no el sidebar
    const screen = document.getElementById("concert-notes-config-screen");
    screen.style.display = "block";
    const tbody = document.getElementById("concert-notes-config-body");
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Cargando conciertos desde BandHelper...</td></tr>';
    console.log("Abriendo config notas. bandHelperWidgetLoaded:", bandHelperWidgetLoaded, "parsedConcerts:", parsedBandHelperConcerts.length);
    if (!bandHelperWidgetLoaded || parsedBandHelperConcerts.length === 0) {
        console.log("Intentando modificar tabla BandHelper desde menú config notas (intento 1)...");
        let success = modifyBandHelperTable();
        if (!success) {
            console.log("Fallo intento 1. Esperando 2s para intento 2...");
            await new Promise(resolve => setTimeout(resolve, 2500)); // Un poco más de tiempo
            success = modifyBandHelperTable();
        }
        if (!success && !bandHelperWidgetLoaded) {
           console.warn("No se pudo cargar/parsear tabla BandHelper desde menú config.");
           tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No se pudo cargar info de BandHelper. Revisa consola.</td></tr>';
           return;
        }
    }
    renderConcertNotesConfigScreen();
  };
  document.getElementById("close-concert-notes-config").onclick = () => { document.getElementById("concert-notes-config-screen").style.display = "none"; document.getElementById("concert-notes-message").textContent = ""; };

  /* ---------- 12. Carga inicial ---------- */
  document.addEventListener("DOMContentLoaded", async () => {
    console.log("DOMContentLoaded: Iniciando.");
    updateConnectionStatus(); // Verificar estado de conexión al cargar
    if (!db) { console.warn("DOMContentLoaded: DB no inicializado, algunas cargas pueden fallar."); }

    try {
      await Promise.all([loadSetlistConfig(), loadUsers(), loadRehearsals(), loadConcertNotes()]);
      console.log("DOMContentLoaded: Datos iniciales de Firestore cargados (o intentados).");
    } catch (e) {
      console.error("DOMContentLoaded: Error crítico al cargar datos iniciales:", e);
      // Considera mostrar un error al usuario aquí
    }

    // Carga de setlists (ejemplo, tu lógica puede variar)
    let songs1 = [], songs2 = [];
    try { songs1 = await cargarPrimerSetlist(); } catch (e) { console.error("Fallo al cargar primer setlist:", e); }
    try { songs2 = await cargarSegundoSetlist(); } catch (e) { console.error("Fallo al cargar segundo setlist:", e); }
    document.getElementById("download-btn").onclick = () => { if (songs1.length > 0) genPDF(songs1, setlistConfig.setlist1.name, "setlist_ensayos.pdf"); else alert("No hay canciones en el setlist de ensayos."); };
    document.getElementById("download-btn-2").onclick = () => { if (songs2.length > 0) genPDF(songs2, setlistConfig.setlist2.name, "setlist_concierto.pdf"); else alert("No hay canciones en el setlist de concierto."); };


    const bandHelperContainer = document.getElementById("bandhelper-concerts");
    if (bandHelperContainer) {
        console.log("DOMContentLoaded: Configurando MutationObserver para BandHelper.");
        const observer = new MutationObserver((mutationsList, observerInstance) => {
            const table = bandHelperContainer.querySelector("table");
            if (table && (!bandHelperTableModified || table.dataset.processedByIntranet !== "true")) {
                console.log("MutationObserver: Tabla BandHelper detectada/cambiada. Intentando modificar...");
                if(modifyBandHelperTable()) {
                    console.log("MutationObserver: Tabla BandHelper modificada exitosamente.");
                    // observerInstance.disconnect(); // Descomentar si solo se necesita una vez
                }
            }
        });
        observer.observe(bandHelperContainer, { childList: true, subtree: true });
    } else {
        console.error("DOMContentLoaded: Contenedor #bandhelper-concerts NO ENCONTRADO para MutationObserver.");
    }

    // Fallback por si el MutationObserver no se dispara o el widget carga de forma extraña
    setTimeout(() => {
        if (!bandHelperTableModified) {
            console.warn("DOMContentLoaded (Fallback 3s): BandHelper no modificado. Intentando...");
            modifyBandHelperTable();
        }
    }, 3000);
    setTimeout(() => {
        if (!bandHelperTableModified) {
            console.warn("DOMContentLoaded (Fallback 7s): BandHelper AÚN no modificado. ÚLTIMO intento.");
            modifyBandHelperTable();
        }
    }, 7000);

    console.log("DOMContentLoaded: Finalizado.");
  });
  //]]>
  </script>
</body>
</html>
