<!DOCTYPE html>
<html lang="es">
<head>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="El S√≥tano">
  <link rel="manifest" href="manifest.json">
   
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <meta charset="UTF-8" />
  <title>El S√≥tano del Doctor ‚Äì Intranet</title>

  <link rel="icon" type="image/x-icon" href="assets/favicon_ElSotanoDr.ico">
  
  <meta property="og:title"        content="El S√≥tano del Doctor ‚Äì Intranet">
  <meta property="og:description"  content="Banda de rock y versiones. Intranet de gesti√≥n.">
  <meta property="og:image"        content="assets/logo_negro copia.jpg">

  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://www.gstatic.com">
  <link rel="preconnect" href="https://www.youtube.com">
  <link rel="preconnect" href="https://www.bandhelper.com">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js" defer></script>
  <script src="https://www.youtube.com/iframe_api" defer></script>

  <style>
    *,*::before,*::after{box-sizing:border-box}
    
    html,body {
        margin:0; padding:0; 
        overflow-x:hidden; 
        width: 100%;
        min-height: 100vh;
        min-height: 100dvh;
        font-family:Arial,Helvetica,sans-serif; 
        background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
        background-attachment: fixed;
        color:#fff;
        touch-action: manipulation;
        overscroll-behavior-y: none;
        -webkit-tap-highlight-color: transparent;
    }
    
    /* SPLASH SCREEN */
    #splash-screen {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background-color: #000000; display: flex; justify-content: center; align-items: center;
      z-index: 200000; opacity: 1; visibility: visible;
      transition: opacity 0.5s ease-out, visibility 0.5s linear;
    }
    #splash-screen img {
      max-width: 60%; max-height: 60%; opacity: 0;
      transform: scale(0.85) translateY(15px); 
      animation: splash-image-entry 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    @keyframes splash-image-entry { to { opacity: 1; transform: scale(1) translateY(0); } }
    #splash-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

    header{
        background: rgba(17, 17, 17, 0.95); padding:10px 20px; display:flex; align-items:center;
        justify-content:space-between; position:fixed; top:0; left:0; width:100%; z-index:1000;  
        border-bottom: 1px solid #222; height: 60px; backdrop-filter: blur(5px);
    }
    
    .header-left { display: flex; align-items: center; gap: 15px; }
    .logo img.logo-main{ width: 135px; height:auto; vertical-align: middle; }
    .logo-intranet{ height:35px; width:auto; opacity: 0.9; }
    
    .header-controls-right { display: flex; align-items: center; gap: 10px; }

    .header-icon-btn { 
        background: none; border: 1px solid #0cf; color: #0cf; border-radius: 4px; padding: 5px;           
        cursor: pointer; display: flex; align-items: center; justify-content: center;
        width: 37px; height: 37px; transition: background-color 0.2s ease, transform 0.2s ease;
    }
    .header-icon-btn:hover { background: #333; transform: scale(1.05); }
    .header-icon-btn svg { width: 20px; height: 20px; fill: currentColor; }
    
    #metronome-toggle-btn svg { fill: none; stroke: currentColor; stroke-width: 2; }
    #site-audio-control-button { display: none; } 

    .hamburger{
        cursor:pointer; border:1px solid #0cf; border-radius:4px; padding:5px; display: flex; 
        flex-direction: column; justify-content: space-around; width: 37px; height: 37px; box-sizing: border-box;
    }
    .hamburger div{width:25px;height:3px;background:#0cf;margin:0 auto;} 
    
    .sidebar{
        position:fixed; top:0; left:0; width:280px; height:100vh; background:#1a1a1a; border-right:1px solid #222;
        padding: 20px; padding-top: calc(60px + 20px); box-shadow:3px 0 15px rgba(0,200,200,.15);  
        transform:translateX(-100%); transition:transform .3s ease-in-out; z-index:9999; overflow-y: auto;
    }
    .sidebar.show{ transform:translateX(0); }
    .sidebar h2{color:#0cf;margin:0 0 20px 0;}
    .sidebar a{display:block;color:#fff;text-decoration:none;margin:12px 0;padding:10px 5px;border-bottom:1px solid #333; font-size: 1em;}
    .sidebar a:last-of-type { border-bottom: none; }
    .sidebar a:hover{color:#0cf}
    .sidebar a#menu-second-setlist-section { font-weight: bold; color: #0cf !important; }
    .sidebar .submenu { margin-left: 15px; margin-top: 10px; }
    .sidebar .submenu a { padding: 8px 0; font-size: 0.9em; border-top: 1px solid #2a2a2a; border-bottom: none; margin: 5px 0;}
    .sidebar a#menu-config { color: #FFD700; font-weight: bold; margin-top:15px; }  
    .sidebar a#menu-config:hover { color: #fff2a7; }
    
    #overlay{ position:fixed;top:0;left:0;width:100%;height:100%; background:rgba(0,0,0,.75); z-index:5000; display:none; opacity: 0; transition: opacity .3s ease-in-out; }
    #overlay.show{display:block; opacity: 1;}
    
    main { padding-top: 75px; }
    .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; justify-content: center; align-items: center; padding: 10px; backdrop-filter: blur(3px); }
    .modal-backdrop.show { display: flex; }
    
    .modal-content { 
        background: rgba(26, 26, 26, 0.95); color: #fff; padding: 20px; border-radius: 10px; 
        box-shadow: 0 0 30px rgba(0,255,255,0.15); border: 1px solid rgba(0, 204, 255, 0.2);
        width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; position: relative; 
    }
    .modal-content h3 { color: #0cf; margin-top: 0; margin-bottom: 5px; }  
    .modal-content h4 { color: #0cf; margin-top: 15px; margin-bottom: 10px; }
    #concert-detail-title-display, #rehearsal-detail-title-display { color: #fff; font-size: 1em; font-weight: normal; margin-top: 0px; margin-bottom: 20px; text-align: left; border-bottom: 1px solid #333; padding-bottom: 10px; padding-left: 0px; }
    #concert-detail-title-display .concert-date { font-style: italic; font-size: 0.9em; margin-left: 8px; }
    .modal-content label { display: block; margin: 10px 0 5px; color: #0cf; font-weight: bold; }
    .modal-content input[type="text"], .modal-content input[type="url"], .modal-content input[type="time"], .modal-content textarea { width: 100%; padding: 10px; background: #222; color: #fff; border: 1px solid #333; border-radius: 5px; margin-bottom: 15px; }
    .modal-content textarea { min-height: 80px; resize: vertical; }
    .modal-content button { padding: 10px 15px; background: #0cf; color: #000; border: none; border-radius: 8px; cursor: pointer; margin-right: 10px; margin-top: 10px; }
    .modal-content button:hover { background: #09b; }
    .modal-content .modal-close-btn { background: #444; color: #fff; }
    .modal-content .modal-close-btn:hover { background: #555; }
    #musicians-attendance-list { border: 1px solid #333; padding: 10px; margin-bottom:15px; }
    #musicians-attendance-list div { margin-bottom: 8px; display: flex; align-items: center; }
    #musicians-attendance-list label { color: #fff; margin-left: 8px; font-weight: normal; cursor: pointer; }
    #musicians-attendance-list input[type="checkbox"] { vertical-align: middle; width: 18px; height: 18px; cursor: pointer; }
    .modal-field-group { display: flex; gap: 15px; flex-wrap: wrap; }
    .modal-field-group > div { flex: 1; min-width: 200px; }
    .config-screen {
        display:none; position:fixed; top:0; left:0; width:100%; height:100%;
        background: rgba(10, 10, 10, 0.95); z-index:10001; overflow-y:auto; padding: 20px; padding-top: calc(60px + 20px); 
        backdrop-filter: blur(5px);
    }
    .config-screen h2{color:#0cf;text-align:center;margin:10px 0 20px;}  
    .config-screen h3{color:#0cf;margin:20px 0 10px}
    .config-screen label{display:block;margin:10px 0 5px}
    .config-screen input,.config-screen select{width:100%;max-width:400px;padding:10px;background:#222;color:#fff; border:1px solid #333;border-radius:5px}
    .config-screen select[multiple] { height: 150px; }
    .config-screen button{margin-top:30px;padding:10px 20px;background:#0cf;color:#000;border:none;border-radius:8px;cursor:pointer}
    .config-screen button:hover{background:#09b}
    .config-screen .close-btn{ position:absolute; top:15px; right:20px; font-size:1.2em;background:none;border:1px solid #0cf; color:#0cf;border-radius:4px;padding:5px 10px;cursor:pointer; z-index: 10002; }
    .config-screen .close-btn:hover{background:#333}
    main section{max-width:1200px;margin:0 auto;padding:20px}
    
    #setlists, #star-setlist, #rehearsals, #second-setlist, #calendario, #vista-calendario-mensual, #suggestions, #analisis { 
        background: rgba(20, 20, 20, 0.75); 
        backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); 
        padding:20px; border-radius:12px; 
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); 
        border: 1px solid rgba(0, 204, 255, 0.1); margin-bottom:40px 
    }
    
    #setlists h2, #star-setlist h2, #rehearsals h2, #second-setlist h2, #calendario h2, #suggestions h2, #analisis h2 { text-align:center;color:#0cf;margin-bottom:5px }
    .setlist-dynamic-name { text-align:center;color:#aaa;margin-top:0px; margin-bottom:15px; font-style:italic; font-size: 0.9em; }
    .table-wrapper { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; display: flex; justify-content: center; }
    table { width: 100%; max-width: 100%; border-collapse: collapse; margin-top: 20px; color: #fff; font-size: .95em; margin-left: auto; margin-right: auto; }
    thead{background:#222;color:#0cf}
    th,td{padding:12px;border:1px solid #333;text-align:left;white-space: normal; word-wrap: break-word;}
    
    /* Ajustes columnas setlist */
    #setlists table th:nth-child(3), #setlists table th:nth-child(4), #setlists table th:nth-child(5), #setlists table th:nth-child(6), #setlists table th:nth-child(7),
    #second-setlist table th:nth-child(3), #second-setlist table th:nth-child(4), #second-setlist table th:nth-child(5), #second-setlist table th:nth-child(6), #second-setlist table th:nth-child(7),
    #star-setlist table th:nth-child(3), #star-setlist table th:nth-child(4), #star-setlist table th:nth-child(5), #star-setlist table th:nth-child(6), #star-setlist table th:nth-child(7) { text-align: center; }
    
    #setlists table td:nth-child(3), #setlists table td:nth-child(4), #setlists table td:nth-child(5), #setlists table td:nth-child(6), #setlists table td:nth-child(7),
    #second-setlist table td:nth-child(3), #second-setlist table td:nth-child(4), #second-setlist table td:nth-child(5), #second-setlist table td:nth-child(6), #second-setlist table td:nth-child(7),
    #star-setlist table td:nth-child(3), #star-setlist table td:nth-child(4), #star-setlist table td:nth-child(5), #star-setlist table td:nth-child(6), #star-setlist table td:nth-child(7) { text-align: center; }
    
    /* JUKEBOX COLUMNS */
    th.jukebox-col-header, td.jukebox-col { width: 40px; text-align: center; padding: 5px; }
    .jukebox-btn {
        background: transparent; border: 1px solid #333; color: #555;
        border-radius: 50%; width: 32px; height: 32px; 
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: all 0.3s; margin: 0 auto;
    }
    .jukebox-btn.active {
        border-color: #0cf; color: #0cf;
        box-shadow: 0 0 5px rgba(0, 204, 255, 0.3);
    }
    .jukebox-btn.active:hover {
        background: rgba(0, 204, 255, 0.1); transform: scale(1.1);
        box-shadow: 0 0 10px rgba(0, 204, 255, 0.6);
    }
    .jukebox-btn.inactive {
        opacity: 0.4; filter: grayscale(100%); border-color: #444;
    }
    .jukebox-btn.inactive:hover {
        opacity: 1; border-color: #666; color: #999;
    }
    .jukebox-btn svg { width: 18px; height: 18px; fill: currentColor; }

    /* PDF COLUMNS (NUEVO) */
    th.pdf-col-header, td.pdf-col { width: 40px; text-align: center; padding: 5px; }
    .pdf-btn {
        background: transparent; border: 1px solid #333; color: #555;
        border-radius: 50%; width: 32px; height: 32px;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: all 0.3s; margin: 0 auto;
    }
    .pdf-btn.active {
        border-color: #ff9800; color: #ff9800; /* Naranja/Dorado para PDF */
        box-shadow: 0 0 5px rgba(255, 152, 0, 0.3);
    }
    .pdf-btn.active:hover {
        background: rgba(255, 152, 0, 0.1); transform: scale(1.1);
        box-shadow: 0 0 10px rgba(255, 152, 0, 0.6);
    }
    .pdf-btn.inactive {
        opacity: 0.4; filter: grayscale(100%); border-color: #444;
    }
    .pdf-btn.inactive:hover {
        opacity: 1; border-color: #666; color: #999;
    }
    .pdf-btn svg { width: 18px; height: 18px; fill: currentColor; }


    /* METRONOME COLUMN */
    th.metronome-col-header, td.metronome-col { width: 40px; text-align: center; padding: 5px; }
    .metronome-table-btn {
        background: transparent; border: 1px solid #333; color: #555;
        border-radius: 50%; width: 32px; height: 32px;
        display: flex; align-items: center; justify-content: center;
        margin: 0 auto; cursor: default; transition: all 0.3s;
    }
    .metronome-table-btn svg { width: 18px; height: 18px; fill: none; stroke: currentColor; stroke-width: 2; }
    .metronome-table-btn.has-tempo { border-color: #0cf; color: #0cf; cursor: pointer; box-shadow: 0 0 5px rgba(0, 204, 255, 0.3); }
    .metronome-table-btn.has-tempo:hover { background: rgba(0, 204, 255, 0.1); transform: scale(1.1); box-shadow: 0 0 10px rgba(0, 204, 255, 0.6); }
    .metronome-table-btn.active-metronome {
        background: rgba(255, 85, 85, 0.2); border-color: #ff5555 !important; color: #ff5555 !important;
        box-shadow: 0 0 8px rgba(255, 85, 85, 0.6); animation: pulse-metro 1s infinite; cursor: pointer;
    }
    @keyframes pulse-metro { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

    .break-row td { font-style: italic; color: #ccc; background-color: #161616; }
    .break-row td:first-child { color: #777; text-align: center; }
    .set-header-row td { font-weight: bold; text-align: center; background-color: #383838; color: #0cf; padding-top: 12px; padding-bottom: 12px; border-top: 1px solid #505050 !important; border-bottom: 1px solid #505050 !important; }
    th.calendar-col-header, td.calendar-col { width: 50px; text-align: center; padding-left: 5px; padding-right: 5px; }
    th.details-col-header { width: 50px; text-align: center; padding-left: 5px; padding-right: 5px; }
    tr:nth-child(even):not(.set-header-row):not(.break-row){background: rgba(26, 26, 26, 0.6);}
    .download-btn, .live-mode-btn {display:inline-block;margin:20px 5px 0;padding:10px 20px;font-size:1em;background:#0cf;color:#000;border:none;border-radius:8px;cursor:pointer}
    .download-btn:hover{background:#09b}
    .live-mode-btn { background: #ff0055; color: #fff; border: 1px solid #ff0055; }
    .live-mode-btn:hover { background: #cc0044; }

    #total-time, #total-time-star, #total-time-2{color:#0cf;margin-top:10px;text-align:center}
    footer{background:#111;color:#888;text-align:center;padding:10px;border-top:1px solid #222}
    .calendar-btn, .details-btn { background: none; border: none; cursor: pointer; padding: 5px; margin-left: 0; vertical-align: middle; }
    .calendar-btn svg { fill: #0cf; width: 20px; height: 20px; }
    .delete-user, .edit-user, .delete-rehearsal, .clear-attendance, .edit-rehearsal { padding: 5px 10px; margin: 0 5px; background: #f00; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    .edit-user, .edit-rehearsal { background: #0cf; color: #000; }
    .clear-attendance { background: #ff9800; }
    .attendance-form { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .attendance-form select { padding: 5px; background: #222; color: #fff; border: 1px solid #333; border-radius: 4px; }
    .attendance-form button { padding: 5px 10px; background: #0cf; color: #000; border: none; border-radius: 4px; cursor: pointer; }
    .attendance-summary { margin-top: 10px; font-size: 0.9em; }
    .attendance-summary span { display: block; }
    .attending-yes { color: #0cf; }
    .attending-no { color: #f00; }
    .rehearsal-duration { display: block; font-size: 0.9em; color: #aaa; }
    #connection-status { position: fixed; top: calc(60px + 5px); right: 10px; background: rgba(0, 0, 0, 0.8); color: #fff; padding: 5px 10px; border-radius: 5px; font-size: 0.9em; z-index: 10000; display: none; }
    #connection-status.offline { background: #f00; }
    #connection-status.retrying { background: #ff9800; }
    .success-message { color: #0cf; margin-top: 10px; text-align: center; }
    .error-message { color: #f00; margin-top: 10px; text-align: center; }
    .stats-table { margin-bottom: 40px; }
    .stats-table h3 { color: #0cf; margin: 20px 0 10px; text-align: center; }
    .stats-filter { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px; }
    .stats-filter label { color: #0cf; }
    .stats-filter select { padding: 5px; background: #222; color: #fff; border: 1px solid #333; border-radius: 4px; width: auto; max-width: 200px; }
    #firebase-critical-error-banner { background-color: red; color: white; padding: 15px; text-align: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 100001; font-weight: bold; }

    /* JUKEBOX PLAYER BAR */
    #jukebox-player-bar {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
        width: 95%; max-width: 450px;
        background: rgba(20, 20, 20, 0.98); 
        border: 1px solid #0cf;
        border-radius: 12px;
        padding: 20px; 
        z-index: 11000; 
        display: flex; 
        opacity: 0; visibility: hidden; pointer-events: none;
        flex-direction: column; align-items: center;
        box-shadow: 0 0 50px rgba(0,0,0,0.8), 0 0 15px rgba(0,204,255,0.3);
        backdrop-filter: blur(10px);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    #jukebox-player-bar.visible { 
        opacity: 1; visibility: visible; pointer-events: all;
        transform: translate(-50%, -50%) scale(1);
    }
    .jukebox-info { display: flex; align-items: center; width: 100%; justify-content: space-between; margin-bottom: 15px; }
    .jukebox-song-title { color: #fff; font-weight: bold; font-size: 1.1em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 85%; text-shadow: 0 0 5px rgba(0,204,255,0.5); }
    .jukebox-controls { display: flex; gap: 20px; align-items: center; }
    .jukebox-control-btn { background: none; border: none; color: #0cf; cursor: pointer; padding: 5px; }
    .jukebox-control-btn svg { width: 32px; height: 32px; fill: currentColor; }
    .jukebox-progress-container { width: 100%; display: flex; align-items: center; gap: 10px; color: #aaa; font-size: 0.9em; margin-top: 15px; }
    .jukebox-progress-bar { flex-grow: 1; cursor: pointer; -webkit-appearance: none; height: 6px; background: #333; border-radius: 3px; }
    .jukebox-progress-bar::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #0cf; border-radius: 50%; cursor: pointer; box-shadow: 0 0 5px #0cf; }
    .jukebox-close-btn { font-size: 1.5em; color: #aaa; background:none; border:none; cursor:pointer; padding:0 5px; }
    #jukebox-iframe-container { width: 100%; height: 80px; display: none; margin-top: 10px; border-radius: 8px; overflow: hidden; border: 1px solid #333; }
    #jukebox-iframe-container iframe { width: 100%; height: 100%; border: none; background: transparent; }

    /* METRONOME POPUP */
    #metronome-popup {
        position: fixed; top: 70px; right: 20px; width: 260px;
        background: rgba(20, 20, 20, 0.95); 
        border: 1px solid #0cf; border-radius: 12px;
        padding: 15px; z-index: 2000;
        box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        display: none; flex-direction: column; align-items: center; gap: 10px;
        backdrop-filter: blur(10px);
    }
    #metronome-popup.visible { display: flex; }
    .metronome-bpm-display { font-size: 2.5em; font-weight: bold; color: #fff; font-family: monospace; }
    .metronome-slider { width: 100%; margin: 10px 0; -webkit-appearance: none; background: #333; height: 5px; border-radius: 3px; }
    .metronome-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 15px; height: 15px; background: #0cf; border-radius: 50%; cursor: pointer; }
    .metronome-play-btn { width: 50px; height: 50px; border-radius: 50%; background: #0cf; border: none; color: #000; font-size: 1.2em; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 10px rgba(0,204,255,0.4); }

    /* MOBILE ADJUSTMENTS */
    @media(max-width:768px){
      header { height: 55px; padding: 8px 10px; }  
      .logo img.logo-main{ width: 110px; }
      .logo-intranet{ height:25px; margin-left: 5px; }
      .header-icon-btn { width: 35px; height: 35px; padding: 6px; }
      .hamburger { width: 35px; height: 35px; }
      .hamburger div{width:20px;}
      .sidebar{ width:260px; padding-top: calc(55px + 15px); }
      main { padding-top: 65px; }
      .config-screen { padding-top: calc(55px + 15px); }
      .table-wrapper { overflow-x: hidden; }  
      table { width: 100%; min-width: unset; font-size: 0.85em; }
      th, td { padding: 8px; white-space: normal; word-wrap: break-word; max-width: 150px; }
    }

    /* CALENDAR GRID */
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
    .cal-header { background: rgba(26, 26, 26, 0.8); color: #0cf; text-align: center; padding: 10px 0; font-weight: bold; font-size: 0.9em; border-radius: 4px; }
    .cal-day { background: rgba(0, 0, 0, 0.5); min-height: 100px; padding: 5px; position: relative; display: flex; flex-direction: column; gap: 2px; border-radius: 4px; border: 1px solid #333; }
    .cal-day.other-month { background: rgba(0, 0, 0, 0.2); opacity: 0.5; border: none; }
    .cal-day.today { border: 1px solid #0cf; background: rgba(0, 204, 255, 0.05); }
    .cal-day-number { font-size: 0.8em; color: #777; align-self: flex-end; margin-bottom: 5px; }
    .cal-event { font-size: 0.75em; padding: 3px 5px; border-radius: 3px; margin-bottom: 3px; word-wrap: break-word; line-height: 1.2; box-shadow: 0 2px 4px rgba(0,0,0,0.3); transition: transform 0.2s ease; }
    .cal-event.type-ensayo { color: #ff9999; border-left: 3px solid #ff3333; background: linear-gradient(90deg, rgba(255, 0, 0, 0.15) 0%, rgba(255,0,0,0.05) 100%); }
    .cal-event.type-concierto { color: #ffff99; border-left: 3px solid #ffff00; background: linear-gradient(90deg, rgba(255, 255, 0, 0.15) 0%, rgba(255,255,0,0.05) 100%); }

    /* SUGGESTIONS */
    .suggestion-card { background: rgba(30, 30, 30, 0.6); border: 1px solid rgba(0, 204, 255, 0.1); border-radius: 8px; padding: 15px; margin-bottom: 20px; }
    .suggestion-header { border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; margin-bottom: 10px; }

    /* MODO DIRECTO OVERLAY */
    #live-mode-overlay {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: #000; z-index: 999999;
        display: none; flex-direction: column; color: #fff;
    }
    #live-mode-overlay.show { display: flex; }
    .live-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #333; }
    .live-counter { color: #888; font-size: 1.2em; }
    .live-close-btn { background: none; border: 1px solid #555; color: #aaa; border-radius: 50%; width: 40px; height: 40px; font-size: 1.2em; cursor: pointer; }
    .live-content { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
    .live-song-title { font-size: 3.5em; font-weight: bold; color: #fff; margin-bottom: 20px; line-height: 1.1; text-shadow: 0 0 10px rgba(0,204,255,0.3); }
    .live-song-meta { font-size: 2em; color: #FFD700; display: flex; gap: 30px; margin-bottom: 40px; }
    .live-next-song { color: #555; font-size: 1.2em; margin-top: auto; }
    .live-controls { display: flex; height: 100px; border-top: 1px solid #333; }
    .live-control-btn { flex: 1; background: #111; border: none; color: #0cf; font-size: 2em; cursor: pointer; border-right: 1px solid #333; }
    .live-control-btn:last-child { border-right: none; }
  </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0",
    "firebase/": "https://aistudiocdn.com/firebase@^12.6.0/"
  }
}
</script>
</head>

<body>
  <div id="splash-screen">
    <img src="assets/Logo Sobre negro1.png" alt="Cargando El S√≥tano del Doctor...">
  </div>
  <div id="firebase-critical-error-banner" style="display:none;">
    ERROR CR√çTICO: La configuraci√≥n de Firebase no es v√°lida.
  </div>
  <div id="connection-status"></div>

  <!-- JUKEBOX PLAYER BAR -->
  <div id="jukebox-player-bar">
    <div class="jukebox-info">
        <span id="jukebox-current-title" class="jukebox-song-title">No hay canci√≥n</span>
        <button class="jukebox-close-btn" id="jukebox-close-player">‚úï</button>
    </div>
    <div class="jukebox-controls" id="jukebox-std-controls">
        <button class="jukebox-control-btn" id="jb-play-pause"><svg id="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
    </div>
    <div class="jukebox-progress-container">
        <input type="range" id="jb-progress" class="jukebox-progress-bar" value="0">
    </div>
    <div id="jukebox-iframe-container">
        <iframe id="jb-iframe" src=""></iframe>
    </div>
    <audio id="jukebox-audio-element" style="display:none;"></audio>
  </div>

  <header>
    <div class="header-left">
        <div class="logo"><img src="assets/logo_blanco.png" class="logo-main"></div>
        <img src="assets/logointranet.png" class="logo-intranet">
    </div>
    <div class="header-controls-right">
        <button id="metronome-toggle-btn" class="header-icon-btn"><svg viewBox="0 0 24 24"><path d="M12 2L3 20h18L12 2zm0 3.8L17.6 18H6.4L12 5.8zM11 8v6h2V8h-2z"/></svg></button>
        <button id="header-calendar-btn" class="header-icon-btn"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z"/></svg></button>
        <div class="hamburger" id="hamburger-btn"><div></div><div></div><div></div></div>
    </div>
  </header>

  <div id="metronome-popup">
     <div class="metronome-bpm-display"><span id="metro-bpm-val">120</span></div>
     <input type="range" id="metro-bpm-slider" class="metronome-slider" min="40" max="240" value="120">
     <button class="metronome-play-btn" id="metro-play-btn"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg></button>
  </div>

  <div id="overlay"></div>
  <nav class="sidebar" id="sidebar-menu">
    <h2>Men√∫</h2>
    <a href="#setlists" id="menu-rehearsals-setlist-section">Setlist Pr√≥ximo Ensayo</a>
    <a href="#rehearsals" id="menu-rehearsals-section">Pr√≥ximos Ensayos</a>
    <a href="#second-setlist" id="menu-second-setlist-section">Setlist Pr√≥ximo Concierto</a>
    <a href="#star-setlist" id="menu-star-setlist-section">Setlist Concierto Estrella</a>
    <a href="#calendario" id="menu-concerts-section">Pr√≥ximos Conciertos</a>
    <a href="#vista-calendario-mensual" id="menu-calendar-view">Calendario Mensual</a>
    <a href="#suggestions" id="menu-suggestions">Propuestas de Canciones</a>
    <a href="#analisis" id="menu-analisis-section">An√°lisis / Debriefing</a>
    <a href="#" id="menu-stats">Estad√≠sticas</a>
    <a href="#" id="menu-user-list-display">Usuarios Registrados</a>  
    <a href="#" id="menu-config">Configuraci√≥n</a>
    <div class="submenu" id="config-submenu" style="display: none;">
      <a href="#" id="menu-setlist-config">Configurar Setlists</a>
      <a href="#" id="menu-user-mgmt">Gesti√≥n de Usuarios</a>
      <a href="#" id="menu-rehearsal">Asignar Ensayos</a>
      <a href="#" id="menu-admin-suggestions">Gesti√≥n de Propuestas</a>
      <a href="#" id="menu-jukebox-mgmt">Gesti√≥n Jukebox</a>
      <a href="#" id="menu-pdf-mgmt">Gesti√≥n Partituras/PDFs</a>
    </div>
    <a href="#" id="menu-cerrar">Cerrar Men√∫</a>
  </nav>

  <!-- LIVE MODE OVERLAY -->
  <div id="live-mode-overlay">
      <div class="live-header">
          <div class="live-counter" id="live-counter">1 / 20</div>
          <button class="live-close-btn" id="live-close-btn">‚úï</button>
      </div>
      <div class="live-content" id="live-content-area">
          <div class="live-song-title" id="live-song-title">T√≠tulo Canci√≥n</div>
          <div class="live-song-meta">
              <span id="live-song-key">Key: A</span>
              <span id="live-song-tempo">120 BPM</span>
          </div>
          <div class="live-next-song" id="live-next-song">Siguiente: Otra canci√≥n</div>
      </div>
      <div class="live-controls">
          <button class="live-control-btn" id="live-prev-btn">‚èÆ Anterior</button>
          <button class="live-control-btn" id="live-next-btn">Siguiente ‚è≠</button>
      </div>
  </div>

  <!-- MODALES -->
  <div id="concert-details-modal" class="modal-backdrop"><div class="modal-content"><h3>Detalles del Concierto</h3><h4 id="concert-detail-title-display"></h4><input type="hidden" id="concert-detail-id"><label for="concert-detail-location">Detalles ubicaci√≥n:</label><textarea id="concert-detail-location"></textarea><label for="concert-detail-gmaps-link">Enlace Maps:</label><input type="url" id="concert-detail-gmaps-link"><button id="open-gmaps-link-btn" style="display:none;">Abrir Mapa</button><div class="modal-field-group"><div><label>Montaje Sonido:</label><input type="time" id="concert-detail-soundsetup"></div><div><label>Montaje Instrumentos:</label><input type="time" id="concert-detail-instrumentssetup"></div></div><div class="modal-field-group"><div><label>Prueba sonido:</label><input type="time" id="concert-detail-soundcheck"></div><div><label>Hora show:</label><input type="time" id="concert-detail-showtime"></div></div><label>Notas:</label><textarea id="concert-detail-notes"></textarea><label>Sonorizaci√≥n:</label><input type="text" id="concert-detail-sound-company"><h4>Asistentes</h4><div id="musicians-attendance-list"></div><div id="technicians-attendance-list"></div><button id="save-concert-details">Guardar</button><button id="close-concert-details-modal" class="modal-close-btn">Cerrar</button><p id="concert-detail-message"></p></div></div>
  <div id="rehearsal-details-modal" class="modal-backdrop"><div class="modal-content"><h3>Informaci√≥n Ensayo</h3><h4 id="rehearsal-detail-title-display"></h4><input type="hidden" id="rehearsal-detail-index"><textarea id="rehearsal-notes"></textarea><button id="save-rehearsal-details">Guardar</button><button id="close-rehearsal-details-modal" class="modal-close-btn">Cerrar</button><p id="rehearsal-detail-message"></p></div></div>
  
  <div id="setlist-config-screen" class="config-screen"><button class="close-btn" id="close-setlist-config">Cerrar</button><h2>Configuraci√≥n Setlists</h2><label>Setlist 1</label><input id="setlist1-name"><input id="setlist1-url"><label>Setlist 2</label><input id="setlist2-name"><input id="setlist2-url"><label>Setlist Estrella</label><input id="setlistStar-name"><input id="setlistStar-url"><button id="guardar-setlist-config">Guardar</button><p id="setlist-message"></p></div>
  <div id="jukebox-mgmt-screen" class="config-screen"><button class="close-btn" id="close-jukebox-mgmt">Cerrar</button><h2>Gesti√≥n Jukebox</h2><div class="table-wrapper"><table id="jukebox-mgmt-table"><thead><tr><th>Canci√≥n</th><th>Enlace</th><th>Acci√≥n</th></tr></thead><tbody id="jukebox-mgmt-body"></tbody></table></div></div>
  
  <!-- PDF MGMT SCREEN (NUEVO) -->
  <div id="pdf-mgmt-screen" class="config-screen">
      <button class="close-btn" id="close-pdf-mgmt">Cerrar</button>
      <h2>Gesti√≥n Partituras/PDFs</h2>
      <p style="color:#aaa; text-align:center;">Listado de documentos asignados.</p>
      <div class="table-wrapper">
          <table id="pdf-mgmt-table">
              <thead><tr><th>Canci√≥n</th><th>Enlace</th><th>Acci√≥n</th></tr></thead>
              <tbody id="pdf-mgmt-body"></tbody>
          </table>
      </div>
  </div>

  <div id="jukebox-edit-modal" class="modal-backdrop"><div class="modal-content"><h3>Jukebox: <span id="jb-modal-songname"></span></h3><label>URL Audio:</label><input type="text" id="jb-modal-url-input"><button id="jb-modal-save-btn">Guardar</button><button id="jb-modal-cancel-btn" class="modal-close-btn">Cancelar</button></div></div>
  
  <!-- PDF EDIT MODAL (NUEVO) -->
  <div id="pdf-edit-modal" class="modal-backdrop">
      <div class="modal-content" style="max-width: 500px;">
         <h3>Documento: <span id="pdf-modal-songname" style="color:#fff;"></span></h3>
         <label for="pdf-modal-url-input">Enlace (Dropbox, Drive, PDF):</label>
         <input type="text" id="pdf-modal-url-input" placeholder="Pegar URL aqu√≠...">
         <div style="margin-top:20px; display: flex; justify-content: flex-end;">
            <button id="pdf-modal-cancel-btn" class="modal-close-btn">Cancelar</button>
            <button id="pdf-modal-save-btn">Guardar</button>
         </div>
      </div>
  </div>

  <div id="user-mgmt-screen" class="config-screen"><button class="close-btn" id="close-user-mgmt">Cerrar</button><h2>Gesti√≥n Usuarios</h2><input id="user-name" placeholder="Nombre"><input id="user-nickname" placeholder="Apodo"><select id="user-role" multiple><option value="Bater√≠a">Bater√≠a</option><option value="Voz">Voz</option><option value="Guitarra">Guitarra</option><option value="Bajo">Bajo</option><option value="Teclados">Teclados</option></select><button id="add-user">A√±adir</button><button id="cancel-edit-user" style="display:none;">Cancelar</button><p id="user-message"></p><table id="user-table"><tbody id="user-table-body"></tbody></table></div>
  <div id="rehearsal-screen" class="config-screen"><button class="close-btn" id="close-rehearsal">Cerrar</button><h2>Ensayos</h2><input type="date" id="rehearsal-date"><input type="time" id="rehearsal-start-time"><input type="time" id="rehearsal-end-time"><input id="rehearsal-location"><button id="add-rehearsal">A√±adir</button><button id="cancel-edit-rehearsal" style="display:none;">Cancelar</button><p id="rehearsal-message"></p><table id="rehearsal-table"><tbody id="rehearsal-table-body"></tbody></table></div>
  <div id="stats-screen" class="config-screen"><button class="close-btn" id="close-stats">Cerrar</button><h2>Estad√≠sticas</h2><select id="stats-month-filter"></select><div id="stats-content"><table id="time-per-month-table"><tbody id="time-per-month-body"></tbody></table><table id="time-per-user-table"><tbody id="time-per-user-body"></tbody></table><table id="past-rehearsals-table"><tbody id="past-rehearsals-body"></tbody></table></div></div>
  <div id="suggestions-screen" class="config-screen"><button class="close-btn" id="close-suggestions">Cerrar</button><h2>Propuestas</h2><select id="user-identity-selector"><option value="" disabled selected>-- Selecciona tu nombre --</option></select><div class="suggestion-form"><input id="suggestion-title" placeholder="T√≠tulo"><input id="suggestion-artist" placeholder="Artista"><input id="suggestion-link" placeholder="Link"><button id="add-suggestion-btn">Proponer</button><p id="suggestion-message"></p></div><div id="suggestions-container"></div></div>
  <div id="admin-suggestions-screen" class="config-screen"><button class="close-btn" id="close-admin-suggestions">Cerrar</button><h2>Admin Propuestas</h2><div class="table-wrapper"><table><tbody id="admin-suggestions-body"></tbody></table></div></div>
  <div id="user-list-screen" class="config-screen"><button class="close-btn" id="close-user-list-screen">Cerrar</button><h2>Usuarios Registrados</h2><div class="table-wrapper"><table><thead><tr><th>Nombre</th><th>Apodo</th><th>Roles</th></tr></thead><tbody id="users-body"></tbody></table></div></div>

  <main>
    <section id="setlists">
      <h2>Setlist Pr√≥ximo Ensayo</h2>
      <p id="setlist1-dynamic-name" class="setlist-dynamic-name"></p>
      <div class="table-wrapper"> <table> <thead> <tr><th>#</th><th>T√≠tulo</th><th class="jukebox-col-header">üéß</th><th class="pdf-col-header">üìù</th><th>Key</th><th>Tempo</th><th class="metronome-col-header">‚è±</th><th>Time</th></tr></thead><tbody id="setlist-body"></tbody></table></div>
      <div style="text-align:center;"><button class="download-btn" id="download-btn">Pdf</button><button class="live-mode-btn" onclick="startLiveMode(window.globalItems1)">Modo Show üé§</button></div>
      <p id="total-time"></p>
    </section>
    <section id="rehearsals"> <h2>Pr√≥ximos Ensayos</h2> <div class="table-wrapper"><table id="rehearsal-main-table"> <thead><tr><th>Fecha</th><th>Hora</th><th>Lugar</th><th class="calendar-col-header">Cal</th><th class="details-col-header">Info</th><th>Asistencia</th></tr></thead><tbody id="rehearsal-main-body"></tbody></table></div></section>
    <section id="second-setlist">
      <h2>Setlist Pr√≥ximo Concierto</h2>
      <p id="second-setlist-dynamic-name" class="setlist-dynamic-name"></p>
      <div class="table-wrapper"> <table id="second-list-table"> <thead><tr><th>#</th><th>Canci√≥n</th><th class="jukebox-col-header">üéß</th><th class="pdf-col-header">üìù</th><th>Key</th><th>Tempo</th><th class="metronome-col-header">‚è±</th><th>Time</th></tr></thead><tbody id="second-body"></tbody></table></div>
      <div style="text-align:center;"><button class="download-btn" id="download-btn-2">Pdf</button><button class="live-mode-btn" onclick="startLiveMode(window.globalItems2)">Modo Show üé§</button></div>
      <p id="total-time-2"></p>
    </section>
    <section id="star-setlist">
      <h2>Setlist Concierto Estrella</h2>
      <p id="star-setlist-dynamic-name" class="setlist-dynamic-name"></p>
      <div class="table-wrapper"> <table> <thead><tr><th>#</th><th>T√≠tulo</th><th class="jukebox-col-header">üéß</th><th class="pdf-col-header">üìù</th><th>Key</th><th>Tempo</th><th class="metronome-col-header">‚è±</th><th>Time</th></tr></thead><tbody id="star-setlist-body"></tbody></table></div>
      <div style="text-align:center;"><button class="download-btn" id="download-btn-star">Pdf</button><button class="live-mode-btn" onclick="startLiveMode(window.globalItemsStar)">Modo Show üé§</button></div>
      <p id="total-time-star"></p>
    </section>
    <section id="calendario"> <h2>Pr√≥ximos Conciertos</h2> <div id="bandhelper-concerts-container"><p style="text-align:center;">Cargando conciertos...</p></div> </section>
    <section id="vista-calendario-mensual"><h2>Calendario Mensual</h2><div class="calendar-controls"><button id="prev-month-btn"><</button><h3 id="calendar-month-display"></h3><button id="next-month-btn">></button></div><div class="calendar-grid" id="calendar-grid-container"></div></section>
    <section id="analisis"><h2>An√°lisis</h2><div style="text-align:right;"><button id="add-analysis-btn" class="download-btn">+ Nuevo</button></div><div class="table-wrapper"><table><thead><tr><th>T√≠tulo</th><th>Audio</th><th>Notas</th><th>Config</th></tr></thead><tbody id="analisis-body"></tbody></table></div></section>
  </main>

  <footer>¬© El S√≥tano del Doctor</footer>

  <script src="jukebox.js"></script>
  <script src="metronome.js"></script>
  <script src="analisis.js"></script>

<script>
// --- GLOBAL VARS & CONFIG ---
window.pdfLibrary = {};
window.jukeboxLibrary = {};
window.globalItems1 = []; window.globalItems2 = []; window.globalItemsStar = [];
let db;
let users = []; let rehearsals = []; let suggestions = [];
let setlistConfig = {setlist1:{name:"Setlist Ensayo",url:""},setlist2:{name:"Setlist Concierto",url:""},setlistStar:{name:"Setlist Estrella",url:""}};
let editingUserIndex=null, editingRehearsalIndex=null;
const PASSWORD = "Sotano2014"; 
let isAuthenticated = false;

const firebaseConfig = {
  apiKey: "AIzaSyCEP44xNINCkIejgNvcYafJsALnO0y4dfw",  
  authDomain: "sotanointranet.firebaseapp.com",
  projectId: "sotanointranet",
  storageBucket: "sotanointranet.appspot.com",  
  messagingSenderId: "756955233128",
  appId: "1:756955233128:web:ab36372bdbd895a30e74dd"
};

// --- HELPERS ---
const sanitizeFirebaseKey = (str) => str.replace(/[.#$[\]/:\s,]/g, '_');
const decodeHtmlEntities = (text) => { if (typeof text !== 'string') return text; const textArea = document.createElement('textarea'); textArea.innerHTML = text; return textArea.value;};
const toMMSS = s => { if (isNaN(s)) s=0; const t = Math.round(s); return `${Math.floor(t/60)}:${String(t%60).padStart(2, "0")}`;};
const toHHMM = s => { if (isNaN(s)) s=0; const t = Math.round(s); return `${Math.floor(t/3600)}h ${Math.floor((t%3600)/60)}m`;};
const calculateDuration = (start, end) => { if(!start||!end) return 0; const [sh,sm]=start.split(':').map(Number); const [eh,em]=end.split(':').map(Number); let diff = (eh*60+em)-(sh*60+sm); if(diff<0) diff+=24*60; return diff*60; };
const formatDateWithDay = dateStr => { const date = new Date(dateStr + 'T00:00:00Z'); const days = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"]; const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]; return `${days[date.getUTCDay()]} ${date.getUTCDate()} de ${months[date.getUTCMonth()]}`;};
const getMonthYear = dateStr => { const date = new Date(dateStr + 'T00:00:00Z'); const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]; return `${months[date.getUTCMonth()]} ${date.getUTCFullYear()}`;};

// --- DB ACCESS ---
window.loadDoc = async function(collection, docId, fallback) { 
    if (!db) return fallback;
    try { const snap = await db.collection(collection).doc(docId).get(); return snap.exists ? snap.data() : fallback; } 
    catch (e) { console.warn(`Load ${collection} failed`, e); return fallback; } 
}
window.saveDoc = async function(collection, docId, data, merge = false) { 
    if (!db) return;
    await db.collection(collection).doc(docId).set(data, { merge: merge });
}

// --- PDF FEATURE ---
const pdfEditModal = document.getElementById('pdf-edit-modal');
let currentEditingPdfSongName = null;

window.loadPdfLibrary = async function() {
    const data = await window.loadDoc("intranet", "pdf_library", { library: {} });
    window.pdfLibrary = data.library || {};
};
window.savePdfLibrary = async function() {
    await window.saveDoc("intranet", "pdf_library", { library: window.pdfLibrary });
};
window.openPdfLink = function(url) {
    if(url) window.open(url, '_blank');
};
window.openPdfEditModal = function(songName) {
    currentEditingPdfSongName = songName;
    const cleanName = sanitizeFirebaseKey(songName);
    const val = window.pdfLibrary[cleanName] || "";
    document.getElementById('pdf-modal-url-input').value = val;
    document.getElementById('pdf-modal-songname').textContent = songName;
    pdfEditModal.classList.add('show');
};
document.getElementById('pdf-modal-save-btn').onclick = async () => {
    if(!currentEditingPdfSongName) return;
    const url = document.getElementById('pdf-modal-url-input').value.trim();
    const cleanName = sanitizeFirebaseKey(currentEditingPdfSongName);
    if(url) window.pdfLibrary[cleanName] = url;
    else delete window.pdfLibrary[cleanName];
    await window.savePdfLibrary();
    pdfEditModal.classList.remove('show');
    loadAllSetlists();
};
document.getElementById('pdf-modal-cancel-btn').onclick = () => pdfEditModal.classList.remove('show');
document.getElementById("menu-pdf-mgmt").onclick = e => { e.preventDefault(); openConfig('pdf-mgmt-screen'); renderPdfMgmtTable(); };
document.getElementById("close-pdf-mgmt").onclick = () => document.getElementById("pdf-mgmt-screen").style.display="none";

function renderPdfMgmtTable() {
    const tbody = document.getElementById('pdf-mgmt-body');
    tbody.innerHTML = "";
    Object.keys(window.pdfLibrary).sort().forEach(key => {
        tbody.insertAdjacentHTML('beforeend', `<tr><td>${key.replace(/_/g, " ")}</td><td style="font-size:0.8em; overflow:hidden; max-width:200px;">${window.pdfLibrary[key]}</td><td><button onclick="deletePdfLink('${key}')" style="background:red;">Eliminar</button></td></tr>`);
    });
}
window.deletePdfLink = async function(key) {
    if(confirm("Eliminar enlace?")) {
        delete window.pdfLibrary[key];
        await window.savePdfLibrary();
        renderPdfMgmtTable();
        loadAllSetlists();
    }
}

// --- JUKEBOX MOCK LOGIC ---
document.getElementById('jb-modal-cancel-btn').onclick = () => document.getElementById('jukebox-edit-modal').classList.remove('show');
window.openJukeboxEditModal = function(name) {
    document.getElementById('jb-modal-songname').textContent = name;
    document.getElementById('jukebox-edit-modal').classList.add('show');
};
document.getElementById("menu-jukebox-mgmt").onclick = e => { e.preventDefault(); openConfig('jukebox-mgmt-screen'); };

// --- FULL LOGIC RESTORATION ---

// 1. SETLIST GENERATION
function createPdfCell(songName) {
    const cleanName = sanitizeFirebaseKey(songName);
    const url = window.pdfLibrary[cleanName];
    const statusClass = url ? 'active' : 'inactive';
    const action = url ? `window.openPdfLink('${url}')` : `window.openPdfEditModal('${songName.replace(/'/g, "\\'")}')`;
    const svgIcon = `<svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>`;
    return `<td class="pdf-col"><button class="pdf-btn ${statusClass}" onclick="${action}">${svgIcon}</button></td>`;
}
function createJukeboxCell(songName) {
    const cleanName = sanitizeFirebaseKey(songName);
    const url = window.jukeboxLibrary ? window.jukeboxLibrary[cleanName] : null;
    const statusClass = url ? 'active' : 'inactive';
    const action = url ? `window.openJukeboxPlayer('${songName.replace(/'/g, "\\'")}', '${url}')` : `window.openJukeboxEditModal('${songName.replace(/'/g, "\\'")}')`;
    return `<td class="jukebox-col"><button class="jukebox-btn ${statusClass}" onclick="${action}"><svg viewBox="0 0 24 24"><path d="M12 3a9 9 0 0 0-9 9v7c0 1.1.9 2 2 2h4v-8H5v-1c0-3.87 3.13-7 7-7s7 3.13 7 7v1h-4v8h4c1.1 0 2-.9 2-2v-7a9 9 0 0 0-9-9z"/></svg></button></td>`;
}
function createMetronomeCell(tempo) {
    const t = (tempo||"").replace(/\D/g,'');
    const hasTempo = t.length > 0;
    const cls = hasTempo ? 'has-tempo' : '';
    const action = hasTempo ? `window.toggleMetronomeFromTable && window.toggleMetronomeFromTable('${t}', this)` : '';
    return `<td class="metronome-col"><button class="metronome-table-btn ${cls}" onclick="${action}"><svg viewBox="0 0 24 24"><path d="M12 2L3 20h18L12 2zm0 3.8L17.6 18H6.4L12 5.8zM11 8v6h2V8h-2z"/></svg></button></td>`;
}

async function cargarSetlistGenerico(configEntry, tbodyId, totalTimeId) {
    const tbody = document.getElementById(tbodyId);
    if (!configEntry.url || configEntry.url.includes("CONFIGURAR")) {
        if(tbody) tbody.innerHTML = "<tr><td colspan='8'>URL no configurada</td></tr>";
        return [];
    }
    let items = [];
    try {
        const res = await fetch(configEntry.url);
        const data = await res.json();
        items = Array.isArray(data) ? data : (data.items || []);
    } catch (e) {
        if(tbody) tbody.innerHTML = "<tr><td colspan='8'>Error cargando datos (Offline?)</td></tr>";
        return [];
    }
    if(tbody) tbody.innerHTML = "";
    let totalSec = 0; let count = 0;
    let structure = [];
    
    // Process items like the original code
    items.forEach(item => {
        const name = item.title || item.name || "Sin T√≠tulo";
        let duration = parseFloat(item.duration) || 0;
        let isSet = item.type === "set";
        let isBreak = item.type === "break" || name.toLowerCase().includes("break") || name.toLowerCase().includes("descanso");
        
        let processedItem = { ...item, displayName: name, calculatedDurationSeconds: duration, isSong: !isSet && !isBreak, isSetHeader: isSet, isBreak: isBreak };
        structure.push(processedItem);

        if (isSet) {
            tbody.insertAdjacentHTML('beforeend', `<tr class="set-header-row"><td colspan="8">${name}</td></tr>`);
        } else if (isBreak) {
            if(duration === 0) duration = 15*60; 
            totalSec += duration;
            tbody.insertAdjacentHTML('beforeend', `<tr class="break-row"><td></td><td>${name}</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>${toMMSS(duration)}</td></tr>`);
        } else {
            count++;
            totalSec += duration;
            tbody.insertAdjacentHTML('beforeend', `<tr><td>${count}</td><td>${name}</td>${createJukeboxCell(name)}${createPdfCell(name)}<td>${item.key || '-'}</td><td>${item.tempo || '-'}</td>${createMetronomeCell(item.tempo)}<td>${toMMSS(duration)}</td></tr>`);
        }
    });

    if(document.getElementById(totalTimeId)) document.getElementById(totalTimeId).textContent = "Tiempo Total: " + toHHMM(totalSec);
    return structure;
}

async function loadAllSetlists() {
    window.globalItems1 = await cargarSetlistGenerico(setlistConfig.setlist1, "setlist-body", "total-time");
    window.globalItems2 = await cargarSetlistGenerico(setlistConfig.setlist2, "second-body", "total-time-2");
    window.globalItemsStar = await cargarSetlistGenerico(setlistConfig.setlistStar, "star-setlist-body", "total-time-star");
}

// 2. USERS
async function loadUsers() {
    const data = await window.loadDoc("intranet", "users", { users: [] });
    users = Array.isArray(data.users) ? data.users : [];
    renderUsers();
}
async function saveUsers() { await window.saveDoc("intranet", "users", { users }); renderUsers(); }
function renderUsers() {
    const tbody = document.getElementById("user-table-body"); const tbodyList = document.getElementById("users-body");
    if(tbody) tbody.innerHTML=""; if(tbodyList) tbodyList.innerHTML="";
    const selector = document.getElementById('user-identity-selector');
    if(selector) selector.innerHTML = '<option value="" disabled selected>-- Selecciona tu nombre --</option>';

    users.forEach((u,i) => {
        if(tbody) tbody.insertAdjacentHTML("beforeend",`<tr><td>${u.name}</td><td>${u.nickname}</td><td>${u.roles.join(", ")}</td><td><button class="edit-user" onclick="editUser(${i})">Edit</button><button class="delete-user" onclick="deleteUser(${i})">Del</button></td></tr>`);
        if(tbodyList) tbodyList.insertAdjacentHTML("beforeend",`<tr><td>${u.name}</td><td>${u.nickname}</td><td>${u.roles.join(", ")}</td></tr>`);
        if(selector) selector.insertAdjacentHTML('beforeend', `<option value="${u.name}">${u.name}</option>`);
    });
}
window.editUser = function(i) { editingUserIndex=i; document.getElementById('user-name').value=users[i].name; document.getElementById('user-nickname').value=users[i].nickname; document.getElementById('add-user').textContent="Guardar"; document.getElementById('cancel-edit-user').style.display='inline-block'; }
window.deleteUser = async function(i) { users.splice(i,1); await saveUsers(); }
document.getElementById('add-user').onclick = async () => {
    const name=document.getElementById('user-name').value, nick=document.getElementById('user-nickname').value;
    const roles=Array.from(document.getElementById('user-role').selectedOptions).map(o=>o.value);
    if(editingUserIndex!==null) users[editingUserIndex]={name,nickname:nick,roles};
    else users.push({name,nickname:nick,roles});
    await saveUsers(); resetUserForm();
};
function resetUserForm() { document.getElementById('user-name').value=""; document.getElementById('user-nickname').value=""; editingUserIndex=null; document.getElementById('add-user').textContent="A√±adir"; document.getElementById('cancel-edit-user').style.display='none'; }
document.getElementById('cancel-edit-user').onclick=resetUserForm;

// 3. REHEARSALS
async function loadRehearsals() {
    const data = await window.loadDoc("intranet", "rehearsals", { rehearsals: [] });
    rehearsals = Array.isArray(data.rehearsals) ? data.rehearsals : [];
    renderRehearsals();
}
async function saveRehearsals() { await window.saveDoc("intranet", "rehearsals", { rehearsals }); renderRehearsals(); renderStats(); renderVisualCalendar(); }
function renderRehearsals() {
    const tbodyConfig = document.getElementById("rehearsal-table-body");
    const tbodyMain = document.getElementById("rehearsal-main-body");
    if(tbodyConfig) tbodyConfig.innerHTML=""; if(tbodyMain) tbodyMain.innerHTML="";
    rehearsals.sort((a,b)=>new Date(a.date)-new Date(b.date));
    
    rehearsals.forEach((r,i) => {
        if(tbodyConfig) tbodyConfig.insertAdjacentHTML("beforeend",`<tr><td>${r.date}</td><td>${r.startTime}-${r.endTime}</td><td>${r.location}</td><td>${(r.attendance||[]).length}</td><td><button class="edit-rehearsal" onclick="editRehearsal(${i})">Edit</button><button class="delete-rehearsal" onclick="deleteRehearsal(${i})">Del</button></td></tr>`);
        
        // Main view logic
        if(new Date(r.date) >= new Date()) {
            // Attendance Summary
            const att = r.attendance || [];
            const yes = att.filter(a=>a.attending==='S√≠').map(a=>a.name).join(', ') || 'Nadie';
            const no = att.filter(a=>a.attending==='No').map(a=>a.name).join(', ') || 'Nadie';
            
            const calBtn = `<button class="calendar-btn" onclick="generateICS('Ensayo','${r.date}','${r.startTime}','${r.location}')"><svg viewBox="0 0 24 24"><path d="M12 4V2m0 20v-2m8-8h2m-20 0h-2m15.071-3.071l-1.414-1.414M5.343 17.657l-1.414-1.414m0-10.486l1.414-1.414m12.728 12.728l-1.414 1.414"/><rect x="4" y="6" width="16" height="12" rx="2"/></svg></button>`;
            const infoBtn = `<button class="details-btn" onclick="openRehearsalDetails(${i})">‚û°Ô∏è</button>`;
            
            if(tbodyMain) tbodyMain.insertAdjacentHTML("beforeend", `<tr><td>${formatDateWithDay(r.date)}</td><td>${r.startTime}-${r.endTime}</td><td>${r.location}</td><td class="calendar-col">${calBtn}</td><td class="details-col-header">${infoBtn}</td><td>
                <select id="att-user-${i}">${users.map(u=>`<option value="${u.name}">${u.name}</option>`).join('')}</select>
                <select id="att-resp-${i}"><option value="S√≠">S√≠</option><option value="No">No</option></select>
                <button onclick="confirmAttendance(${i})">OK</button>
                <div class="attendance-summary"><span class="attending-yes">S√≠: ${yes}</span><span class="attending-no">No: ${no}</span></div>
            </td></tr>`);
        }
    });
}
window.editRehearsal = function(i) { editingRehearsalIndex=i; document.getElementById('rehearsal-date').value=rehearsals[i].date; document.getElementById('rehearsal-start-time').value=rehearsals[i].startTime; document.getElementById('rehearsal-end-time').value=rehearsals[i].endTime; document.getElementById('rehearsal-location').value=rehearsals[i].location; document.getElementById('add-rehearsal').textContent="Guardar"; document.getElementById('cancel-edit-rehearsal').style.display='inline-block'; }
window.deleteRehearsal = async function(i) { rehearsals.splice(i,1); await saveRehearsals(); }
document.getElementById('add-rehearsal').onclick = async () => {
    const date=document.getElementById('rehearsal-date').value, start=document.getElementById('rehearsal-start-time').value, end=document.getElementById('rehearsal-end-time').value, loc=document.getElementById('rehearsal-location').value;
    const newData = {date,startTime:start,endTime:end,location:loc, attendance:[]};
    if(editingRehearsalIndex!==null) { newData.attendance=rehearsals[editingRehearsalIndex].attendance; rehearsals[editingRehearsalIndex]=newData; }
    else rehearsals.push(newData);
    await saveRehearsals(); resetRehearsalForm();
};
function resetRehearsalForm() { document.getElementById('rehearsal-date').value=""; document.getElementById('rehearsal-location').value=""; editingRehearsalIndex=null; document.getElementById('add-rehearsal').textContent="A√±adir"; document.getElementById('cancel-edit-rehearsal').style.display='none'; }
document.getElementById('cancel-edit-rehearsal').onclick=resetRehearsalForm;

window.confirmAttendance = async function(i) {
    const name = document.getElementById(`att-user-${i}`).value;
    const resp = document.getElementById(`att-resp-${i}`).value;
    if(!rehearsals[i].attendance) rehearsals[i].attendance=[];
    const existing = rehearsals[i].attendance.find(a=>a.name===name);
    if(existing) existing.attending=resp; else rehearsals[i].attendance.push({name,attending:resp});
    await saveRehearsals();
};
window.openRehearsalDetails = function(i) {
    document.getElementById('rehearsal-detail-index').value = i;
    document.getElementById('rehearsal-notes').value = rehearsals[i].notes || "";
    document.getElementById('rehearsal-details-modal').classList.add('show');
}
document.getElementById('save-rehearsal-details').onclick = async () => {
    const i = document.getElementById('rehearsal-detail-index').value;
    rehearsals[i].notes = document.getElementById('rehearsal-notes').value;
    await saveRehearsals();
    document.getElementById('rehearsal-details-modal').classList.remove('show');
}
document.getElementById('close-rehearsal-details-modal').onclick = () => document.getElementById('rehearsal-details-modal').classList.remove('show');

// 4. CALENDAR VISUAL
let currentCalDate = new Date();
function renderVisualCalendar() {
    const grid = document.getElementById('calendar-grid-container');
    const display = document.getElementById('calendar-month-display');
    if(!grid || !display) return;
    grid.innerHTML="";
    const year=currentCalDate.getFullYear(), month=currentCalDate.getMonth();
    const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    display.textContent = `${months[month]} ${year}`;
    ["L","M","X","J","V","S","D"].forEach(d=>grid.insertAdjacentHTML('beforeend',`<div class="cal-header">${d}</div>`));
    
    const firstDay = new Date(year, month, 1).getDay() || 7;
    const daysInMonth = new Date(year, month+1, 0).getDate();
    
    for(let i=1; i<firstDay; i++) grid.insertAdjacentHTML('beforeend',`<div class="cal-day other-month"></div>`);
    for(let d=1; d<=daysInMonth; d++) {
        const iso = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const evts = rehearsals.filter(r=>r.date===iso).map(r=>`<div class="cal-event type-ensayo">Ensayo ${r.startTime}</div>`);
        grid.insertAdjacentHTML('beforeend',`<div class="cal-day"><div class="cal-day-number">${d}</div>${evts.join('')}</div>`);
    }
}
document.getElementById('prev-month-btn').onclick = () => { currentCalDate.setMonth(currentCalDate.getMonth()-1); renderVisualCalendar(); };
document.getElementById('next-month-btn').onclick = () => { currentCalDate.setMonth(currentCalDate.getMonth()+1); renderVisualCalendar(); };

// 5. STATS
function renderStats() {
    // Simplified stats for restoration check
    const tbody = document.getElementById('time-per-user-table');
    if(tbody) {
        tbody.innerHTML = "";
        users.forEach(u => {
            let total = 0;
            rehearsals.forEach(r => {
                const attended = r.attendance && r.attendance.find(a=>a.name===u.name && a.attending==='S√≠');
                if(attended) total += calculateDuration(r.startTime, r.endTime)/60;
            });
            tbody.insertAdjacentHTML('beforeend', `<tr><td>${u.name}</td><td>${(total/60).toFixed(1)}h</td></tr>`);
        });
    }
}

// 6. LIVE MODE
window.startLiveMode = function(items) {
    if(!items || items.length===0) return alert("Setlist vac√≠o");
    const overlay = document.getElementById('live-mode-overlay');
    let index = 0;
    const render = () => {
        const item = items[index];
        if(!item) return;
        document.getElementById('live-song-title').textContent = item.displayName;
        document.getElementById('live-song-key').textContent = item.key || "-";
        document.getElementById('live-song-tempo').textContent = (item.tempo || "-") + " BPM";
        document.getElementById('live-counter').textContent = `${index+1} / ${items.length}`;
        document.getElementById('live-next-song').textContent = items[index+1] ? "Siguiente: " + items[index+1].displayName : "FIN";
    };
    overlay.classList.add('show');
    render();
    document.getElementById('live-next-btn').onclick = () => { if(index<items.length-1) { index++; render(); } };
    document.getElementById('live-prev-btn').onclick = () => { if(index>0) { index--; render(); } };
    document.getElementById('live-close-btn').onclick = () => overlay.classList.remove('show');
};

// 7. BANDHELPER (Safe Loading)
function loadBandHelperWidget() {
    const container = document.getElementById('bandhelper-concerts-container');
    if(!container) return;
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    document.body.appendChild(iframe);
    const doc = iframe.contentWindow.document;
    doc.open(); doc.write(`<script src="https://www.bandhelper.com/widget/calendar/10353?layout=1&range=6"><\/script>`); doc.close();
    
    let attempts = 0;
    const check = setInterval(() => {
        attempts++;
        const table = doc.querySelector('table');
        if(table) {
            clearInterval(check);
            container.innerHTML = "";
            container.appendChild(table.cloneNode(true));
            document.body.removeChild(iframe);
        } else if(attempts > 50) { clearInterval(check); document.body.removeChild(iframe); }
    }, 500);
}

// --- APP ENTRY POINT ---
document.addEventListener("DOMContentLoaded", async () => {
    // BLACK SCREEN SAFETY NET
    setTimeout(() => {
        const s = document.getElementById('splash-screen');
        if(s && !s.classList.contains('hidden')) {
            console.warn("Forcing Splash Hide");
            s.classList.add('hidden');
            setTimeout(()=>s.style.display='none', 500);
        }
    }, 4500);

    // MENU HANDLERS
    const overlay = document.getElementById('overlay');
    const closeAll = () => {
        document.getElementById('sidebar-menu').classList.remove('show');
        overlay.classList.remove('show');
        document.querySelectorAll('.config-screen').forEach(s => s.style.display='none');
        document.querySelectorAll('.modal-backdrop').forEach(s => s.classList.remove('show'));
    };
    document.getElementById('menu-cerrar').onclick = closeAll;
    overlay.onclick = closeAll;
    document.getElementById('hamburger-btn').onclick = () => { document.getElementById('sidebar-menu').classList.add('show'); overlay.classList.add('show'); };
    const openConfig = (id) => {
        const pwd = prompt("Contrase√±a:");
        if(pwd && pwd.toLowerCase() === PASSWORD.toLowerCase()) { closeAll(); document.getElementById(id).style.display='block'; }
    };
    
    // Config Links
    document.getElementById('menu-rehearsals-setlist-section').onclick = () => { closeAll(); window.scrollTo(0, document.getElementById('setlists').offsetTop-80); };
    document.getElementById('menu-config').onclick = () => document.getElementById('config-submenu').style.display = document.getElementById('config-submenu').style.display==='block' ? 'none' : 'block';
    document.getElementById('menu-user-mgmt').onclick = (e) => { e.preventDefault(); openConfig('user-mgmt-screen'); };
    document.getElementById('menu-rehearsal').onclick = (e) => { e.preventDefault(); openConfig('rehearsal-screen'); };
    document.getElementById('menu-setlist-config').onclick = (e) => { e.preventDefault(); openConfig('setlist-config-screen'); };
    
    // FIREBASE START
    if (typeof firebase !== 'undefined') {
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            await db.enablePersistence().catch(e=>console.log("Persistence error", e));

            // Load all data parallel
            const cfg = await window.loadDoc("intranet", "setlists", {config: setlistConfig});
            setlistConfig = cfg.config || setlistConfig;
            document.getElementById('setlist1-dynamic-name').textContent = setlistConfig.setlist1.name;
            document.getElementById('second-setlist-dynamic-name').textContent = setlistConfig.setlist2.name;
            document.getElementById('star-setlist-dynamic-name').textContent = setlistConfig.setlistStar.name;

            await Promise.all([
                loadUsers(),
                loadRehearsals(),
                (window.loadJukeboxLibrary ? window.loadJukeboxLibrary() : Promise.resolve()),
                window.loadPdfLibrary(),
                loadAllSetlists()
            ]);

            // Load non-critical
            setTimeout(loadBandHelperWidget, 1000);
            renderStats();
            renderVisualCalendar();

        } catch (e) {
            console.error("Firebase Init Failed", e);
            document.getElementById('firebase-critical-error-banner').style.display = 'block';
        }
    }
    
    // Hide Splash
    const s = document.getElementById('splash-screen');
    if(s) { s.classList.add('hidden'); setTimeout(()=>s.style.display='none', 500); }
});

// ICS Helper
window.generateICS = function(title, date, time, loc) {
    const start = new Date(`${date}T${time}`).toISOString().replace(/-|:|\.\d+/g,'');
    const ics = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nSUMMARY:${title}\nDTSTART:${start}\nLOCATION:${loc}\nEND:VEVENT\nEND:VCALENDAR`;
    const blob = new Blob([ics], {type:'text/calendar'});
    const link = document.createElement('a'); link.href=URL.createObjectURL(blob); link.download='event.ics'; link.click();
}
</script>
</body>
</html>
