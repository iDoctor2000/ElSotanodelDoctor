<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>El Sótano del Doctor – Uso Interno</title>

  <link rel="icon" type="image/x-icon" href="assets/favicon_ElSotanoDr.ico">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">

  <meta property="og:title"       content="El Sótano del Doctor – Uso Interno">
  <meta property="og:description" content="Banda de rock y versiones. Explora nuestro setlist, fechas de conciertos y más.">
  <meta property="og:image"       content="assets/logo_negro copia.jpg">
  <meta property="og:type"        content="website">
  <meta property="og:url"         content="https://idoctor2000.github.io/ElSotanoDelDoctor-Intranet/">
  <meta name="twitter:card"        content="summary_large_image">
  <meta name="twitter:title"       content="El Sótano del Doctor – Uso Interno">
  <meta name="twitter:description" content="Banda de rock y versiones. Explora nuestro setlist, fechas de conciertos y mucho más. ¡Disfruta de la música!">
  <meta name="twitter:image"       content="assets/logo_negro copia.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    /* Estilos CSS (iguales a la v7.8, por brevedad no se repiten aquí) */
    /* ... Pega aquí los estilos de la versión anterior ... */
    /* Reset y fuente base */
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;padding:0;overflow-x:hidden;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff}
    /* Cabecera */
    header{background:#111;padding:15px 20px;display:flex;align-items:center;justify-content:space-between;position:relative; border-bottom: 1px solid #0cf;}
    .logo img.logo-main{width:160px;height:auto} /* Logo principal */
    .logo-intranet{position:absolute;left:50%;transform:translateX(-50%);height:50px;width:auto} /* Centrar logointranet.png */
    /* Hamburguesa */
    .hamburger{cursor:pointer;border:1px solid #0cf;border-radius:4px;padding:5px}
    .hamburger div{width:25px;height:3px;background:#0cf;margin:4px 0}
    /* Sidebar */
    .sidebar{position:fixed;top:0;left:0;width:250px;height:100%;background:#111;border-right:1px solid #222;
             padding:20px;box-shadow:2px 0 10px rgba(0,255,255,.1);transform:translateX(-250px);transition:transform .3s ease-in-out;z-index:9999; overflow-y: auto;}
    .sidebar.show{transform:translateX(0)}
    .sidebar h2{color:#0cf;margin:0 0 15px 0; text-align: center; border-bottom: 1px solid #0cf; padding-bottom: 10px;}
    .sidebar a{display:block;color:#fff;text-decoration:none;margin:12px 0;padding:8px 5px;border-bottom:1px solid #222; font-size: 0.95em;}
    .sidebar a:hover{color:#0cf; background-color: #222; border-radius: 3px;}
    .sidebar .submenu { margin-left: 15px; border-left: 2px solid #0cf; padding-left: 10px; margin-top: 5px;}
    .sidebar .submenu a { padding: 6px 0; font-size: 0.9em; border-bottom: 1px solid #2a2a2a;}
    /* Overlay */
    #overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:9998;display:none;backdrop-filter: blur(2px);}
    #overlay.show{display:block}
    /* Pantallas modales */
    .config-screen, .modal-screen { /* Unificando clase base para modales */
        display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:10000; /* Aumentado z-index para el modal */
        overflow-y:auto;padding:70px 20px 20px
    }
    .config-screen h2, .modal-screen h2 {color:#0cf;text-align:center;margin:10px 0 20px 0}
    .config-screen h3, .modal-screen h3 {color:#0cf;margin:20px 0 10px; border-bottom: 1px solid #333; padding-bottom: 5px;}
    .config-screen label, .modal-screen label {display:block;margin:10px 0 5px; color: #0cf;}
    .config-screen input,.config-screen select, .config-screen textarea,
    .modal-screen input,.modal-screen select, .modal-screen textarea {
        width:100%;max-width:450px;padding:12px;background:#1a1a1a;color:#fff;
        border:1px solid #0cf;border-radius:5px; margin-bottom: 12px; box-shadow: 0 0 5px rgba(0,204,255,0.2); display: block; margin-left: auto; margin-right: auto; 
    }
    /* Ajuste para inputs de hora y texto en modal de notas */
    #concert-note-edit-modal input[type="time"],
    #concert-note-edit-modal input[type="text"] { /* Si tuvieras inputs de texto específicos */
        margin-left: 0; /* Anula el centrado para estos */
        margin-right: 0;
        max-width: 250px; /* O el ancho que prefieras */
    }
     #concert-note-edit-modal textarea {
        margin-left: 0;
        margin-right: 0;
    }

    .config-screen select[multiple], .modal-screen select[multiple] { height: 150px; }
    .config-screen textarea, .modal-screen textarea { height: 120px; resize: vertical; } 
    .modal-screen textarea#concert-note-general { height: 100px; } 

    .config-screen button, .modal-screen button {
        margin-top:25px;padding:12px 22px;background:#0cf;color:#000;border:none;
        border-radius:8px;cursor:pointer;font-weight:bold; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-left: auto; margin-right: auto; 
    }
    .config-screen button:hover, .modal-screen button:hover {background:#0ae; box-shadow: 0 0 10px #0cf;}
    .config-screen .close-btn, .modal-screen .close-btn {
        position:absolute;top:15px;right:15px;font-size:1.5em;background:transparent;border:2px solid #0cf;
        color:#0cf;border-radius:50%;padding:0px;cursor:pointer; width:35px; height:35px; line-height:30px; text-align:center; margin:0; 
    }
    .config-screen .close-btn:hover, .modal-screen .close-btn:hover {background:#0cf; color:#000; box-shadow: 0 0 8px #0cf;}
    
    #concert-note-edit-modal .modal-content { max-width: 600px; margin: auto; background-color: #111; padding: 20px; border-radius: 8px; border: 1px solid #0cf;}
    #concert-note-info { color: #ccc; font-style: italic; margin-bottom: 15px; text-align: center; font-size: 1.1em; }
    #concert-note-edit-modal label {text-align: left; max-width: 450px; margin-left: 0; margin-right: auto;} /* Alinear labels a la izquierda */
    
    /* Estilos para la lista de asistencia en el modal */
    #concert-attendance-list { max-height: 150px; overflow-y: auto; border: 1px solid #333; padding: 10px; border-radius: 5px; margin-top: 10px; max-width: 450px; margin-left:0; margin-right:auto;}
    #concert-attendance-list div { display: flex; align-items: center; margin-bottom: 8px; }
    #concert-attendance-list input[type="checkbox"] { width: auto; margin-right: 10px; -webkit-appearance: checkbox; appearance: checkbox; } /* Resetear apariencia para que se vea el check */
    #concert-attendance-list label { margin-bottom: 0; color: #fff; font-weight: normal;}


    /* Secciones */
    main section{max-width:1200px;margin:20px auto;padding:25px; background:#0a0a0a; border: 1px solid #1c1c1c; border-radius:10px;box-shadow:0 0 20px rgba(0,204,255,.1);}
    #setlists h2,#rehearsals h2,#second-setlist h2, #setlist-estrella h2, #calendario h2,#usuarios h2{text-align:center;color:#0cf;margin-bottom:20px; font-size: 1.8em;} /* Añadido #setlist-estrella h2 */
    /* Ajuste para tablas */
    .table-wrapper { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; color: #fff; font-size: .95em; }
    thead{background:#111;color:#0cf; border-bottom: 2px solid #0cf;}
    th,td{padding:12px 15px;border:1px solid #282828;text-align:left;white-space:normal; word-wrap:break-word;}
    tr:nth-child(even){background:#101010}
    tr:hover {background-color: #181818;}
    #second-setlist .table-wrapper table, #setlist-estrella .table-wrapper table { min-width: 600px; } /* Añadido #setlist-estrella */
    .download-btn{display:block;margin:25px auto 0;padding:12px 25px;font-size:1em;background:#0cf;color:#000;border:none;border-radius:8px;cursor:pointer; font-weight: bold;}
    .download-btn:hover{background:#09b; box-shadow: 0 0 8px #0cf;}
    #total-time,#total-time-2, #total-time-3 {color:#0cf;margin-top:15px;text-align:center; font-size: 1.1em; font-weight: bold;} /* Añadido #total-time-3 */
    #second-setlist-name, #setlist3-title-display {text-align:center;color:#aaa;margin-top:5px;font-style:italic; font-size: 1.1em;} /* Añadido #setlist3-title-display */
    footer{background:#050505;color:#888;text-align:center;padding:15px;border-top:1px solid #0cf; margin-top: 30px;}
    /* Botones de acción, calendario, detalles */
    .calendar-btn, .details-btn { background: none; border: none; cursor: pointer; padding: 5px; margin-left: 10px; vertical-align: middle; }
    .calendar-btn svg { fill: #0cf; width: 22px; height: 22px; transition: fill 0.2s;}
    .calendar-btn:hover svg { fill: #09b; transform: scale(1.1); }
    .details-btn svg { fill: #0af; width: 22px; height: 22px; transition: fill 0.2s;}
    .details-btn:hover svg { fill: #07a; transform: scale(1.1); }
    .action-btn { padding: 6px 12px; margin: 0 5px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s, transform 0.2s; }
    .action-btn:hover {transform: translateY(-1px);}
    .edit-btn { background: #0cf; color: #000; } .edit-btn:hover { background: #09b; }
    .delete-btn { background: #f00; color: #fff; } .delete-btn:hover { background: #d00; }
    .clear-attendance-btn { background: #ff9800; color: #000;} .clear-attendance-btn:hover { background: #e68900;}
    .save-note-btn { background: #0cf; color: #000; margin-top: 5px !important; } .save-note-btn:hover { background: #09b; }
    #cancel-edit-user, #cancel-edit-rehearsal { background: #666; color: #fff; } #cancel-edit-user:hover, #cancel-edit-rehearsal:hover { background: #555; }
    /* Formulario de asistencia */
    .attendance-form { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-top:5px; }
    .attendance-form select { padding: 8px; background: #222; color: #fff; border: 1px solid #333; border-radius: 4px; }
    .attendance-form button { padding: 8px 12px; background: #0cf; color: #000; border: none; border-radius: 4px; cursor: pointer; }
    .attendance-form button:hover { background: #09b; }
    .attendance-summary { margin-top: 10px; font-size: 0.9em; } .attendance-summary span { display: block; margin-bottom: 3px;}
    .attending-yes { color: #0cf; font-weight: bold;} .attending-no { color: #f00; font-weight: bold;}
    .rehearsal-duration { display: block; font-size: 0.9em; color: #aaa; margin-top: 3px;}
    /* Indicador de conexión y mensajes */
    #connection-status { position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.85); color: #fff; padding: 8px 12px; border-radius: 5px; font-size: 0.9em; z-index: 10001; display: none; border: 1px solid #555; } /* Aumentado z-index */
    #connection-status.offline { background: #c00; border-color: #f00;}
    #connection-status.retrying { background: #e68900; border-color: #ff9800;}
    #persistence-warning { 
        background-color: #f44336; color: #fff; padding: 10px; text-align: center;
        font-weight: bold; display: none; position: sticky; top:0; z-index: 10002;
    }
    .message { margin-top: 15px; text-align: center; padding: 8px; border-radius: 4px; font-weight: bold;}
    .success-message { color: #000; background-color: #0cf; }
    .error-message { color: #fff; background-color: #d32f2f; }
    /* Estadísticas */
    .stats-table { margin-bottom: 40px; } .stats-table h3 { color: #0cf; margin: 20px 0 10px; text-align: center; }
    .stats-filter { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px; }
    .stats-filter label { color: #0cf; }
    .stats-filter select { padding: 8px; background: #222; color: #fff; border: 1px solid #333; border-radius: 4px; width: auto; max-width: 220px; }
    /* Columnas específicas en tablas */
    #calendario table th:last-child, #calendario table td:last-child { text-align: center; } /* Para centrar la columna de detalles */

    /* Responsive */
    @media(max-width:768px){
      header{padding:10px 15px;} .logo img.logo-main{width:130px} .logo-intranet{height:40px} .hamburger div{width:20px}
      main section {padding: 15px;}
      #setlists h2,#rehearsals h2,#second-setlist h2, #setlist-estrella h2, #calendario h2,#usuarios h2{font-size: 1.5em;} /* Añadido #setlist-estrella h2 */
      .config-screen, .modal-screen {padding:60px 15px 15px}
      .config-screen input, .config-screen select, .config-screen textarea,
      .modal-screen input, .modal-screen select, .modal-screen textarea {padding:10px; max-width: none;}
      .config-screen button, .modal-screen button {padding:10px 18px;}
      .action-btn, .attendance-form button {width: 100%; margin-bottom: 8px;}
      .attendance-form { flex-direction: column; align-items: stretch; } .attendance-form select { width: 100%; }
      #connection-status { font-size: 0.8em; padding: 6px 10px; bottom: 5px; right: 5px;}
      table { font-size: 0.8em; } th, td { padding: 8px 6px; max-width: 100px; }
    }
  </style>
</head>
<body>
  <div id="persistence-warning">Advertencia: La persistencia de datos (modo offline) podría no funcionar. Revisa la configuración de tu navegador (cookies/almacenamiento, extensiones).</div>
  <div id="connection-status"></div>
  <header>
    <div class="logo"><img src="assets/logo_blanco.png" alt="Logo El Sótano del Doctor" class="logo-main"></div>
    <img src="assets/logointranet.png" alt="Logo Intranet" class="logo-intranet">
    <div class="hamburger" id="hamburger-btn"><div></div><div></div><div></div></div>
  </header>
  <div id="overlay"></div>
  <nav class="sidebar" id="sidebar-menu">
    <h2>Menú Principal</h2>
    <a href="#rehearsals" id="menu-rehearsals-section">Próximos Ensayos</a>
    <a href="#second-setlist" id="menu-second-setlist-section">Setlist Próximo Concierto</a> <a href="#setlist-estrella" id="menu-setlist-estrella-section">Setlist Concierto Estrella</a> <a href="#calendario" id="menu-concerts-section">Próximos Conciertos</a>
    <a href="#" id="menu-stats">Estadísticas</a>
    <a href="#" id="menu-config">Configuración</a>
    <div class="submenu" id="config-submenu" style="display: none;">
      <a href="#" id="menu-setlist-config">Setlists</a>
      <a href="#" id="menu-user-mgmt">Usuarios</a>
      <a href="#" id="menu-rehearsal">Ensayos</a>
    </div>
    <a href="#" id="menu-cerrar">Cerrar Menú</a>
  </nav>
  <div id="setlist-config-screen" class="config-screen">
    <button class="close-btn" id="close-setlist-config" title="Cerrar">&times;</button>
    <h2>Configuración de Setlists</h2>
    <h3>Setlist Próximo Ensayo</h3>
    <label for="setlist1-name">Nombre del Setlist:</label><input id="setlist1-name" placeholder="Ej: Ensayos Verano 2025">
    <label for="setlist1-url">ID/URL del feed:</label><input id="setlist1-url" placeholder="URL completa del feed JSON">
    
    <h3>Setlist Próximo Concierto</h3> <label for="setlist2-name">Nombre del Setlist:</label><input id="setlist2-name" placeholder="Ej: Concierto Sala X">
    <label for="setlist2-url">ID/URL del feed (BandHelper):</label><input id="setlist2-url" placeholder="ID del feed (ej: TXHvyb) o URL completa">

    <h3>Setlist Concierto Estrella</h3> <label for="setlist3-name">Nombre del Setlist:</label><input id="setlist3-name" placeholder="Ej: Festival Estrella">
    <label for="setlist3-url">ID/URL del feed:</label><input id="setlist3-url" placeholder="URL completa o ID de BandHelper">

    <button id="guardar-setlist-config">Guardar Configuración</button>
    <p id="setlist-message" class="message"></p>
  </div>

  <div id="user-mgmt-screen" class="config-screen">
    <button class="close-btn" id="close-user-mgmt" title="Cerrar">&times;</button>
    <h2>Gestión de Usuarios</h2>
    <label for="user-name">Nombre:</label><input id="user-name" placeholder="Nombre completo">
    <label for="user-nickname">Apodo:</label><input id="user-nickname" placeholder="Apodo corto (para tablas)">
    <label for="user-role">Roles:</label>
    <select id="user-role" multiple>
      <option value="Batería">Batería</option><option value="Teclados">Teclados</option><option value="Voz">Voz</option>
      <option value="Guitarra eléctrica">Guitarra eléctrica</option><option value="Guitarra Acústica">Guitarra Acústica</option>
      <option value="Bajo">Bajo</option><option value="Percusión">Percusión</option><option value="Saxo">Saxo</option>
      <option value="Dirección Musical">Dirección Musical</option><option value="Técnico de Sonido">Técnico de Sonido</option>
      <option value="Montador">Montador</option><option value="Coros">Coros</option>
    </select>
    <button id="add-user" class="action-btn edit-btn">Añadir Usuario</button>
    <button id="cancel-edit-user" class="action-btn delete-btn" style="display:none; background-color: #555;">Cancelar Edición</button>
    <p id="user-message" class="message"></p>
    <div class="table-wrapper">
        <table id="user-table"><thead><tr><th>Nombre</th><th>Apodo</th><th>Roles</th><th>Acciones</th></tr></thead><tbody id="user-table-body"></tbody></table>
    </div>
  </div>
  <div id="rehearsal-screen" class="config-screen">
    <button class="close-btn" id="close-rehearsal" title="Cerrar">&times;</button>
    <h2>Asignación y Gestión de Ensayos</h2>
    <label for="rehearsal-date">Fecha:</label><input type="date" id="rehearsal-date">
    <label for="rehearsal-start-time">Hora Inicio:</label><input type="time" id="rehearsal-start-time">
    <label for="rehearsal-end-time">Hora Fin:</label><input type="time" id="rehearsal-end-time">
    <label for="rehearsal-location">Lugar:</label><input id="rehearsal-location" placeholder="Ej: Local de Ensayo XYZ">
    <button id="add-rehearsal" class="action-btn edit-btn">Añadir Ensayo</button>
    <button id="cancel-edit-rehearsal" class="action-btn delete-btn" style="display:none; background-color: #555;">Cancelar Edición</button>
    <p id="rehearsal-message" class="message"></p>
    <div class="table-wrapper">
        <table id="rehearsal-table">
          <thead><tr><th>Fecha</th><th>Inicio</th><th>Fin</th><th>Lugar</th><th>Asistencias</th><th>Acciones</th></tr></thead>
          <tbody id="rehearsal-table-body"></tbody>
        </table>
    </div>
  </div>
  <div id="stats-screen" class="config-screen">
    <button class="close-btn" id="close-stats" title="Cerrar">&times;</button>
    <h2>Estadísticas de Ensayos</h2>
    <div class="stats-filter">
      <label for="stats-month-filter">Filtrar por mes:</label>
      <select id="stats-month-filter"><option value="all">Todos los meses</option></select>
    </div>
    <div class="stats-table">
      <h3>Tiempo Ensayado por Mes</h3>
      <div class="table-wrapper"><table id="time-per-month-table"><thead><tr><th>Mes</th><th>Tiempo Total (horas)</th></tr></thead><tbody id="time-per-month-body"></tbody></table></div>
    </div>
    <div class="stats-table">
      <h3>Tiempo Ensayado por Usuario (Asistido)</h3>
      <div class="table-wrapper"><table id="time-per-user-table"><thead><tr><th>Usuario</th><th>Tiempo Total (horas)</th></tr></thead><tbody id="time-per-user-body"></tbody></table></div>
    </div>
    <div class="stats-table">
      <h3>Historial de Ensayos Pasados</h3>
      <div class="table-wrapper"><table id="past-rehearsals-table"><thead><tr><th>Fecha</th><th>Horario</th><th>Lugar</th><th>Asistencias (Apodos)</th></tr></thead><tbody id="past-rehearsals-body"></tbody></table></div>
    </div>
  </div>

  <div id="concert-note-edit-modal" class="modal-screen">
    <div class="modal-content">
        <button class="close-btn" id="close-concert-note-edit-modal" title="Cerrar">&times;</button>
        <h2>Detalles del Concierto</h2>
        <p id="concert-note-info">Concierto: Cargando...</p>
        
        <label for="concert-note-location-details">Detalles Ubicación (ej. entrada, parking, camerinos):</label>
        <textarea id="concert-note-location-details" placeholder="Notas sobre la ubicación..."></textarea>

        <label for="concert-note-soundcheck-time">Hora Prueba de Sonido:</label>
        <input type="time" id="concert-note-soundcheck-time">

        <label for="concert-note-show-time">Hora del Show (confirmada/ajustada):</label>
        <input type="time" id="concert-note-show-time">
        
        <label for="concert-note-general">Notas Generales Adicionales:</label>
        <textarea id="concert-note-general" placeholder="Otras notas importantes..."></textarea>

        <h3>Músicos Asistentes al Concierto</h3>
        <div id="concert-attendance-list"><p>Cargando lista de usuarios...</p></div>
        
        <button id="save-concert-note-modal-btn">Guardar Detalles</button>
        <p id="concert-note-edit-message" class="message"></p>
    </div>
  </div>

  <main>
    <section id="setlists">
      <h2 id="setlist1-title">Setlist Ensayos</h2>
      <div class="table-wrapper"><table id="setlist-table-main"><thead><tr><th>#</th><th>Título</th><th>Tonalidad</th><th>Tempo</th><th>Duración</th></tr></thead><tbody id="setlist-body"></tbody></table></div>
      <button class="download-btn" id="download-btn">Descargar PDF</button>
      <p id="total-time"></p>
    </section>

    <section id="rehearsals">
      <h2>Próximos Ensayos</h2>
      <div class="table-wrapper"><table id="rehearsal-main-table"><thead><tr><th>Fecha y Duración</th><th>Horario</th><th>Lugar y Calendario</th><th>Confirmar Asistencia</th></tr></thead><tbody id="rehearsal-main-body"></tbody></table></div>
    </section>

    <section id="second-setlist">
      <h2 id="setlist2-title-placeholder">Setlist Próximo Concierto</h2>
      <p id="second-setlist-name"></p>
      <div class="table-wrapper"><table id="second-list-table"><thead><tr><th>#</th><th>Canción</th><th>Tonalidad</th><th>Tempo</th><th>Duración</th></tr></thead><tbody id="second-body"></tbody></table></div>
      <button class="download-btn" id="download-btn-2">Descargar PDF</button>
      <p id="total-time-2"></p>
    </section>

    <section id="setlist-estrella">
      <h2 id="setlist3-title">Setlist Concierto Estrella</h2>
      <p id="setlist3-title-display"></p> <div class="table-wrapper">
        <table id="setlist3-table">
          <thead><tr><th>#</th><th>Canción</th><th>Tonalidad</th><th>Tempo</th><th>Duración</th></tr></thead>
          <tbody id="setlist3-body"></tbody>
        </table>
      </div>
      <button class="download-btn" id="download-btn-3">Descargar PDF</button>
      <p id="total-time-3"></p>
    </section>

    <section id="calendario">
      <h2>Próximos Conciertos</h2>
      <div id="bandhelper-concerts">
        <script src="https://www.bandhelper.com/widget/calendar/10353?layout=1&range=6"></script>
      </div>
    </section>

    <section id="usuarios">
      <h2>Usuarios Registrados</h2>
      <div class="table-wrapper"><table id="users-main-table"><thead><tr><th>Nombre</th><th>Apodo</th><th>Roles</th></tr></thead><tbody id="users-body"></tbody></table></div>
    </section>
  </main>
  <footer>© 2025 El Sótano del Doctor. Todos los derechos reservados.</footer>

  <script>
  //<![CDATA[
  /* ---------- 0. Firebase ---------- */
  const firebaseConfig = {
    apiKey: "TU_API_KEY", // ¡¡¡REEMPLAZA ESTO CON TU API KEY REAL!!!
    authDomain: "sotanointranet.firebaseapp.com",
    projectId: "sotanointranet",
    storageBucket: "sotanointranet.appspot.com",
    messagingSenderId: "756955233128",
    appId: "1:756955233128:web:ab36372bdbd895a30e74dd"
  };

  let db;
  let persistencePromise;
  const persistenceWarningDiv = document.getElementById("persistence-warning");

  if (firebaseConfig.apiKey === "TU_API_KEY") {
    console.error("!!! API Key de Firebase NO CONFIGURADA !!!");
    if(persistenceWarningDiv) {
        persistenceWarningDiv.innerHTML = "<b>ERROR CRÍTICO: API Key de Firebase no configurada. La aplicación NO funcionará correctamente.</b>";
        persistenceWarningDiv.style.display = "block";
    }
  }

  try {
    if (firebase.apps.length === 0) { firebase.initializeApp(firebaseConfig); console.log("Firebase App inicializada."); }
    else { console.log("Firebase App ya inicializada."); }
    db = firebase.firestore();
    persistencePromise = db.enablePersistence({ synchronizeTabs: true })
      .then(() => { console.log("Persistencia Firestore (multi-pestaña) HABILITADA."); if(persistenceWarningDiv && firebaseConfig.apiKey !== "TU_API_KEY") persistenceWarningDiv.style.display = "none"; })
      .catch(err => {
        // Solo mostrar advertencia de persistencia si la API key ES correcta y el error NO es por ya estar habilitada
        if (err.code !== 'failed-precondition' || !err.message.includes("already active")) {
            if(persistenceWarningDiv && firebaseConfig.apiKey !== "TU_API_KEY") {
                persistenceWarningDiv.style.display = "block";
                persistenceWarningDiv.innerHTML = "Advertencia: Problema con persistencia de datos (offline): " + err.message.substring(0,100) + "... Revisa config. del navegador.";
            }
        }
        if (err.code === 'failed-precondition') {
          console.warn("Persistencia (multi) falló, intentando una sola pestaña...", err.message);
          return db.enablePersistence();
        }
        console.error("Error habilitando persistencia (multi):", err);
        throw err;
      })
      .then(() => { console.log("Intento de config. de persistencia completado."); })
      .catch(err => {
        console.error("Error final config. persistencia:", err);
        if(persistenceWarningDiv && firebaseConfig.apiKey !== "TU_API_KEY" && (err.code !== 'failed-precondition' || !err.message.includes("already active")) ) {
            persistenceWarningDiv.style.display = "block";
            persistenceWarningDiv.innerHTML = "Advertencia: La persistencia de datos (modo offline) NO está disponible: " + err.message.substring(0,100) + "...";
        }
      });
  } catch (e) {
    console.error("Error GRAVE: Firebase App no pudo inicializarse.", e);
    if(persistenceWarningDiv) {
        persistenceWarningDiv.innerHTML = "<b>Error CRÍTICO: Firebase no pudo inicializarse. Revisa la config.</b>";
        persistenceWarningDiv.style.display = "block";
    }
    persistencePromise = Promise.reject(e);
  }

  /* ---------- 1. Utilidades (sin cambios desde v7.3) ---------- */
  const parseDuration = str => { if (!str) return 0; if (str.includes(":")) { const [m, s = 0] = str.split(":").map(Number); return m * 60 + s; } const n = parseInt(str, 10); return isNaN(n) ? 0 : n; };
  const toMMSS = s => `${Math.floor(s / 60)}:${String(s % 60).padStart(2, "0")}`;
  const toHHMM = s => { const h = Math.floor(s / 3600); const m = Math.floor((s % 3600) / 60); return h ? `${h}h ${String(m).padStart(2, "0")}m` : `${m}m`; };
  const toHours = s => (s / 3600).toFixed(2);
  const clean = s => (s || "").toString().replace(/[^\x00-\xFF]/g, "").trim();
  const calculateDuration = (startTime, endTime) => { if (!startTime || !endTime) return 0; const [startH, startM] = startTime.split(":").map(Number); const [endH, endM] = endTime.split(":").map(Number); const startSeconds = startH * 3600 + startM * 60; const endSeconds = endH * 3600 + endM * 60; let duration = endSeconds - startSeconds; if (duration < 0) duration += 24 * 3600; return duration; };
  const formatDateWithDay = dateStr => { try { const date = new Date(dateStr + "T00:00:00Z"); const days = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"]; const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]; const dayName = days[date.getUTCDay()]; const day = date.getUTCDate(); const monthName = months[date.getUTCMonth()]; return `${dayName} ${day} de ${monthName}`; } catch(e) { console.warn(`Error formateando fecha '${dateStr}':`, e); return dateStr;}};
  const getMonthYear = dateStr => { try {const date = new Date(dateStr + "T00:00:00Z"); const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]; return `${months[date.getUTCMonth()]} ${date.getUTCFullYear()}`; } catch(e) { console.warn(`Error getMonthYear para '${dateStr}':`, e); return "Fecha Inválida";}};
  function generateICS(title, dateISO, startTime, location, description = "", durationSeconds = 7200) {
    console.log("generateICS - Entradas:", { title, dateISO, startTime, location, description, durationSeconds });
    const timeParts = String(startTime).match(/^(\d{1,2}):(\d{2})$/); 
    if (!timeParts) { console.error("generateICS: Formato de hora inválido o no proporcionado:", startTime); alert("Formato de hora incorrecto para evento de calendario."); return; }
    const validStartTime = `${String(timeParts[1]).padStart(2, '0')}:${timeParts[2]}`;
    try {
        const startDate = new Date(`${dateISO}T${validStartTime}:00Z`); 
        if (isNaN(startDate.getTime())) { console.error("generateICS: Fecha de inicio inválida:", startDate); alert("Fecha/hora inválida para evento de calendario."); return; }
        const endDate = new Date(startDate.getTime() + durationSeconds * 1000);
        const formatDateForICS = d => d.toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";
        const start = formatDateForICS(startDate); const end = formatDateForICS(endDate);
        const icsContent = ["BEGIN:VCALENDAR", "VERSION:2.0", "PRODID:-//ElSotanoDelDoctor//Intranet//ES", "BEGIN:VEVENT", `UID:${new Date().getTime()}@elsotanodeldoctor.com`, `DTSTAMP:${formatDateForICS(new Date())}`, `DTSTART:${start}`, `DTEND:${end}`, `SUMMARY:${clean(title)}`, `DESCRIPTION:${clean(description)}`, `LOCATION:${clean(location)}`, "END:VEVENT", "END:VCALENDAR"].join("\r\n");
        const blob = new Blob([icsContent], { type: "text/calendar;charset=utf-8" }); const url = URL.createObjectURL(blob);
        const link = document.createElement("a"); link.href = url; link.download = `${clean(title).replace(/[^\w\s]/gi, '').replace(/\s+/g, "_")}.ics`;
        document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
    } catch (e) { console.error("Error en generateICS:", e); alert("Error generando archivo de calendario."); }
  }
  function generateConcertId(date, time, location) { const locNorm = (location || "sin_lugar").toLowerCase().replace(/\s+/g, '_').replace(/[^\w-]/g, ''); const timeNorm = (time || "sin_hora").replace(":", ""); return `${date}_${timeNorm}_${locNorm}`; }

  /* ---------- 1.5. Manejo de conexión (sin cambios) ---------- */
  const connectionStatus = document.getElementById("connection-status"); let isOnline = navigator.onLine;
  function updateConnectionStatus() { isOnline = navigator.onLine; if (!isOnline) { connectionStatus.className = "offline"; connectionStatus.textContent = "Sin conexión. Mostrando datos locales."; connectionStatus.style.display = "block"; } else { connectionStatus.style.display = "none"; connectionStatus.textContent = ""; } }
  window.addEventListener("online", updateConnectionStatus); window.addEventListener("offline", updateConnectionStatus);
  async function withRetry(fn, operationName = 'operación anónima', maxRetries = 3, delay = 2000) { for (let i = 0; i < maxRetries; i++) { try { if (!isOnline && i > 0) { connectionStatus.className = "offline"; connectionStatus.textContent = `Sin conexión. Reintentando ${operationName}...`; connectionStatus.style.display = "block"; } return await fn(); } catch (e) { console.warn(`Intento ${i+1} fallido para ${operationName}:`, e); if (i === maxRetries - 1) { connectionStatus.className = "offline"; connectionStatus.textContent = `Error final en ${operationName} tras ${maxRetries} intentos.`; connectionStatus.style.display = "block"; throw e; } connectionStatus.className = "retrying"; connectionStatus.textContent = `Reintentando ${operationName} (${i + 1}/${maxRetries})...`; connectionStatus.style.display = "block"; await new Promise(resolve => setTimeout(resolve, delay)); } } }

  /* ---------- 2. Acceso Firestore (sin cambios) ---------- */
  async function loadDoc(docId, fallback = {}) { if (!db) { console.error("DB no inicializado. No se puede cargar:", docId); return fallback; } console.log(`Intentando cargar doc: ${docId}`); try { const snap = await db.collection("intranet").doc(docId).get(); if (snap.exists) { console.log(`Doc ${docId} cargado OK.`, snap.data()); return snap.data(); } else { console.warn(`Doc ${docId} NO ENCONTRADO. Usando fallback.`); return fallback; } } catch (e) { console.error(`Error FATAL al cargar doc ${docId}:`, e.message, e); throw e; } }
  async function saveDoc(docId, data) { if (!db) { console.error("DB no inicializado. No se puede guardar:", docId); return false; } console.log(`Intentando guardar doc: ${docId}`); try { await db.collection("intranet").doc(docId).set(data); console.log(`Doc ${docId} guardado OK.`); return true; } catch (e) { console.error(`Error FATAL al guardar doc ${docId}:`, e.message, e); throw e; } }

  /* ---------- SECCIONES (Setlists, Usuarios, Ensayos, etc.) ---------- */
  let setlistConfig = { 
    setlist1: { name: "Setlist Próximo Ensayo", url: "" },
    setlist2: { name: "Setlist Próximo Concierto", url: "" },
    setlist3: { name: "Setlist Concierto Estrella", url: "" }
  };
  async function loadSetlistConfig() {
    console.log("loadSetlistConfig: Iniciando...");
    const fallbackConfig = { 
        setlist1: { name: "Setlist Ensayos (Default)", url: "" },
        setlist2: { name: "Setlist Próximo Concierto (Default)", url: "" },
        setlist3: { name: "Setlist Concierto Estrella (Default)", url: "" }
    };
    let dataFromFirestore = { config: fallbackConfig }; 
    try {
        dataFromFirestore = await withRetry(() => loadDoc("setlists", {config: fallbackConfig }), "configuración de setlists");
    } catch (e) {
        console.error("Error en withRetry para loadSetlistConfig, usando fallback completo:", e);
    }
    
    const loadedConfig = dataFromFirestore.config || {};
    setlistConfig = {
        setlist1: { ...(fallbackConfig.setlist1), ...(loadedConfig.setlist1 || {}) },
        setlist2: { ...(fallbackConfig.setlist2), ...(loadedConfig.setlist2 || {}) },
        setlist3: { ...(fallbackConfig.setlist3), ...(loadedConfig.setlist3 || {}) }
    };
    updateTitles();
    console.log("loadSetlistConfig: Finalizado. Config:", JSON.parse(JSON.stringify(setlistConfig))); // Loguear copia para evitar problemas de referencia
  }
  function updateTitles() {
    try {
        document.getElementById("setlist1-title").textContent = setlistConfig.setlist1?.name || "Setlist Ensayos";
        document.getElementById("setlist2-title-placeholder").textContent = setlistConfig.setlist2?.name || "Setlist Próximo Concierto";
        document.getElementById("setlist3-title").textContent = setlistConfig.setlist3?.name || "Setlist Concierto Estrella";
        document.getElementById("setlist3-title-display").textContent = setlistConfig.setlist3?.name || "";
    } catch (e) {
        console.error("Error en updateTitles:", e, "setlistConfig era:", JSON.stringify(setlistConfig));
    }
  }
  async function saveSetlistConfig() { /* ... (Pega aquí tu función saveSetlistConfig de v7.8) ... */ }
  async function cargarPrimerSetlist() { /* ... (Pega aquí tu función cargarPrimerSetlist de v7.8) ... */ }
  async function cargarSegundoSetlist() { /* ... (Pega aquí tu función cargarSegundoSetlist de v7.8) ... */ }
  async function cargarTercerSetlist() { /* ... (Pega aquí tu función cargarTercerSetlist de v7.8) ... */ }
  
  let users = []; let editingUserIndex = null;
  function renderUsers() { /* ... (Pega aquí tu función renderUsers completa de v7.5) ... */ }
  function addUserTableListeners() { /* ... (Pega aquí tu función addUserTableListeners completa de v7.5) ... */ }
  async function loadUsers() { console.log("loadUsers: Iniciando..."); const data = await withRetry(() => loadDoc("users", {users:[]}), "carga de usuarios"); users = Array.isArray(data.users) ? data.users : []; renderUsers(); console.log("loadUsers: Finalizado. Usuarios:", users.length); }
  async function saveUsers() { /* ... (Pega aquí tu función saveUsers de v7.5) ... */ }
  function resetUserForm() { /* ... (Pega aquí tu función resetUserForm de v7.5) ... */ }

  let rehearsals = []; let editingRehearsalIndex = null;
  function renderRehearsals() { /* ... (Pega aquí tu función renderRehearsals completa de v7.5) ... */ }
  function addRehearsalTableListeners() { /* ... (Pega aquí tu función addRehearsalTableListeners completa de v7.5) ... */ }
  async function loadRehearsals() { console.log("loadRehearsals: Iniciando..."); const data = await withRetry(() => loadDoc("rehearsals", {rehearsals:[]}), "carga de ensayos"); rehearsals = Array.isArray(data.rehearsals) ? data.rehearsals : []; renderRehearsals(); console.log("loadRehearsals: Finalizado. Ensayos:", rehearsals.length); }
  async function saveRehearsals() { /* ... (Pega aquí tu función saveRehearsals de v7.5) ... */ }
  function resetRehearsalForm() { /* ... (Pega aquí tu función resetRehearsalForm de v7.5) ... */ }
  
  function updateMonthFilter() { /* ... */ } function renderStats() { /* ... */ }
  async function genPDF(songs, title, fileName) { /* ... */ }

  /* ---------- 10. Modificar tabla de BandHelper (igual a v7.5, con logs y corrección de onclick) ---------- */
  // ... Pega aquí la función modifyBandHelperTable de la v7.5 ...
  let parsedBandHelperConcerts = [];
  let bandHelperTableModified = false;
  let bandHelperWidgetLoaded = false; 
  function modifyBandHelperTable() {
    console.log("modifyBandHelperTable: Iniciando...");
    const bandHelperContentDiv = document.getElementById("bandhelper-concerts");
    if (!bandHelperContentDiv) { console.error("Div #bandhelper-concerts no encontrado."); return false; }
    const table = bandHelperContentDiv.querySelector("table");
    if (!table) { console.warn("modifyBandHelperTable: Tabla de BandHelper NO encontrada."); bandHelperWidgetLoaded = true; return false; }
    console.log("modifyBandHelperTable: Tabla encontrada:", table);

    if (table.dataset.processedByIntranet === "true" && bandHelperTableModified) { console.log("modifyBandHelperTable: Tabla ya procesada. Saltando."); return true; }
    parsedBandHelperConcerts = [];

    let head = table.querySelector("thead");
    if (!head) {
        console.warn("modifyBandHelperTable: No se encontró <thead>. Creando uno.");
        head = document.createElement("thead");
        table.insertBefore(head, table.firstChild); 
    }
    let headerRow = head.querySelector("tr");
    if (!headerRow) {
        console.warn("modifyBandHelperTable: No se encontró <tr> en <thead>. Creando uno.");
        headerRow = document.createElement("tr");
        head.appendChild(headerRow);
    }

    if (!headerRow.querySelector("th.th-details")) {
        const firstBodyRow = table.querySelector("tbody tr");
        let existingHeadersCount = headerRow.querySelectorAll("th").length;
        if (existingHeadersCount === 0 && firstBodyRow) { 
            existingHeadersCount = firstBodyRow.querySelectorAll("td").length;
        }
        if (headerRow.children.length === 0 && existingHeadersCount >=3) { 
             headerRow.innerHTML = '<th>Fecha</th><th>Hora</th><th>Lugar</th>'; 
        }
        headerRow.insertAdjacentHTML("beforeend", '<th class="th-details" style="text-align:center;">Detalles</th>');
        console.log("modifyBandHelperTable: Cabecera 'Detalles' AÑADIDA.");
    } else {
        console.log("modifyBandHelperTable: Cabecera 'Detalles' ya existe.");
    }

    const rows = table.querySelectorAll("tbody tr");
    console.log("modifyBandHelperTable: Filas encontradas en tbody:", rows.length);
    if (rows.length === 0) { console.log("modifyBandHelperTable: No hay conciertos listados."); }
    else {
        rows.forEach((row, rowIndex) => {
          const cells = row.querySelectorAll("td");
          if (cells.length < 3) { console.warn(`Fila #${rowIndex} con celdas insuficientes: ${cells.length}`); return; }

          const dateCellText = cells[0].textContent.trim();
          const timeCellText = cells[1].textContent.trim();
          const locationCell = cells[2];
          const locationText = locationCell.textContent.trim() || "Lugar no especificado";

          const dateParts = dateCellText.match(/(\d{1,2})\/(\d{1,2})\/(\d{2,4})/);
          if (!dateParts) { console.warn(`Fila #${rowIndex}: Formato de fecha no reconocido: '${dateCellText}'`); return; }
          let day = parseInt(dateParts[1]), month = parseInt(dateParts[2]) - 1, year = parseInt(dateParts[3]);
          if (year < 100) year += 2000;
          const concertDateObj = new Date(Date.UTC(year, month, day)); 
          const dateISO = concertDateObj.toISOString().split('T')[0];
          
          let time24h = "20:00"; 
          const timeMatch = timeCellText.match(/(\d{1,2}:\d{2})/); 
          if (timeMatch) {
              time24h = timeMatch[1];
          } else {
              console.warn(`Fila #${rowIndex}: Formato de hora no reconocido en '${timeCellText}', usando default ${time24h}`);
          }

          const concertId = generateConcertId(dateISO, time24h, locationText);
          parsedBandHelperConcerts.push({ id: concertId, date: dateISO, time: time24h, location: locationText, displayDate: dateCellText });

          if (!locationCell.querySelector("button.calendar-btn")) {
            const calendarButtonHTML = `<button class="calendar-btn" title="Añadir a mi calendario" onclick='generateICS("Concierto: ${clean(locationText)}", "${dateISO}", "${time24h}", "${clean(locationText)}")'><svg viewBox="0 0 24 24"><path d="M12 4V2m0 20v-2m8-8h2m-20 0h-2m15.071-3.071l-1.414-1.414M5.343 17.657l-1.414-1.414m0-10.486l1.414-1.414m12.728 12.728l-1.414 1.414"/><rect x="4" y="6" width="16" height="12" rx="2"/></svg></button>`;
            if (!locationCell.innerHTML.includes('calendar-btn')) { locationCell.innerHTML += calendarButtonHTML; }
          }

          let detailsCell = row.querySelector("td.td-details");
          if (!detailsCell) {
            detailsCell = document.createElement("td");
            detailsCell.classList.add("td-details");
            detailsCell.style.textAlign = "center";
            if (row.children.length > cells.length) row.appendChild(detailsCell); 
            else row.appendChild(detailsCell);
          }
          if (!detailsCell.querySelector("button.details-btn")) {
              detailsCell.innerHTML = `<button class="details-btn" title="Ver/Editar Detalles" onclick="openConcertNoteModal('${concertId}')"><svg viewBox="0 0 24 24"><path d="M8.59,16.59L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.59Z" /></svg></button>`;
          }
        });
    }
    console.log("modifyBandHelperTable: Conciertos parseados:", parsedBandHelperConcerts.length);
    bandHelperTableModified = true; table.dataset.processedByIntranet = "true"; bandHelperWidgetLoaded = true;
    console.log("modifyBandHelperTable: Finalizada.");
    return true;
  }

  /* ---------- 10.5. Notas de Concierto y Modal (igual a v7.2) ---------- */
  // ... Pega aquí loadConcertNotes, saveConcertNotes, openConcertNoteModal y los listeners del modal de la v7.2 ...
  let concertNotes = {}; 
  let currentEditingConcertId = null;
  async function loadConcertNotes() {
    console.log("loadConcertNotes: Iniciando...");
    const data = await withRetry(() => loadDoc("concert_notes_store", { notes: {} }), "carga de notas de concierto");
    concertNotes = data.notes || {}; 
    console.log("loadConcertNotes: Finalizado. Notas:", concertNotes);
  }
  async function saveConcertNotes() {
    console.log("Guardando notas de conciertos...", concertNotes);
    try {
      await withRetry(() => saveDoc("concert_notes_store", { notes: concertNotes }), "guardar notas de concierto");
      return true;
    } catch (e) {
      console.error("Error al guardar notas:", e);
      const msgEl = document.getElementById("concert-note-edit-message");
      if(msgEl){ msgEl.className = "message error-message"; msgEl.textContent = "Error al guardar: " + e.message;}
      throw e;
    }
  }
  function openConcertNoteModal(concertId) {
    console.log("openConcertNoteModal para concertId:", concertId);
    currentEditingConcertId = concertId;
    const concertDataFromWidget = parsedBandHelperConcerts.find(c => c.id === concertId);
    const existingNoteData = concertNotes[concertId] || { attendees: [] }; 

    const modal = document.getElementById("concert-note-edit-modal");
    const infoEl = document.getElementById("concert-note-info");
    const locationDetailsTextarea = document.getElementById("concert-note-location-details");
    const soundcheckTimeInput = document.getElementById("concert-note-soundcheck-time");
    const showTimeInput = document.getElementById("concert-note-show-time");
    const generalNoteTextarea = document.getElementById("concert-note-general");
    const messageEl = document.getElementById("concert-note-edit-message");
    const concertAttendanceListDiv = document.getElementById("concert-attendance-list");

    if (!modal || !infoEl || !locationDetailsTextarea || !soundcheckTimeInput || !showTimeInput || !generalNoteTextarea || !messageEl || !concertAttendanceListDiv) {
        console.error("Elementos del modal de notas no encontrados.");
        return;
    }
    messageEl.textContent = "";
    concertAttendanceListDiv.innerHTML = ""; 

    if (concertDataFromWidget) {
        infoEl.textContent = `Concierto: ${concertDataFromWidget.displayDate} en ${concertDataFromWidget.location} (Hora original: ${concertDataFromWidget.time})`;
    } else {
        console.warn("No se encontró información del concierto (widget) para el ID:", concertId);
        infoEl.textContent = "Información del concierto (widget) no disponible.";
    }
    
    locationDetailsTextarea.value = existingNoteData.locationUserNotes || "";
    soundcheckTimeInput.value = existingNoteData.soundcheckTime || "";
    showTimeInput.value = existingNoteData.showTimeUser || (concertDataFromWidget ? concertDataFromWidget.time : "") || ""; 
    generalNoteTextarea.value = existingNoteData.generalNote || "";

    if (users.length > 0) {
        users.forEach(user => {
            const isChecked = (existingNoteData.attendees || []).includes(user.name); 
            const userHtml = `
                <div>
                    <input type="checkbox" id="user-att-${user.name.replace(/\s+/g, '-')}" name="concertAttendees" value="${user.name}" ${isChecked ? 'checked' : ''}>
                    <label for="user-att-${user.name.replace(/\s+/g, '-')}">${user.name} (${user.nickname || 'N/A'})</label>
                </div>`;
            concertAttendanceListDiv.insertAdjacentHTML("beforeend", userHtml);
        });
    } else {
        concertAttendanceListDiv.innerHTML = "<p>No hay usuarios registrados para listar.</p>";
    }

    modal.style.display = "block";
    overlay.classList.add("show");
  }
  document.getElementById("close-concert-note-edit-modal").onclick = () => {
    document.getElementById("concert-note-edit-modal").style.display = "none";
    overlay.classList.remove("show");
    currentEditingConcertId = null;
  };
  document.getElementById("save-concert-note-modal-btn").onclick = async () => {
    if (!currentEditingConcertId) { console.error("No hay concertId para guardar la nota."); return; }
    
    const attendingUsers = [];
    document.querySelectorAll('#concert-attendance-list input[type="checkbox"]:checked').forEach(checkbox => {
        attendingUsers.push(checkbox.value);
    });

    const noteDetails = {
        locationUserNotes: document.getElementById("concert-note-location-details").value.trim(),
        soundcheckTime: document.getElementById("concert-note-soundcheck-time").value,
        showTimeUser: document.getElementById("concert-note-show-time").value,
        generalNote: document.getElementById("concert-note-general").value.trim(),
        attendees: attendingUsers 
    };
    
    concertNotes[currentEditingConcertId] = noteDetails;
    const messageEl = document.getElementById("concert-note-edit-message");
    messageEl.className = "message retrying"; messageEl.textContent = "Guardando detalles...";
    try {
        await saveConcertNotes();
        messageEl.className = "message success-message"; messageEl.textContent = "¡Detalles guardados!";
        setTimeout(() => { messageEl.textContent = ""; }, 2500);
    } catch (e) { console.error("Fallo al guardar detalles desde modal:", e); }
  };

  /* ---------- 11. Menú & pantallas (igual a v7.2, sin config de notas) ---------- */
  // ... Pega aquí el código de menú y pantallas de la v7.2 ...
  const sidebar = document.getElementById("sidebar-menu"), overlay = document.getElementById("overlay");
  const PASSWORD = "Sotano2014"; let isAuthenticated = false;
  function closeAllScreens() { document.querySelectorAll(".config-screen, .modal-screen").forEach(s => s.style.display = "none"); } 
  function closeSidebarAndOverlay() { sidebar.classList.remove("show"); overlay.classList.remove("show"); document.getElementById("config-submenu").style.display = "none"; }
  function closeAll() { closeAllScreens(); closeSidebarAndOverlay(); resetUserForm(); resetRehearsalForm(); }
  document.getElementById("hamburger-btn").onclick = () => { sidebar.classList.add("show"); overlay.classList.add("show"); };
  document.getElementById("menu-cerrar").onclick = e => { e.preventDefault(); closeAll(); };
  overlay.onclick = () => { closeAllScreens(); closeSidebarAndOverlay(); };
  ['menu-rehearsals-section', 'menu-second-setlist-section', 'menu-setlist-estrella-section', 'menu-concerts-section'].forEach(id => { // Añadido menu-setlist-estrella-section
    const element = document.getElementById(id);
    if (element) {
        element.onclick = e => { 
            e.preventDefault(); 
            closeAll(); 
            const targetId = e.target.getAttribute('href').substring(1); 
            document.getElementById(targetId)?.scrollIntoView({ behavior: "smooth" }); 
        };
    } else {
        console.warn("Elemento de menú no encontrado:", id);
    }
  });
  document.getElementById("menu-config").onclick = e => { e.preventDefault(); if (!isAuthenticated) { const pass = prompt("Contraseña para Configuración:"); if (pass === PASSWORD) { isAuthenticated = true; } else { alert("Contraseña incorrecta."); return; } } document.getElementById("config-submenu").style.display = document.getElementById("config-submenu").style.display === "block" ? "none" : "block"; };
  function openConfigScreen(screenId, loadDataFn) { if (!isAuthenticated) { alert("Acceso denegado."); return; } closeAllScreens(); document.getElementById(screenId).style.display = "block"; overlay.classList.add("show"); if (loadDataFn) loadDataFn(); }
  document.getElementById("menu-setlist-config").onclick = e => { e.preventDefault(); openConfigScreen("setlist-config-screen", () => { 
    document.getElementById("setlist1-name").value = setlistConfig.setlist1.name; 
    document.getElementById("setlist1-url").value = setlistConfig.setlist1.url; 
    document.getElementById("setlist2-name").value = setlistConfig.setlist2.name; 
    document.getElementById("setlist2-url").value = setlistConfig.setlist2.url.replace("https://www.bandhelper.com/feed/set_list/", ""); 
    document.getElementById("setlist3-name").value = setlistConfig.setlist3.name; // NUEVO
    document.getElementById("setlist3-url").value = setlistConfig.setlist3.url; // NUEVO
  });};
  document.getElementById("close-setlist-config").onclick = () => { document.getElementById("setlist-config-screen").style.display = "none"; overlay.classList.remove("show"); document.getElementById("setlist-message").textContent = ""; };
  // MODIFICADO: Guardar config de setlists
  document.getElementById("guardar-setlist-config").onclick = async () => {
    const msg = document.getElementById("setlist-message"); msg.textContent = "";
    setlistConfig.setlist1.name = document.getElementById("setlist1-name").value.trim();
    setlistConfig.setlist1.url = document.getElementById("setlist1-url").value.trim();
    setlistConfig.setlist2.name = document.getElementById("setlist2-name").value.trim();
    const rawSetlist2Url = document.getElementById("setlist2-url").value.trim();
    setlistConfig.setlist2.url = rawSetlist2Url.startsWith("http") ? rawSetlist2Url : `https://www.bandhelper.com/feed/set_list/${rawSetlist2Url}`;
    setlistConfig.setlist3.name = document.getElementById("setlist3-name").value.trim(); // NUEVO
    setlistConfig.setlist3.url = document.getElementById("setlist3-url").value.trim(); // NUEVO

    if (!setlistConfig.setlist1.name || !setlistConfig.setlist1.url || !setlistConfig.setlist2.name || !rawSetlist2Url || !setlistConfig.setlist3.name /* No requerir URL para setlist3 opcionalmente */) {
        msg.className = "message error-message"; msg.textContent = "Completa todos los campos obligatorios (nombre y URL para setlist 1 y 2)."; return;
    }
    try {
        await saveSetlistConfig();
        await Promise.all([cargarPrimerSetlist(), cargarSegundoSetlist(), cargarTercerSetlist()]); // Añadir tercer setlist
        msg.className = "message success-message"; msg.textContent = "Configuración guardada.";
        setTimeout(() => { document.getElementById("setlist-config-screen").style.display = "none"; overlay.classList.remove("show"); msg.textContent = "";}, 1500);
    } catch (e) { msg.className = "message error-message"; msg.textContent = "Error al guardar: " + e.message; }
  };
  document.getElementById("menu-user-mgmt").onclick = e => { e.preventDefault(); openConfigScreen("user-mgmt-screen"); };
  document.getElementById("menu-rehearsal").onclick = e => { e.preventDefault(); openConfigScreen("rehearsal-screen"); };
  document.getElementById("menu-stats").onclick = e => { e.preventDefault(); openConfigScreen("stats-screen", () => { updateMonthFilter(); renderStats(); }); };
  document.getElementById("close-user-mgmt").onclick = () => { document.getElementById("user-mgmt-screen").style.display = "none"; overlay.classList.remove("show"); resetUserForm(); document.getElementById("user-message").textContent = "";};
  document.getElementById("close-rehearsal").onclick = () => { document.getElementById("rehearsal-screen").style.display = "none"; overlay.classList.remove("show"); resetRehearsalForm(); document.getElementById("rehearsal-message").textContent = "";};
  document.getElementById("close-stats").onclick = () => { document.getElementById("stats-screen").style.display = "none"; overlay.classList.remove("show"); };

  /* ---------- 12. Carga inicial de datos y DOMContentLoaded (igual a v7.2) ---------- */
  // ... Pega aquí la función loadInitialData y el listener DOMContentLoaded de la v7.2 ...
  async function loadInitialData() {
    console.log("loadInitialData: Iniciando...");
    if (!db) { console.warn("loadInitialData: DB no inicializado. Abortando carga de datos de Firestore."); return; }
    const statusDiv = document.getElementById("connection-status");
    try {
      if(statusDiv) { statusDiv.textContent = "Cargando datos..."; statusDiv.className = "retrying"; statusDiv.style.display = "block"; }
      await Promise.all([ loadSetlistConfig(), loadUsers(), loadRehearsals(), loadConcertNotes() ]);
      console.log("loadInitialData: Cargas de Firestore completadas.");
      
      let songs1 = [], songs2 = [], songs3 = []; // Añadir songs3
      try { songs1 = await cargarPrimerSetlist(); } catch (e) { console.error("Fallo al cargar primer setlist:", e); }
      try { songs2 = await cargarSegundoSetlist(); } catch (e) { console.error("Fallo al cargar segundo setlist:", e); }
      try { songs3 = await cargarTercerSetlist(); } catch (e) { console.error("Fallo al cargar tercer setlist:", e); } // NUEVO

      document.getElementById("download-btn").onclick = () => { if (songs1.length > 0) genPDF(songs1, setlistConfig.setlist1.name, "setlist_ensayos.pdf"); else alert("No hay canciones en Setlist Ensayos."); };
      document.getElementById("download-btn-2").onclick = () => { if (songs2.length > 0) genPDF(songs2, setlistConfig.setlist2.name, "setlist_proximo_concierto.pdf"); else alert("No hay canciones en Setlist Próximo Concierto."); };
      document.getElementById("download-btn-3").onclick = () => { if (songs3.length > 0) genPDF(songs3, setlistConfig.setlist3.name, "setlist_concierto_estrella.pdf"); else alert("No hay canciones en Setlist Concierto Estrella."); }; // NUEVO
      
      if(statusDiv) statusDiv.style.display = "none";
    } catch (e) {
      console.error("loadInitialData: Error crítico durante la carga de datos:", e);
      if(statusDiv) { statusDiv.textContent = "Error al cargar datos. Recarga la página."; statusDiv.className = "offline"; statusDiv.style.display = "block"; }
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    console.log("DOMContentLoaded: Evento disparado.");
    updateConnectionStatus();
    if (persistencePromise) {
        persistencePromise.finally(() => {
            console.log("DOMContentLoaded: Promesa de persistencia finalizada. Cargando datos iniciales.");
            loadInitialData();
        });
    } else if (db) {
        console.warn("DOMContentLoaded: persistencePromise no definida, pero db existe. Cargando datos iniciales.");
        loadInitialData();
    } else {
        console.error("DOMContentLoaded: Firebase (db) no está disponible. No se cargarán datos iniciales.");
    }

    const bandHelperContainer = document.getElementById("bandhelper-concerts");
    if (bandHelperContainer) {
        console.log("DOMContentLoaded: Configurando MutationObserver para BandHelper.");
        const observer = new MutationObserver(() => {
            const table = bandHelperContainer.querySelector("table");
            if (table && (!bandHelperTableModified || table.dataset.processedByIntranet !== "true")) {
                console.log("MutationObserver: Tabla BandHelper detectada/cambiada. Intentando modificar...");
                if(modifyBandHelperTable()) { console.log("MutationObserver: Tabla BandHelper modificada."); }
            }
        });
        observer.observe(bandHelperContainer, { childList: true, subtree: true });
    } else { console.error("DOMContentLoaded: Contenedor #bandhelper-concerts NO ENCONTRADO."); }

    setTimeout(() => { if (!bandHelperTableModified) { console.warn("DOMContentLoaded (Fallback 3s): BandHelper no modificado. Intentando..."); modifyBandHelperTable(); }}, 3000);
    setTimeout(() => { if (!bandHelperTableModified) { console.warn("DOMContentLoaded (Fallback 7s): BandHelper AÚN no modificado. ÚLTIMO intento."); modifyBandHelperTable(); }}, 7000);
    console.log("DOMContentLoaded: Configuración finalizada.");
  });
  //]]>
  </script>
</body>
</html>
