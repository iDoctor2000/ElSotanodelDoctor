<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>El Sótano del Doctor – Intranet</title>

  <link rel="icon" type="image/x-icon" href="assets/favicon_ElSotanoDr.ico">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">

  <meta property="og:title"        content="El Sótano del Doctor – Intranet">
  <meta property="og:description"  content="Banda de rock y versiones. Explora nuestro setlist, fechas de conciertos y más.">
  <meta property="og:image"        content="assets/logo_negro copia.jpg">
  <meta property="og:type"         content="website">
  <meta property="og:url"          content="https://tusitioweb.com">
  <meta name="twitter:card"        content="summary_large_image">
  <meta name="twitter:title"       content="El Sótano del Doctor – Intranet">
  <meta name="twitter:description" content="Banda de rock y versiones. Explora nuestro setlist, fechas de conciertos y mucho más. ¡Disfruta de la música!">
  <meta name="twitter:image"       content="assets/logo_negro copia.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;padding:0;overflow-x:hidden;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff}
    
    /* ---------- Splash Screen ---------- */
    #splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: #000000; /* Fondo negro */
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 200000; 
      opacity: 1;
      visibility: visible;
      transition: opacity 0.8s ease-out, transform 0.8s ease-out, visibility 0.8s linear; 
      transform: scale(1);
    }

    #splash-screen img {
      max-width: 60%; 
      max-height: 60%; 
      opacity: 0;
      transform: scale(0.85) translateY(15px); 
      animation: splash-image-entry 0.45s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    @keyframes splash-image-entry {
      to {
        opacity: 1;
        transform: scale(1) translateY(0); 
      }
    }

    #splash-screen.hidden {
      opacity: 0;
      transform: scale(0.95); 
      visibility: hidden;
      pointer-events: none; 
    }
    /* ---------- End Splash Screen ---------- */

    header{
        background:#111;
        padding:10px 20px;  
        display:flex;
        align-items:center;
        justify-content:space-between;
        position:fixed;  
        top:0;
        left:0;
        width:100%;
        z-index:1000;  
        border-bottom: 1px solid #222;  
        height: 60px;  
    }
    .logo img.logo-main{
        width: 135px;  
        height:auto;
        vertical-align: middle;  
    }
    .logo-intranet{
        position:absolute;
        left:50%;
        top:50%;  
        transform:translate(-50%,-50%);
        height:45px;  
        width:auto;
    }

    .header-controls-right { 
        display: flex;
        align-items: center;
    }

    .header-audio-control { 
        background: none;
        border: 1px solid #0cf; 
        color: #0cf;            
        border-radius: 4px;
        padding: 5px;          
        margin-right: 15px;    
        cursor: pointer;
        display: flex; /* JS lo cambia de 'none' a 'flex' cuando está listo */
        align-items: center;
        justify-content: center;
        width: 37px; 
        height: 37px; 
        transition: background-color 0.2s ease, transform 0.2s ease;
    }
    .header-audio-control:hover {
        background: #333; 
        transform: scale(1.05);
    }
    .header-audio-control svg {
        width: 20px; 
        height: 20px;
    }

    .hamburger{
        cursor:pointer;
        border:1px solid #0cf;
        border-radius:4px;
        padding:5px;
        display: flex; 
        flex-direction: column;
        justify-content: space-around;
        width: 37px; 
        height: 37px; 
        box-sizing: border-box;
    }
    .hamburger div{width:25px;height:3px;background:#0cf;margin:0 auto;} 
    
    .sidebar{
        position:fixed;
        top:0;  
        left:0;
        width:280px;  
        height:100vh;  
        background:#1a1a1a;  
        border-right:1px solid #222;
        padding: 20px;
        padding-top: calc(60px + 20px);  
        box-shadow:3px 0 15px rgba(0,200,200,.15);  
        transform:translateX(-100%);  
        transition:transform .3s ease-in-out;
        z-index:9999;  
        overflow-y: auto;
    }
    .sidebar.show{
        transform:translateX(0);  
    }
    .sidebar h2{color:#0cf;margin:0 0 20px 0;}
    .sidebar a{display:block;color:#fff;text-decoration:none;margin:12px 0;padding:10px 5px;border-bottom:1px solid #333; font-size: 1em;}
    .sidebar a:last-of-type { border-bottom: none; }
    .sidebar a:hover{color:#0cf}
    .sidebar .submenu { margin-left: 15px; margin-top: 10px; }
    .sidebar .submenu a { padding: 8px 0; font-size: 0.9em; border-top: 1px solid #2a2a2a; border-bottom: none; margin: 5px 0;}
    .sidebar a#menu-config { color: #FFD700; font-weight: bold; margin-top:15px; }  
    .sidebar a#menu-config:hover { color: #fff2a7; }
    
    #overlay{
        position:fixed;top:0;left:0;width:100%;height:100%;
        background:rgba(0,0,0,.75);  
        z-index:5000;  
        display:none;
        opacity: 0;
        transition: opacity .3s ease-in-out;
    }
    #overlay.show{display:block; opacity: 1;}
    
    main {
        padding-top: 75px;  
    }

    .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; justify-content: center; align-items: center; padding: 10px; }
    .modal-backdrop.show { display: flex; }
    .modal-content { background: #1a1a1a; color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,255,255,0.2); width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; position: relative; }
    .modal-content h3 { color: #0cf; margin-top: 0; margin-bottom: 5px; }  
    .modal-content h4 { color: #0cf; margin-top: 15px; margin-bottom: 10px; }
    #concert-detail-title-display { color: #fff; font-size: 1em; font-weight: normal; margin-top: 0px; margin-bottom: 20px; text-align: left; border-bottom: 1px solid #333; padding-bottom: 10px; padding-left: 0px; }
    #concert-detail-title-display .concert-date { font-style: italic; font-size: 0.9em; margin-left: 8px; }
    .modal-content label { display: block; margin: 10px 0 5px; color: #0cf; font-weight: bold; }
    .modal-content input[type="text"], .modal-content input[type="url"], .modal-content input[type="time"], .modal-content textarea { width: 100%; padding: 10px; background: #222; color: #fff; border: 1px solid #333; border-radius: 5px; margin-bottom: 15px; }
    .modal-content textarea { min-height: 80px; resize: vertical; }
    .modal-content button { padding: 10px 15px; background: #0cf; color: #000; border: none; border-radius: 8px; cursor: pointer; margin-right: 10px; margin-top: 10px; }
    .modal-content button:hover { background: #09b; }
    .modal-content .modal-close-btn { background: #444; color: #fff; }
    .modal-content .modal-close-btn:hover { background: #555; }
    #musicians-attendance-list { border: 1px solid #333; padding: 10px; margin-bottom:15px; }
    #musicians-attendance-list div { margin-bottom: 8px; display: flex; align-items: center; }
    #musicians-attendance-list label { color: #fff; margin-left: 8px; font-weight: normal; cursor: pointer; }
    #musicians-attendance-list input[type="checkbox"] { vertical-align: middle; width: 18px; height: 18px; cursor: pointer; }
    .modal-field-group { display: flex; gap: 15px; flex-wrap: wrap; }
    .modal-field-group > div { flex: 1; min-width: 200px; }
    .modal-field-group input[type="time"] { text-align: left; }

    .config-screen{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#000; z-index:10001; overflow-y:auto; padding: 20px; padding-top: calc(60px + 20px); }
    .config-screen h2{color:#0cf;text-align:center;margin:10px 0 20px;}  
    .config-screen h3{color:#0cf;margin:20px 0 10px}
    .config-screen label{display:block;margin:10px 0 5px}
    .config-screen input,.config-screen select{width:100%;max-width:400px;padding:10px;background:#222;color:#fff; border:1px solid #333;border-radius:5px}
    .config-screen select[multiple] { height: 150px; }
    .config-screen button{margin-top:30px;padding:10px 20px;background:#0cf;color:#000;border:none;border-radius:8px;cursor:pointer}
    .config-screen button:hover{background:#09b}
    .config-screen .close-btn{ position:absolute; top:15px; right:20px; font-size:1.2em;background:none;border:1px solid #0cf; color:#0cf;border-radius:4px;padding:5px 10px;cursor:pointer; z-index: 10002; }
    .config-screen .close-btn:hover{background:#333}
    main section{max-width:1200px;margin:0 auto;padding:20px}
    #setlists, #star-setlist, #rehearsals, #second-setlist, #calendario { background:#111;padding:20px;border-radius:10px;box-shadow:0 0 20px rgba(0,255,255,.1);margin-bottom:40px }
    #setlists h2, #star-setlist h2, #rehearsals h2, #second-setlist h2, #calendario h2 { text-align:center;color:#0cf;margin-bottom:5px }
    .setlist-dynamic-name { text-align:center;color:#aaa;margin-top:0px; margin-bottom:15px; font-style:italic; font-size: 0.9em; }
    .table-wrapper { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; display: flex; justify-content: center; }
    table { width: 100%; max-width: 100%; border-collapse: collapse; margin-top: 20px; color: #fff; font-size: .95em; margin-left: auto; margin-right: auto; }
    thead{background:#222;color:#0cf}
    th,td{padding:12px;border:1px solid #333;text-align:left;white-space: normal; word-wrap: break-word;}
    #setlists table th:nth-child(3), #setlists table th:nth-child(4), #setlists table th:nth-child(5), #second-setlist table th:nth-child(3), #second-setlist table th:nth-child(4), #second-setlist table th:nth-child(5), #star-setlist table th:nth-child(3), #star-setlist table th:nth-child(4), #star-setlist table th:nth-child(5) { text-align: center; }
    #setlists table td:nth-child(3), #setlists table td:nth-child(4), #setlists table td:nth-child(5), #second-setlist table td:nth-child(3), #second-setlist table td:nth-child(4), #second-setlist table td:nth-child(5), #star-setlist table td:nth-child(3), #star-setlist table td:nth-child(4), #star-setlist table td:nth-child(5) { text-align: center; }
    .break-row td { font-style: italic; color: #ccc; background-color: #161616; }
    .break-row td:first-child { color: #777; text-align: center; }
    .break-row td:nth-child(3), .break-row td:nth-child(4), .break-row td:nth-child(5) { text-align: center; }
    .set-header-row td { font-weight: bold; text-align: center; background-color: #383838; color: #0cf; padding-top: 12px; padding-bottom: 12px; border-top: 1px solid #505050 !important; border-bottom: 1px solid #505050 !important; }
    th.calendar-col-header, td.calendar-col { width: 50px; text-align: center; padding-left: 5px; padding-right: 5px; }
    th.details-col-header { width: 50px; text-align: center; padding-left: 5px; padding-right: 5px; }
    tr:nth-child(even):not(.set-header-row):not(.break-row){background:#1a1a1a}
    .download-btn{display:inline-block;margin:20px 5px 0;padding:10px 20px;font-size:1em;background:#0cf;color:#000;border:none;border-radius:8px;cursor:pointer}
    .download-btn:hover{background:#09b}
    #total-time, #total-time-star, #total-time-2{color:#0cf;margin-top:10px;text-align:center}
    footer{background:#111;color:#888;text-align:center;padding:10px;border-top:1px solid #222}
    .calendar-btn, .details-btn { background: none; border: none; cursor: pointer; padding: 5px; margin-left: 0; vertical-align: middle; }
    .calendar-btn svg { fill: #0cf; width: 20px; height: 20px; }
    .calendar-btn:hover svg { fill: #09b; }
    .details-btn { font-size: 1.5em; color: #0cf; }
    .details-btn:hover { color: #09b; }
    .delete-user, .edit-user, .delete-rehearsal, .clear-attendance, .edit-rehearsal { padding: 5px 10px; margin: 0 5px; background: #f00; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    .edit-user, .edit-rehearsal { background: #0cf; color: #000; }
    .clear-attendance { background: #ff9800; }
    .delete-user:hover, .delete-rehearsal:hover { background: #d00; }
    .edit-user:hover, .edit-rehearsal:hover { background: #09b; }
    .clear-attendance:hover { background: #e68900; }
    #cancel-edit-user, #cancel-edit-rehearsal { background: #666; color: #fff; }
    #cancel-edit-user:hover, #cancel-edit-rehearsal:hover { background: #555; }
    .attendance-form { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .attendance-form select { padding: 5px; background: #222; color: #fff; border: 1px solid #333; border-radius: 4px; }
    .attendance-form button { padding: 5px 10px; background: #0cf; color: #000; border: none; border-radius: 4px; cursor: pointer; }
    .attendance-form button:hover { background: #09b; }
    .attendance-summary { margin-top: 10px; font-size: 0.9em; }
    .attendance-summary span { display: block; }
    .attending-yes { color: #0cf; }
    .attending-no { color: #f00; }
    .rehearsal-duration { display: block; font-size: 0.9em; color: #aaa; }
    #connection-status { position: fixed; top: calc(60px + 5px); right: 10px; background: rgba(0, 0, 0, 0.8); color: #fff; padding: 5px 10px; border-radius: 5px; font-size: 0.9em; z-index: 10000; display: none; }
    #connection-status.offline { background: #f00; }
    #connection-status.retrying { background: #ff9800; }
    .success-message { color: #0cf; margin-top: 10px; text-align: center; }
    .error-message { color: #f00; margin-top: 10px; text-align: center; }
    .stats-table { margin-bottom: 40px; }
    .stats-table h3 { color: #0cf; margin: 20px 0 10px; text-align: center; }
    .stats-filter { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px; }
    .stats-filter label { color: #0cf; }
    .stats-filter select { padding: 5px; background: #222; color: #fff; border: 1px solid #333; border-radius: 4px; width: auto; max-width: 200px; }
    #firebase-critical-error-banner { background-color: red; color: white; padding: 15px; text-align: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 100001; font-weight: bold; }

    @media(max-width:768px){
      header { height: 55px; padding: 8px 15px; }  
      .logo img.logo-main{ width: 110px; }
      .logo-intranet{height:35px}
      .hamburger div{width:20px}
      .header-audio-control { margin-right: 10px; width: 35px; height: 35px; }
      .header-audio-control svg { width: 18px; height: 18px; }
      .hamburger { width: 35px; height: 35px; }
      .hamburger div{width:20px;}
      .sidebar{ width:260px; padding-top: calc(55px + 15px); }
      main { padding-top: 65px; }
      .config-screen { padding-top: calc(55px + 15px); }
      .config-screen .close-btn{ top:10px; right:15px; }
      #connection-status { top: calc(55px + 5px); right: 5px; font-size: 0.8em; }
      .attendance-form { flex-direction: column; align-items: flex-start; }
      .attendance-form select { width: 100%; }
      .delete-rehearsal, .clear-attendance, .edit-rehearsal { display: block; margin: 5px 0; width: 100%; }
      .table-wrapper { overflow-x: hidden; }  
      table { width: 100%; min-width: unset; font-size: 0.85em; }
      th, td { padding: 8px; white-space: normal; word-wrap: break-word; max-width: 150px; }
      th.calendar-col-header, td.calendar-col, th.details-col-header { width: 40px; padding: 8px 2px;}  
      #second-setlist .table-wrapper table, #star-setlist .table-wrapper table { min-width: unset; }
      .stats-table table { font-size: 0.85em; }
      .modal-content { width: 95%; padding: 15px; }  
      .modal-field-group { flex-direction: column; }  
    }
  </style>
</head>

<body>
  <div id="splash-screen">
    <img src="assets/Logo Sobre negro1.png" alt="Cargando El Sótano del Doctor...">
  </div>
  <div id="firebase-critical-error-banner" style="display:none;">
    ERROR CRÍTICO: La configuración de Firebase no es válida o es un placeholder. La aplicación puede no funcionar correctamente. Contacta al administrador.
  </div>
  <div id="connection-status"></div>

  <header>
    <div class="logo">
      <img src="assets/logo_blanco.png" alt="Logo El Sótano del Doctor" class="logo-main">
    </div>
    <img src="assets/logointranet.png" alt="Logo Intranet El Sótano del Doctor" class="logo-intranet">
    <div class="header-controls-right">
        <button id="site-audio-control-button" class="header-audio-control" title="Activar sonido" style="display: none;"> 
            <svg class="icon-muted" viewBox="0 0 24 24" fill="currentColor">
                <path d="M16.5 12A4.5 4.5 0 0012 7.5v2.14l4.5 4.5zm2.51.53l-1.06-1.06-1.06 1.06a1 1 0 01-1.41 0l-.7-.71a1 1 0 010-1.41l1.06-1.06-1.06-1.06a1 1 0 010-1.41l.7-.71a1 1 0 011.41 0l1.06 1.06 1.06-1.06a1 1 0 011.41 0l.71.71a1 1 0 010 1.41l-1.06 1.06 1.06 1.06a1 1 0 010 1.41l-.71.71a1 1 0 01-1.41 0zM4 9.78V14.2a1 1 0 001 1h2.34l4.91 3.3A1.19 1.19 0 0014 17.55V6.45a1.19 1.19 0 00-1.75-1.05L7.34 8.7H5a1 1 0 00-1 1.08z"/>
            </svg>
            <svg class="icon-unmuted" viewBox="0 0 24 24" fill="currentColor" style="display:none;">
                <path d="M12.4 4.42a1.19 1.19 0 00-1.75 1.05v13.1a1.19 1.19 0 001.75 1.05l4.91-3.3H19a1 1 0 001-1.07V9.72a1 1 0 00-1-1.07h-1.66zm6.1 2.51a6.73 6.73 0 010 10.14M16 9.48a3.23 3.23 0 010 5M4 9.72v4.56a1 1 0 001 1h2.34l4.91 3.3A1.19 1.19 0 0014 17.55V6.45a1.19 1.19 0 00-1.75-1.05L7.34 8.65H5a1 1 0 00-1 1.07z"/>
            </svg>
        </button>
        <div class="hamburger" id="hamburger-btn"><div></div><div></div><div></div></div>
    </div>
  </header>

  <div id="overlay"></div>
  <nav class="sidebar" id="sidebar-menu">
    <h2>Menú</h2>
    <a href="#setlists" id="menu-rehearsals-setlist-section">Setlist Próximo Ensayo</a>
    <a href="#rehearsals" id="menu-rehearsals-section">Próximos Ensayos</a>
    <a href="#second-setlist" id="menu-second-setlist-section">Setlist Próximo Concierto</a>
    <a href="#star-setlist" id="menu-star-setlist-section">Setlist Concierto Estrella</a>
    <a href="#calendario" id="menu-concerts-section">Próximos Conciertos</a>
    <a href="#" id="menu-stats">Estadísticas</a>
    <a href="#" id="menu-user-list-display">Usuarios Registrados</a>  
    <a href="#" id="menu-config">Configuración</a>
    <div class="submenu" id="config-submenu" style="display: none;">
      <a href="#" id="menu-setlist-config">Configurar Setlists</a>
      <a href="#" id="menu-user-mgmt">Gestión de Usuarios</a>
      <a href="#" id="menu-rehearsal">Asignar Ensayos</a>
    </div>
    <a href="#" id="menu-cerrar">Cerrar Menú</a>
  </nav>

  <div id="concert-details-modal" class="modal-backdrop"> <div class="modal-content"> </div> </div>
  <div id="setlist-config-screen" class="config-screen"> </div>
  <div id="user-mgmt-screen" class="config-screen"> </div>
  <div id="rehearsal-screen" class="config-screen"> </div>
  <div id="stats-screen" class="config-screen"> </div>
  <div id="user-list-screen" class="config-screen"> </div>

  <main>
    <section id="setlists">
      <h2>Setlist Próximo Ensayo</h2>
      <p id="setlist1-dynamic-name" class="setlist-dynamic-name"></p>
      <div class="table-wrapper"> <table> <thead> </thead> <tbody id="setlist-body"></tbody> </table> </div>
      <div style="text-align: center;">
        <button class="download-btn" id="download-btn">Pdf Complex</button>
        <button class="download-btn" id="download-basic-btn">Pdf Simple</button>
        <button class="download-btn" id="download-personal-btn">PDF Personal</button>
      </div>
      <p id="total-time"></p>
    </section>
    <section id="rehearsals"> <h2>Próximos Ensayos</h2> <div class="table-wrapper"><table id="rehearsal-main-table"> <thead> </thead> <tbody id="rehearsal-main-body"></tbody> </table></div> </section>
    <section id="second-setlist">
      <h2>Setlist Próximo Concierto</h2>
      <p id="second-setlist-dynamic-name" class="setlist-dynamic-name"></p>
      <div class="table-wrapper"> <table id="second-list-table"> <thead> </thead> <tbody id="second-body"></tbody> </table> </div>
      <div style="text-align: center;">
        <button class="download-btn" id="download-btn-2">Pdf Complex</button>
        <button class="download-btn" id="download-basic-btn-2">Pdf Simple</button>
        <button class="download-btn" id="download-personal-btn-2">PDF Personal</button>
      </div>
      <p id="total-time-2"></p>
    </section>
    <section id="star-setlist">
      <h2>Setlist Concierto Estrella</h2>
      <p id="star-setlist-dynamic-name" class="setlist-dynamic-name"></p>
      <div class="table-wrapper"> <table> <thead> </thead> <tbody id="star-setlist-body"></tbody> </table> </div>
      <div style="text-align: center;">
        <button class="download-btn" id="download-btn-star">Pdf Complex</button>
        <button class="download-btn" id="download-basic-btn-star">Pdf Simple</button>
        <button class="download-btn" id="download-personal-btn-star">PDF Personal</button>
      </div>
      <p id="total-time-star"></p>
    </section>
    <section id="calendario"> <h2>Próximos Conciertos</h2> <div id="bandhelper-concerts-container"> <script src="https://www.bandhelper.com/widget/calendar/10353?layout=1&range=6"></script> <p id="bandhelper-loading-message" style="display:none;">Procesando conciertos...</p> </div> </section>
  </main>

  <footer>© Año 2025 -iDoctor & El Sótano del Doctor- All Rights Reserved.</footer>

  <audio id="site-audio">
    <source src="" type="audio/mpeg">
    Tu navegador no soporta el elemento de audio.
  </audio>

<script>
/* ---------- 0. Firebase ---------- */
const firebaseConfig = { /* ... tu config ... */ };
if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "TU_API_KEY_AQUI" || (firebaseConfig.apiKey.startsWith("AIzaSyC") && firebaseConfig.apiKey.length < 30 && firebaseConfig.apiKey.includes("placeholder")) ) { const banner = document.getElementById('firebase-critical-error-banner'); if (banner) banner.style.display = 'block'; console.error("¡ERROR CRÍTICO! La API Key de Firebase no está configurada o es un placeholder.");}
firebase.initializeApp(firebaseConfig); const db = firebase.firestore(); firebase.firestore().enablePersistence().catch(err => { console.warn("Persistencia Firestore no habilitada:", err.code === 'failed-precondition' ? 'Múltiples pestañas.' : err.message); });

/* ---------- 1. Utilidades ---------- */
const parseDuration = str => { if (!str) return 0; if (str.includes(":")) { const [m, s = 0] = str.split(":").map(Number); return m * 60 + s; } const n = parseInt(str, 10); return isNaN(n) ? 0 : n;};
const toMMSS = s => { if (isNaN(s) || s === null || s === undefined) s = 0; const totalSeconds = Math.round(s); return `${Math.floor(totalSeconds / 60)}:${String(totalSeconds % 60).padStart(2, "0")}`;};
const toHHMM = s => { if (isNaN(s) || s === null || s === undefined) s = 0; const totalSeconds = Math.round(s); const h = Math.floor(totalSeconds / 3600); const m = Math.floor((totalSeconds % 3600) / 60); return h ? `${h}h ${String(m).padStart(2, "0")}m` : `${m}m`;};
const toHours = s => { if (isNaN(s) || s === null || s === undefined) return (0).toFixed(2); return (s / 3600).toFixed(2);};
function decodeHtmlEntities(text) { if (typeof text !== 'string') return text; const textArea = document.createElement('textarea'); textArea.innerHTML = text; return textArea.value;}
const calculateDuration = (startTime, endTime) => { if (!startTime || !endTime) return 0; const [startH, startM] = startTime.split(":").map(Number); const [endH, endM] = endTime.split(":").map(Number); const startSeconds = startH * 3600 + startM * 60; const endSeconds = endH * 3600 + endM * 60; let duration = endSeconds - startSeconds; if (duration < 0) duration += 24 * 3600; return duration;};
const formatDateWithDay = dateStr => { const date = new Date(dateStr + 'T00:00:00Z'); const days = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"]; const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]; return `${days[date.getUTCDay()]} ${date.getUTCDate()} de ${months[date.getUTCMonth()]}`;};
const getMonthYear = dateStr => { const date = new Date(dateStr + 'T00:00:00Z'); const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]; return `${months[date.getUTCMonth()]} ${date.getUTCFullYear()}`;};
function generateICS(title, date, startTime, location, description = "", durationSeconds = 7200) { /* ... (sin cambios) ... */ }
const sanitizeFirebaseKey = (str) => str.replace(/[.#$[\]/:\s,]/g, '_');
const sanitizeForPdfFilename = (str) => (str || "setlist").replace(/[\\/:*?"<>|#$.[\]]/g, '_').replace(/\s+/g, '_');

/* ---------- 1.5. Manejo de conexión ---------- */
const connectionStatus = document.getElementById("connection-status"); let isOnline = navigator.onLine; function updateConnectionStatus() { /* ... (sin cambios) ... */ } window.addEventListener("online", updateConnectionStatus); window.addEventListener("offline", updateConnectionStatus); async function withRetry(fn, maxRetries = 3, delay = 2000) { /* ... (sin cambios) ... */ }

/* ---------- 2. Acceso Firestore ---------- */
async function loadDoc(collection, docId, fallback) { try { const snap = await db.collection(collection).doc(docId).get(); return snap.exists ? snap.data() : fallback; } catch (e) { console.error(`Error al cargar documento ${collection}/${docId}:`, e.message, e); return fallback; } }
async function saveDoc(collection, docId, data, merge = false) { try { console.log(`Firestore: Guardando en ${collection}/${docId}. Datos:`, JSON.parse(JSON.stringify(data)), "Con merge:", merge); await db.collection(collection).doc(docId).set(data, { merge: merge }); console.log(`Firestore: Guardado de ${collection}/${docId} exitoso con merge=${merge}`); return true; } catch (e) { console.error(`Error al guardar documento ${collection}/${docId} con merge=${merge}:`, e.message, e); throw e; } }

/* ---------- 3. Configuración Setlists ---------- */
let setlistConfig = {setlist1:{name:"Setlist Predeterminado Ensayo",url:"URL_POR_CONFIGURAR_1"},setlist2:{name:"Setlist Predeterminado Próximo Concierto",url:"URL_POR_CONFIGURAR_2"},setlistStar:{name:"Setlist Predeterminado Concierto Estrella",url:"URL_POR_CONFIGURAR_STAR"}};
function updateDynamicSetlistTitles(){document.getElementById("setlist1-dynamic-name").textContent=setlistConfig.setlist1.name;document.getElementById("second-setlist-dynamic-name").textContent=setlistConfig.setlist2.name;document.getElementById("star-setlist-dynamic-name").textContent=setlistConfig.setlistStar.name}
async function loadSetlistConfig(){try{const data=await withRetry(()=>loadDoc("intranet","setlists",{config:setlistConfig}));setlistConfig={setlist1:data.config?.setlist1||setlistConfig.setlist1,setlist2:data.config?.setlist2||setlistConfig.setlist2,setlistStar:data.config?.setlistStar||setlistConfig.setlistStar};updateDynamicSetlistTitles()}catch(e){console.error("Error al cargar la configuración de setlists:",e);updateDynamicSetlistTitles()}}
async function saveSetlistConfig(){updateDynamicSetlistTitles();return await withRetry(()=>saveDoc("intranet","setlists",{config:setlistConfig}))}
async function cargarSetlistGenerico(configEntry,tbodyId,totalTimeId,defaultErrorMessage){try{if(!configEntry.url||configEntry.url.startsWith("URL_POR_CONFIGURAR")){console.warn(`[cargarSetlistGenerico] URL no configurada o es placeholder para ${tbodyId}`);throw new Error("URL no configurada.")}
const response=await fetch(configEntry.url);if(!response.ok){console.error(`[cargarSetlistGenerico] Error en la respuesta de la API para ${tbodyId}. Status: ${response.status}, URL: ${configEntry.url}`);throw new Error(`Error en la respuesta de la API (${response.status}): ${response.statusText}`)}
const rawData=await response.json();const dataToProcess=Array.isArray(rawData)?rawData:rawData.items||[];
const processedItems=dataToProcess.map(item=>{if(!item||item.type!=="song"&&item.type!=="set"){return null}
let rawDurationValue=parseFloat(item.duration);let durationIsInvalidOrMissing=isNaN(rawDurationValue)||rawDurationValue===0;if(isNaN(rawDurationValue)){rawDurationValue=0;durationIsInvalidOrMissing=true}
let durationInSeconds;const itemName=item.name||item.title||(item.type==="song"?"Canción sin título":"Set sin nombre");const isBreakByName=/break|descanso|intermedio|pausa|intermission|beer time/i.test(itemName);item.isSong=false;item.isBreak=false;item.isSetHeader=false;
if(item.type==="song"){durationInSeconds=rawDurationValue;item.isSong=true}else if(item.type==="set"){if(isBreakByName){item.isBreak=true;if(durationIsInvalidOrMissing){durationInSeconds=3*60}else{durationInSeconds=rawDurationValue*60}}else{item.isSetHeader=true;durationInSeconds=rawDurationValue*60}}else{durationInSeconds=0}
item.calculatedDurationSeconds=durationInSeconds;item.displayName=decodeHtmlEntities(item.title||item.name||(item.isSong?"Canción sin título":item.isBreak?"Pausa":"Set"));item.originalJSONDuration=item.duration;return item}).filter(item=>item!==null);
const tbody=document.getElementById(tbodyId);tbody.innerHTML="";let songCount=0;const setlistStructure=[];let currentSet=null;
processedItems.forEach(item=>{if(item.isSetHeader){if(currentSet){currentSet.calculatedBlockDurationSeconds=currentSet.songs.reduce((sum,song)=>sum+(song.calculatedDurationSeconds||0),0);setlistStructure.push(currentSet)}
currentSet={...item,songs:[],calculatedBlockDurationSeconds:0}}else if(item.isBreak){if(currentSet){currentSet.calculatedBlockDurationSeconds=currentSet.songs.reduce((sum,song)=>sum+(song.calculatedDurationSeconds||0),0);setlistStructure.push(currentSet);currentSet=null}
setlistStructure.push(item)}else if(item.isSong){if(!currentSet){currentSet={isSetHeader:true,displayName:"Set General",calculatedDurationSeconds:0,songs:[],calculatedBlockDurationSeconds:0}}
currentSet.songs.push(item)}});if(currentSet){currentSet.calculatedBlockDurationSeconds=currentSet.songs.reduce((sum,song)=>sum+(song.calculatedDurationSeconds||0),0);setlistStructure.push(currentSet)}
let totalSecondsOverall=0;setlistStructure.forEach(blockOrItem=>{if(blockOrItem.isSetHeader){const setHeaderTime=toMMSS(blockOrItem.calculatedBlockDurationSeconds||0);tbody.insertAdjacentHTML("beforeend",`<tr class="set-header-row"><td colspan="5">${blockOrItem.displayName} (${setHeaderTime})</td></tr>`);totalSecondsOverall+=(blockOrItem.calculatedBlockDurationSeconds||0);blockOrItem.songs.forEach(song=>{songCount++;const songFormattedTime=toMMSS(song.calculatedDurationSeconds||0);tbody.insertAdjacentHTML("beforeend",`<tr><td>${songCount}</td><td>${song.displayName}</td><td>${decodeHtmlEntities(song.key||"-")}</td><td>${decodeHtmlEntities(song.tempo||"-")}</td><td>${songFormattedTime}</td></tr>`)})}else if(blockOrItem.isBreak){const breakFormattedTime=toMMSS(blockOrItem.calculatedDurationSeconds||0);totalSecondsOverall+=(blockOrItem.calculatedDurationSeconds||0);tbody.insertAdjacentHTML("beforeend",`<tr class="break-row"><td></td><td style="font-style:italic;">${blockOrItem.displayName}</td><td style="font-style:italic; text-align:center;">-</td><td style="font-style:italic; text-align:center;">-</td><td style="font-style:italic; text-align:center;">${breakFormattedTime}</td></tr>`)}else if(blockOrItem.isSong){songCount++;const songFormattedTime=toMMSS(blockOrItem.calculatedDurationSeconds||0);totalSecondsOverall+=(blockOrItem.calculatedDurationSeconds||0);tbody.insertAdjacentHTML("beforeend",`<tr><td>${songCount}</td><td>${blockOrItem.displayName}</td><td>${decodeHtmlEntities(blockOrItem.key||"-")}</td><td>${decodeHtmlEntities(blockOrItem.tempo||"-")}</td><td>${songFormattedTime}</td></tr>`)}});
document.getElementById(totalTimeId).textContent="Tiempo total del set: "+toHHMM(totalSecondsOverall);return setlistStructure}catch(e){console.error(`[cargarSetlistGenerico] Error fatal en ${defaultErrorMessage} para ${tbodyId}:`,e);const tbody=document.getElementById(tbodyId);if(tbody)tbody.innerHTML=`<tr><td colspan="5">${defaultErrorMessage}. ${e.message}</td></tr>`;const totalTimeElem=document.getElementById(totalTimeId);if(totalTimeElem)totalTimeElem.textContent="Error al calcular tiempo.";return[]}}
const cargarPrimerSetlist=()=>cargarSetlistGenerico(setlistConfig.setlist1,"setlist-body","total-time","Error cargando Setlist Próximo Ensayo");const cargarSegundoSetlist=()=>cargarSetlistGenerico(setlistConfig.setlist2,"second-body","total-time-2","Error cargando Setlist Próximo Concierto");const cargarStarSetlist=()=>cargarSetlistGenerico(setlistConfig.setlistStar,"star-setlist-body","total-time-star","Error cargando Setlist Concierto Estrella");

/* ---------- 6. Usuarios ---------- */
// (Las funciones de Usuarios como renderUsers, loadUsers, saveUsers, resetUserForm permanecen sin cambios)
let users = []; let editingUserIndex = null; const excludedRehearsalUsers = ["Ximo", "Ginés Torres"];  
function renderUsers() { /* ... (código original) ... */ }
async function loadUsers() { /* ... (código original) ... */ }
async function saveUsers() { /* ... (código original) ... */ }
function resetUserForm() { /* ... (código original) ... */ }

/* ---------- 7. Ensayos ---------- */
// (Las funciones de Ensayos como renderRehearsals, loadRehearsals, saveRehearsals, resetRehearsalForm permanecen sin cambios)
let rehearsals = []; let editingRehearsalIndex = null;
function renderRehearsals() { /* ... (código original) ... */ }
async function loadRehearsals() { /* ... (código original) ... */ }
async function saveRehearsals() { /* ... (código original) ... */ }
function resetRehearsalForm() { /* ... (código original) ... */ }

/* ---------- 8. Estadísticas ---------- */
// (Las funciones de Estadísticas como updateMonthFilter, getMonthIndex, renderStats permanecen sin cambios)
function updateMonthFilter() { /* ... (código original) ... */ }
function getMonthIndex(monthName) { /* ... (código original) ... */ }
function renderStats() { /* ... (código original) ... */ }

/* ---------- 9. PDF ---------- */
// (Las funciones de PDF como loadFontAsBase64, registerFontWithDoc, getBackgroundImageDataURL, genPDF, genBasicPDF, genPersonalPDF permanecen sin cambios)
const fontDataCache = {}; const PDF_FONT_PATHS = { /* ... */ }; const PDF_FONT_NAMES = { /* ... */ }; const PDF_BACKGROUND_IMAGE_PATH = 'assets/Plantilla_pdf_ESDD_001.png';
async function loadFontAsBase64(fontPath) { /* ... (código original) ... */ }
async function registerFontWithDoc(doc, fontPath, fontVFSAlias, fontNameInDoc) { /* ... (código original) ... */ }
async function getBackgroundImageDataURL() { /* ... (código original) ... */ }
async function genPDF(setlistStructure, setlistDynamicName, rawFileNameForPdf) { /* ... (código original) ... */ }
async function genBasicPDF(setlistStructure, setlistDynamicName, rawFileNameForPdf) { /* ... (código original) ... */ }
async function genPersonalPDF(setlistStructure, setlistDynamicName, rawFileNameForPdf, songTitleFontSizeParam) { /* ... (código original) ... */ }


/* ---------- 10. BandHelper & Detalles Concierto ---------- */
let processTableAttempts = 0; const MAX_PROCESS_ATTEMPTS = 20;  
function processBandHelperTable() { /* ... (código original) ... */ }
const concertDetailModal = document.getElementById('concert-details-modal'); const concertDetailMessage = document.getElementById('concert-detail-message');
async function openConcertDetailModal(concertId, concertFullDateText, concertTitle, concertLocationOriginal) { /* ... (código original) ... */ }
document.getElementById('save-concert-details').onclick = async () => { /* ... (código original) ... */ };
document.getElementById('close-concert-details-modal').onclick = () => { closeAll(); };

/* ---------- 11. Menú & pantallas ---------- */
const sidebar = document.getElementById("sidebar-menu"), overlay = document.getElementById("overlay"); const PASSWORD = "Sotano2014"; let isAuthenticated = false;
function closeAll() { /* ... (código original) ... */ }
// (Resto de la lógica del menú y pantallas sin cambios)
document.getElementById("hamburger-btn").onclick = () => { sidebar.classList.add("show"); overlay.classList.add("show"); };
document.getElementById("menu-cerrar").onclick = e => { e.preventDefault(); closeAll(); }; overlay.onclick = closeAll;
const setupMenuLink = (menuId, targetId) => { /* ... (código original) ... */ };
setupMenuLink("menu-rehearsals-setlist-section", "setlists"); setupMenuLink("menu-rehearsals-section", "rehearsals");
setupMenuLink("menu-second-setlist-section", "second-setlist"); setupMenuLink("menu-star-setlist-section", "star-setlist");
setupMenuLink("menu-concerts-section", "calendario");
document.getElementById("menu-config").onclick = e => { /* ... (código original) ... */ };
const openConfigScreen = (screenId) => { /* ... (código original) ... */ }
document.getElementById("menu-setlist-config").onclick = e => { /* ... (código original) ... */ };
document.getElementById("close-setlist-config").onclick = () => { /* ... (código original) ... */ };
document.getElementById("guardar-setlist-config").onclick = async () => { /* ... (código original) ... */ };
document.getElementById("menu-user-mgmt").onclick = e => { /* ... (código original) ... */ };
document.getElementById("close-user-mgmt").onclick = () => { /* ... (código original) ... */ };
document.getElementById("add-user").onclick = async () => { /* ... (código original) ... */ };
document.getElementById("cancel-edit-user").onclick = () => { /* ... (código original) ... */ };
document.getElementById("menu-rehearsal").onclick = e => { /* ... (código original) ... */ };
document.getElementById("close-rehearsal").onclick = () => { /* ... (código original) ... */ };
document.getElementById("add-rehearsal").onclick = async () => { /* ... (código original) ... */ };
document.getElementById("cancel-edit-rehearsal").onclick = () => { /* ... (código original) ... */ };
document.getElementById("menu-stats").onclick = e => { /* ... (código original) ... */ };
document.getElementById("close-stats").onclick = () => document.getElementById("stats-screen").style.display = "none";
document.getElementById("stats-month-filter").addEventListener("change", renderStats);
document.getElementById("menu-user-list-display").onclick = e => { e.preventDefault(); openConfigScreen("user-list-screen"); };
document.getElementById("close-user-list-screen").onclick = () => { document.getElementById("user-list-screen").style.display = "none"; };


/* ---------- 12. Carga inicial & Lógica Audio Global y Splash ---------- */
document.addEventListener("DOMContentLoaded", async () => {
  
  // --- Lógica de Audio Global START ---
  const siteAudioElement = document.getElementById('site-audio');
  const siteAudioControlButton = document.getElementById('site-audio-control-button'); // Cambiado de splash-mute-button
  const siteAudioSongs = ['assets/que_mas_da.mp3', 'assets/una_semana.mp3'];
  let currentSiteSongIndex = -1;
  let siteAudioFadeInterval = null;
  const SITE_AUDIO_FADE_DURATION = 500; 
  const SITE_AUDIO_TARGET_VOLUME = 0.8;

  function stopSiteAudioFade() {
    if (siteAudioFadeInterval) {
      clearInterval(siteAudioFadeInterval);
      siteAudioFadeInterval = null;
    }
  }

  function fadeInSiteAudio(audio, duration, targetVolume) {
    stopSiteAudioFade();
    if (!audio) return;
    if (audio.muted) {
      audio.volume = 0; 
      audio.play().catch(e => console.warn("Error al reproducir en fadeInSiteAudio (muted):", e));
      return;
    }
    audio.volume = 0;
    audio.play().catch(e => console.warn("Error al reproducir en fadeInSiteAudio:", e));
    
    let step = targetVolume / (duration / 50);
    let currentVolume = 0;
    siteAudioFadeInterval = setInterval(() => {
      currentVolume += step;
      if (currentVolume >= targetVolume) {
        audio.volume = targetVolume;
        stopSiteAudioFade();
      } else if (audio) { // Chequeo extra por si el audio se destruye/cambia
        audio.volume = currentVolume;
      } else { // Si el audio ya no existe, limpiar intervalo
        stopSiteAudioFade();
      }
    }, 50);
  }

  function fadeOutSiteAudio(audio, duration, callback) {
    stopSiteAudioFade();
    if (!audio) { if (callback) callback(); return; }
    if (audio.paused || audio.volume < 0.01) {
      if (!audio.paused) audio.pause();
      audio.volume = 0;
      if (callback) callback();
      return;
    }
    let currentVolume = audio.volume;
    let step = currentVolume / (duration / 50);
    siteAudioFadeInterval = setInterval(() => {
      currentVolume -= step;
      if (currentVolume <= 0.01) {
        if (audio) {
            audio.volume = 0;
            audio.pause();
        }
        stopSiteAudioFade();
        if (callback) callback();
      } else if (audio) {
        audio.volume = currentVolume;
      } else {
        stopSiteAudioFade();
      }
    }, 50);
  }

  function playNextSiteSong(audioElement) {
    if (!audioElement || siteAudioSongs.length === 0) return;
    currentSiteSongIndex = (currentSiteSongIndex + 1) % siteAudioSongs.length;
    audioElement.src = siteAudioSongs[currentSiteSongIndex];
    audioElement.load();

    const playWhenReady = () => {
      if (audioElement) { // Verificar si audioElement aún existe
        fadeInSiteAudio(audioElement, SITE_AUDIO_FADE_DURATION, audioElement.muted ? 0 : SITE_AUDIO_TARGET_VOLUME);
        audioElement.removeEventListener('canplaythrough', playWhenReady);
        audioElement.removeEventListener('loadeddata', playWhenReady);
      }
    };
    audioElement.addEventListener('canplaythrough', playWhenReady);
    audioElement.addEventListener('loadeddata', playWhenReady);
  }

  if (siteAudioElement && siteAudioControlButton) {
    const iconMuted = siteAudioControlButton.querySelector('.icon-muted');
    const iconUnmuted = siteAudioControlButton.querySelector('.icon-unmuted');

    const updateSiteAudioMuteButton = () => {
      if (!siteAudioElement || !iconMuted || !iconUnmuted || !siteAudioControlButton) return;
      if (siteAudioElement.muted) {
        iconMuted.style.display = 'inline';
        iconUnmuted.style.display = 'none';
        siteAudioControlButton.title = "Activar sonido";
      } else {
        iconMuted.style.display = 'none';
        iconUnmuted.style.display = 'inline';
        siteAudioControlButton.title = "Desactivar sonido";
      }
    };

    siteAudioElement.muted = true; 
    siteAudioElement.loop = false; 
    updateSiteAudioMuteButton();
    siteAudioControlButton.style.display = 'flex'; // Hacer visible el botón en la cabecera

    currentSiteSongIndex = Math.floor(Math.random() * siteAudioSongs.length);
    siteAudioElement.src = siteAudioSongs[currentSiteSongIndex];
    siteAudioElement.load(); 

    siteAudioElement.addEventListener('ended', () => {
      fadeOutSiteAudio(siteAudioElement, SITE_AUDIO_FADE_DURATION, () => {
        playNextSiteSong(siteAudioElement);
      });
    });

    siteAudioControlButton.addEventListener('click', () => {
      if (!siteAudioElement) return;
      const wasMuted = siteAudioElement.muted;
      siteAudioElement.muted = !siteAudioElement.muted;
      updateSiteAudioMuteButton();

      if (!siteAudioElement.muted) { 
          if (siteAudioElement.paused || wasMuted) { 
              if(wasMuted && siteAudioElement.volume > 0 && !siteAudioElement.paused){
                   fadeInSiteAudio(siteAudioElement, SITE_AUDIO_FADE_DURATION, SITE_AUDIO_TARGET_VOLUME);
              } else { 
                  siteAudioElement.volume = 0; 
                  fadeInSiteAudio(siteAudioElement, SITE_AUDIO_FADE_DURATION, SITE_AUDIO_TARGET_VOLUME); 
              }
          }
      } else { 
        stopSiteAudioFade(); 
      }
    });
  }
  // --- Lógica de Audio Global END ---

  // --- Splash Screen Visual Logic START ---
  const splashScreen = document.getElementById('splash-screen');
  if (splashScreen) {
    const visibleDuration = 1000; 
    const exitAnimationDuration = 800; 

    setTimeout(() => {
      splashScreen.classList.add('hidden');
      // La música NO se detiene aquí, es persistente.
      setTimeout(() => {
        if (splashScreen.parentNode) {
           splashScreen.style.display = 'none';
        }
      }, exitAnimationDuration);
    }, visibleDuration);
  }
  // --- Splash Screen Visual Logic END ---

  console.log("[DOMContentLoaded] Iniciando carga de la aplicación.");
  updateConnectionStatus();
  try {
      console.log("[DOMContentLoaded] Cargando configuración de setlists, usuarios y ensayos...");
      await Promise.all([loadSetlistConfig(), loadUsers(), loadRehearsals()]);
      console.log("[DOMContentLoaded] Configuración, usuarios y ensayos cargados.");
  } catch (e) { console.error("[DOMContentLoaded] Error en carga inicial de Firestore:", e); }

  let items1 = [], items2 = [], itemsStar = [];  
  try {  
    console.log("[DOMContentLoaded] Cargando primer setlist...");
    items1 = await cargarPrimerSetlist();  
    console.log("[DOMContentLoaded] Primer setlist cargado:", items1 ? items1.length : 0, "bloques/items.");
  } catch (e) { console.error("[DOMContentLoaded] Fallo carga Setlist Ensayo:", e); }
  
  try {  
    console.log("[DOMContentLoaded] Cargando segundo setlist...");
    items2 = await cargarSegundoSetlist();  
    console.log("[DOMContentLoaded] Segundo setlist cargado:", items2 ? items2.length : 0, "bloques/items.");
  } catch (e) { console.error("[DOMContentLoaded] Fallo carga Setlist Próx. Concierto:", e); }
  
  try {  
    console.log("[DOMContentLoaded] Cargando setlist estrella...");
    itemsStar = await cargarStarSetlist();  
    console.log("[DOMContentLoaded] Setlist estrella cargado:", itemsStar ? itemsStar.length : 0, "bloques/items.");
  } catch (e) { console.error("[DOMContentLoaded] Fallo carga Setlist Estrella:", e); }

  document.getElementById("download-btn").onclick = () => { if (items1 && items1.length > 0) genPDF(items1, setlistConfig.setlist1.name, setlistConfig.setlist1.name); else alert("No hay elementos en Setlist Ensayo."); };
  document.getElementById("download-basic-btn").onclick = () => { if (items1 && items1.length > 0) genBasicPDF(items1, setlistConfig.setlist1.name, setlistConfig.setlist1.name); else alert("No hay elementos en Setlist Ensayo para PDF básico."); };
  
  document.getElementById("download-btn-2").onclick = () => { if (items2 && items2.length > 0) genPDF(items2, setlistConfig.setlist2.name, setlistConfig.setlist2.name); else alert("No hay elementos en Setlist Próx. Concierto."); };
  document.getElementById("download-basic-btn-2").onclick = () => { if (items2 && items2.length > 0) genBasicPDF(items2, setlistConfig.setlist2.name, setlistConfig.setlist2.name); else alert("No hay elementos en Setlist Próx. Concierto para PDF básico."); };
  
  document.getElementById("download-btn-star").onclick = () => { if (itemsStar && itemsStar.length > 0) genPDF(itemsStar, setlistConfig.setlistStar.name, setlistConfig.setlistStar.name); else alert("No hay elementos en Setlist Estrella."); };
  document.getElementById("download-basic-btn-star").onclick = () => { if (itemsStar && itemsStar.length > 0) genBasicPDF(itemsStar, setlistConfig.setlistStar.name, setlistConfig.setlistStar.name); else alert("No hay elementos en Setlist Estrella para PDF básico."); };
  
  document.getElementById("download-personal-btn").onclick = () => {
      if (items1 && items1.length > 0) {
          const fontSizeInput = prompt("PDF Personal - Introduce el tamaño de letra para los títulos de las canciones (ej: 12, 14, 16):", "14");
          if (fontSizeInput) {
              const fontSize = parseInt(fontSizeInput, 10);
              if (!isNaN(fontSize) && fontSize >= 8 && fontSize <= 30) { 
                  genPersonalPDF(items1, setlistConfig.setlist1.name, setlistConfig.setlist1.name, fontSize);
              } else {
                  alert("Tamaño de letra inválido. Por favor, introduce un número entre 8 y 30.");
              }
          }
      } else {
          alert("No hay elementos en Setlist Ensayo para generar un PDF personal.");
      }
  };
  document.getElementById("download-personal-btn-2").onclick = () => {
      if (items2 && items2.length > 0) {
          const fontSizeInput = prompt("PDF Personal - Introduce el tamaño de letra para los títulos de las canciones (ej: 12, 14, 16):", "14");
          if (fontSizeInput) {
              const fontSize = parseInt(fontSizeInput, 10);
              if (!isNaN(fontSize) && fontSize >= 8 && fontSize <= 30) {
                  genPersonalPDF(items2, setlistConfig.setlist2.name, setlistConfig.setlist2.name, fontSize);
              } else {
                  alert("Tamaño de letra inválido. Por favor, introduce un número entre 8 y 30.");
              }
          }
      } else {
          alert("No hay elementos en Setlist Próximo Concierto para generar un PDF personal.");
      }
  };
  document.getElementById("download-personal-btn-star").onclick = () => {
      if (itemsStar && itemsStar.length > 0) {
          const fontSizeInput = prompt("PDF Personal - Introduce el tamaño de letra para los títulos de las canciones (ej: 12, 14, 16):", "14");
          if (fontSizeInput) {
              const fontSize = parseInt(fontSizeInput, 10);
              if (!isNaN(fontSize) && fontSize >= 8 && fontSize <= 30) {
                  genPersonalPDF(itemsStar, setlistConfig.setlistStar.name, setlistConfig.setlistStar.name, fontSize);
              } else {
                  alert("Tamaño de letra inválido. Por favor, introduce un número entre 8 y 30.");
              }
          }
      } else {
          alert("No hay elementos en Setlist Estrella para generar un PDF personal.");
      }
  };

  console.log("[DOMContentLoaded] Iniciando proceso de tabla BandHelper...");
  setTimeout(processBandHelperTable, 2000);  
  console.log("[DOMContentLoaded] Carga de la aplicación completada.");
});
</script>
</body>
</html>
