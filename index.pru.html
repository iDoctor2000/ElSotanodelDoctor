<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>El Sótano del Doctor – Uso Interno</title>

  <link rel="icon" type="image/x-icon" href="assets/favicon_ElSotanoDr.ico">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">

  <meta property="og:title"       content="El Sótano del Doctor – Uso Interno">
  <meta property="og:description" content="Banda de rock y versiones. Explora nuestro setlist, fechas de conciertos y más.">
  <meta property="og:image"       content="assets/logo_negro copia.jpg">
  <meta property="og:type"        content="website">
  <meta property="og:url"         content="https://tusitioweb.com">

  <meta name="twitter:card"        content="summary_large_image">
  <meta name="twitter:title"       content="El Sótano del Doctor – Uso Interno">
  <meta name="twitter:description" content="Banda de rock y versiones. Explora nuestro setlist, fechas de conciertos y mucho más. ¡Disfruta de la música!">
  <meta name="twitter:image"       content="assets/logo_negro copia.jpg">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    /* Reset y fuente base */
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;padding:0;overflow-x:hidden;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff}
    /* Cabecera */
    header{background:#111;padding:20px 20px;display:flex;align-items:center;justify-content:space-between;position:relative}
    .logo img.logo-main{width:180px;height:auto} /* Logo principal */
    .logo-intranet{position:absolute;left:50%;transform:translateX(-50%);height:60px;width:auto} /* Centrar logointranet.png */
    /* Hamburguesa */
    .hamburger{cursor:pointer;border:1px solid #0cf;border-radius:4px;padding:5px}
    .hamburger div{width:25px;height:3px;background:#0cf;margin:4px 0}
    /* Sidebar */
    .sidebar{position:fixed;top:0;left:0;width:250px;height:100%;background:#111;border-right:1px solid #222;
             padding:20px;box-shadow:2px 0 10px rgba(0,255,255,.1);transform:translateX(-250px);transition:.3s;z-index:9999}
    .sidebar.show{transform:translateX(0)}
    .sidebar h2{color:#0cf;margin:0}
    .sidebar a{display:block;color:#fff;text-decoration:none;margin:10px 0;padding:5px 0;border-bottom:1px solid #222}
    .sidebar a:hover{color:#0cf}
    .sidebar .submenu { margin-left: 15px; }
    .sidebar .submenu a { padding: 5px 0; font-size: 0.95em; }
    /* Overlay */
    #overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:9998;display:none}
    #overlay.show{display:block}
    
    /* Pantallas modales y Modal de Detalles del Concierto */
    .modal-backdrop {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); z-index: 10000; justify-content: center; align-items: center;
    }
    .modal-backdrop.show { display: flex; }
    .modal-content {
        background: #1a1a1a; color: #fff; padding: 25px; border-radius: 10px;
        box-shadow: 0 0 20px rgba(0,255,255,0.2); width: 90%; max-width: 600px;
        max-height: 90vh; overflow-y: auto; position: relative;
    }
    .modal-content h3 { color: #0cf; margin-top: 0; }
    .modal-content label { display: block; margin: 10px 0 5px; color: #0cf; }
    .modal-content input[type="text"],
    .modal-content input[type="time"],
    .modal-content textarea {
        width: 100%; padding: 10px; background: #222; color: #fff;
        border: 1px solid #333; border-radius: 5px; margin-bottom: 15px;
    }
    .modal-content textarea { min-height: 80px; }
    .modal-content button {
        padding: 10px 20px; background: #0cf; color: #000; border: none;
        border-radius: 8px; cursor: pointer; margin-right: 10px;
    }
    .modal-content button:hover { background: #09b; }
    .modal-content .modal-close-btn {
        background: #444; color: #fff;
    }
    .modal-content .modal-close-btn:hover { background: #555; }
    #musicians-attendance-list { max-height: 150px; overflow-y: auto; border: 1px solid #333; padding: 10px; margin-bottom:15px; }
    #musicians-attendance-list div { margin-bottom: 5px; }
    #musicians-attendance-list label { color: #fff; margin-left: 5px; }
    .modal-field-group { display: flex; gap: 10px; }
    .modal-field-group > div { flex: 1; }
    .modal-field-group input[type="time"] { text-align: left; }


    .config-screen{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:9999;
                   overflow-y:auto;padding:80px 20px 20px}
    .config-screen h2{color:#0cf;text-align:center;margin:20px 0}
    .config-screen h3{color:#0cf;margin:20px 0 10px}
    .config-screen label{display:block;margin:10px 0 5px}
    .config-screen input,.config-screen select{width:100%;max-width:400px;padding:10px;background:#222;color:#fff;
                                              border:1px solid #333;border-radius:5px}
    .config-screen select[multiple] { height: 150px; }
    .config-screen button{margin-top:30px;padding:10px 20px;background:#0cf;color:#000;border:none;border-radius:8px;cursor:pointer}
    .config-screen button:hover{background:#09b}
    .config-screen .close-btn{position:absolute;top:20px;right:20px;font-size:1.2em;background:none;border:1px solid #0cf;
                              color:#0cf;border-radius:4px;padding:5px 10px;cursor:pointer}
    .config-screen .close-btn:hover{background:#333}
    /* Secciones */
    main section{max-width:1200px;margin:0 auto;padding:20px}
    #setlists, #star-setlist, #rehearsals, #second-setlist, #calendario, #usuarios {
        background:#111;padding:20px;border-radius:10px;box-shadow:0 0 20px rgba(0,255,255,.1);margin-bottom:40px
    }
    #setlists h2, #star-setlist h2, #rehearsals h2, #second-setlist h2, #calendario h2, #usuarios h2 {
        text-align:center;color:#0cf;margin-bottom:15px
    }
    /* Ajuste para tablas: envolvente para permitir desplazamiento horizontal */
    .table-wrapper {
      width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch;
      display: flex; justify-content: center;
    }
    table {
      width: 100%; max-width: 100%; border-collapse: collapse; margin-top: 20px;
      color: #fff; font-size: .95em; margin-left: auto; margin-right: auto;
    }
    thead{background:#222;color:#0cf}
    th,td{padding:12px;border:1px solid #333;text-align:left;white-space: normal; word-wrap: break-word;}
    tr:nth-child(even){background:#1a1a1a}
    
    .download-btn{display:block;margin:20px auto 0;padding:10px 20px;font-size:1em;background:#0cf;color:#000;border:none;border-radius:8px;cursor:pointer}
    .download-btn:hover{background:#09b}
    #total-time, #total-time-star, #total-time-2{color:#0cf;margin-top:10px;text-align:center}
    #star-setlist-name, #second-setlist-name {text-align:center;color:#aaa;margin-top:5px;font-style:italic}

    footer{background:#111;color:#888;text-align:center;padding:10px;border-top:1px solid #222}
    /* Estilo para el botón de añadir al calendario y detalles */
    .calendar-btn, .details-btn { background: none; border: none; cursor: pointer; padding: 5px; margin-left: 10px; vertical-align: middle; }
    .calendar-btn svg { fill: #0cf; width: 20px; height: 20px; }
    .calendar-btn:hover svg { fill: #09b; }
    .details-btn { font-size: 1.5em; color: #0cf; } /* Flecha azul */
    .details-btn:hover { color: #09b; }

    /* Estilo para botones de acción en tablas */
    .delete-user, .edit-user, .delete-rehearsal, .clear-attendance, .edit-rehearsal {
      padding: 5px 10px; margin: 0 5px; background: #f00; color: #fff; border: none; border-radius: 4px; cursor: pointer;
    }
    .edit-user, .edit-rehearsal { background: #0cf; color: #000; }
    .clear-attendance { background: #ff9800; }
    .delete-user:hover, .delete-rehearsal:hover { background: #d00; }
    .edit-user:hover, .edit-rehearsal:hover { background: #09b; }
    .clear-attendance:hover { background: #e68900; }
    #cancel-edit-user, #cancel-edit-rehearsal { background: #666; color: #fff; }
    #cancel-edit-user:hover, #cancel-edit-rehearsal:hover { background: #555; }
    .attendance-form { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .attendance-form select { padding: 5px; background: #222; color: #fff; border: 1px solid #333; border-radius: 4px; }
    .attendance-form button { padding: 5px 10px; background: #0cf; color: #000; border: none; border-radius: 4px; cursor: pointer; }
    .attendance-form button:hover { background: #09b; }
    .attendance-summary { margin-top: 10px; font-size: 0.9em; }
    .attendance-summary span { display: block; }
    .attending-yes { color: #0cf; }
    .attending-no { color: #f00; }
    .rehearsal-duration { display: block; font-size: 0.9em; color: #aaa; }
    #connection-status {
      position: fixed; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.8); color: #fff;
      padding: 5px 10px; border-radius: 5px; font-size: 0.9em; z-index: 10000; display: none;
    }
    #connection-status.offline { background: #f00; }
    #connection-status.retrying { background: #ff9800; }
    .success-message { color: #0cf; margin-top: 10px; text-align: center; }
    .error-message { color: #f00; margin-top: 10px; text-align: center; }
    .stats-table { margin-bottom: 40px; }
    .stats-table h3 { color: #0cf; margin: 20px 0 10px; text-align: center; }
    .stats-filter { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px; }
    .stats-filter label { color: #0cf; }
    .stats-filter select { padding: 5px; background: #222; color: #fff; border: 1px solid #333; border-radius: 4px; width: auto; max-width: 200px; }
    
    #firebase-critical-error-banner {
        background-color: red; color: white; padding: 15px; text-align: center;
        position: fixed; top: 0; left: 0; width: 100%; z-index: 100001; font-weight: bold;
    }

    @media(max-width:768px){
      .hamburger div{width:20px}
      .logo img.logo-main{width:150px}
      .logo-intranet{height:50px}
      .attendance-form { flex-direction: column; align-items: flex-start; }
      .attendance-form select { width: 100%; }
      .delete-rehearsal, .clear-attendance, .edit-rehearsal { display: block; margin: 5px 0; width: 100%; }
      #connection-status { top: 70px; right: 5px; font-size: 0.8em; }
      .table-wrapper { overflow-x: hidden; }
      table { width: 100%; min-width: unset; font-size: 0.85em; }
      th, td { padding: 8px; white-space: normal; word-wrap: break-word; max-width: 150px; }
      #second-setlist .table-wrapper table, #star-setlist .table-wrapper table { min-width: unset; }
      .stats-table table { font-size: 0.85em; }
      .modal-content { width: 95%; padding: 15px; }
      .modal-field-group { flex-direction: column; }
    }
  </style>
</head>

<body>
  <div id="firebase-critical-error-banner" style="display:none;">
    ERROR CRÍTICO: La configuración de Firebase no es válida o es un placeholder. La aplicación puede no funcionar correctamente. Contacta al administrador.
  </div>
  <div id="connection-status"></div>

  <header>
    <div class="logo">
      <img src="assets/logo_blanco.png" alt="Logo" class="logo-main">
    </div>
    <img src="assets/logointranet.png" alt="Logo Intranet" class="logo-intranet">
    <div class="hamburger" id="hamburger-btn"><div></div><div></div><div></div></div>
  </header>

  <div id="overlay"></div>
  <nav class="sidebar" id="sidebar-menu">
    <h2>Menú</h2>
    <a href="#star-setlist" id="menu-star-setlist-section">Setlist Concierto Estrella</a>
    <a href="#setlists" id="menu-rehearsals-setlist-section">Setlist Próximo Ensayo</a>
    <a href="#second-setlist" id="menu-second-setlist-section">Setlist Próximo Concierto</a>
    <a href="#rehearsals" id="menu-rehearsals-section">Próximos Ensayos</a>
    <a href="#calendario" id="menu-concerts-section">Próximos Conciertos</a>
    <a href="#" id="menu-stats">Estadísticas</a>
    <a href="#" id="menu-config">Configuración</a>
    <div class="submenu" id="config-submenu" style="display: none;">
      <a href="#" id="menu-setlist-config">Configurar Setlists</a>
      <a href="#" id="menu-user-mgmt">Gestión de Usuarios</a>
      <a href="#" id="menu-rehearsal">Asignar Ensayos</a>
      </div>
    <a href="#" id="menu-cerrar">Cerrar Menú</a>
  </nav>

  <div id="concert-details-modal" class="modal-backdrop">
    <div class="modal-content">
        <h3>Detalles del Concierto</h3>
        <input type="hidden" id="concert-detail-id">
        
        <label for="concert-detail-location">Detalles adicionales de la ubicación:</label>
        <textarea id="concert-detail-location"></textarea>

        <div class="modal-field-group">
            <div>
                <label for="concert-detail-soundcheck">Hora de la prueba de sonido:</label>
                <input type="time" id="concert-detail-soundcheck">
            </div>
            <div>
                <label for="concert-detail-showtime">Hora del show (confirmada/ajustada):</label>
                <input type="time" id="concert-detail-showtime">
            </div>
        </div>
        
        <label for="concert-detail-notes">Notas generales:</label>
        <textarea id="concert-detail-notes"></textarea>

        <h4>Músicos Asistentes al Concierto</h4>
        <div id="musicians-attendance-list">
            </div>
        
        <button id="save-concert-details">Guardar Detalles</button>
        <button id="close-concert-details-modal" class="modal-close-btn">Cerrar</button>
        <p id="concert-detail-message" class="success-message" style="text-align:left; margin-top:10px;"></p>
    </div>
  </div>


  <div id="setlist-config-screen" class="config-screen">
    <button class="close-btn" id="close-setlist-config">Cerrar</button>
    <h2>Configuración de Setlists</h2>
    
    <h3>Setlist Concierto Estrella</h3>
    <label>Nombre</label><input id="setlistStar-name" placeholder="Ej: Gran Evento 2025">
    <label>ID/URL feed</label><input id="setlistStar-url" placeholder="URL">

    <h3>Setlist Próximo Ensayo</h3>
    <label>Nombre</label><input id="setlist1-name" placeholder="Ej: Ensayos 2025">
    <label>ID/URL feed</label><input id="setlist1-url" placeholder="URL">
    
    <h3>Setlist Próximo Concierto</h3>
    <label>Nombre</label><input id="setlist2-name" placeholder="Ej: Concierto Navidad">
    <label>ID/URL feed</label><input id="setlist2-url" placeholder="Ej: TXHvy autónomo o URL completa">
    
    <button id="guardar-setlist-config">Guardar Configuración</button>
    <p id="setlist-message" class="error-message"></p>
  </div>

  <div id="user-mgmt-screen" class="config-screen">
    <button class="close-btn" id="close-user-mgmt">Cerrar</button>
    <h2>Gestión de Usuarios</h2>
    <label>Nombre</label><input id="user-name" placeholder="Nombre">
    <label>Apodo</label><input id="user-nickname" placeholder="Apodo (corto)">
    <label>Roles</label>
    <select id="user-role" multiple>
      <option value="Batería">Batería</option><option value="Teclados">Teclados</option><option value="Voz">Voz</option>
      <option value="Guitarra eléctrica">Guitarra eléctrica</option><option value="Guitarra Acústica">Guitarra Acústica</option>
      <option value="Bajo">Bajo</option><option value="Percusión">Percusión</option><option value="Saxo">Saxo</option>
      <option value="Dirección Musical">Dirección Musical</option><option value="Técnico de Sonido">Técnico de Sonido</option>
      <option value="Montador">Montador</option><option value="Coros">Coros</option>
    </select>
    <button id="add-user">Añadir Usuario</button>
    <button id="cancel-edit-user" style="display:none;">Cancelar Edición</button>
    <p id="user-message" class="error-message"></p>
    <table id="user-table"><thead><tr><th>Nombre</th><th>Apodo</th><th>Roles</th><th>Acciones</th></tr></thead><tbody id="user-table-body"></tbody></table>
  </div>

  <div id="rehearsal-screen" class="config-screen">
    <button class="close-btn" id="close-rehearsal">Cerrar</button>
    <h2>Asignación de Ensayos</h2>
    <label>Fecha</label><input type="date" id="rehearsal-date">
    <label>Hora Inicio</label><input type="time" id="rehearsal-start-time">
    <label>Hora Fin</label><input type="time" id="rehearsal-end-time">
    <label>Lugar</label><input id="rehearsal-location" placeholder="Ej: Estudio 1">
    <button id="add-rehearsal">Añadir Ensayo</button>
    <button id="cancel-edit-rehearsal" style="display:none;">Cancelar Edición</button>
    <p id="rehearsal-message" class="error-message"></p>
    <table id="rehearsal-table">
      <thead><tr><th>Fecha</th><th>Hora Inicio</th><th>Hora Fin</th><th>Lugar</th><th>Asistencias</th><th>Acciones</th></tr></thead>
      <tbody id="rehearsal-table-body"></tbody>
    </table>
  </div>

  <div id="stats-screen" class="config-screen">
    <button class="close-btn" id="close-stats">Cerrar</button>
    <h2>Estadísticas</h2>
    <div class="stats-filter">
      <label>Filtrar por mes:</label>
      <select id="stats-month-filter"><option value="all">Todos los meses</option></select>
    </div>
    <div class="stats-table">
      <h3>Tiempo Ensayado por Mes</h3>
      <table id="time-per-month-table"><thead><tr><th>Mes</th><th>Tiempo Total (horas)</th></tr></thead><tbody id="time-per-month-body"></tbody></table>
    </div>
    <div class="stats-table">
      <h3>Tiempo Ensayado por Usuario</h3>
      <table id="time-per-user-table"><thead><tr><th>Usuario</th><th>Tiempo Total (horas)</th></tr></thead><tbody id="time-per-user-body"></tbody></table>
    </div>
    <div class="stats-table">
      <h3>Ensayos Pasados</h3>
      <div class="table-wrapper">
        <table id="past-rehearsals-table">
          <thead><tr><th>Fecha</th><th>Hora</th><th>Lugar</th><th>Asistencias</th></tr></thead>
          <tbody id="past-rehearsals-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <main>
    <section id="star-setlist">
      <h2 id="star-setlist-title">Setlist Concierto Estrella</h2>
      <p id="star-setlist-name"></p>
      <div class="table-wrapper">
        <table><thead><tr><th>#</th><th>Título</th><th>Tonalidad</th><th>Tempo</th><th>Duración</th></tr></thead><tbody id="star-setlist-body"></tbody></table>
      </div>
      <button class="download-btn" id="download-btn-star">Descargar PDF</button>
      <p id="total-time-star"></p>
    </section>

    <section id="setlists">
      <h2 id="setlist1-title">Setlist Próximo Ensayo</h2>
      <div class="table-wrapper">
        <table><thead><tr><th>#</th><th>Título</th><th>Tonalidad</th><th>Tempo</th><th>Duración</th></tr></thead><tbody id="setlist-body"></tbody></table>
      </div>
      <button class="download-btn" id="download-btn">Descargar PDF</button>
      <p id="total-time"></p>
    </section>

    <section id="second-setlist">
      <h2 id="second-setlist-title">Setlist Próximo Concierto</h2>
      <p id="second-setlist-name"></p>
      <div class="table-wrapper">
        <table id="second-list-table"><thead><tr><th>#</th><th>Canción</th><th>Tonalidad</th><th>Tempo</th><th>Duración</th></tr></thead><tbody id="second-body"></tbody></table>
      </div>
      <button class="download-btn" id="download-btn-2">Descargar PDF</button>
      <p id="total-time-2"></p>
    </section>
    
    <section id="rehearsals">
      <h2>Próximos Ensayos</h2>
      <div class="table-wrapper">
        <table id="rehearsal-main-table">
          <thead><tr><th>Fecha</th><th>Hora</th><th>Lugar</th><th>Confirmar Asistencia</th></tr></thead>
          <tbody id="rehearsal-main-body"></tbody>
        </table>
      </div>
    </section>

    <section id="calendario">
      <h2>Próximos Conciertos</h2>
      <div id="bandhelper-concerts">
        </div>
    </section>

    <section id="usuarios">
      <h2>Usuarios Registrados</h2>
      <div class="table-wrapper">
        <table><thead><tr><th>Nombre</th><th>Apodo</th><th>Roles</th></tr></thead><tbody id="users-body"></tbody></table>
      </div>
    </section>
  </main>

  <footer>© 2025 El Sótano del Doctor. All Rights Reserved.</footer>

  <script>
  /* ---------- 0. Firebase ---------- */
  const firebaseConfig = {
    apiKey: "AIzaSyCEP44xNINCkIejgNvcYafJsALnO0y4dfw", // ¡ASEGÚRATE QUE ESTA NO SEA LA KEY DE PRODUCCIÓN SI ES UN PLACEHOLDER!
    authDomain: "sotanointranet.firebaseapp.com",
    projectId: "sotanointranet",
    messagingSenderId: "756955233128",
    appId: "1:756955233128:web:ab36372bdbd895a30e74dd"
  };

  // Mostrar advertencia si la API Key parece ser un placeholder o la de ejemplo
  // (Adaptar esta condición si es necesario)
  if (!firebaseConfig.apiKey || 
      firebaseConfig.apiKey === "TU_API_KEY_AQUI" || 
      firebaseConfig.apiKey.startsWith("AIzaSyC") && firebaseConfig.apiKey.length < 40) { // Heuristic for placeholder
      const banner = document.getElementById('firebase-critical-error-banner');
      if (banner) banner.style.display = 'block';
      console.error("¡ERROR CRÍTICO! La API Key de Firebase no está configurada correctamente o es un placeholder.");
  }

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  firebase.firestore().enablePersistence()
    .catch(err => {
      console.warn("No se pudo habilitar la persistencia de Firestore:", err.code === 'failed-precondition' ? 'Múltiples pestañas abiertas.' : err.message);
    });

  /* ---------- 1. Utilidades ---------- */
  const parseDuration = str => {
    if (!str) return 0;
    if (str.includes(":")) { const [m, s = 0] = str.split(":").map(Number); return m * 60 + s; }
    const n = parseInt(str, 10); return isNaN(n) ? 0 : n;
  };
  const toMMSS = s => `${Math.floor(s / 60)}:${String(s % 60).padStart(2, "0")}`;
  const toHHMM = s => {
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    return h ? `${h}h ${String(m).padStart(2, "0")}m` : `${m}m`;
  };
  const toHours = s => (s / 3600).toFixed(2);
  const clean = s => (s || "").replace(/[^\x00-\xFF]/g, "").trim();
  const calculateDuration = (startTime, endTime) => {
    if (!startTime || !endTime) return 0;
    const [startH, startM] = startTime.split(":").map(Number);
    const [endH, endM] = endTime.split(":").map(Number);
    const startSeconds = startH * 3600 + startM * 60;
    const endSeconds = endH * 3600 + endM * 60;
    let duration = endSeconds - startSeconds;
    if (duration < 0) duration += 24 * 3600;
    return duration;
  };
  const formatDateWithDay = dateStr => {
    const date = new Date(dateStr + 'T00:00:00'); // Asegurar que se interprete como fecha local
    const days = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];
    const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    return `${days[date.getDay()]} ${date.getDate()} de ${months[date.getMonth()]}`;
  };
  const getMonthYear = dateStr => {
    const date = new Date(dateStr + 'T00:00:00');
    const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    return `${months[date.getMonth()]} ${date.getFullYear()}`;
  };
  function generateICS(title, date, startTime, location, description = "", durationSeconds = 7200) { // Default 2h duration
    const startDate = new Date(`${date}T${startTime}`);
    const endDate = new Date(startDate.getTime() + durationSeconds * 1000);
    const formatDate = d => d.toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";
    const start = formatDate(startDate);
    const end = formatDate(endDate);
    const icsContent = [
      "BEGIN:VCALENDAR", "VERSION:2.0", "BEGIN:VEVENT",
      `DTSTART:${start}`, `DTEND:${end}`, `SUMMARY:${title}`,
      `DESCRIPTION:${description}`, `LOCATION:${location}`,
      "END:VEVENT", "END:VCALENDAR"
    ].join("\r\n");
    const blob = new Blob([icsContent], { type: "text/calendar" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `${title.replace(/\s+/g, "_")}.ics`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }
  // Función para sanitizar claves de Firebase (simplificada)
  const sanitizeFirebaseKey = (str) => str.replace(/[.#$[\]]/g, '_');


  /* ---------- 1.5. Manejo de conexión ---------- */
  const connectionStatus = document.getElementById("connection-status");
  let isOnline = navigator.onLine;
  function updateConnectionStatus() {
    isOnline = navigator.onLine;
    if (!isOnline) {
      connectionStatus.className = "offline";
      connectionStatus.textContent = "Sin conexión: Mostrando datos en caché";
      connectionStatus.style.display = "block";
    } else {
      connectionStatus.style.display = "none";
    }
  }
  window.addEventListener("online", updateConnectionStatus);
  window.addEventListener("offline", updateConnectionStatus);

  async function withRetry(fn, maxRetries = 3, delay = 2000) {
    for (let i = 0; i < maxRetries; i++) {
      try {
        if (!navigator.onLine) {
          connectionStatus.className = "offline";
          connectionStatus.textContent = "Sin conexión. Operación podría fallar o usar caché.";
          connectionStatus.style.display = "block";
        }
        return await fn();
      } catch (e) {
        console.error(`Intento ${i+1} fallido:`, e);
        if (i === maxRetries - 1 || !navigator.onLine) { // No reintentar si estamos offline o es el último intento
             connectionStatus.className = "offline";
             connectionStatus.textContent = "Error: Operación fallida. " + e.message;
             connectionStatus.style.display = "block";
             throw e;
        }
        connectionStatus.className = "retrying";
        connectionStatus.textContent = `Reintentando (${i + 1}/${maxRetries})...`;
        connectionStatus.style.display = "block";
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  }

  /* ---------- 2. Acceso Firestore ---------- */
  async function loadDoc(collection, docId, fallback) {
    try {
      const snap = await db.collection(collection).doc(docId).get();
      return snap.exists ? snap.data() : fallback;
    } catch (e) {
      console.error(`Error al cargar documento ${collection}/${docId}:`, e.message);
      throw new Error(`No se pudo cargar el documento ${collection}/${docId}: ${e.message}`);
    }
  }
  async function saveDoc(collection, docId, data, merge = false) {
    try {
      await db.collection(collection).doc(docId).set(data, { merge });
      return true;
    } catch (e) {
      console.error(`Error al guardar documento ${collection}/${docId}:`, e.message);
      throw new Error(`No se pudo guardar el documento ${collection}/${docId}: ${e.message}`);
    }
  }

  /* ---------- 3. Configuración Setlists ---------- */
  let setlistConfig = {
    setlistStar: { name: "Setlist Concierto Estrella", url: "URL_POR_CONFIGURAR_STAR" },
    setlist1: { name: "Setlist Próximo Ensayo", url: "https://cold-limit-811a.jagomezc.workers.dev" },
    setlist2: { name: "Setlist Próximo Concierto", url: "https://www.bandhelper.com/feed/set_list/TXHvyb" }
  };

  function updateTitles() {
    document.getElementById("star-setlist-title").textContent = setlistConfig.setlistStar.name;
    document.getElementById("star-setlist-name").textContent = ""; // O algún subtítulo si se desea
    document.getElementById("setlist1-title").textContent = setlistConfig.setlist1.name;
    document.getElementById("second-setlist-name").textContent = setlistConfig.setlist2.name; // Este es el subtítulo
  }

  async function loadSetlistConfig() {
    try {
      const data = await withRetry(() => loadDoc("intranet", "setlists", { config: setlistConfig }));
      // Asegurar que todos los setlists tengan entrada en config, incluso si se añaden nuevos
      setlistConfig = {
          setlistStar: data.config?.setlistStar || setlistConfig.setlistStar,
          setlist1: data.config?.setlist1 || setlistConfig.setlist1,
          setlist2: data.config?.setlist2 || setlistConfig.setlist2,
      };
      updateTitles();
    } catch (e) {
      console.error("Error al cargar la configuración de setlists:", e);
      // No relanzar, permitir que la app continúe con config por defecto
    }
  }

  async function saveSetlistConfig() {
    updateTitles(); // Actualiza títulos principales por si cambiaron
    return await withRetry(() => saveDoc("intranet", "setlists", { config: setlistConfig }));
  }
  
  /* ---------- 3.5. Setlist Concierto Estrella ---------- */
  async function cargarStarSetlist() {
    try {
      if (!setlistConfig.setlistStar.url || setlistConfig.setlistStar.url === "URL_POR_CONFIGURAR_STAR") {
        throw new Error("URL del Setlist Concierto Estrella no configurada.");
      }
      const response = await fetch(setlistConfig.setlistStar.url);
      if (!response.ok) throw new Error(`Error en la respuesta de la API para Setlist Estrella: ${response.statusText}`);
      const data = await response.json();
      const songs = Array.isArray(data) ? data.filter(i => i.type === "song") : (data.items || []).filter(i => i.type === "song"); // Adaptar a posible estructura del JSON
      
      const tbody = document.getElementById("star-setlist-body");
      tbody.innerHTML = "";
      let total = 0;
      songs.forEach((s, i) => {
        const secs = parseDuration(s.duration || "0");
        total += secs;
        tbody.insertAdjacentHTML("beforeend",
          `<tr><td>${i + 1}</td><td>${clean(s.name || "Sin título")}</td><td>${clean(s.key || "-")}</td><td>${clean(s.tempo || "-")}</td><td>${toMMSS(secs)}</td></tr>`
        );
      });
      document.getElementById("total-time-star").textContent = "Tiempo total del set: " + toHHMM(total);
      return songs;
    } catch (e) {
      console.error("Error cargando Setlist Concierto Estrella:", e);
      document.getElementById("star-setlist-body").innerHTML =
        `<tr><td colspan="5">No se pudo cargar el Setlist Concierto Estrella. ${e.message}</td></tr>`;
      document.getElementById("total-time-star").textContent = "";
      return [];
    }
  }


  /* ---------- 4. Primer Setlist (Ensayo) ---------- */
  async function cargarPrimerSetlist() {
    try {
      if (!setlistConfig.setlist1.url || setlistConfig.setlist1.url === "URL_POR_CONFIGURAR_1") {
        throw new Error("URL del Setlist Próximo Ensayo no configurada.");
      }
      const response = await fetch(setlistConfig.setlist1.url);
      if (!response.ok) throw new Error(`Error en la respuesta de la API para Setlist Ensayo: ${response.statusText}`);
      const data = await response.json();
      const songs = Array.isArray(data) ? data.filter(i => i.type === "song") : (data.items || []).filter(i => i.type === "song");

      const tbody = document.getElementById("setlist-body");
      tbody.innerHTML = "";
      let total = 0;
      songs.forEach((s, i) => {
        const secs = parseDuration(s.duration);
        total += secs;
        tbody.insertAdjacentHTML("beforeend",
          `<tr><td>${i + 1}</td><td>${s.name || ""}</td><td>${s.key || ""}</td><td>${s.tempo || ""}</td><td>${toMMSS(secs)}</td></tr>`);
      });
      document.getElementById("total-time").textContent = "Tiempo total del set: " + toHHMM(total);
      return songs;
    } catch (e) {
      console.error("Error cargando primer setlist (ensayo):", e);
      document.getElementById("setlist-body").innerHTML =
        `<tr><td colspan="5">Error al cargar el setlist de ensayo. ${e.message}</td></tr>`;
      return [];
    }
  }

  /* ---------- 5. Segundo Setlist (Próximo Concierto) ---------- */
  async function cargarSegundoSetlist() {
    try {
      if (!setlistConfig.setlist2.url || setlistConfig.setlist2.url === "URL_POR_CONFIGURAR_2") {
        throw new Error("URL del Setlist Próximo Concierto no configurada.");
      }
      const response = await fetch(setlistConfig.setlist2.url);
      if (!response.ok) throw new Error(`Error en la respuesta de la API para Setlist Próximo Concierto: ${response.statusText}`);
      const data = await response.json();
      const songs = Array.isArray(data) ? data.filter(i => i.type === "song") : (data.items || []).filter(i => i.type === "song");
      
      const tbody = document.getElementById("second-body");
      tbody.innerHTML = "";
      let total = 0;
      songs.forEach((s, i) => {
        const secs = parseDuration(s.duration || "0");
        total += secs;
        tbody.insertAdjacentHTML("beforeend",
          `<tr><td>${i + 1}</td><td>${clean(s.name || "Sin título")}</td><td>${clean(s.key || "-")}</td><td>${clean(s.tempo || "-")}</td><td>${toMMSS(secs)}</td></tr>`
        );
      });
      document.getElementById("total-time-2").textContent = "Tiempo total del set: " + toHHMM(total);
      return songs;
    } catch (e) {
      console.error("Error cargando segundo setlist (próximo concierto):", e);
      document.getElementById("second-body").innerHTML =
        `<tr><td colspan="5">No se pudo cargar el setlist del próximo concierto. ${e.message}</td></tr>`;
      document.getElementById("total-time-2").textContent = "";
      return [];
    }
  }

  /* ---------- 6. Usuarios ---------- */
  let users = [];
  let editingUserIndex = null;

  function renderUsers() {
    const tbody = document.getElementById("user-table-body");
    const mainUsersBody = document.getElementById("users-body"); // Corregido: users-body, no main
    if (!tbody || !mainUsersBody) {
        console.error("Tablas de usuarios no encontradas en el DOM.");
        return;
    }
    tbody.innerHTML = mainUsersBody.innerHTML = ""; // Limpiar ambas tablas

    if (!Array.isArray(users) || users.length === 0) {
        const emptyMsg = '<tr><td colspan="4">No hay usuarios registrados.</td></tr>';
        tbody.innerHTML = emptyMsg;
        mainUsersBody.innerHTML = emptyMsg;
        return;
    }

    users.forEach((u, i) => {
      if (!u || typeof u !== 'object' || !u.name || !u.nickname || !Array.isArray(u.roles)) {
        console.warn(`Usuario inválido en la posición ${i}:`, u);
        return;
      }
      const rolesDisplay = u.roles.join(", ");
      tbody.insertAdjacentHTML("beforeend",
        `<tr>
          <td>${u.name}</td><td>${u.nickname}</td><td>${rolesDisplay}</td>
          <td><button data-i="${i}" class="edit-user">Editar</button><button data-i="${i}" class="delete-user">Eliminar</button></td>
        </tr>`);
      mainUsersBody.insertAdjacentHTML("beforeend", // Para la tabla de visualización principal
        `<tr><td>${u.name}</td><td>${u.nickname}</td><td>${rolesDisplay}</td></tr>`);
    });

    tbody.querySelectorAll(".delete-user").forEach(btn =>
      btn.onclick = async () => {
        const userIndex = parseInt(btn.dataset.i, 10);
        const userToDelete = users[userIndex];
        if (confirm(`¿Estás seguro de que deseas eliminar al usuario "${userToDelete.name}"? Esto también eliminará sus asistencias asociadas a ensayos y conciertos.`)) {
          // Actualizar asistencias en ensayos para eliminar al usuario
          rehearsals.forEach(r => {
            if (Array.isArray(r.attendance)) {
              r.attendance = r.attendance.filter(a => a.name !== userToDelete.name);
            }
          });
          // (Opcional) Actualizar asistencias en detalles de conciertos si se implementa
          // Esto requeriría cargar todos los concert_details, modificarlos y guardarlos, puede ser intensivo.
          // Por ahora, solo se actualiza en ensayos.

          users.splice(userIndex, 1);
          await saveUsers(); // Guarda la lista de usuarios actualizada
          await saveRehearsals(); // Guarda los ensayos con las asistencias actualizadas
          renderStats();
        }
      });

    tbody.querySelectorAll(".edit-user").forEach(btn =>
      btn.onclick = () => {
        editingUserIndex = parseInt(btn.dataset.i, 10);
        const user = users[editingUserIndex];
        document.getElementById("user-name").value = user.name;
        document.getElementById("user-nickname").value = user.nickname;
        const roleSelect = document.getElementById("user-role");
        Array.from(roleSelect.options).forEach(option => {
          option.selected = user.roles.includes(option.value);
        });
        document.getElementById("add-user").textContent = "Guardar Cambios";
        document.getElementById("cancel-edit-user").style.display = "inline-block";
      });
  }

  async function loadUsers() {
    try {
      const data = await withRetry(() => loadDoc("intranet", "users", { users: [] }));
      users = Array.isArray(data.users) ? data.users : [];
      users = users.filter(u => u && typeof u === 'object' && u.name && u.nickname && Array.isArray(u.roles));
      renderUsers();
    } catch (e) {
      console.error("Error al cargar usuarios:", e);
      // No relanzar, permitir que la app continúe
    }
  }

  async function saveUsers() {
    try {
      await withRetry(() => saveDoc("intranet", "users", { users }));
      renderUsers(); // Re-renderiza la tabla de usuarios en config y en principal
      renderRehearsals(); // Re-renderiza ensayos por si los nombres de usuario en asistencia deben actualizarse
      renderStats();
      return true;
    } catch (e) {
      console.error("Error al guardar usuarios:", e);
      throw e; // Relanzar para que se maneje en el вызывающем código (ej. mostrar mensaje)
    }
  }

  function resetUserForm() {
    document.getElementById("user-name").value = "";
    document.getElementById("user-nickname").value = "";
    const roleSelect = document.getElementById("user-role");
    Array.from(roleSelect.options).forEach(option => option.selected = false);
    document.getElementById("add-user").textContent = "Añadir Usuario";
    document.getElementById("cancel-edit-user").style.display = "none";
    editingUserIndex = null;
  }

  /* ---------- 7. Ensayos ---------- */
  let rehearsals = [];
  let editingRehearsalIndex = null;

  function renderRehearsals() {
    const tbodyConfig = document.getElementById("rehearsal-table-body");
    const tbodyMain = document.getElementById("rehearsal-main-body");

    if (!tbodyConfig || !tbodyMain) {
        console.error("Tablas de ensayos no encontradas en el DOM.");
        return;
    }
    
    rehearsals.sort((a, b) => new Date(a.date + 'T' + (a.startTime || '00:00')) - new Date(b.date + 'T' + (b.startTime || '00:00')));
    tbodyConfig.innerHTML = tbodyMain.innerHTML = "";

    if (!Array.isArray(rehearsals) || rehearsals.length === 0) {
        const emptyMsg = '<tr><td colspan="6">No hay ensayos programados.</td></tr>';
        tbodyConfig.innerHTML = emptyMsg;
        tbodyMain.innerHTML = '<tr><td colspan="4">No hay próximos ensayos.</td></tr>';
        return;
    }
    
    const userOptions = users.length > 0
      ? users.map(user => `<option value="${user.name}">${user.nickname || user.name}</option>`).join("")
      : `<option value="" disabled>No hay usuarios registrados</option>`;

    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

    rehearsals.forEach((r, i) => {
      if (r.time && (!r.startTime || !r.endTime)) { // Migración de datos antiguos
        r.startTime = r.time;
        const [hours, minutes] = r.time.split(":").map(Number);
        const endHours = (hours + 2) % 24;
        r.endTime = `${String(endHours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}`;
        delete r.time;
      }

      const formattedDate = formatDateWithDay(r.date);
      const durationSeconds = calculateDuration(r.startTime, r.endTime);
      const durationText = toHHMM(durationSeconds);
      const attendance = Array.isArray(r.attendance) ? r.attendance : [];
      const getAttendeeNicknames = (status) => attendance
        .filter(a => a.attending === status)
        .map(a => {
          const user = users.find(u => u.name === a.name);
          return user ? user.nickname : a.name;
        })
        .join(", ") || "Ninguno";

      const summary = `
        <div class="attendance-summary">
          <span class="attending-yes">Asisten: ${getAttendeeNicknames("Sí")}</span>
          <span class="attending-no">No asisten: ${getAttendeeNicknames("No")}</span>
        </div>`;

      tbodyConfig.insertAdjacentHTML("beforeend",
        `<tr>
          <td>${r.date}</td><td>${r.startTime}</td><td>${r.endTime}</td><td>${r.location}</td>
          <td>${summary}</td>
          <td>
            <button data-i="${i}" class="edit-rehearsal">Editar</button>
            <button data-i="${i}" class="clear-attendance">Eliminar Asistentes</button>
            <button data-i="${i}" class="delete-rehearsal">Eliminar</button>
          </td>
        </tr>`);

      const rehearsalDate = new Date(r.date + 'T00:00:00');
      if (rehearsalDate >= today) {
        tbodyMain.insertAdjacentHTML("beforeend",
          `<tr>
            <td>${formattedDate} <span class="rehearsal-duration">(${durationText})</span></td>
            <td>${r.startTime} - ${r.endTime}</td>
            <td>
              ${r.location}
              <button class="calendar-btn" title="Añadir a mi calendario" onclick='generateICS("Ensayo El Sótano del Doctor", "${r.date}", "${r.startTime}", "${r.location}", "Ensayo de la banda El Sótano del Doctor", ${durationSeconds})'>
                <svg viewBox="0 0 24 24"><path d="M12 4V2m0 20v-2m8-8h2m-20 0h-2m15.071-3.071l-1.414-1.414M5.343 17.657l-1.414-1.414m0-10.486l1.414-1.414m12.728 12.728l-1.414 1.414"/><rect x="4" y="6" width="16" height="12" rx="2"/></svg>
              </button>
            </td>
            <td>
              <div class="attendance-form">
                <select class="attendance-user" data-i="${i}"><option value="" disabled selected>¿Nombre?</option>${userOptions}</select>
                <select class="attendance-response" data-i="${i}"><option value="" disabled selected>¿Asistirás?</option><option value="Sí">Sí</option><option value="No">No</option></select>
                <button class="confirm-attendance" data-i="${i}">Confirmar</button>
              </div>
              ${summary}
            </td>
          </tr>`);
      }
    });

    tbodyConfig.querySelectorAll(".edit-rehearsal").forEach(btn =>
      btn.onclick = () => {
        editingRehearsalIndex = parseInt(btn.dataset.i, 10);
        const rehearsal = rehearsals[editingRehearsalIndex];
        document.getElementById("rehearsal-date").value = rehearsal.date;
        document.getElementById("rehearsal-start-time").value = rehearsal.startTime;
        document.getElementById("rehearsal-end-time").value = rehearsal.endTime;
        document.getElementById("rehearsal-location").value = rehearsal.location;
        document.getElementById("add-rehearsal").textContent = "Guardar Cambios";
        document.getElementById("cancel-edit-rehearsal").style.display = "inline-block";
      });

    tbodyConfig.querySelectorAll(".delete-rehearsal").forEach(btn =>
      btn.onclick = async () => {
        if (confirm("¿Estás seguro de que deseas eliminar este ensayo? Esto también eliminará todas las asistencias asociadas.")) {
          rehearsals.splice(parseInt(btn.dataset.i, 10), 1);
          await saveRehearsals();
          renderStats();
        }
      });

    tbodyConfig.querySelectorAll(".clear-attendance").forEach(btn =>
      btn.onclick = async () => {
        const index = parseInt(btn.dataset.i, 10);
        const rehearsal = rehearsals[index];
        const formattedDate = formatDateWithDay(rehearsal.date);
        if (confirm(`¿Estás seguro de que deseas eliminar todas las asistencias para el ensayo del día ${formattedDate} a las ${rehearsal.startTime} en ${rehearsal.location}?`)) {
          rehearsal.attendance = [];
          await saveRehearsals();
          document.getElementById("rehearsal-message").textContent = "Asistencias eliminadas.";
          renderStats();
        }
      });

    tbodyMain.querySelectorAll(".confirm-attendance").forEach(btn => {
      btn.onclick = async () => {
        const index = parseInt(btn.dataset.i, 10);
        const userSelect = document.querySelector(`.attendance-user[data-i="${index}"]`);
        const responseSelect = document.querySelector(`.attendance-response[data-i="${index}"]`);
        const name = userSelect.value;
        const attending = responseSelect.value;

        if (!name || !attending) { alert("Selecciona nombre y respuesta."); return; }

        const rehearsal = rehearsals[index];
        const formattedDate = formatDateWithDay(rehearsal.date);
        const confirmMsg = `${name}, ¿${attending === "Sí" ? "ASISTIRÁS" : "NO ASISTIRÁS"} al ensayo del ${formattedDate} (${rehearsal.startTime} - ${rehearsal.endTime}) en ${rehearsal.location}?`;
        
        if (!confirm(confirmMsg)) return;

        if (!Array.isArray(rehearsal.attendance)) rehearsal.attendance = [];
        const existingResponse = rehearsal.attendance.find(a => a.name === name);
        if (existingResponse) existingResponse.attending = attending;
        else rehearsal.attendance.push({ name, attending });

        try {
          await saveRehearsals();
          userSelect.value = ""; responseSelect.value = "";
          renderStats();
        } catch (e) { alert("Error al guardar asistencia: " + e.message); }
      };
    });
  }

  async function loadRehearsals() {
    try {
      const data = await withRetry(() => loadDoc("intranet", "rehearsals", { rehearsals: [] }));
      rehearsals = Array.isArray(data.rehearsals) ? data.rehearsals : [];
      renderRehearsals();
    } catch (e) {
      console.error("Error al cargar ensayos:", e);
      // No relanzar, app puede continuar
    }
  }

  async function saveRehearsals() {
    try {
      await withRetry(() => saveDoc("intranet", "rehearsals", { rehearsals }));
      renderRehearsals();
      renderStats();
      return true;
    } catch (e) {
      console.error("Error al guardar ensayos:", e);
      throw e;
    }
  }
  
  function resetRehearsalForm() {
    document.getElementById("rehearsal-date").value = "";
    document.getElementById("rehearsal-start-time").value = "";
    document.getElementById("rehearsal-end-time").value = "";
    document.getElementById("rehearsal-location").value = "";
    document.getElementById("add-rehearsal").textContent = "Añadir Ensayo";
    document.getElementById("cancel-edit-rehearsal").style.display = "none";
    editingRehearsalIndex = null;
  }

  /* ---------- 8. Estadísticas ---------- */
  function updateMonthFilter() {
    const select = document.getElementById("stats-month-filter");
    select.innerHTML = '<option value="all">Todos los meses</option>';
    const now = new Date();
    const pastRehearsals = rehearsals.filter(r => new Date(r.date + 'T00:00:00') < now);
    const months = new Set(pastRehearsals.map(r => getMonthYear(r.date)));
    Array.from(months).sort((a,b) => new Date(b.split(" ")[1], getMonthIndex(b.split(" ")[0])) - new Date(a.split(" ")[1], getMonthIndex(a.split(" ")[0])) ).forEach(month => { // Sort reverse chrono
        select.insertAdjacentHTML("beforeend", `<option value="${month}">${month}</option>`);
    });
  }
  function getMonthIndex(monthName) {
    const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    return months.indexOf(monthName);
  }


  function renderStats() {
    const now = new Date();
    const selectedMonth = document.getElementById("stats-month-filter")?.value || "all";
    let filteredRehearsals = rehearsals.filter(r => new Date(r.date + 'T00:00:00') < now);
    if (selectedMonth !== "all") {
      filteredRehearsals = filteredRehearsals.filter(r => getMonthYear(r.date) === selectedMonth);
    }

    const timePerMonth = {};
    filteredRehearsals.forEach(r => {
      const monthYear = getMonthYear(r.date);
      const duration = calculateDuration(r.startTime, r.endTime);
      timePerMonth[monthYear] = (timePerMonth[monthYear] || 0) + duration;
    });
    const tbodyMonth = document.getElementById("time-per-month-body");
    tbodyMonth.innerHTML = "";
    Object.keys(timePerMonth).sort((a,b) => new Date(b.split(" ")[1], getMonthIndex(b.split(" ")[0])) - new Date(a.split(" ")[1], getMonthIndex(a.split(" ")[0])) ).forEach(month => {
      tbodyMonth.insertAdjacentHTML("beforeend", `<tr><td>${month}</td><td>${toHours(timePerMonth[month])}</td></tr>`);
    });

    const timePerUser = {};
    users.forEach(user => {
      timePerUser[user.name] = 0;
      filteredRehearsals.forEach(r => {
        const attendance = r.attendance?.find(a => a.name === user.name);
        if (attendance && attendance.attending === "Sí") {
          timePerUser[user.name] += calculateDuration(r.startTime, r.endTime);
        }
      });
    });
    const tbodyUser = document.getElementById("time-per-user-body");
    tbodyUser.innerHTML = "";
    Object.keys(timePerUser).sort().forEach(user => {
      tbodyUser.insertAdjacentHTML("beforeend", `<tr><td>${users.find(u=>u.name===user)?.nickname || user}</td><td>${toHours(timePerUser[user])}</td></tr>`);
    });

    const tbodyPast = document.getElementById("past-rehearsals-body");
    tbodyPast.innerHTML = "";
    filteredRehearsals.sort((a, b) => new Date(b.date + 'T' + (b.startTime || '00:00')) - new Date(a.date + 'T' + (a.startTime || '00:00')));
    filteredRehearsals.forEach(r => {
      const formattedDate = formatDateWithDay(r.date);
      const durationText = toHHMM(calculateDuration(r.startTime, r.endTime));
      const attendance = Array.isArray(r.attendance) ? r.attendance : [];
      const getAttendeeNicknames = (status) => attendance
        .filter(a => a.attending === status)
        .map(a => {
          const user = users.find(u => u.name === a.name);
          return user ? user.nickname : a.name;
        })
        .join(", ") || "Ninguno";
      const summary = `<div class="attendance-summary"><span class="attending-yes">Asisten: ${getAttendeeNicknames("Sí")}</span><span class="attending-no">No asisten: ${getAttendeeNicknames("No")}</span></div>`;
      tbodyPast.insertAdjacentHTML("beforeend",
        `<tr><td>${formattedDate} <span class="rehearsal-duration">(${durationText})</span></td><td>${r.startTime} - ${r.endTime}</td><td>${r.location}</td><td>${summary}</td></tr>`);
    });
  }

  /* ---------- 9. PDF ---------- */
  async function genPDF(songs, title, fileName) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "A4" });
    try {
      const blob = await (await fetch("assets/logo_negro copia.jpg")).blob(); // Asegúrate que la ruta al logo sea correcta
      const base = await new Promise((ok, ko) => {
        const r = new FileReader(); r.onload = () => ok(r.result); r.onerror = ko; r.readAsDataURL(blob);
      });
      doc.addImage(base, "JPEG", 40, 30, 60, 60);
    } catch (e) { console.error("Error al cargar el logo para el PDF:", e); }
    doc.setFontSize(16); doc.text(`Setlist - ${title}`, 120, 50);
    const totalTime = toHHMM(songs.reduce((a, s) => a + parseDuration(s.duration), 0)); // Usar toHHMM para consistencia
    doc.setFontSize(12); doc.text(`${songs.length} canciones, ${totalTime} total`, 120, 70);
    doc.autoTable({
      startY: 100,
      head: [["#", "Título", "Tonalidad", "Tempo", "Duración"]],
      body: songs.map((s, i) => [i + 1, s.name || "", s.key || "", s.tempo || "", toMMSS(parseDuration(s.duration))]),
      headStyles: { fillColor: [60, 60, 60], textColor: [255, 255, 255], fontStyle: "bold" },
      styles: { fontSize: 10, cellPadding: 5 }
    });
    doc.save(fileName);
  }

  /* ---------- 10. Modificar tabla de BandHelper y Detalles del Concierto ---------- */
  function modifyBandHelperTable() {
    const bandHelperContainer = document.querySelector("#bandhelper-concerts");
    if (!bandHelperContainer) {
      console.error("Contenedor de BandHelper no encontrado.");
      return;
    }
    
    // Cargar el script de BandHelper si aún no está cargado
    if (!bandHelperContainer.querySelector('script') && !bandHelperContainer.querySelector('table')) {
        const script = document.createElement('script');
        script.src = "https://www.bandhelper.com/widget/calendar/10353?layout=1&range=6";
        script.onload = () => processBandHelperTable(bandHelperContainer);
        script.onerror = () => console.error("Error al cargar el widget de BandHelper.");
        bandHelperContainer.appendChild(script);
    } else if (bandHelperContainer.querySelector('table')) {
        processBandHelperTable(bandHelperContainer);
    } else { // Script está, pero tabla aún no. Reintentar.
        setTimeout(() => modifyBandHelperTable(), 500);
    }
  }

  function processBandHelperTable(container) {
    const table = container.querySelector("table");
    if (!table) {
      setTimeout(() => processBandHelperTable(container), 500); // Reintentar si la tabla no está lista
      return;
    }

    // Añadir cabecera de "Detalles" si no existe
    const headerRow = table.querySelector("thead tr");
    if (headerRow && !headerRow.querySelector(".details-header")) {
        const th = document.createElement("th");
        th.className = "details-header";
        th.textContent = "Detalles";
        headerRow.appendChild(th);
    }

    const rows = table.querySelectorAll("tbody tr");
    rows.forEach((row, index) => {
      const cells = row.querySelectorAll("td");
      if (cells.length < 3) return; // Fecha, Hora, Lugar como mínimo

      // Añadir celda de "Detalles" si no existe
      if (cells.length === (headerRow.cells.length -1) ) { // Si falta la última celda (Detalles)
          const detailCell = row.insertCell(-1); // Añadir al final
          detailCell.style.textAlign = "center";

          const dateCellText = cells[0].textContent.trim();
          const eventNameText = cells[2].textContent.trim().split('\n')[0]; // Tomar solo la primera línea del lugar como nombre del evento
          // Crear un ID único para el concierto. Ejemplo: "2024-12-25_Concierto_Navidad"
          // Esto es crucial y debe ser consistente.
          const concertId = sanitizeFirebaseKey(`${dateCellText}_${eventNameText}`.replace(/\s+/g, '_'));
          
          const detailsBtn = document.createElement("button");
          detailsBtn.className = "details-btn";
          detailsBtn.innerHTML = "➡️"; // Flecha azul (estilada por CSS)
          detailsBtn.title = "Ver/Editar Detalles del Concierto";
          detailsBtn.onclick = () => openConcertDetailModal(concertId, dateCellText, eventNameText, cells[2].textContent.trim());
          detailCell.appendChild(detailsBtn);
      }

      // Lógica existente para botón de calendario
      const locationCell = cells[2]; // La celda de ubicación/evento
      let locationText = locationCell.textContent.trim().split('\n')[0] || "Lugar no especificado";
      if (!locationCell.querySelector('.calendar-btn')) { // Solo añadir si no existe ya
        const dateCellContent = cells[0].textContent.trim(); // Ej: "18 de Mayo"
        const timeCellContent = cells[1].textContent.trim() || "20:00"; // Ej: "22:00"
        
        // Intentar parsear la fecha para el .ics
        const dateParts = dateCellContent.match(/(\d+)\s+de\s+(\w+)/i);
        let icsDate = new Date().toISOString().split('T')[0]; // Fallback a hoy
        if (dateParts) {
            const day = dateParts[1];
            const monthName = dateParts[2];
            const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const month = months.findIndex(m => m.toLowerCase() === monthName.toLowerCase());
            if (month !== -1) {
                const year = new Date().getFullYear(); // Asumir año actual
                // Podría ser necesario ajustar el año si el mes ya pasó (para el próximo año)
                icsDate = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
            }
        }

        const calendarBtn = document.createElement('button');
        calendarBtn.className = 'calendar-btn';
        calendarBtn.title = 'Añadir a mi calendario';
        calendarBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 4V2m0 20v-2m8-8h2m-20 0h-2m15.071-3.071l-1.414-1.414M5.343 17.657l-1.414-1.414m0-10.486l1.414-1.414m12.728 12.728l-1.414 1.414"/><rect x="4" y="6" width="16" height="12" rx="2"/></svg>';
        calendarBtn.onclick = () => generateICS(`Concierto: ${eventNameText}`, icsDate, timeCellContent, locationText, `Concierto de El Sótano del Doctor en ${locationText}`);
        
        // Insertar el botón de calendario sin borrar el contenido existente
        const existingContent = locationCell.innerHTML;
        locationCell.innerHTML = existingContent + " "; // Añadir espacio
        locationCell.appendChild(calendarBtn);
      }
    });
  }


  const concertDetailModal = document.getElementById('concert-details-modal');
  const concertDetailMessage = document.getElementById('concert-detail-message');

  async function openConcertDetailModal(concertId, concertDate, concertTitle, concertLocationOriginal) {
    concertDetailMessage.textContent = "";
    document.getElementById('concert-detail-id').value = concertId;
    concertDetailModal.classList.add('show');
    
    // Limpiar campos del modal
    document.getElementById('concert-detail-location').value = '';
    document.getElementById('concert-detail-soundcheck').value = '';
    document.getElementById('concert-detail-showtime').value = '';
    document.getElementById('concert-detail-notes').value = '';
    
    const musiciansListDiv = document.getElementById('musicians-attendance-list');
    musiciansListDiv.innerHTML = 'Cargando músicos...';

    // Poblar lista de músicos
    if (users && users.length > 0) {
        musiciansListDiv.innerHTML = ''; // Limpiar "Cargando..."
        users.forEach(user => {
            const userDiv = document.createElement('div');
            const checkboxId = `user-att-${sanitizeFirebaseKey(user.nickname || user.name)}`;
            userDiv.innerHTML = `
                <input type="checkbox" id="${checkboxId}" name="concertAttendees" value="${user.nickname || user.name}">
                <label for="${checkboxId}">${user.name} (${user.nickname})</label>
            `;
            musiciansListDiv.appendChild(userDiv);
        });
    } else {
        musiciansListDiv.innerHTML = 'No hay músicos registrados para listar.';
    }

    // Cargar datos existentes de Firestore
    try {
        const details = await loadDoc('concert_details', concertId, {});
        if (details) {
            document.getElementById('concert-detail-location').value = details.locationDetails || '';
            document.getElementById('concert-detail-soundcheck').value = details.soundcheckTime || '';
            document.getElementById('concert-detail-showtime').value = details.showTime || '';
            document.getElementById('concert-detail-notes').value = details.generalNotes || '';
            
            // Marcar asistentes
            if (details.attendees && Array.isArray(details.attendees)) {
                details.attendees.forEach(attendeeName => {
                    const checkbox = musiciansListDiv.querySelector(`input[value="${attendeeName}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
        }
    } catch (error) {
        console.error("Error al cargar detalles del concierto:", error);
        concertDetailMessage.className = "error-message";
        concertDetailMessage.textContent = "Error al cargar detalles: " + error.message;
    }
  }

  document.getElementById('save-concert-details').onclick = async () => {
    const concertId = document.getElementById('concert-detail-id').value;
    if (!concertId) {
        concertDetailMessage.className = "error-message";
        concertDetailMessage.textContent = "Error: ID de concierto no encontrado.";
        return;
    }

    const selectedAttendees = [];
    document.querySelectorAll('#musicians-attendance-list input[type="checkbox"]:checked').forEach(checkbox => {
        selectedAttendees.push(checkbox.value); // Guardar nickname o nombre que se usó como value
    });

    const concertData = {
        locationDetails: document.getElementById('concert-detail-location').value.trim(),
        soundcheckTime: document.getElementById('concert-detail-soundcheck').value,
        showTime: document.getElementById('concert-detail-showtime').value,
        generalNotes: document.getElementById('concert-detail-notes').value.trim(),
        attendees: selectedAttendees
    };

    try {
        await saveDoc('concert_details', concertId, concertData, true); // Usar merge true para no borrar otros campos si existieran
        concertDetailMessage.className = "success-message";
        concertDetailMessage.textContent = "Detalles guardados correctamente.";
        setTimeout(() => concertDetailModal.classList.remove('show'), 1500);
    } catch (error) {
        console.error("Error al guardar detalles del concierto:", error);
        concertDetailMessage.className = "error-message";
        concertDetailMessage.textContent = "Error al guardar: " + error.message;
    }
  };

  document.getElementById('close-concert-details-modal').onclick = () => {
    concertDetailModal.classList.remove('show');
  };


  /* ---------- 11. Menú & pantallas ---------- */
  const sidebar = document.getElementById("sidebar-menu"), overlay = document.getElementById("overlay");
  const PASSWORD = "Sotano2014"; // Considera mover esto a una configuración más segura si es posible
  let isAuthenticated = false;

  function closeAll() {
    document.querySelectorAll(".config-screen, .modal-backdrop").forEach(s => s.classList.remove("show")); // Para modal
    document.querySelectorAll(".config-screen").forEach(s => s.style.display = "none"); // Para config screens
    
    sidebar.classList.remove("show");
    overlay.classList.remove("show");
    document.getElementById("config-submenu").style.display = "none";
    
    // Resetear formularios de config si existen
    if (typeof resetUserForm === "function") resetUserForm();
    if (typeof resetRehearsalForm === "function") resetRehearsalForm();
    // Limpiar mensajes de error/éxito en pantallas de config
    document.querySelectorAll("#user-message, #rehearsal-message, #setlist-message, #concert-detail-message").forEach(el => el.textContent = "");
  }

  document.getElementById("hamburger-btn").onclick = () => {
    sidebar.classList.add("show");
    overlay.classList.add("show");
  };
  document.getElementById("menu-cerrar").onclick = e => { e.preventDefault(); closeAll(); };
  overlay.onclick = closeAll;

  // Nuevos ítems de acceso directo (sin contraseña)
  const setupMenuLink = (menuId, targetId) => {
      const link = document.getElementById(menuId);
      if (link) {
          link.onclick = e => {
              e.preventDefault();
              closeAll();
              const targetElement = document.getElementById(targetId);
              if (targetElement) {
                  targetElement.scrollIntoView({ behavior: "smooth" });
              } else {
                  console.warn(`Elemento ${targetId} no encontrado para scroll.`);
              }
          };
      } else {
          console.warn(`Enlace de menú ${menuId} no encontrado.`);
      }
  };

  setupMenuLink("menu-star-setlist-section", "star-setlist");
  setupMenuLink("menu-rehearsals-setlist-section", "setlists"); // Enlace para Setlist Próximo Ensayo
  setupMenuLink("menu-second-setlist-section", "second-setlist");
  setupMenuLink("menu-rehearsals-section", "rehearsals");
  setupMenuLink("menu-concerts-section", "calendario");


  document.getElementById("menu-config").onclick = e => {
    e.preventDefault();
    if (!isAuthenticated) {
      const password = prompt("iDoctor Dice: ¡¡¡Si no sabes no toques!!! Pon la contraseña para acceder a la configuración:");
      if (password && password.toLowerCase() === PASSWORD.toLowerCase()) {
        isAuthenticated = true;
        document.getElementById("config-submenu").style.display = "block";
      } else { alert("Contraseña incorrecta. Acceso denegado."); return; }
    } else {
      document.getElementById("config-submenu").style.display = "block";
    }
  };

  const openConfigScreen = (screenId) => {
    if (!isAuthenticated) {
      const password = prompt("iDoctor Dice: ¡¡¡Si no sabes no toques!!! Pon la contraseña para acceder a la configuración:");
      if (password && password.toLowerCase() === PASSWORD.toLowerCase()) {
        isAuthenticated = true;
      } else { alert("Contraseña incorrecta. Acceso denegado."); return false; }
    }
    closeAll(); // Cierra otros modales/sidebar
    const screen = document.getElementById(screenId);
    if (screen) screen.style.display = "block";
    else console.error(`Pantalla de configuración ${screenId} no encontrada.`);
    return true;
  }

  document.getElementById("menu-setlist-config").onclick = e => {
    e.preventDefault();
    if (openConfigScreen("setlist-config-screen")) {
        document.getElementById("setlistStar-name").value = setlistConfig.setlistStar.name;
        document.getElementById("setlistStar-url").value = setlistConfig.setlistStar.url === "URL_POR_CONFIGURAR_STAR" ? "" : setlistConfig.setlistStar.url;
        document.getElementById("setlist1-name").value = setlistConfig.setlist1.name;
        document.getElementById("setlist1-url").value = setlistConfig.setlist1.url === "URL_POR_CONFIGURAR_1" ? "" : setlistConfig.setlist1.url;
        document.getElementById("setlist2-name").value = setlistConfig.setlist2.name;
        const setlist2UrlInput = setlistConfig.setlist2.url.replace("https://www.bandhelper.com/feed/set_list/", "");
        document.getElementById("setlist2-url").value = setlist2UrlInput === "URL_POR_CONFIGURAR_2" ? "" : setlist2UrlInput;
    }
  };
  document.getElementById("close-setlist-config").onclick = () => {
    document.getElementById("setlist-config-screen").style.display = "none";
    document.getElementById("setlist-message").textContent = "";
  };
  document.getElementById("guardar-setlist-config").onclick = async () => {
    const setlistMessage = document.getElementById("setlist-message");
    setlistMessage.textContent = "";
    
    const nStar = document.getElementById("setlistStar-name").value.trim();
    const uStar = document.getElementById("setlistStar-url").value.trim();
    const n1 = document.getElementById("setlist1-name").value.trim();
    const u1 = document.getElementById("setlist1-url").value.trim();
    const n2 = document.getElementById("setlist2-name").value.trim();
    const raw2 = document.getElementById("setlist2-url").value.trim();

    if (!nStar || !uStar || !n1 || !u1 || !n2 || !raw2) {
      setlistMessage.className = "error-message";
      setlistMessage.textContent = "Completa todos los campos para los tres setlists";
      return;
    }
    try {
      setlistConfig.setlistStar = { name: nStar, url: uStar };
      setlistConfig.setlist1 = { name: n1, url: u1 };
      setlistConfig.setlist2 = { name: n2, url: raw2.startsWith("http") ? raw2 : `https://www.bandhelper.com/feed/set_list/${raw2}` };
      
      await saveSetlistConfig();
      await Promise.all([cargarStarSetlist(), cargarPrimerSetlist(), cargarSegundoSetlist()]);
      
      document.getElementById("setlist-config-screen").style.display = "none";
      // No mostrar mensaje de éxito aquí, se cierra la pantalla. Podría mostrarse en la principal si es necesario.
    } catch (e) {
      setlistMessage.className = "error-message";
      setlistMessage.textContent = "Error al guardar configuración: " + e.message;
    }
  };

  document.getElementById("menu-user-mgmt").onclick = e => { e.preventDefault(); openConfigScreen("user-mgmt-screen"); };
  document.getElementById("close-user-mgmt").onclick = () => {
    document.getElementById("user-mgmt-screen").style.display = "none";
    document.getElementById("user-message").textContent = "";
    resetUserForm();
  };
  document.getElementById("add-user").onclick = async () => {
    const userMessage = document.getElementById("user-message");
    userMessage.textContent = "";
    const name = document.getElementById("user-name").value.trim();
    const nickname = document.getElementById("user-nickname").value.trim();
    const roles = Array.from(document.getElementById("user-role").selectedOptions).map(o => o.value);

    if (!name || !nickname || roles.length === 0) {
      userMessage.className = "error-message";
      userMessage.textContent = "Nombre, apodo y al menos un rol son obligatorios.";
      return;
    }
    try {
      if (editingUserIndex !== null) {
        const oldName = users[editingUserIndex].name;
        users[editingUserIndex] = { name, nickname, roles };
        if (oldName !== name) { // Si el nombre cambió, actualizar en asistencias
          rehearsals.forEach(r => {
            if (Array.isArray(r.attendance)) {
              r.attendance.forEach(a => { if (a.name === oldName) a.name = name; });
            }
          });
          await saveRehearsals(); // Guardar ensayos con nombres actualizados
        }
        userMessage.textContent = "Usuario actualizado.";
      } else {
        users.push({ name, nickname, roles });
        userMessage.textContent = "Usuario añadido.";
      }
      await saveUsers();
      userMessage.className = "success-message";
      resetUserForm();
    } catch (e) {
      userMessage.className = "error-message";
      userMessage.textContent = "Error al guardar usuario: " + e.message;
    }
  };
  document.getElementById("cancel-edit-user").onclick = () => { resetUserForm(); document.getElementById("user-message").textContent = ""; };

  document.getElementById("menu-rehearsal").onclick = e => { e.preventDefault(); openConfigScreen("rehearsal-screen"); };
  document.getElementById("close-rehearsal").onclick = () => {
    document.getElementById("rehearsal-screen").style.display = "none";
    document.getElementById("rehearsal-message").textContent = "";
    resetRehearsalForm();
  };
  document.getElementById("add-rehearsal").onclick = async () => {
    const msgEl = document.getElementById("rehearsal-message");
    msgEl.textContent = "";
    const date = document.getElementById("rehearsal-date").value;
    const startTime = document.getElementById("rehearsal-start-time").value;
    const endTime = document.getElementById("rehearsal-end-time").value;
    const loc = document.getElementById("rehearsal-location").value.trim();

    if (!date || !startTime || !endTime || !loc) {
      msgEl.className = "error-message"; msgEl.textContent = "Completa todos los campos."; return;
    }
    if (calculateDuration(startTime, endTime) <= 0) {
      msgEl.className = "error-message"; msgEl.textContent = "Hora de fin debe ser posterior a inicio."; return;
    }
    try {
      const newRehearsalData = { date, startTime, endTime, location: loc, attendance: [] };
      if (editingRehearsalIndex !== null) {
        newRehearsalData.attendance = rehearsals[editingRehearsalIndex].attendance || []; // Conservar asistencias al editar
        rehearsals[editingRehearsalIndex] = newRehearsalData;
        msgEl.textContent = "Ensayo actualizado.";
      } else {
        rehearsals.push(newRehearsalData);
        msgEl.textContent = "Ensayo añadido.";
      }
      await saveRehearsals();
      msgEl.className = "success-message";
      resetRehearsalForm();
    } catch (e) {
      msgEl.className = "error-message"; msgEl.textContent = "Error al guardar ensayo: " + e.message;
    }
  };
  document.getElementById("cancel-edit-rehearsal").onclick = () => { resetRehearsalForm(); document.getElementById("rehearsal-message").textContent = ""; };

  document.getElementById("menu-stats").onclick = e => {
    e.preventDefault();
    if (openConfigScreen("stats-screen")) {
      updateMonthFilter(); renderStats();
    }
  };
  document.getElementById("close-stats").onclick = () => document.getElementById("stats-screen").style.display = "none";
  document.getElementById("stats-month-filter").addEventListener("change", renderStats);

  /* ---------- 12. Carga inicial ---------- */
  document.addEventListener("DOMContentLoaded", async () => {
    updateConnectionStatus();

    try {
        await Promise.all([loadSetlistConfig(), loadUsers(), loadRehearsals()]);
    } catch (e) {
        console.error("Error en la carga inicial de datos de Firestore:", e);
        // La app intentará continuar con datos por defecto o caché. Los errores ya se muestran en consola.
    }

    let songsStar = [], songs1 = [], songs2 = [];
    try { songsStar = await cargarStarSetlist(); } catch (e) { console.error("Fallo al cargar Setlist Estrella:", e); }
    try { songs1 = await cargarPrimerSetlist(); } catch (e) { console.error("Fallo al cargar primer setlist (ensayo):", e); }
    try { songs2 = await cargarSegundoSetlist(); } catch (e) { console.error("Fallo al cargar segundo setlist (concierto):", e); }

    document.getElementById("download-btn-star").onclick = () => {
      if (songsStar.length > 0) genPDF(songsStar, setlistConfig.setlistStar.name, "setlist_estrella.pdf");
      else alert("No hay canciones en Setlist Estrella para PDF.");
    };
    document.getElementById("download-btn").onclick = () => {
      if (songs1.length > 0) genPDF(songs1, setlistConfig.setlist1.name, "setlist_ensayos.pdf");
      else alert("No hay canciones en Setlist Ensayo para PDF.");
    };
    document.getElementById("download-btn-2").onclick = () => {
      if (songs2.length > 0) genPDF(songs2, setlistConfig.setlist2.name, "setlist_concierto.pdf");
      else alert("No hay canciones en Setlist Concierto para PDF.");
    };

    modifyBandHelperTable(); // Iniciar modificación de tabla de BandHelper
  });
  </script>
</body>
</html>
