<!DOCTYPE html>
<html lang="es">
<head>
Â  <meta name="apple-mobile-web-app-capable" content="yes">
Â  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
Â  <meta name="apple-mobile-web-app-title" content="El SÃ³tano">
Â  <link rel="manifest" href="manifest.json">
Â  Â 
Â  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
Â  <meta charset="UTF-8" />
Â  <title>El SÃ³tano del Doctor â€“ Intranet</title>

Â  <link rel="icon" type="image/x-icon" href="assets/favicon_ElSotanoDr.ico">
Â  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">

Â  <meta property="og:title"Â  Â  Â  Â  content="El SÃ³tano del Doctor â€“ Intranet">
Â  <meta property="og:description"Â  content="Banda de rock y versiones. Intranet de gestiÃ³n.">
Â  <meta property="og:image"Â  Â  Â  Â  content="assets/logo_negro copia.jpg">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">

Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

Â  <style>
Â  Â  *,*::before,*::after{box-sizing:border-box}
Â  Â Â 
Â  Â  /* FONDO CON PROFUNDIDAD */
Â  Â  html,body {
Â  Â  Â  Â  margin:0; padding:0; overflow-x:hidden;Â 
Â  Â  Â  Â  font-family:Arial,Helvetica,sans-serif;Â 
Â  Â  Â  Â  background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
Â  Â  Â  Â  background-attachment: fixed;
Â  Â  Â  Â  color:#fff;
Â  Â  }
Â  Â Â 
Â  Â  /* ---------- Splash Screen ---------- */
Â  Â  #splash-screen {
Â  Â  Â  position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
Â  Â  Â  background-color: #000000; display: flex; justify-content: center; align-items: center;
Â  Â  Â  z-index: 200000; opacity: 1; visibility: visible;
Â  Â  Â  transition: opacity 0.8s ease-out, transform 0.8s ease-out, visibility 0.8s linear;Â 
Â  Â  Â  transform: scale(1);
Â  Â  }
Â  Â  #splash-screen img {
Â  Â  Â  max-width: 60%; max-height: 60%; opacity: 0;
Â  Â  Â  transform: scale(0.85) translateY(15px);Â 
Â  Â  Â  animation: splash-image-entry 0.45s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
Â  Â  }
Â  Â  @keyframes splash-image-entry { to { opacity: 1; transform: scale(1) translateY(0); } }
Â  Â  #splash-screen.hidden { opacity: 0; transform: scale(0.95); visibility: hidden; pointer-events: none; }

Â  Â  header{
Â  Â  Â  Â  background: rgba(17, 17, 17, 0.95); padding:10px 20px; display:flex; align-items:center;
Â  Â  Â  Â  justify-content:space-between; position:fixed; top:0; left:0; width:100%; z-index:1000;Â Â 
Â  Â  Â  Â  border-bottom: 1px solid #222; height: 60px; backdrop-filter: blur(5px);
Â  Â  }
Â  Â  .logo img.logo-main{ width: 135px; height:auto; vertical-align: middle; }
Â  Â  .logo-intranet{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); height:45px; width:auto; }
Â  Â Â 
Â  Â  .header-controls-right { display: flex; align-items: center; gap: 10px; }

Â  Â  .header-icon-btn {Â 
Â  Â  Â  Â  background: none; border: 1px solid #0cf; color: #0cf; border-radius: 4px; padding: 5px;Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  cursor: pointer; display: flex; align-items: center; justify-content: center;
Â  Â  Â  Â  width: 37px; height: 37px; transition: background-color 0.2s ease, transform 0.2s ease;
Â  Â  }
Â  Â  .header-icon-btn:hover { background: #333; transform: scale(1.05); }
Â  Â  .header-icon-btn svg { width: 20px; height: 20px; fill: currentColor; }
Â  Â  #site-audio-control-button { display: none; }Â 

Â  Â  .hamburger{
Â  Â  Â  Â  cursor:pointer; border:1px solid #0cf; border-radius:4px; padding:5px; display: flex;Â 
Â  Â  Â  Â  flex-direction: column; justify-content: space-around; width: 37px; height: 37px; box-sizing: border-box;
Â  Â  }
Â  Â  .hamburger div{width:25px;height:3px;background:#0cf;margin:0 auto;}Â 
Â  Â Â 
Â  Â  .sidebar{
Â  Â  Â  Â  position:fixed; top:0; left:0; width:280px; height:100vh; background:#1a1a1a; border-right:1px solid #222;
Â  Â  Â  Â  padding: 20px; padding-top: calc(60px + 20px); box-shadow:3px 0 15px rgba(0,200,200,.15);Â Â 
Â  Â  Â  Â  transform:translateX(-100%); transition:transform .3s ease-in-out; z-index:9999; overflow-y: auto;
Â  Â  }
Â  Â  .sidebar.show{ transform:translateX(0); }
Â  Â  .sidebar h2{color:#0cf;margin:0 0 20px 0;}
Â  Â  .sidebar a{display:block;color:#fff;text-decoration:none;margin:12px 0;padding:10px 5px;border-bottom:1px solid #333; font-size: 1em;}
Â  Â  .sidebar a:last-of-type { border-bottom: none; }
Â  Â  .sidebar a:hover{color:#0cf}
Â  Â  .sidebar a#menu-second-setlist-section { font-weight: bold; color: #0cf !important; }
Â  Â  .sidebar .submenu { margin-left: 15px; margin-top: 10px; }
Â  Â  .sidebar .submenu a { padding: 8px 0; font-size: 0.9em; border-top: 1px solid #2a2a2a; border-bottom: none; margin: 5px 0;}
Â  Â  .sidebar a#menu-config { color: #FFD700; font-weight: bold; margin-top:15px; }Â Â 
Â  Â  .sidebar a#menu-config:hover { color: #fff2a7; }
Â  Â Â 
Â  Â  #overlay{ position:fixed;top:0;left:0;width:100%;height:100%; background:rgba(0,0,0,.75); z-index:5000; display:none; opacity: 0; transition: opacity .3s ease-in-out; }
Â  Â  #overlay.show{display:block; opacity: 1;}
Â  Â Â 
Â  Â  main { padding-top: 75px; }
Â  Â  .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; justify-content: center; align-items: center; padding: 10px; backdrop-filter: blur(3px); }
Â  Â  .modal-backdrop.show { display: flex; }
Â  Â Â 
Â  Â  .modal-content {Â 
Â  Â  Â  Â  background: rgba(26, 26, 26, 0.95); color: #fff; padding: 20px; border-radius: 10px;Â 
Â  Â  Â  Â  box-shadow: 0 0 30px rgba(0,255,255,0.15); border: 1px solid rgba(0, 204, 255, 0.2);
Â  Â  Â  Â  width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; position: relative;Â 
Â  Â  }
Â  Â  .modal-content h3 { color: #0cf; margin-top: 0; margin-bottom: 5px; }Â Â 
Â  Â  .modal-content h4 { color: #0cf; margin-top: 15px; margin-bottom: 10px; }
Â  Â  #concert-detail-title-display, #rehearsal-detail-title-display { color: #fff; font-size: 1em; font-weight: normal; margin-top: 0px; margin-bottom: 20px; text-align: left; border-bottom: 1px solid #333; padding-bottom: 10px; padding-left: 0px; }
Â  Â  #concert-detail-title-display .concert-date { font-style: italic; font-size: 0.9em; margin-left: 8px; }
Â  Â  .modal-content label { display: block; margin: 10px 0 5px; color: #0cf; font-weight: bold; }
Â  Â  .modal-content input[type="text"], .modal-content input[type="url"], .modal-content input[type="time"], .modal-content textarea { width: 100%; padding: 10px; background: #222; color: #fff; border: 1px solid #333; border-radius: 5px; margin-bottom: 15px; }
Â  Â  .modal-content textarea { min-height: 80px; resize: vertical; }
Â  Â  .modal-content button { padding: 10px 15px; background: #0cf; color: #000; border: none; border-radius: 8px; cursor: pointer; margin-right: 10px; margin-top: 10px; }
Â  Â  .modal-content button:hover { background: #09b; }
Â  Â  .modal-content .modal-close-btn { background: #444; color: #fff; }
Â  Â  .modal-content .modal-close-btn:hover { background: #555; }
Â  Â  #musicians-attendance-list { border: 1px solid #333; padding: 10px; margin-bottom:15px; }
Â  Â  #musicians-attendance-list div { margin-bottom: 8px; display: flex; align-items: center; }
Â  Â  #musicians-attendance-list label { color: #fff; margin-left: 8px; font-weight: normal; cursor: pointer; }
Â  Â  #musicians-attendance-list input[type="checkbox"] { vertical-align: middle; width: 18px; height: 18px; cursor: pointer; }
Â  Â  .modal-field-group { display: flex; gap: 15px; flex-wrap: wrap; }
Â  Â  .modal-field-group > div { flex: 1; min-width: 200px; }
Â  Â  .modal-field-group input[type="time"] { text-align: left; }
Â  Â  .config-screen {
Â  Â  Â  Â  display:none; position:fixed; top:0; left:0; width:100%; height:100%;
Â  Â  Â  Â  background: rgba(10, 10, 10, 0.95); z-index:10001; overflow-y:auto; padding: 20px; padding-top: calc(60px + 20px);Â 
Â  Â  Â  Â  backdrop-filter: blur(5px);
Â  Â  }
Â  Â  .config-screen h2{color:#0cf;text-align:center;margin:10px 0 20px;}Â Â 
Â  Â  .config-screen h3{color:#0cf;margin:20px 0 10px}
Â  Â  .config-screen label{display:block;margin:10px 0 5px}
Â  Â  .config-screen input,.config-screen select{width:100%;max-width:400px;padding:10px;background:#222;color:#fff; border:1px solid #333;border-radius:5px}
Â  Â  .config-screen select[multiple] { height: 150px; }
Â  Â  .config-screen button{margin-top:30px;padding:10px 20px;background:#0cf;color:#000;border:none;border-radius:8px;cursor:pointer}
Â  Â  .config-screen button:hover{background:#09b}
Â  Â  .config-screen .close-btn{ position:absolute; top:15px; right:20px; font-size:1.2em;background:none;border:1px solid #0cf; color:#0cf;border-radius:4px;padding:5px 10px;cursor:pointer; z-index: 10002; }
Â  Â  .config-screen .close-btn:hover{background:#333}
Â  Â  main section{max-width:1200px;margin:0 auto;padding:20px}
Â  Â Â 
Â  Â  #setlists, #star-setlist, #rehearsals, #second-setlist, #calendario, #vista-calendario-mensual, #suggestions {Â 
Â  Â  Â  Â  background: rgba(20, 20, 20, 0.75);Â 
Â  Â  Â  Â  backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);Â 
Â  Â  Â  Â  padding:20px; border-radius:12px;Â 
Â  Â  Â  Â  box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);Â 
Â  Â  Â  Â  border: 1px solid rgba(0, 204, 255, 0.1); margin-bottom:40pxÂ 
Â  Â  }
Â  Â Â 
Â  Â  #setlists h2, #star-setlist h2, #rehearsals h2, #second-setlist h2, #calendario h2, #suggestions h2 { text-align:center;color:#0cf;margin-bottom:5px }
Â  Â  .setlist-dynamic-name { text-align:center;color:#aaa;margin-top:0px; margin-bottom:15px; font-style:italic; font-size: 0.9em; }
Â  Â  .table-wrapper { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; display: flex; justify-content: center; }
Â  Â  table { width: 100%; max-width: 100%; border-collapse: collapse; margin-top: 20px; color: #fff; font-size: .95em; margin-left: auto; margin-right: auto; }
Â  Â  thead{background:#222;color:#0cf}
Â  Â  th,td{padding:12px;border:1px solid #333;text-align:left;white-space: normal; word-wrap: break-word;}
    /* Ajuste para la nueva columna de audio */
Â  Â  #setlists table th:nth-child(4), #setlists table th:nth-child(5), #setlists table th:nth-child(6), 
    #second-setlist table th:nth-child(4), #second-setlist table th:nth-child(5), #second-setlist table th:nth-child(6), 
    #star-setlist table th:nth-child(4), #star-setlist table th:nth-child(5), #star-setlist table th:nth-child(6) { text-align: center; }
Â  Â  #setlists table td:nth-child(4), #setlists table td:nth-child(5), #setlists table td:nth-child(6), 
    #second-setlist table td:nth-child(4), #second-setlist table td:nth-child(5), #second-setlist table td:nth-child(6), 
    #star-setlist table td:nth-child(4), #star-setlist table td:nth-child(5), #star-setlist table td:nth-child(6) { text-align: center; }

Â  Â  .break-row td { font-style: italic; color: #ccc; background-color: #161616; }
Â  Â  .break-row td:first-child { color: #777; text-align: center; }
Â  Â  .break-row td:nth-child(3), .break-row td:nth-child(4), .break-row td:nth-child(5) { text-align: center; }
Â  Â  .set-header-row td { font-weight: bold; text-align: center; background-color: #383838; color: #0cf; padding-top: 12px; padding-bottom: 12px; border-top: 1px solid #505050 !important; border-bottom: 1px solid #505050 !important; }
Â  Â  th.calendar-col-header, td.calendar-col { width: 50px; text-align: center; padding-left: 5px; padding-right: 5px; }
Â  Â  th.details-col-header { width: 50px; text-align: center; padding-left: 5px; padding-right: 5px; }
Â  Â  tr:nth-child(even):not(.set-header-row):not(.break-row){background: rgba(26, 26, 26, 0.6);}
Â  Â  .download-btn, .live-mode-btn {display:inline-block;margin:20px 5px 0;padding:10px 20px;font-size:1em;background:#0cf;color:#000;border:none;border-radius:8px;cursor:pointer}
Â  Â  .download-btn:hover{background:#09b}
Â  Â  .live-mode-btn { background: #ff0055; color: #fff; border: 1px solid #ff0055; }
Â  Â  .live-mode-btn:hover { background: #cc0044; }

Â  Â  #total-time, #total-time-star, #total-time-2{color:#0cf;margin-top:10px;text-align:center}
Â  Â  footer{background:#111;color:#888;text-align:center;padding:10px;border-top:1px solid #222}
Â  Â  .calendar-btn, .details-btn { background: none; border: none; cursor: pointer; padding: 5px; margin-left: 0; vertical-align: middle; }
Â  Â  .calendar-btn svg { fill: #0cf; width: 20px; height: 20px; }
Â  Â  .calendar-btn:hover svg { fill: #09b; }
Â  Â  .details-btn { font-size: 1.5em; color: #0cf; }
Â  Â  .details-btn:hover { color: #09b; }
Â  Â  .delete-user, .edit-user, .delete-rehearsal, .clear-attendance, .edit-rehearsal { padding: 5px 10px; margin: 0 5px; background: #f00; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
Â  Â  .edit-user, .edit-rehearsal { background: #0cf; color: #000; }
Â  Â  .clear-attendance { background: #ff9800; }
Â  Â  .delete-user:hover, .delete-rehearsal:hover { background: #d00; }
Â  Â  .edit-user:hover, .edit-rehearsal:hover { background: #09b; }
Â  Â  .clear-attendance:hover { background: #e68900; }
Â  Â  #cancel-edit-user, #cancel-edit-rehearsal { background: #666; color: #fff; }
Â  Â  #cancel-edit-user:hover, #cancel-edit-rehearsal:hover { background: #555; }
Â  Â  .attendance-form { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
Â  Â  .attendance-form select { padding: 5px; background: #222; color: #fff; border: 1px solid #333; border-radius: 4px; }
Â  Â  .attendance-form button { padding: 5px 10px; background: #0cf; color: #000; border: none; border-radius: 4px; cursor: pointer; }
Â  Â  .attendance-form button:hover { background: #09b; }
Â  Â  .attendance-summary { margin-top: 10px; font-size: 0.9em; }
Â  Â  .attendance-summary span { display: block; }
Â  Â  .attending-yes { color: #0cf; }
Â  Â  .attending-no { color: #f00; }
Â  Â  .rehearsal-duration { display: block; font-size: 0.9em; color: #aaa; }
Â  Â  #connection-status { position: fixed; top: calc(60px + 5px); right: 10px; background: rgba(0, 0, 0, 0.8); color: #fff; padding: 5px 10px; border-radius: 5px; font-size: 0.9em; z-index: 10000; display: none; }
Â  Â  #connection-status.offline { background: #f00; }
Â  Â  #connection-status.retrying { background: #ff9800; }
Â  Â  .success-message { color: #0cf; margin-top: 10px; text-align: center; }
Â  Â  .error-message { color: #f00; margin-top: 10px; text-align: center; }
Â  Â  .stats-table { margin-bottom: 40px; }
Â  Â  .stats-table h3 { color: #0cf; margin: 20px 0 10px; text-align: center; }
Â  Â  .stats-filter { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px; }
Â  Â  .stats-filter label { color: #0cf; }
Â  Â  .stats-filter select { padding: 5px; background: #222; color: #fff; border: 1px solid #333; border-radius: 4px; width: auto; max-width: 200px; }
Â  Â  #firebase-critical-error-banner { background-color: red; color: white; padding: 15px; text-align: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 100001; font-weight: bold; }

Â  Â  @media(max-width:768px){
Â  Â  Â  header { height: 55px; padding: 8px 15px; }Â Â 
Â  Â  Â  .logo img.logo-main{ width: 110px; }
Â  Â  Â  .logo-intranet{height:35px}
Â  Â  Â  .header-audio-control { margin-right: 10px; width: 35px; height: 35px; }
Â  Â  Â  .header-audio-control svg { width: 18px; height: 18px; }
Â  Â  Â  .hamburger { width: 35px; height: 35px; }
Â  Â  Â  .hamburger div{width:20px;}
Â  Â  Â  .sidebar{ width:260px; padding-top: calc(55px + 15px); }
Â  Â  Â  main { padding-top: 65px; }
Â  Â  Â  .config-screen { padding-top: calc(55px + 15px); }
Â  Â  Â  .config-screen .close-btn{ top:10px; right:15px; }
Â  Â  Â  #connection-status { top: calc(55px + 5px); right: 5px; font-size: 0.8em; }
Â  Â  Â  .attendance-form { flex-direction: column; align-items: flex-start; }
Â  Â  Â  .attendance-form select { width: 100%; }
Â  Â  Â  .delete-rehearsal, .clear-attendance, .edit-rehearsal { display: block; margin: 5px 0; width: 100%; }
Â  Â  Â  .table-wrapper { overflow-x: hidden; }Â Â 
Â  Â  Â  table { width: 100%; min-width: unset; font-size: 0.85em; }
Â  Â  Â  th, td { padding: 8px; white-space: normal; word-wrap: break-word; max-width: 150px; }
Â  Â  Â  th.calendar-col-header, td.calendar-col, th.details-col-header { width: 40px; padding: 8px 2px;}Â Â 
Â  Â  Â  #second-setlist .table-wrapper table, #star-setlist .table-wrapper table { min-width: unset; }
Â  Â  Â  .stats-table table { font-size: 0.85em; }
Â  Â  Â  .modal-content { width: 95%; padding: 15px; }Â Â 
Â  Â  Â  .modal-field-group { flex-direction: column; }Â Â 
Â  Â  }

Â  Â  #vista-calendario-mensual h2 { text-align: center; color: #0cf; margin-bottom: 20px; }
Â  Â  .calendar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; color: #fff; }
Â  Â  .calendar-controls button { background: rgba(34, 34, 34, 0.8); border: 1px solid #0cf; color: #0cf; padding: 5px 15px; border-radius: 4px; cursor: pointer; transition: all 0.2s;}
Â  Â  .calendar-controls button:hover { background: #0cf; color: #000; }
Â  Â  .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; background: transparent; border: none; }
Â  Â  .cal-header { background: rgba(26, 26, 26, 0.8); color: #0cf; text-align: center; padding: 10px 0; font-weight: bold; font-size: 0.9em; border-radius: 4px; }
Â  Â  .cal-day { background: rgba(0, 0, 0, 0.5); min-height: 100px; padding: 5px; position: relative; display: flex; flex-direction: column; gap: 2px; border-radius: 4px; border: 1px solid #333; }
Â  Â  .cal-day.other-month { background: rgba(0, 0, 0, 0.2); opacity: 0.5; border: none; }
Â  Â  .cal-day.today { border: 1px solid #0cf; background: rgba(0, 204, 255, 0.05); }
Â  Â  .cal-day-number { font-size: 0.8em; color: #777; align-self: flex-end; margin-bottom: 5px; }
Â  Â  .cal-event { font-size: 0.75em; padding: 3px 5px; border-radius: 3px; margin-bottom: 3px; word-wrap: break-word; line-height: 1.2; box-shadow: 0 2px 4px rgba(0,0,0,0.3); transition: transform 0.2s ease, filter 0.2s ease; }
Â  Â  .cal-event:hover { transform: scale(1.02) translateY(-1px); filter: brightness(1.2); z-index: 5; }
Â  Â  .cal-event.type-ensayo { color: #ff9999; border-left: 3px solid #ff3333; background: linear-gradient(90deg, rgba(255, 0, 0, 0.15) 0%, rgba(255,0,0,0.05) 100%); }
Â  Â  .cal-event.type-concierto { color: #ffff99; border-left: 3px solid #ffff00; background: linear-gradient(90deg, rgba(255, 255, 0, 0.15) 0%, rgba(255,255,0,0.05) 100%); }

Â  Â  @media(max-width:768px){ .cal-day { min-height: 70px; font-size: 0.9em; } .cal-event { font-size: 0.7em; } .cal-header { font-size: 0.7em; padding: 5px 0; } }

Â  Â  .suggestion-form { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; }
Â  Â  .suggestion-form-row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
Â  Â  .suggestion-form-row input { flex: 1; min-width: 150px; }
Â  Â  .suggestions-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
Â  Â  .suggestion-card { background: rgba(30, 30, 30, 0.6); border: 1px solid rgba(0, 204, 255, 0.1); border-radius: 8px; padding: 15px; position: relative; transition: transform 0.2s; display: flex; flex-direction: column; }
Â  Â  .suggestion-card:hover { transform: translateY(-3px); background: rgba(40, 40, 40, 0.8); border-color: rgba(0, 204, 255, 0.3); }
Â  Â  .suggestion-header { border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; margin-bottom: 10px; }
Â  Â  .suggestion-title { font-size: 1.1em; font-weight: bold; color: #fff; margin-bottom: 2px; }
Â  Â  .suggestion-artist { color: #0cf; font-size: 0.9em; margin-bottom: 5px; }
Â  Â  .suggestion-meta { font-size: 0.75em; color: #888; font-style: italic; }
Â  Â  .suggestion-body { flex-grow: 1; margin-bottom: 10px; }
Â  Â  .star-rating-display { display: flex; align-items: center; gap: 5px; margin-bottom: 10px; }
Â  Â  .star-rating-display .avg-score { font-size: 1.2em; font-weight: bold; color: #FFD700; }
Â  Â  .star-rating-display .star-visual { color: #555; font-size: 1.2em; }
Â  Â  .star-visual.filled { color: #FFD700; }
Â  Â  .voting-area { background: rgba(0,0,0,0.3); padding: 8px; border-radius: 5px; text-align: center; }
Â  Â  .voting-label { font-size: 0.8em; color: #aaa; margin-bottom: 5px; display:block; }
Â  Â  .interactive-stars { display: inline-flex; gap: 5px; cursor: pointer; }
Â  Â  .interactive-star { font-size: 1.5em; color: #555; transition: color 0.2s; }
Â  Â  .interactive-star:hover, .interactive-star.active { color: #FFD700; }
Â  Â  .interactive-stars.voted { pointer-events: none; opacity: 0.8; }
Â  Â  .interactive-stars.voted .interactive-star.active { color: #FFD700; }
Â  Â  .voters-details { margin-top: 10px; font-size: 0.8em; color: #ccc; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 5px; display: none; }
Â  Â  .voters-details.show { display: block; }
Â  Â  .toggle-voters-btn { background: none; border: none; color: #0cf; font-size: 0.8em; cursor: pointer; padding: 0; margin-top: 5px; text-decoration: underline; }
Â  Â  #user-identity-selector { background: #222; color: #fff; border: 1px solid #0cf; padding: 5px; border-radius: 4px; margin-bottom: 15px; width: 100%; max-width: 300px; }
Â  Â  .admin-badge { background: red; color: white; font-size: 0.7em; padding: 2px 5px; border-radius: 3px; margin-left: 5px; }
Â  Â  .deleted-row { background: rgba(255, 0, 0, 0.1); color: #aaa; }

Â  Â  /* --- ESTILOS MODO DIRECTO --- */
Â  Â  #live-mode-overlay {
Â  Â  Â  Â  position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
Â  Â  Â  Â  background: #000; z-index: 999999;
Â  Â  Â  Â  display: none; flex-direction: column; color: #fff;
Â  Â  }
Â  Â  #live-mode-overlay.show { display: flex; }
Â  Â  .live-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #333; }
Â  Â  .live-counter { color: #888; font-size: 1.2em; }
Â  Â  .live-close-btn { background: none; border: 1px solid #555; color: #aaa; border-radius: 50%; width: 40px; height: 40px; font-size: 1.2em; cursor: pointer; }
Â  Â  .live-close-btn:active { background: #222; }
Â  Â  .live-content { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
Â  Â  .live-song-title { font-size: 3.5em; font-weight: bold; color: #fff; margin-bottom: 20px; line-height: 1.1; text-shadow: 0 0 10px rgba(0,204,255,0.3); }
Â  Â  .live-song-meta { font-size: 2em; color: #FFD700; display: flex; gap: 30px; margin-bottom: 40px; }
Â  Â  .live-next-song { color: #555; font-size: 1.2em; margin-top: auto; }
Â  Â  .live-controls { display: flex; height: 100px; border-top: 1px solid #333; }
Â  Â  .live-control-btn { flex: 1; background: #111; border: none; color: #0cf; font-size: 2em; cursor: pointer; border-right: 1px solid #333; }
Â  Â  .live-control-btn:last-child { border-right: none; }
Â  Â  .live-control-btn:active { background: #222; }
Â  Â  @media(max-width:768px){
Â  Â  Â  Â  .live-song-title { font-size: 2.2em; }
Â  Â  Â  Â  .live-song-meta { font-size: 1.5em; flex-direction: column; gap: 10px; }
Â  Â  }
    
    /* --- ESTILOS JUKebox NUEVOS --- */
    .jukebox-col-header { width: 40px; text-align: center; padding-left: 5px; padding-right: 5px; }
    .jukebox-col { width: 40px; text-align: center; padding: 0; vertical-align: middle; }
    .jukebox-btn { background: none; border: none; cursor: pointer; padding: 0; margin: 0; vertical-align: middle; display: inline-flex; align-items: center; justify-content: center; width: 30px; height: 30px; transition: transform 0.2s; }
    .jukebox-btn:hover { transform: scale(1.15); }
    .jukebox-btn svg { width: 20px; height: 20px; fill: currentColor; }

    /* Icono de Auriculares - Apagado */
    .jukebox-btn.muted svg { fill: #444; }

    /* Icono de Auriculares - Iluminado (con link) */
    .jukebox-btn.active svg { fill: #0cf; }
    .jukebox-btn.active:hover svg { fill: #fff; }

    #jukebox-player-modal .modal-content { max-width: 900px; }
    .jukebox-embed-container { position: relative; padding-bottom: 56.25%; /* 16:9 Aspect Ratio */ height: 0; overflow: hidden; max-width: 100%; background: #000; border-radius: 8px; }
    .jukebox-embed-container iframe,
    .jukebox-embed-container audio { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
    .modal-close-jukebox { position: absolute; top: -10px; right: -10px; z-index: 10002; width: 30px; height: 30px; border-radius: 50%; background: #ff3333; color: white; border: 2px solid #fff; cursor: pointer; font-weight: bold; line-height: 1; padding: 0; font-size: 1.2em; }
    .modal-close-jukebox:hover { background: #d00; }

    /* ESTILOS NUEVOS PARA LA GESTIÃ“N DE AUDIO LINKS */
    .link-management-screen h3 { text-align: center; color: #fff; margin-top: 15px; }
    .link-management-screen .table-wrapper { max-height: 70vh; overflow-y: auto; }
    .link-management-screen table { width: 100%; margin: 10px auto; }
    .link-management-screen table th:nth-child(1) { width: 40%; }
    .link-management-screen table th:nth-child(2) { width: 40%; }
    .link-management-screen table td { max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .link-management-screen input[type="url"] { width: 100%; padding: 5px; margin: 0; background: #333; color: #fff; border: 1px solid #555; }
    .link-management-screen .save-link-btn { padding: 5px 10px; margin: 0; font-size: 0.9em; border-radius: 4px; }
Â  </style>
</head>

<body>
Â  <div id="splash-screen">
Â  Â  <img src="assets/Logo Sobre negro1.png" alt="Cargando El SÃ³tano del Doctor...">
Â  </div>
Â  <div id="firebase-critical-error-banner" style="display:none;">
Â  Â  ERROR CRÃTICO: La configuraciÃ³n de Firebase no es vÃ¡lida o es un placeholder. La aplicaciÃ³n puede no funcionar correctamente. Contacta al administrador.
Â  </div>
Â  <div id="connection-status"></div>

Â  <div id="live-mode-overlay">
Â  Â  Â  <div class="live-header">
Â  Â  Â  Â  Â  <div class="live-counter" id="live-counter">1 / 20</div>
Â  Â  Â  Â  Â  <button class="live-close-btn" id="live-close-btn">âœ•</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="live-content" id="live-content-area">
Â  Â  Â  Â  Â  <div class="live-song-title" id="live-song-title">TÃ­tulo CanciÃ³n</div>
Â  Â  Â  Â  Â  <div class="live-song-meta">
Â  Â  Â  Â  Â  Â  Â  <span id="live-song-key">Key: A</span>
Â  Â  Â  Â  Â  Â  Â  <span id="live-song-tempo">120 BPM</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="live-next-song" id="live-next-song">Siguiente: Otra canciÃ³n</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="live-controls">
Â  Â  Â  Â  Â  <button class="live-control-btn" id="live-prev-btn">â® Anterior</button>
Â  Â  Â  Â  Â  <button class="live-control-btn" id="live-next-btn">Siguiente â­</button>
Â  Â  Â  </div>
Â  </div>

Â  <header>
Â  Â  <div class="logo">
Â  Â  Â  <img src="assets/logo_blanco.png" alt="Logo El SÃ³tano del Doctor" class="logo-main">
Â  Â  </div>
Â  Â  <img src="assets/logointranet.png" alt="Logo Intranet El SÃ³tano del Doctor" class="logo-intranet">
Â  Â  <div class="header-controls-right">
Â  Â  Â  Â  <button id="site-audio-control-button" class="header-icon-btn" title="Activar sonido">Â 
Â  Â  Â  Â  Â  Â  <svg class="icon-muted" viewBox="0 0 24 24" fill="currentColor">
Â  Â  Â  Â  Â  Â  Â  Â  <path d="M16.5 12A4.5 4.5 0 0012 7.5v2.14l4.5 4.5zm2.51.53l-1.06-1.06-1.06 1.06a1 1 0 01-1.41 0l-.7-.71a1 1 0 010-1.41l1.06-1.06-1.06-1.06a1 1 0 010-1.41l.7-.71a1 1 0 011.41 0l1.06 1.06 1.06-1.06a1 1 0 011.41 0l.71.71a1 1 0 010 1.41l-1.06 1.06 1.06 1.06a1 1 0 010 1.41l-.71.71a1 1 0 01-1.41 0zM4 9.78V14.2a1 1 0 001 1h2.34l4.91 3.3A1.19 1.19 0 0014 17.55V6.45a1.19 1.19 0 00-1.75-1.05L7.34 8.7H5a1 1 0 00-1 1.08z"/>
Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  <svg class="icon-unmuted" viewBox="0 0 24 24" fill="currentColor" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  <path d="M12.4 4.42a1.19 1.19 0 00-1.75 1.05v13.1a1.19 1.19 0 001.75 1.05l4.91-3.3H19a1 1 0 001-1.07V9.72a1 1 0 00-1-1.07h-1.66zm6.1 2.51a6.73 6.73 0 010 10.14M16 9.48a3.23 3.23 0 010 5M4 9.72v4.56a1 1 0 001 1h2.34l4.91 3.3A1.19 1.19 0 0014 17.55V6.45a1.19 1.19 0 00-1.75-1.05L7.34 8.65H5a1 1 0 00-1 1.07z"/>
Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  </button>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <button id="header-calendar-btn" class="header-icon-btn" title="Calendario Mensual">
Â  Â  Â  Â  Â  Â  Â <svg viewBox="0 0 24 24" fill="currentColor">
Â  Â  Â  Â  Â  Â  Â  Â  <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z"/>
Â  Â  Â  Â  Â  Â  Â </svg>
Â  Â  Â  Â  </button>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="hamburger" id="hamburger-btn"><div></div><div></div><div></div></div>
Â  Â  </div>
Â  </header>

Â  <div id="overlay"></div>
Â  <nav class="sidebar" id="sidebar-menu">
Â  Â  <h2>MenÃº</h2>
Â  Â  <a href="#setlists" id="menu-rehearsals-setlist-section">Setlist PrÃ³ximo Ensayo</a>
Â  Â  <a href="#rehearsals" id="menu-rehearsals-section">PrÃ³ximos Ensayos</a>
Â  Â  <a href="#second-setlist" id="menu-second-setlist-section">Setlist PrÃ³ximo Concierto</a>
Â  Â  <a href="#star-setlist" id="menu-star-setlist-section">Setlist Concierto Estrella</a>
Â  Â  <a href="#calendario" id="menu-concerts-section">PrÃ³ximos Conciertos</a>
Â  Â  <a href="#vista-calendario-mensual" id="menu-calendar-view">Calendario Mensual</a>
Â  Â  <a href="#suggestions" id="menu-suggestions">Propuestas de Canciones</a>
Â  Â  <a href="#" id="menu-stats">EstadÃ­sticas</a>
Â  Â  <a href="#" id="menu-user-list-display">Usuarios Registrados</a>Â Â 
Â  Â  <a href="#" id="menu-config">ConfiguraciÃ³n</a>
Â  Â  <div class="submenu" id="config-submenu" style="display: none;">
Â  Â  Â  <a href="#" id="menu-setlist-config">Configurar Setlists</a>
Â  Â  Â  <a href="#" id="menu-user-mgmt">GestiÃ³n de Usuarios</a>
Â  Â  Â  <a href="#" id="menu-rehearsal">Asignar Ensayos</a>
Â  Â  Â  <a href="#" id="menu-admin-suggestions">GestiÃ³n de Propuestas</a>
      <a href="#" id="menu-audio-links">GestiÃ³n de Audio Links ğŸ§</a>
Â  Â  </div>
Â  Â  <a href="#" id="menu-cerrar">Cerrar MenÃº</a>
Â  </nav>

Â  <div id="concert-details-modal" class="modal-backdrop"><div class="modal-content"><h3>Detalles del Concierto</h3><h4 id="concert-detail-title-display"></h4><input type="hidden" id="concert-detail-id"><label for="concert-detail-location">Detalles adicionales de la ubicaciÃ³n:</label><textarea id="concert-detail-location"></textarea><label for="concert-detail-gmaps-link">Enlace de Google Maps (Lugar Evento):</label><div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;"><input type="url" id="concert-detail-gmaps-link" placeholder="https://maps.app.goo.gl/example" style="flex-grow: 1; margin-bottom: 0;"><button id="open-gmaps-link-btn" style="display:none; padding: 10px 15px; background: #0cf; color: #000; border: none; border-radius: 8px; cursor: pointer; line-height: 1.5;">Abrir Mapa</button></div><div class="modal-field-group"><div><label for="concert-detail-soundsetup">Montaje Equipo Sonido:</label><input type="time" id="concert-detail-soundsetup"></div><div><label for="concert-detail-instrumentssetup">Montaje BaterÃ­a/Instrumentos:</label><input type="time" id="concert-detail-instrumentssetup"></div></div><div class="modal-field-group"><div><label for="concert-detail-soundcheck">Prueba de sonido:</label><input type="time" id="concert-detail-soundcheck"></div><div><label for="concert-detail-showtime">Hora del show (confirmada/ajustada):</label><input type="time" id="concert-detail-showtime"></div></div><label for="concert-detail-notes">Notas generales:</label><textarea id="concert-detail-notes"></textarea><label for="concert-detail-sound-company">Empresa de SonorizaciÃ³n:</label><input type="text" id="concert-detail-sound-company" placeholder="Nombre de la empresa o tÃ©cnico externo"><h4>MÃºsicos Asistentes</h4><div id="musicians-attendance-list"></div><h4>TÃ©cnicos Responsables</h4><div id="technicians-attendance-list" style="border: 1px solid #333; padding: 10px; margin-bottom:15px;"></div><button id="save-concert-details">Guardar Detalles</button><button id="close-concert-details-modal" class="modal-close-btn">Cerrar</button><p id="concert-detail-message" class="success-message" style="text-align:left; margin-top:10px;"></p></div></div>
Â  <div id="rehearsal-details-modal" class="modal-backdrop"><div class="modal-content"><h3>InformaciÃ³n del Ensayo</h3><h4 id="rehearsal-detail-title-display"></h4><input type="hidden" id="rehearsal-detail-index"><label for="rehearsal-notes">PreparaciÃ³n / Notas / Canciones a mirar:</label><textarea id="rehearsal-notes" style="min-height: 400px; font-size: 1em;" placeholder="Escribe aquÃ­ quÃ© hay que preparar para este ensayo..."></textarea><button id="save-rehearsal-details">Guardar InformaciÃ³n</button><button id="close-rehearsal-details-modal" class="modal-close-btn">Cerrar</button><p id="rehearsal-detail-message" class="success-message" style="text-align:left; margin-top:10px;"></p></div></div>
Â  <div id="setlist-config-screen" class="config-screen"><button class="close-btn" id="close-setlist-config">Cerrar</button><h2>ConfiguraciÃ³n de Setlists</h2><h3>Setlist PrÃ³ximo Ensayo</h3><label>Nombre</label><input id="setlist1-name" placeholder="Ej: Ensayos 2025"><label>ID/URL feed</label><input id="setlist1-url" placeholder="URL"><h3>Setlist PrÃ³ximo Concierto</h3><label>Nombre</label><input id="setlist2-name" placeholder="Ej: Concierto Navidad"><label>ID/URL feed</label><input id="setlist2-url" placeholder="Ej: TXHvy autÃ³nomo o URL completa"><h3>Setlist Concierto Estrella</h3><label>Nombre</label><input id="setlistStar-name" placeholder="Ej: Gran Evento 2025"><label>ID/URL feed</label><input id="setlistStar-url" placeholder="URL"><button id="guardar-setlist-config">Guardar ConfiguraciÃ³n</button><p id="setlist-message" class="error-message"></p></div>
Â  <div id="user-mgmt-screen" class="config-screen"><button class="close-btn" id="close-user-mgmt">Cerrar</button><h2>GestiÃ³n de Usuarios</h2><label>Nombre</label><input id="user-name" placeholder="Nombre"><label>Apodo</label><input id="user-nickname" placeholder="Apodo (corto)"><label>Roles</label><select id="user-role" multiple><option value="BaterÃ­a">BaterÃ­a</option><option value="Teclados">Teclados</option><option value="Voz">Voz</option><option value="Guitarra elÃ©ctrica">Guitarra elÃ©ctrica</option><option value="Guitarra AcÃºstica">Guitarra AcÃºstica</option><option value="Bajo">Bajo</option><option value="PercusiÃ³n">PercusiÃ³n</option><option value="Saxo">Saxo</option><option value="Coros">Coros</option><option value="DirecciÃ³n Musical">DirecciÃ³n Musical</option><option value="TÃ©cnico de Sonido">TÃ©cnico de Sonido</option><option value="TÃ©cnico de Luces">TÃ©cnico de Luces</option><option value="Montador">Montador</option><option value="Road Manager">Road Manager</option><option value="Backliner">Backliner</option></select><button id="add-user">AÃ±adir Usuario</button><button id="cancel-edit-user" style="display:none;">Cancelar EdiciÃ³n</button><p id="user-message" class="error-message"></p><table id="user-table"><thead><tr><th>Nombre</th><th>Apodo</th><th>Roles</th><th>Acciones</th></tr></thead><tbody id="user-table-body"></tbody></table></div>
Â  <div id="rehearsal-screen" class="config-screen"><button class="close-btn" id="close-rehearsal">Cerrar</button><h2>AsignaciÃ³n de Ensayos</h2><label>Fecha</label><input type="date" id="rehearsal-date"><label>Hora Inicio</label><input type="time" id="rehearsal-start-time"><label>Hora Fin</label><input type="time" id="rehearsal-end-time"><label>Lugar</label><input id="rehearsal-location" placeholder="Ej: Estudio 1"><button id="add-rehearsal">AÃ±adir Ensayo</button><button id="cancel-edit-rehearsal" style="display:none;">Cancelar EdiciÃ³n</button><p id="rehearsal-message" class="error-message"></p><table id="rehearsal-table"><thead><tr><th>Fecha</th><th>Hora Inicio</th><th>Hora Fin</th><th>Lugar</th><th>Asistencias</th><th>Acciones</th></tr></thead><tbody id="rehearsal-table-body"></tbody></table></div>
Â  <div id="admin-suggestions-screen" class="config-screen"><button class="close-btn" id="close-admin-suggestions">Cerrar</button><h2>GestiÃ³n de Propuestas (Admin)</h2><p style="color:#aaa; text-align:center;">AquÃ­ puedes ver el historial y eliminar propuestas inadecuadas.</p><div class="table-wrapper"><table id="admin-suggestions-table"><thead><tr><th>CanciÃ³n</th><th>Propuesta por</th><th>Fecha</th><th>Estado</th><th>AcciÃ³n</th></tr></thead><tbody id="admin-suggestions-body"></tbody></table></div></div>
Â  <div id="suggestions-screen" class="config-screen"><button class="close-btn" id="close-suggestions">Cerrar</button><h2>Propuestas de Canciones</h2><div style="text-align:center; margin-bottom:20px;"><label for="user-identity-selector" style="color:#0cf; font-weight:bold; display:block; margin-bottom:5px;">Â¿QuiÃ©n eres? (Necesario para proponer y votar)</label><select id="user-identity-selector"><option value="" disabled selected>-- Selecciona tu nombre --</option></select></div><div class="suggestion-form"><h4 style="color:#fff; margin-top:0;">Nueva Propuesta</h4><div class="suggestion-form-row"><input type="text" id="suggestion-title" placeholder="TÃ­tulo de la canciÃ³n"><input type="text" id="suggestion-artist" placeholder="Artista / Banda original"></div><div class="suggestion-form-row"><input type="url" id="suggestion-link" placeholder="Enlace (Spotify/Youtube) - Opcional"><button id="add-suggestion-btn" style="width:auto; flex:0 0 150px;">Proponer</button></div><p id="suggestion-message" class="error-message" style="text-align:left; margin:0;"></p></div><div class="suggestions-grid" id="suggestions-container"></div></div>
Â  <div id="stats-screen" class="config-screen"><button class="close-btn" id="close-stats">Cerrar</button><h2>EstadÃ­sticas</h2><div class="stats-filter"><label>Filtrar por mes:</label><select id="stats-month-filter"><option value="all">Todos los meses</option></select></div><div class="stats-table"><h3>Tiempo Ensayado por Mes</h3><table id="time-per-month-table"><thead><tr><th>Mes</th><th>Tiempo Total (horas)</th></tr></thead><tbody id="time-per-month-body"></tbody></table></div><div class="stats-table"><h3>Tiempo Ensayado por Usuario</h3><table id="time-per-user-table"><thead><tr><th>Usuario</th><th>Tiempo Total (horas)</th></tr></thead><tbody id="time-per-user-body"></tbody></table></div><div class="stats-table"><h3>Ensayos Pasados</h3><div class="table-wrapper"><table id="past-rehearsals-table"><thead><tr><th>Fecha</th><th>Hora</th><th>Lugar</th><th>Asistencias</th></tr></thead><tbody id="past-rehearsals-body"></tbody></table></div></div></div>
Â  <div id="user-list-screen" class="config-screen"><button class="close-btn" id="close-user-list-screen">Cerrar</button><h2>Usuarios Registrados</h2><div class="table-wrapper" style="padding: 0 10px;"><table><thead><tr><th>Nombre</th><th>Apodo</th><th>Roles</th></tr></thead><tbody id="users-body"></tbody></table></div></div>

<div id="jukebox-player-modal" class="modal-backdrop">
    <div class="modal-content">
        <button id="close-jukebox-modal" class="modal-close-jukebox" title="Cerrar reproductor">âœ•</button>
        <h3 id="jukebox-song-title" style="margin-bottom:15px; color:#fff;">Reproduciendo...</h3>
        <div class="jukebox-embed-container" id="jukebox-embed-container">
            </div>
        <p style="font-size:0.8em; color:#aaa; margin-top:15px;">**Nota:** El control de reproducciÃ³n (Play, Stop, etc.) lo proporciona el reproductor de la plataforma de origen (YouTube, Drive, etc.).</p>
    </div>
</div>

<div id="audio-link-management-screen" class="config-screen link-management-screen">
    <button class="close-btn" id="close-audio-link-management">Cerrar</button>
    <h2>GestiÃ³n de Audio Links (Jukebox ğŸ§)</h2>
    <p style="color:#aaa; text-align:center;">Introduce o modifica la URL de audio/video para cada canciÃ³n del setlist maestro (actualiza la lista principal al cerrar el modal).</p>
    <div class="table-wrapper">
        <table id="audio-links-table">
            <thead>
                <tr>
                    <th>CanciÃ³n</th>
                    <th>URL de Audio/Video (YouTube, Drive, MP3)</th>
                    <th>AcciÃ³n</th>
                </tr>
            </thead>
            <tbody id="audio-links-body">
                <tr><td colspan="3" style="text-align:center;">Cargando lista de canciones...</td></tr>
            </tbody>
        </table>
    </div>
    <p id="audio-link-message" class="success-message" style="text-align:center;"></p>
</div>

Â  <main>
Â  Â  <section id="setlists">
Â  Â  Â  <h2>Setlist PrÃ³ximo Ensayo</h2>
Â  Â  Â  <p id="setlist1-dynamic-name" class="setlist-dynamic-name"></p>
Â  Â  Â  <div class="table-wrapper"> 
Â  Â  Â  Â  <table> 
Â  Â  Â  Â  Â  <thead> 
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  <th>#</th>
Â  Â  Â  Â  Â  Â  Â  <th>TÃ­tulo</th>
Â  Â  Â  Â  Â  Â  Â  <th class="jukebox-col-header">ğŸ§</th> Â  Â  Â  Â  Â  Â  Â  <th>Key</th>
Â  Â  Â  Â  Â  Â  Â  <th>Tempo</th>
Â  Â  Â  Â  Â  Â  Â  <th>Time</th>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody id="setlist-body"></tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  Â  <div style="text-align: center;">
Â  Â  Â  Â  <button class="download-btn" id="download-btn">Pdf Complex</button>
Â  Â  Â  Â  <button class="download-btn" id="download-basic-btn">Pdf Simple</button>
Â  Â  Â  Â  <button class="download-btn" id="download-personal-btn">PDF Personal</button>
Â  Â  Â  Â  <button class="live-mode-btn" onclick="startLiveMode(globalItems1)">Modo Show ğŸ¤</button>
Â  Â  Â  </div>
Â  Â  Â  <p id="total-time"></p>
Â  Â  </section>
Â  Â  
Â  Â  <section id="rehearsals"> 
Â  Â  Â  Â  <h2>PrÃ³ximos Ensayos</h2> 
Â  Â  Â  Â  <div class="table-wrapper">
Â  Â  Â  Â  Â  Â  <table id="rehearsal-main-table"> 
Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Fecha</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Hora</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Lugar</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="calendar-col-header">Cal</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="details-col-header">Info</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Confirmar Asistencia</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="rehearsal-main-body"></tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  </section>
Â  Â  
Â  Â  <section id="second-setlist">
Â  Â  Â  <h2>Setlist PrÃ³ximo Concierto</h2>
Â  Â  Â  <p id="second-setlist-dynamic-name" class="setlist-dynamic-name"></p>
Â  Â  Â  <div class="table-wrapper"> 
Â  Â  Â  Â  <table id="second-list-table"> 
Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  <th>#</th>
Â  Â  Â  Â  Â  Â  Â  <th>CanciÃ³n</th>
Â  Â  Â  Â  Â  Â  Â  <th class="jukebox-col-header">ğŸ§</th> Â  Â  Â  Â  Â  Â  Â  <th>Key</th>
Â  Â  Â  Â  Â  Â  Â  <th>Tempo</th>
Â  Â  Â  Â  Â  Â  Â  <th>Time</th>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody id="second-body"></tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  Â  <div style="text-align: center;">
Â  Â  Â  Â  <button class="download-btn" id="download-btn-2">Pdf Complex</button>
Â  Â  Â  Â  <button class="download-btn" id="download-basic-btn-2">Pdf Simple</button>
Â  Â  Â  Â  <button class="download-btn" id="download-personal-btn-2">PDF Personal</button>
Â  Â  Â  Â  <button class="live-mode-btn" onclick="startLiveMode(globalItems2)">Modo Show ğŸ¤</button>
Â  Â  Â  </div>
Â  Â  Â  <p id="total-time-2"></p>
Â  Â  </section>
Â  Â  
Â  Â  <section id="star-setlist">
Â  Â  Â  <h2>Setlist Concierto Estrella</h2>
Â  Â  Â  <p id="star-setlist-dynamic-name" class="setlist-dynamic-name"></p>
Â  Â  Â  <div class="table-wrapper"> 
Â  Â  Â  Â  <table> 
Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  <th>#</th>
Â  Â  Â  Â  Â  Â  Â  <th>TÃ­tulo</th>
Â  Â  Â  Â  Â  Â  Â  <th class="jukebox-col-header">ğŸ§</th> Â  Â  Â  Â  Â  Â  Â  <th>Key</th>
Â  Â  Â  Â  Â  Â  Â  <th>Tempo</th>
Â  Â  Â  Â  Â  Â  Â  <th>Time</th>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody id="star-setlist-body"></tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  Â  <div style="text-align: center;">
Â  Â  Â  Â  <button class="download-btn" id="download-btn-star">Pdf Complex</button>
Â  Â  Â  Â  <button class="download-btn" id="download-basic-btn-star">Pdf Simple</button>
Â  Â  Â  Â  <button class="download-btn" id="download-personal-btn-star">PDF Personal</button>
Â  Â  Â  Â  <button class="live-mode-btn" onclick="startLiveMode(globalItemsStar)">Modo Show ğŸ¤</button>
Â  Â  Â  </div>
Â  Â  Â  <p id="total-time-star"></p>
Â  Â  </section>
Â  Â  
Â  Â  <section id="calendario"> <h2>PrÃ³ximos Conciertos</h2> <div id="bandhelper-concerts-container"> <script src="https://www.bandhelper.com/widget/calendar/10353?layout=1&range=6"></script> <p id="bandhelper-loading-message" style="display:none;">Procesando conciertos...</p> </div> </section>

Â  Â  <section id="vista-calendario-mensual">
Â  Â  Â  <h2>Calendario Mensual</h2>
Â  Â  Â  <div class="calendar-controls">
Â  Â  Â  Â  <button id="prev-month-btn">< Anterior</button>
Â  Â  Â  Â  <h3 id="calendar-month-display" style="margin:0; color:#fff;">Mes AÃ±o</h3>
Â  Â  Â  Â  <button id="next-month-btn">Siguiente ></button>
Â  Â  Â  </div>
Â  Â  Â  <div class="calendar-grid" id="calendar-grid-container"></div>
Â  Â  </section>
Â  </main>

Â  <footer>Â© AÃ±o 2025 -iDoctor & El SÃ³tano del Doctor- All Rights Reserved.</footer>

Â  <audio id="site-audio">
Â  Â  <source src="" type="audio/mpeg">
Â  Â  Tu navegador no soporta el elemento de audio.
Â  </audio>

<script>
/* ---------- 0. Firebase ---------- */
const firebaseConfig = {
Â  apiKey: "AIzaSyCEP44xNINCkIejgNvcYafJsALnO0y4dfw",Â Â 
Â  authDomain: "sotanointranet.firebaseapp.com",
Â  projectId: "sotanointranet",
Â  storageBucket: "sotanointranet.appspot.com",Â Â 
Â  messagingSenderId: "756955233128",
Â  appId: "1:756955233128:web:ab36372bdbd895a30e74dd"
};
if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "TU_API_KEY_AQUI" || (firebaseConfig.apiKey.startsWith("AIzaSyC") && firebaseConfig.apiKey.length < 30 && firebaseConfig.apiKey.includes("placeholder")) ) { const banner = document.getElementById('firebase-critical-error-banner'); if (banner) banner.style.display = 'block'; console.error("Â¡ERROR CRÃTICO! La API Key de Firebase no estÃ¡ configurada o es un placeholder.");}
firebase.initializeApp(firebaseConfig); const db = firebase.firestore(); firebase.firestore().enablePersistence().catch(err => { console.warn("Persistencia Firestore no habilitada:", err.code === 'failed-precondition' ? 'MÃºltiples pestaÃ±as.' : err.message); });

/* ---------- 1. Utilidades y Variables Globales ---------- */
let globalItems1 = [];
let globalItems2 = [];
let globalItemsStar = [];
let globalAudioLinks = {}; // NUEVO: AlmacÃ©n global para los links de audio

const parseDuration = str => { if (!str) return 0; if (str.includes(":")) { const [m, s = 0] = str.split(":").map(Number); return m * 60 + s; } const n = parseInt(str, 10); return isNaN(n) ? 0 : n;};
const toMMSS = s => { if (isNaN(s) || s === null || s === undefined) s = 0; const totalSeconds = Math.round(s); return `${Math.floor(totalSeconds / 60)}:${String(totalSeconds % 60).padStart(2, "0")}`;};
const toHHMM = s => { if (isNaN(s) || s === null || s === undefined) s = 0; const totalSeconds = Math.round(s); const h = Math.floor(totalSeconds / 3600); const m = Math.floor((totalSeconds % 3600) / 60); return h ? `${h}h ${String(m).padStart(2, "0")}m` : `${m}m`;};
const toHours = s => { if (isNaN(s) || s === null || s === undefined) return (0).toFixed(2); return (s / 3600).toFixed(2);};
function decodeHtmlEntities(text) { if (typeof text !== 'string') return text; const textArea = document.createElement('textarea'); textArea.innerHTML = text; return textArea.value;}
const calculateDuration = (startTime, endTime) => { if (!startTime || !endTime) return 0; const [startH, startM] = startTime.split(":").map(Number); const [endH, endM] = endTime.split(":").map(Number); const startSeconds = startH * 3600 + startM * 60; const endSeconds = endH * 3600 + endM * 60; let duration = endSeconds - startSeconds; if (duration < 0) duration += 24 * 3600; return duration;};
const formatDateWithDay = dateStr => { const date = new Date(dateStr + 'T00:00:00Z'); const days = ["Domingo", "Lunes", "Martes", "MiÃ©rcoles", "Jueves", "Viernes", "SÃ¡bado"]; const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]; return `${days[date.getUTCDay()]} ${date.getUTCDate()} de ${months[date.getUTCMonth()]}`;};
const getMonthYear = dateStr => { const date = new Date(dateStr + 'T00:00:00Z'); const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]; return `${months[date.getUTCMonth()]} ${date.getUTCFullYear()}`;};
function generateICS(title, date, startTime, location, description = "", durationSeconds = 7200) { const startDate = new Date(`${date}T${startTime}`); const endDate = new Date(startDate.getTime() + durationSeconds * 1000); const formatICSDate = d => { const pad = (num) => String(num).padStart(2, '0'); return `${d.getUTCFullYear()}${pad(d.getUTCMonth() + 1)}${pad(d.getUTCDate())}T${pad(d.getUTCHours())}${pad(d.getUTCMinutes())}${pad(d.getUTCSeconds())}Z`; }; const startICS = formatICSDate(startDate); const endICS = formatICSDate(endDate); const icsContent = ["BEGIN:VCALENDAR", "VERSION:2.0", "PRODID:-//ElSotanoDelDoctor//Intranet//ES", "BEGIN:VEVENT", `DTSTAMP:${new Date().toISOString().replace(/[-:.]/g, "")}Z`, `UID:${startICS}-${sanitizeFirebaseKey(title)}@elsotanodeldoctor.com`, `DTSTART:${startICS}`, `DTEND:${endICS}`, `SUMMARY:${title}`, `DESCRIPTION:${description}`, `LOCATION:${location}`, "END:VEVENT", "END:VCALENDAR"].join("\r\n"); const blob = new Blob([icsContent], { type: "text/calendar;charset=utf-8" }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = `${sanitizeFirebaseKey(title)}.ics`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); }
const sanitizeFirebaseKey = (str) => str.replace(/[.#$[\]/:\s,]/g, '_');
const sanitizeForPdfFilename = (str) => (str || "setlist").replace(/[\\/:*?"<>|#$.[\]]/g, '_').replace(/\s+/g, '_');

/* ---------- 1.5. Manejo de conexiÃ³n ---------- */
const connectionStatus = document.getElementById("connection-status"); let isOnline = navigator.onLine;Â 
function updateConnectionStatus() { isOnline = navigator.onLine; if (!isOnline) { connectionStatus.className = "offline"; connectionStatus.textContent = "Sin conexiÃ³n: Mostrando datos en cachÃ©"; connectionStatus.style.display = "block"; } else { connectionStatus.style.display = "none"; } }Â 
window.addEventListener("online", updateConnectionStatus); window.addEventListener("offline", updateConnectionStatus);Â 
async function withRetry(fn, maxRetries = 3, delay = 2000) { for (let i = 0; i < maxRetries; i++) { try { if (!navigator.onLine) { connectionStatus.className = "offline"; connectionStatus.textContent = "Sin conexiÃ³n. OperaciÃ³n podrÃ­a fallar o usar cachÃ©."; connectionStatus.style.display = "block"; } return await fn(); } catch (e) { console.error(`Intento ${i+1} fallido:`, e); if (i === maxRetries - 1 || !navigator.onLine) { connectionStatus.className = "offline"; connectionStatus.textContent = "Error: OperaciÃ³n fallida. " + e.message; connectionStatus.style.display = "block"; throw e; } connectionStatus.className = "retrying"; connectionStatus.textContent = `Reintentando (${i + 1}/${maxRetries})...`; connectionStatus.style.display = "block"; await new Promise(resolve => setTimeout(resolve, delay)); } } }

/* ---------- 2. Acceso Firestore ---------- */
async function loadDoc(collection, docId, fallback) { try { const snap = await db.collection(collection).doc(docId).get(); return snap.exists ? snap.data() : fallback; } catch (e) { console.error(`Error al cargar documento ${collection}/${docId}:`, e.message, e); return fallback; } }
async function saveDoc(collection, docId, data, merge = false) { try { console.log(`Firestore: Guardando en ${collection}/${docId}. Datos:`, JSON.parse(JSON.stringify(data)), "Con merge:", merge); await db.collection(collection).doc(docId).set(data, { merge: merge }); console.log(`Firestore: Guardado de ${collection}/${docId} exitoso con merge=${merge}`); return true; } catch (e) { console.error(`Error al guardar documento ${collection}/${docId} con merge=${merge}:`, e.message, e); throw e; } }

/* ---------- 3. ConfiguraciÃ³n Setlists ---------- */
let setlistConfig = {setlist1:{name:"Setlist Predeterminado Ensayo",url:"URL_POR_CONFIGURAR_1"},setlist2:{name:"Setlist Predeterminado PrÃ³ximo Concierto",url:"URL_POR_CONFIGURAR_2"},setlistStar:{name:"Setlist Predeterminado Concierto Estrella",url:"URL_POR_CONFIGURAR_STAR"}};
function updateDynamicSetlistTitles(){document.getElementById("setlist1-dynamic-name").textContent=setlistConfig.setlist1.name;document.getElementById("second-setlist-dynamic-name").textContent=setlistConfig.setlist2.name;document.getElementById("star-setlist-dynamic-name").textContent=setlistConfig.setlistStar.name}
async function loadSetlistConfig(){try{const data=await withRetry(()=>loadDoc("intranet","setlists",{config:setlistConfig}));setlistConfig={setlist1:data.config?.setlist1||setlistConfig.setlist1,setlist2:data.config?.setlist2||setlistConfig.setlist2,setlistStar:data.config?.setlistStar||setlistConfig.setlistStar};updateDynamicSetlistTitles()}catch(e){console.error("Error al cargar la configuraciÃ³n de setlists:",e);updateDynamicSetlistTitles()}}
async function saveSetlistConfig(){updateDynamicSetlistTitles();return await withRetry(()=>saveDoc("intranet","setlists",{config:setlistConfig}))}
async function cargarSetlistGenerico(configEntry, tbodyId, totalTimeId, defaultErrorMessage) {
Â  Â  const CACHE_KEY = `cache_setlist_${tbodyId}`;
Â  Â  let rawData = null;
Â  Â  let usedCache = false;

    // 1. Cargamos los links de audio de Firebase
    if(Object.keys(globalAudioLinks).length === 0) {
        await loadAudioLinks(); 
    }
    
Â  Â  try {
Â  Â  Â  Â  if (!configEntry.url || configEntry.url.startsWith("URL_POR_CONFIGURAR")) { throw new Error("URL no configurada."); }
Â  Â  Â  Â  const response = await fetch(configEntry.url);
Â  Â  Â  Â  if (!response.ok) throw new Error(`Error API (${response.status})`);
Â  Â  Â  Â  rawData = await response.json();
Â  Â  Â  Â  localStorage.setItem(CACHE_KEY, JSON.stringify(rawData));
Â  Â  } catch (networkError) {
Â  Â  Â  Â  console.warn(`[Offline Mode] FallÃ³ la descarga para ${tbodyId}. Intentando cachÃ©...`, networkError);
Â  Â  Â  Â  const cachedData = localStorage.getItem(CACHE_KEY);
Â  Â  Â  Â  if (cachedData) {
Â  Â  Â  Â  Â  Â  rawData = JSON.parse(cachedData);
Â  Â  Â  Â  Â  Â  usedCache = true;
Â  Â  Â  Â  Â  Â  const titleEl = document.getElementById(totalTimeId).previousElementSibling.previousElementSibling;
Â  Â  Â  Â  Â  Â  if(titleEl) titleEl.innerHTML += " <span style='color:orange; font-size:0.8em;'>(âš ï¸ Modo Offline)</span>";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  console.error(`[cargarSetlistGenerico] Error fatal: ${defaultErrorMessage}`, networkError);
Â  Â  Â  Â  Â  Â  const tbody = document.getElementById(tbodyId);
Â  Â  Â  Â  Â  Â  if (tbody) tbody.innerHTML = `<tr><td colspan="6" style="color:red;">${defaultErrorMessage}. Sin conexiÃ³n y sin cachÃ©.</td></tr>`; // Modificado a colspan="6"
Â  Â  Â  Â  Â  Â  const totalTimeElem = document.getElementById(totalTimeId);
Â  Â  Â  Â  Â  Â  if (totalTimeElem) totalTimeElem.textContent = "Error de conexiÃ³n.";
Â  Â  Â  Â  Â  Â  return [];
Â  Â  Â  Â  }
Â  Â  }

Â  Â  const dataToProcess = Array.isArray(rawData) ? rawData : rawData.items || [];
Â  Â  const processedItems = dataToProcess.map(item => {
Â  Â  Â  Â  if (!item || item.type !== "song" && item.type !== "set") { return null }
Â  Â  Â  Â  let rawDurationValue = parseFloat(item.duration);
Â  Â  Â  Â  let durationIsInvalidOrMissing = isNaN(rawDurationValue) || rawDurationValue === 0;
Â  Â  Â  Â  if (isNaN(rawDurationValue)) { rawDurationValue = 0; durationIsInvalidOrMissing = true }
Â  Â  Â  Â  let durationInSeconds;
Â  Â  Â  Â  const itemName = item.name || item.title || (item.type === "song" ? "CanciÃ³n sin tÃ­tulo" : "Set sin nombre");
Â  Â  Â  Â  const isBreakByName = /break|descanso|intermedio|pausa|intermission|beer time/i.test(itemName);
Â  Â  Â  Â  item.isSong = false; item.isBreak = false; item.isSetHeader = false;
Â  Â  Â  Â  if (item.type === "song") { durationInSeconds = rawDurationValue; item.isSong = true; }Â 
Â  Â  Â  Â  else if (item.type === "set") {
Â  Â  Â  Â  Â  Â  if (isBreakByName) { item.isBreak = true; if (durationIsInvalidOrMissing) { durationInSeconds = 3 * 60 } else { durationInSeconds = rawDurationValue * 60 } }Â 
Â  Â  Â  Â  Â  Â  else { item.isSetHeader = true; durationInSeconds = rawDurationValue * 60 }
Â  Â  Â  Â  } else { durationInSeconds = 0 }
Â  Â  Â  Â  item.calculatedDurationSeconds = durationInSeconds;
Â  Â  Â  Â  item.displayName = decodeHtmlEntities(item.title || item.name || (item.isSong ? "CanciÃ³n sin tÃ­tulo" : item.isBreak ? "Pausa" : "Set"));
Â  Â  Â  Â  item.originalJSONDuration = item.duration;
        
        // **NUEVA LÃ“GICA DE AUDIO:** Toma el link del campo de Firebase (link_audio)
        const songKey = sanitizeFirebaseKey(item.displayName);
        item.link_audio = globalAudioLinks[songKey] || null; 
        
Â  Â  Â  Â  return item
Â  Â  }).filter(item => item !== null);

Â  Â  const tbody = document.getElementById(tbodyId);
Â  Â  tbody.innerHTML = "";
Â  Â  let songCount = 0;
Â  Â  const setlistStructure = [];
Â  Â  let currentSet = null;

Â  Â  processedItems.forEach(item => {
Â  Â  Â  Â  if (item.isSetHeader) {
Â  Â  Â  Â  Â  Â  if (currentSet) { currentSet.calculatedBlockDurationSeconds = currentSet.songs.reduce((sum, song) => sum + (song.calculatedDurationSeconds || 0), 0); setlistStructure.push(currentSet) }
Â  Â  Â  Â  Â  Â  currentSet = { ...item, songs: [], calculatedBlockDurationSeconds: 0 }
Â  Â  Â  Â  } else if (item.isBreak) {
Â  Â  Â  Â  Â  Â  if (currentSet) { currentSet.calculatedBlockDurationSeconds = currentSet.songs.reduce((sum, song) => sum + (song.calculatedDurationSeconds || 0), 0); setlistStructure.push(currentSet); currentSet = null }
Â  Â  Â  Â  Â  Â  setlistStructure.push(item)
Â  Â  Â  Â  } else if (item.isSong) {
Â  Â  Â  Â  Â  Â  if (!currentSet) { currentSet = { isSetHeader: true, displayName: "Set General", calculatedDurationSeconds: 0, songs: [], calculatedBlockDurationSeconds: 0 } }
Â  Â  Â  Â  Â  Â  currentSet.songs.push(item)
Â  Â  Â  Â  }
Â  Â  });
Â  Â  if (currentSet) { currentSet.calculatedBlockDurationSeconds = currentSet.songs.reduce((sum, song) => sum + (song.calculatedDurationSeconds || 0), 0); setlistStructure.push(currentSet) }

Â  Â  let totalSecondsOverall = 0;
Â  Â  setlistStructure.forEach(blockOrItem => {
Â  Â  Â  Â  if (blockOrItem.isSetHeader) {
Â  Â  Â  Â  Â  Â  const setHeaderTime = toHHMM(blockOrItem.calculatedBlockDurationSeconds || 0);
Â  Â  Â  Â  Â  Â  tbody.insertAdjacentHTML("beforeend", `<tr class="set-header-row"><td colspan="6">${blockOrItem.displayName} (${setHeaderTime})</td></tr>`);
Â  Â  Â  Â  Â  Â  totalSecondsOverall += (blockOrItem.calculatedBlockDurationSeconds || 0);
Â  Â  Â  Â  Â  Â  blockOrItem.songs.forEach(song => {
Â  Â  Â  Â  Â  Â  Â  Â  songCount++;
Â  Â  Â  Â  Â  Â  Â  Â  const songFormattedTime = toMMSS(song.calculatedDurationSeconds || 0);
                // Columna Jukebox: Si hay link_audio, el botÃ³n estÃ¡ activo y tiene onclick
                const hasAudio = !!song.link_audio;
                const jukeboxButton = `<td class="jukebox-col">${hasAudio ? `<button class="jukebox-btn active" title="Escuchar: ${song.displayName}" onclick="openJukeboxPlayer('${encodeURIComponent(song.link_audio)}', '${song.displayName}')"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2-9c-.55 0-1 .45-1 1v2c0 .55.45 1 1 1h2c.55 0 1-.45 1-1v-2c0-.55-.45-1-1-1h-2zm-3.5 1.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5S4 9.17 4 10s.67 1.5 1.5 1.5zm13 0c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5S17 9.17 17 10s.67 1.5 1.5 1.5z"/></svg></button>` : `<button class="jukebox-btn muted" title="Sin archivo de audio"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2-9c-.55 0-1 .45-1 1v2c0 .55.45 1 1 1h2c.55 0 1-.45 1-1v-2c0-.55-.45-1-1-1h-2zm-3.5 1.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5S4 9.17 4 10s.67 1.5 1.5 1.5zm13 0c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5S17 9.17 17 10s.67 1.5 1.5 1.5z"/></svg></button>`}</td>`;
Â  Â  Â  Â  Â  Â  Â  Â  tbody.insertAdjacentHTML("beforeend", `<tr><td>${songCount}</td><td>${song.displayName}</td>${jukeboxButton}<td>${decodeHtmlEntities(song.key || "-")}</td><td>${decodeHtmlEntities(song.tempo || "-")}</td><td>${songFormattedTime}</td></tr>`)
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  } else if (blockOrItem.isBreak) {
Â  Â  Â  Â  Â  Â  const breakFormattedTime = toMMSS(blockOrItem.calculatedDurationSeconds || 0);
Â  Â  Â  Â  Â  Â  totalSecondsOverall += (blockOrItem.calculatedDurationSeconds || 0);
Â  Â  Â  Â  Â  Â  tbody.insertAdjacentHTML("beforeend", `<tr class="break-row"><td></td><td style="font-style:italic;">${blockOrItem.displayName}</td><td style="font-style:italic; text-align:center;">-</td><td style="font-style:italic; text-align:center;">-</td><td style="font-style:italic; text-align:center;">-</td><td style="font-style:italic; text-align:center;">${breakFormattedTime}</td></tr>`)
Â  Â  Â  Â  } else if (blockOrItem.isSong) {
Â  Â  Â  Â  Â  Â  songCount++;
Â  Â  Â  Â  Â  Â  const songFormattedTime = toMMSS(blockOrItem.calculatedDurationSeconds || 0);
Â  Â  Â  Â  Â  Â  totalSecondsOverall += (blockOrItem.calculatedDurationSeconds || 0);
            // Columna Jukebox: Si hay link_audio, el botÃ³n estÃ¡ activo y tiene onclick
            const hasAudio = !!blockOrItem.link_audio;
            const jukeboxButton = `<td class="jukebox-col">${hasAudio ? `<button class="jukebox-btn active" title="Escuchar: ${blockOrItem.displayName}" onclick="openJukeboxPlayer('${encodeURIComponent(blockOrItem.link_audio)}', '${blockOrItem.displayName}')"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2-9c-.55 0-1 .45-1 1v2c0 .55.45 1 1 1h2c.55 0 1-.45 1-1v-2c0-.55-.45-1-1-1h-2zm-3.5 1.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5S4 9.17 4 10s.67 1.5 1.5 1.5zm13 0c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5S17 9.17 17 10s.67 1.5 1.5 1.5z"/></svg></button>` : `<button class="jukebox-btn muted" title="Sin archivo de audio"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2-9c-.55 0-1 .45-1 1v2c0 .55.45 1 1 1h2c.55 0 1-.45 1-1v-2c0-.55-.45-1-1-1h-2zm-3.5 1.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5S4 9.17 4 10s.67 1.5 1.5 1.5zm13 0c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5S17 9.17 17 10s.67 1.5 1.5 1.5z"/></svg></button>`}</td>`;
Â  Â  Â  Â  Â  Â  tbody.insertAdjacentHTML("beforeend", `<tr><td>${songCount}</td><td>${blockOrItem.displayName}</td>${jukeboxButton}<td>${decodeHtmlEntities(blockOrItem.key || "-")}</td><td>${decodeHtmlEntities(blockOrItem.tempo || "-")}</td><td>${songFormattedTime}</td></tr>`)
Â  Â  Â  Â  }
Â  Â  });
Â  Â Â 
Â  Â  let timeText = "Tiempo total del set: " + toHHMM(totalSecondsOverall);
Â  Â  if(usedCache) timeText += " (Datos guardados)";
Â  Â Â 
Â  Â  document.getElementById(totalTimeId).textContent = timeText;
Â  Â  return setlistStructure;
}

const cargarPrimerSetlist = async () => { globalItems1 = await cargarSetlistGenerico(setlistConfig.setlist1, "setlist-body", "total-time", "Error cargando Setlist PrÃ³ximo Ensayo"); return globalItems1; };
const cargarSegundoSetlist = async () => { globalItems2 = await cargarSetlistGenerico(setlistConfig.setlist2, "second-body", "total-time-2", "Error cargando Setlist PrÃ³ximo Concierto"); return globalItems2; };
const cargarStarSetlist = async () => { globalItemsStar = await cargarSetlistGenerico(setlistConfig.setlistStar, "star-setlist-body", "total-time-star", "Error cargando Setlist Concierto Estrella"); return globalItemsStar; };

/* ---------- 6. Usuarios ---------- */
let users = []; let editingUserIndex = null; const excludedRehearsalUsers = ["Ximo", "GinÃ©s Torres"];Â Â 
function renderUsers() { const tbodyMgmt=document.getElementById("user-table-body");const tbodyDisplay=document.getElementById("users-body");if(tbodyMgmt)tbodyMgmt.innerHTML="";if(tbodyDisplay)tbodyDisplay.innerHTML="";if(!Array.isArray(users)||users.length===0){const emptyMsgMgmt='<tr><td colspan="4">No hay usuarios registrados.</td></tr>';const emptyMsgDisplay='<tr><td colspan="3">No hay usuarios registrados.</td></tr>';if(tbodyMgmt)tbodyMgmt.innerHTML=emptyMsgMgmt;if(tbodyDisplay)tbodyDisplay.innerHTML=emptyMsgDisplay;return} users.forEach((u,i)=>{if(!u||typeof u!=='object'||!u.name||!u.nickname||!Array.isArray(u.roles)){console.warn(`Usuario invÃ¡lido en la posiciÃ³n ${i}:`,u);return} const rolesDisplay=u.roles.join(", ");if(tbodyMgmt){tbodyMgmt.insertAdjacentHTML("beforeend",`<tr><td>${u.name}</td><td>${u.nickname}</td><td>${rolesDisplay}</td><td><button data-i="${i}" class="edit-user">Editar</button><button data-i="${i}" class="delete-user">Eliminar</button></td></tr>`)} if(tbodyDisplay){tbodyDisplay.insertAdjacentHTML("beforeend",`<tr><td>${u.name}</td><td>${u.nickname}</td><td>${rolesDisplay}</td></tr>`)}});if(tbodyMgmt){tbodyMgmt.querySelectorAll(".delete-user").forEach(btn=>btn.onclick=async()=>{const userIndex=parseInt(btn.dataset.i,10);const userToDelete=users[userIndex];if(confirm(`Â¿EstÃ¡s seguro de que deseas eliminar al usuario "${userToDelete.name}"? Esto tambiÃ©n eliminarÃ¡ sus asistencias asociadas a ensayos y conciertos.`)){rehearsals.forEach(r=>{if(Array.isArray(r.attendance)){r.attendance=r.attendance.filter(a=>a.name!==userToDelete.name)}});users.splice(userIndex,1);await saveUsers();await saveRehearsals();renderStats()}});tbodyMgmt.querySelectorAll(".edit-user").forEach(btn=>btn.onclick=()=>{editingUserIndex=parseInt(btn.dataset.i,10);const user=users[editingUserIndex];document.getElementById("user-name").value=user.name;document.getElementById("user-nickname").value=user.nickname;const roleSelect=document.getElementById("user-role");Array.from(roleSelect.options).forEach(option=>{option.selected=user.roles.includes(option.value)});document.getElementById("add-user").textContent="Guardar Cambios";document.getElementById("cancel-edit-user").style.display="inline-block"})}}
async function loadUsers() { try { const data = await withRetry(() => loadDoc("intranet", "users", { users: [] })); users = Array.isArray(data.users) ? data.users : []; users = users.filter(u => u && typeof u === 'object' && u.name && u.nickname && Array.isArray(u.roles)); renderUsers(); populateIdentitySelector(); } catch (e) { console.error("Error al cargar usuarios:", e); } }
async function saveUsers() { try { await withRetry(() => saveDoc("intranet", "users", { users })); renderUsers(); renderRehearsals(); renderStats(); return true; } catch (e) { console.error("Error al guardar usuarios:", e); throw e; } }
function resetUserForm() { document.getElementById("user-name").value = ""; document.getElementById("user-nickname").value = ""; const roleSelect = document.getElementById("user-role"); Array.from(roleSelect.options).forEach(option => option.selected = false); document.getElementById("add-user").textContent = "AÃ±adir Usuario"; document.getElementById("cancel-edit-user").style.display = "none"; editingUserIndex = null; }

function populateIdentitySelector() {
Â  Â  const select = document.getElementById('user-identity-selector');
Â  Â  select.innerHTML = '<option value="" disabled selected>-- Selecciona tu nombre --</option>';
Â  Â  users.sort((a, b) => a.name.localeCompare(b.name)).forEach(u => {
Â  Â  Â  Â  select.insertAdjacentHTML('beforeend', `<option value="${u.name}">${u.name} (${u.nickname})</option>`);
Â  Â  });
}

/* ---------- 7. Ensayos ---------- */
let rehearsals = []; let editingRehearsalIndex = null;
function renderRehearsals() {Â 
Â  Â  const tbodyConfig=document.getElementById("rehearsal-table-body");
Â  Â  const tbodyMain=document.getElementById("rehearsal-main-body");
Â  Â Â 
Â  Â  if(!tbodyConfig||!tbodyMain){console.error("Tablas de ensayos no encontradas en el DOM.");return}Â 
Â  Â Â 
Â  Â  rehearsals.sort((a,b)=>new Date(a.date+'T'+(a.startTime||'00:00'))-new Date(b.date+'T'+(b.startTime||'00:00')));
Â  Â  tbodyConfig.innerHTML=tbodyMain.innerHTML="";
Â  Â Â 
Â  Â  if(!Array.isArray(rehearsals)||rehearsals.length===0){
Â  Â  Â  Â  const emptyMsgConfig='<tr><td colspan="6">No hay ensayos programados.</td></tr>';
Â  Â  Â  Â  tbodyConfig.innerHTML=emptyMsgConfig;
Â  Â  Â  Â  const emptyMsgMain='<tr><td colspan="6">No hay prÃ³ximos ensayos.</td></tr>';
Â  Â  Â  Â  tbodyMain.innerHTML=emptyMsgMain;
Â  Â  Â  Â  return
Â  Â  }Â 
Â  Â Â 
Â  Â  const availableUsersForRehearsal=users.filter(user=>!excludedRehearsalUsers.includes(user.name));
Â  Â  const userOptions=availableUsersForRehearsal.length>0?availableUsersForRehearsal.map(user=>`<option value="${user.name}">${user.nickname||user.name}</option>`).join(""):`<option value="" disabled>No hay usuarios disponibles</option>`;
Â  Â Â 
Â  Â  const now=new Date();
Â  Â  const today=new Date(now.getFullYear(),now.getMonth(),now.getDate());Â 
Â  Â Â 
Â  Â  rehearsals.forEach((r,i)=>{
Â  Â  Â  Â  if(r.time&&(!r.startTime||!r.endTime)){r.startTime=r.time;const[hours,minutes]=r.time.split(":").map(Number);const endHours=(hours+2)%24;r.endTime=`${String(endHours).padStart(2,"0")}:${String(minutes).padStart(2,"0")}`;delete r.time}Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  const formattedDate=formatDateWithDay(r.date);
Â  Â  Â  Â  const durationSeconds=calculateDuration(r.startTime,r.endTime);
Â  Â  Â  Â  const durationText=toHHMM(durationSeconds);
Â  Â  Â  Â  const attendance=Array.isArray(r.attendance)?r.attendance:[];
Â  Â  Â  Â  const getAttendeeNicknames=status=>attendance.filter(a=>a.attending===status).map(a=>{const user=users.find(u=>u.name===a.name);return user?user.nickname:a.name}).join(", ")||"Ninguno";
Â  Â  Â  Â  const summary=`<div class="attendance-summary"><span class="attending-yes">Asisten: ${getAttendeeNicknames("SÃ­")}</span><span class="attending-no">No asisten: ${getAttendeeNicknames("No")}</span></div>`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Tabla ConfiguraciÃ³n
Â  Â  Â  Â  tbodyConfig.insertAdjacentHTML("beforeend",`<tr><td>${r.date}</td><td>${r.startTime}</td><td>${r.endTime}</td><td>${r.location}</td><td>${summary}</td><td><button data-i="${i}" class="edit-rehearsal">Editar</button><button data-i="${i}" class="clear-attendance">Eliminar Asistentes</button><button data-i="${i}" class="delete-rehearsal">Eliminar</button></td></tr>`);Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  const rehearsalDate=new Date(r.date+'T00:00:00Z');
Â  Â  Â  Â  if(rehearsalDate>=today){
Â  Â  Â  Â  Â  Â  const calendarCell=`<td class="calendar-col"><button class="calendar-btn" title="AÃ±adir a mi calendario" onclick='generateICS("Ensayo El SÃ³tano del Doctor", "${r.date}", "${r.startTime}", "${r.location}", "Ensayo de la banda El SÃ³tano del Doctor.", ${durationSeconds})'><svg viewBox="0 0 24 24"><path d="M12 4V2m0 20v-2m8-8h2m-20 0h-2m15.071-3.071l-1.414-1.414M5.343 17.657l-1.414-1.414m0-10.486l1.414-1.414m12.728 12.728l-1.414 1.414"/><rect x="4" y="6" width="16" height="12" rx="2"/></svg></button></td>`;
Â  Â  Â  Â  Â  Â  const detailsCell = `<td class="details-col-header"><button class="details-btn" onclick="openRehearsalDetailsModal(${i})" title="Notas del Ensayo">â¡ï¸</button></td>`;
Â  Â  Â  Â  Â  Â  tbodyMain.insertAdjacentHTML("beforeend",`<tr><td>${formattedDate} <span class="rehearsal-duration">(${durationText})</span></td><td>${r.startTime} - ${r.endTime}</td><td>${r.location}</td>${calendarCell}${detailsCell}<td><div class="attendance-form"><select class="attendance-user" data-i="${i}"><option value="" disabled selected>Â¿Nombre?</option>${userOptions}</select><select class="attendance-response" data-i="${i}"><option value="" disabled selected>Â¿AsistirÃ¡s?</option><option value="SÃ­">SÃ­</option><option value="No">No</option></select><button class="confirm-attendance" data-i="${i}">Confirmar</button></div>${summary}</td></tr>`)
Â  Â  Â  Â  }
Â  Â  });Â 

Â  Â  // Event Listeners Config
Â  Â  tbodyConfig.querySelectorAll(".edit-rehearsal").forEach(btn=>btn.onclick=()=>{editingRehearsalIndex=parseInt(btn.dataset.i,10);const rehearsal=rehearsals[editingRehearsalIndex];document.getElementById("rehearsal-date").value=rehearsal.date;document.getElementById("rehearsal-start-time").value=rehearsal.startTime;document.getElementById("rehearsal-end-time").value=rehearsal.endTime;document.getElementById("rehearsal-location").value=rehearsal.location;document.getElementById("add-rehearsal").textContent="Guardar Cambios";document.getElementById("cancel-edit-rehearsal").style.display="inline-block"});Â 
Â  Â  tbodyConfig.querySelectorAll(".delete-rehearsal").forEach(btn=>btn.onclick=async()=>{if(confirm("Â¿EstÃ¡s seguro de que deseas eliminar este ensayo?")){rehearsals.splice(parseInt(btn.dataset.i,10),1);await saveRehearsals();renderStats()}});Â 
Â  Â  tbodyConfig.querySelectorAll(".clear-attendance").forEach(btn=>btn.onclick=async()=>{const index=parseInt(btn.dataset.i,10);const rehearsal=rehearsals[index];if(confirm(`Â¿Eliminar asistencias para ensayo del ${formatDateWithDay(rehearsal.date)} en ${rehearsal.location}?`)){rehearsal.attendance=[];await saveRehearsals();document.getElementById("rehearsal-message").textContent="Asistencias eliminadas.";renderStats()}});Â 
Â  Â Â 
Â  Â  // Event Listeners Main
Â  Â  tbodyMain.querySelectorAll(".confirm-attendance").forEach(btn=>{btn.onclick=async()=>{const index=parseInt(btn.dataset.i,10);const userSelect=document.querySelector(`.attendance-user[data-i="${index}"]`);const responseSelect=document.querySelector(`.attendance-response[data-i="${index}"]`);const name=userSelect.value;const attending=responseSelect.value;if(!name||!attending){alert("Selecciona nombre y respuesta.");return} const rehearsal=rehearsals[index];const confirmMsg=`${name}, Â¿${attending==="SÃ­"?"ASISTIRÃS":"NO ASISTIRÃS"} al ensayo del ${formatDateWithDay(rehearsal.date)}?`;if(!confirm(confirmMsg))return;if(!Array.isArray(rehearsal.attendance))rehearsal.attendance=[];const existingResponse=rehearsal.attendance.find(a=>a.name===name);if(existingResponse)existingResponse.attending=attending;else rehearsal.attendance.push({name,attending});try{await saveRehearsals();userSelect.value="";responseSelect.value="";renderStats()}catch(e){alert("Error al guardar asistencia: "+e.message)}}})
}

/* LÃ³gica Modal Detalles Ensayo */
const rehearsalDetailModal = document.getElementById('rehearsal-details-modal');
function openRehearsalDetailsModal(index) {
Â  Â  const rehearsal = rehearsals[index];
Â  Â  if(!rehearsal) return;

Â  Â  document.getElementById('rehearsal-detail-index').value = index;
Â  Â  document.getElementById('rehearsal-detail-title-display').textContent = `Ensayo: ${formatDateWithDay(rehearsal.date)} (${rehearsal.startTime} - ${rehearsal.endTime})`;
Â  Â  document.getElementById('rehearsal-notes').value = rehearsal.notes || "";
Â  Â  document.getElementById('rehearsal-detail-message').textContent = "";
Â  Â Â 
Â  Â  rehearsalDetailModal.classList.add('show');
}

document.getElementById('close-rehearsal-details-modal').onclick = () => {
Â  Â  rehearsalDetailModal.classList.remove('show');
};

document.getElementById('save-rehearsal-details').onclick = async () => {
Â  Â  const index = parseInt(document.getElementById('rehearsal-detail-index').value, 10);
Â  Â  const notes = document.getElementById('rehearsal-notes').value;
Â  Â  const msg = document.getElementById('rehearsal-detail-message');

Â  Â  if (rehearsals[index]) {
Â  Â  Â  Â  rehearsals[index].notes = notes;
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await saveRehearsals();
Â  Â  Â  Â  Â  Â  msg.textContent = "InformaciÃ³n guardada correctamente.";
Â  Â  Â  Â  Â  Â  msg.className = "success-message";
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  msg.textContent = "Error al guardar: " + e.message;
Â  Â  Â  Â  Â  Â  msg.className = "error-message";
Â  Â  Â  Â  }
Â  Â  }
};

async function loadRehearsals() { try { const data = await withRetry(() => loadDoc("intranet", "rehearsals", { rehearsals: [] })); rehearsals = Array.isArray(data.rehearsals) ? data.rehearsals : []; renderRehearsals(); } catch (e) { console.error("Error al cargar ensayos:", e); } }
async function saveRehearsals() { try { await withRetry(() => saveDoc("intranet", "rehearsals", { rehearsals })); renderRehearsals(); renderStats(); return true; } catch (e) { console.error("Error al guardar ensayos:", e); throw e; } }
function resetRehearsalForm() { document.getElementById("rehearsal-date").value = ""; document.getElementById("rehearsal-start-time").value = ""; document.getElementById("rehearsal-end-time").value = ""; document.getElementById("rehearsal-location").value = ""; document.getElementById("add-rehearsal").textContent = "AÃ±adir Ensayo"; document.getElementById("cancel-edit-rehearsal").style.display = "none"; editingRehearsalIndex = null; }

/* ---------- 8. EstadÃ­sticas ---------- */
function updateMonthFilter() { const select=document.getElementById("stats-month-filter");select.innerHTML='<option value="all">Todos los meses</option>';const now=new Date();const pastRehearsals=rehearsals.filter(r=>new Date(r.date+'T00:00:00Z')<now);const months=new Set(pastRehearsals.map(r=>getMonthYear(r.date)));Array.from(months).sort((a,b)=>new Date(b.split(" ")[1],getMonthIndex(b.split(" ")[0]))-new Date(a.split(" ")[1],getMonthIndex(a.split(" ")[0]))).forEach(month=>{select.insertAdjacentHTML("beforeend",`<option value="${month}">${month}</option>`)})}
function getMonthIndex(monthName) { const months=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];return months.indexOf(monthName)}
function renderStats() { const now=new Date();const selectedMonth=document.getElementById("stats-month-filter")?.value||"all";let filteredRehearsals=rehearsals.filter(r=>new Date(r.date+'T00:00:00Z')<now);if(selectedMonth!=="all"){filteredRehearsals=filteredRehearsals.filter(r=>getMonthYear(r.date)===selectedMonth)} const timePerMonth={};filteredRehearsals.forEach(r=>{const monthYear=getMonthYear(r.date);const duration=calculateDuration(r.startTime,r.endTime);timePerMonth[monthYear]=(timePerMonth[monthYear]||0)+duration});const tbodyMonth=document.getElementById("time-per-month-body");tbodyMonth.innerHTML="";Object.keys(timePerMonth).sort((a,b)=>new Date(b.split(" ")[1],getMonthIndex(b.split(" ")[0]))-new Date(a.split(" ")[1],getMonthIndex(a.split(" ")[0]))).forEach(month=>{tbodyMonth.insertAdjacentHTML("beforeend",`<tr><td>${month}</td><td>${toHours(timePerMonth[month])}</td></tr>`)}); const timePerUser={};users.forEach(user=>{timePerUser[user.name]=0;filteredRehearsals.forEach(r=>{const attendance=r.attendance?.find(a=>a.name===user.name);if(attendance&&attendance.attending==="SÃ­"){timePerUser[user.name]+=calculateDuration(r.startTime,r.endTime)}})});const tbodyUser=document.getElementById("time-per-user-body");tbodyUser.innerHTML="";Object.keys(timePerUser).sort().forEach(user=>{tbodyUser.insertAdjacentHTML("beforeend",`<tr><td>${users.find(u=>u.name===user)?.nickname||user}</td><td>${toHours(timePerUser[user])}</td></tr>`)}); const tbodyPast=document.getElementById("past-rehearsals-body");tbodyPast.innerHTML="";filteredRehearsals.sort((a,b)=>new Date(b.date+'T'+(b.startTime||'00:00'))-new Date(a.date+'T'+(a.startTime||'00:00')));filteredRehearsals.forEach(r=>{const formattedDate=formatDateWithDay(r.date);const durationText=toHHMM(calculateDuration(r.startTime,r.endTime));const attendance=Array.isArray(r.attendance)?r.attendance:[];const getAttendeeNicknames=status=>attendance.filter(a=>a.attending===status).map(a=>{const user=users.find(u=>u.name===a.name);return user?user.nickname:a.name}).join(", ")||"Ninguno";const summary=`<div class="attendance-summary"><span class="attending-yes">Asisten: ${getAttendeeNicknames("SÃ­")}</span><span class="attending-no">No asisten: ${getAttendeeNicknames("No")}</span></div>`;tbodyPast.insertAdjacentHTML("beforeend",`<tr><td>${formattedDate} <span class="rehearsal-duration">(${durationText})</span></td><td>${r.startTime} - ${r.endTime}</td><td>${r.location}</td><td>${summary}</td></tr>`)})}

/* ---------- 9. PDF ---------- */
const fontDataCache = {}; const PDF_FONT_PATHS = { bleedingCowboys: 'assets/Bleeding_Cowboys.ttf', carnevalee: 'assets/Carnevalee_Freakshow.ttf' };
const PDF_FONT_NAMES = { bleedingCowboys: "BleedingCowboysCustom", carnevalee: "CarnevaleeCustom" }; const PDF_BACKGROUND_IMAGE_PATH = 'assets/Plantilla_pdf_ESDD_001.png';
async function loadFontAsBase64(fontPath) { if(fontDataCache[fontPath]){return fontDataCache[fontPath]}try{const response=await fetch(fontPath);if(!response.ok){throw new Error(`No se pudo cargar la fuente: ${response.statusText} (URL: ${fontPath})`)} const blob=await response.blob();return new Promise((resolve,reject)=>{const reader=new FileReader();reader.onloadend=()=>{fontDataCache[fontPath]=reader.result.split(',')[1];resolve(fontDataCache[fontPath])};reader.onerror=(error)=>reject(new Error("Error del FileReader al convertir fuente a Base64: "+error.message));reader.readAsDataURL(blob)})}catch(error){console.error(`Error crÃ­tico cargando la fuente ${fontPath}:`,error);fontDataCache[fontPath]=null;return null}}
async function registerFontWithDoc(doc,fontPath,fontVFSAlias,fontNameInDoc){const fontBase64=await loadFontAsBase64(fontPath);if(fontBase64){try{doc.addFileToVFS(fontVFSAlias,fontBase64);doc.addFont(fontVFSAlias,fontNameInDoc,'normal');console.log(`Fuente ${fontNameInDoc} registrada en jsPDF desde ${fontPath}.`);return true}catch(fontError){console.error(`Error al registrar la fuente ${fontNameInDoc} en jsPDF:`,fontError)}}else{console.warn(`No se pudo cargar la fuente ${fontPath} para registrarla.`)} return false}
async function getBackgroundImageDataURL(){return new Promise((resolve,reject)=>{const img=new Image();img.onload=()=>{const canvas=document.createElement('canvas');canvas.width=img.width;canvas.height=img.height;const ctx=canvas.getContext('2d');ctx.drawImage(img,0,0);resolve(canvas.toDataURL('image/png'))};img.onerror=(err)=>reject(new Error("Error al cargar la imagen de plantilla: "+(err.message||err.toString())));img.src=PDF_BACKGROUND_IMAGE_PATH;if(img.complete){if(img.naturalHeight!==0){const canvas=document.createElement('canvas');canvas.width=img.width;canvas.height=img.height;const ctx=canvas.getContext('2d');ctx.drawImage(img,0,0);resolve(canvas.toDataURL('image/png'))}else if(img.src){reject(new Error("Imagen de plantilla en cachÃ© pero invÃ¡lida."))}}})}
async function genPDF(setlistStructure,setlistDynamicName,rawFileNameForPdf){const{jsPDF}=window.jspdf;const doc=new jsPDF({orientation:"portrait",unit:"pt",format:"a4"});const pageWidth=doc.internal.pageSize.getWidth();const pageHeight=doc.internal.pageSize.getHeight();const cleanFileName=sanitizeForPdfFilename(rawFileNameForPdf)||"setlist"; let bleedingCowboysRegistered=await registerFontWithDoc(doc,PDF_FONT_PATHS.bleedingCowboys,'Bleeding_Cowboys.ttf',PDF_FONT_NAMES.bleedingCowboys);let carnevaleeRegistered=await registerFontWithDoc(doc,PDF_FONT_PATHS.carnevalee,'Carnevalee_Freakshow.ttf',PDF_FONT_NAMES.carnevalee);let backgroundImageData=null;try{backgroundImageData=await getBackgroundImageDataURL();doc.addImage(backgroundImageData,'PNG',0,0,pageWidth,pageHeight)}catch(e){console.error("No se pudo aÃ±adir la plantilla de fondo al PDF:",e);doc.rect(10,10,pageWidth-20,pageHeight-20,'S');doc.setFontSize(10);doc.setTextColor(150,0,0);doc.text("Advertencia: No se pudo cargar la plantilla de fondo.",pageWidth/2,pageHeight/2,{align:"center"})} doc.setTextColor(0,0,0);const contentMarginTop=120;const contentMarginSides=60;const contentMarginBottom=100;let currentY=contentMarginTop;doc.setFont(bleedingCowboysRegistered?PDF_FONT_NAMES.bleedingCowboys:"times",'normal');if(!bleedingCowboysRegistered)doc.setFontType("bold");doc.setFontSize(28);doc.text("SETLIST",pageWidth/2,currentY,{align:"center"});currentY+=28+10;doc.setFont(carnevaleeRegistered?PDF_FONT_NAMES.carnevalee:"times",'normal');if(!carnevaleeRegistered)doc.setFontType("bold");doc.setFontSize(22);doc.text(decodeHtmlEntities(setlistDynamicName),pageWidth/2,currentY,{align:"center"});currentY+=22+5;doc.setFont("times","italic");doc.setFontSize(10); let totalOverallSeconds=0;let totalSongCount=0;setlistStructure.forEach(blockOrItem=>{if(blockOrItem.isSetHeader){totalOverallSeconds+=blockOrItem.calculatedBlockDurationSeconds||0;totalSongCount+=blockOrItem.songs?blockOrItem.songs.length:0}else if(blockOrItem.isBreak){totalOverallSeconds+=blockOrItem.calculatedDurationSeconds||0}else if(blockOrItem.isSong){totalOverallSeconds+=blockOrItem.calculatedDurationSeconds||0;totalSongCount++}});const totalItemsText=`${totalSongCount} canciones`;doc.text(`${totalItemsText}Â  |Â  Tiempo total: ${toHHMM(totalOverallSeconds)}`,pageWidth/2,currentY,{align:"center"});currentY+=10+20; const tableFont="helvetica";const tableHeadFont="helvetica";let pdfSongNumber=0;const tableBody=[];setlistStructure.forEach(blockOrItem=>{if(blockOrItem.isSetHeader){tableBody.push([{content:`${blockOrItem.displayName} (${toMMSS(blockOrItem.calculatedBlockDurationSeconds||0)})`,colSpan:6,styles:{halign:'center',fontStyle:'bold',fillColor:[230,230,230],textColor:[0,0,0],fontSize:10}}]);if(blockOrItem.songs){blockOrItem.songs.forEach(song=>{pdfSongNumber++;tableBody.push([pdfSongNumber,song.displayName,(!!song.link_audio ? "ğŸ§" : "-"),decodeHtmlEntities(song.key||"-"),decodeHtmlEntities(song.tempo||"-"),toMMSS(song.calculatedDurationSeconds||0)])})}}else if(blockOrItem.isBreak){tableBody.push([{content:"Â»",styles:{halign:'center',fontStyle:'italic',textColor:[100,100,100]}},{content:blockOrItem.displayName,styles:{fontStyle:'italic',textColor:[80,80,80]}},{content:"-",styles:{halign:'center',fontStyle:'italic',textColor:[150,150,150]}},{content:"-",styles:{halign:'center',fontStyle:'italic',textColor:[150,150,150]}},{content:"-",styles:{halign:'center',fontStyle:'italic',textColor:[150,150,150]}},{content:toMMSS(blockOrItem.calculatedDurationSeconds||0),styles:{halign:'center',fontStyle:'italic',textColor:[80,80,80]}}])}else if(blockOrItem.isSong){pdfSongNumber++;tableBody.push([pdfSongNumber,blockOrItem.displayName,(!!blockOrItem.link_audio ? "ğŸ§" : "-"),decodeHtmlEntities(blockOrItem.key||"-"),decodeHtmlEntities(blockOrItem.tempo||"-"),toMMSS(blockOrItem.calculatedDurationSeconds||0)])}}); doc.autoTable({startY:currentY,head:[["#","TÃ­tulo","Audio","Key","Tempo","Time"]],body:tableBody,theme:'grid',headStyles:{fillColor:[200,200,200],textColor:[0,0,0],font:tableHeadFont,fontStyle:'bold',halign:'center',fontSize:10},styles:{font:tableFont,fontSize:9,cellPadding:{top:4,right:5,bottom:4,left:5},lineColor:[80,80,80],lineWidth:.5,textColor:[0,0,0]},columnStyles:{0:{halign:'center',cellWidth:25,fontSize:9},1:{halign:'left',cellWidth:'auto',fontSize:10},2:{halign:'center',cellWidth:30,fontSize:9},3:{halign:'center',cellWidth:50,fontSize:9},4:{halign:'center',cellWidth:50,fontSize:9},5:{halign:'center',cellWidth:50,fontSize:9}},margin:{top:contentMarginTop,right:contentMarginSides,bottom:contentMarginBottom,left:contentMarginSides},pageBreak:'auto',didDrawPage:function(data){if(data.pageNumber>1&&backgroundImageData){doc.addImage(backgroundImageData,'PNG',0,0,pageWidth,pageHeight)}}});doc.save(`${cleanFileName}.pdf`)}
async function genBasicPDF(setlistStructure,setlistDynamicName,rawFileNameForPdf){const{jsPDF}=window.jspdf;const doc=new jsPDF({orientation:"portrait",unit:"pt",format:"a4"});const pageWidth=doc.internal.pageSize.getWidth();const pageHeight=doc.internal.pageSize.getHeight();const cleanFileName=sanitizeForPdfFilename(rawFileNameForPdf)||"setlist";let carnevaleeRegistered=await registerFontWithDoc(doc,PDF_FONT_PATHS.carnevalee,'Carnevalee_Freakshow.ttf',PDF_FONT_NAMES.carnevalee);let backgroundImageData=null;try{backgroundImageData=await getBackgroundImageDataURL();doc.addImage(backgroundImageData,'PNG',0,0,pageWidth,pageHeight)}catch(e){} doc.setTextColor(0,0,0);const contentMarginTop=120;const contentMarginSides=60;const contentMarginBottom=100;let currentY=contentMarginTop;const setlistNameFontSize=22;const itemTitleFontSize=14;const setHeaderFontSize=16;const itemLineHeight=itemTitleFontSize*1.6;doc.setFont(carnevaleeRegistered?PDF_FONT_NAMES.carnevalee:"times",'normal');doc.setFontSize(setlistNameFontSize);doc.text(decodeHtmlEntities(setlistDynamicName),pageWidth/2,currentY,{align:"center"});currentY+=setlistNameFontSize+30; setlistStructure.forEach((blockOrItem,idx)=>{if(currentY+itemLineHeight*2.5>pageHeight-contentMarginBottom){doc.addPage();if(backgroundImageData){doc.addImage(backgroundImageData,'PNG',0,0,pageWidth,pageHeight)} currentY=contentMarginTop} if(blockOrItem.isSetHeader){if(idx>0)currentY+=itemLineHeight*.3;doc.setFont("helvetica",'bold');doc.setFontSize(setHeaderFontSize);doc.text(`${blockOrItem.displayName} (${toMMSS(blockOrItem.calculatedBlockDurationSeconds||0)})`,pageWidth/2,currentY,{align:"center"});currentY+=setHeaderFontSize*1.6;if(blockOrItem.songs){blockOrItem.songs.forEach(song=>{if(currentY+itemLineHeight>pageHeight-contentMarginBottom){doc.addPage();if(backgroundImageData)doc.addImage(backgroundImageData,'PNG',0,0,pageWidth,pageHeight);currentY=contentMarginTop} doc.setFont("helvetica",'normal');doc.setFontSize(itemTitleFontSize);doc.text(song.displayName,pageWidth/2,currentY,{align:"center"});currentY+=itemLineHeight})}}else if(blockOrItem.isBreak){if(idx>0)currentY+=itemLineHeight*.2;doc.setFont("helvetica",'italic');doc.setFontSize(itemTitleFontSize-1>8?itemTitleFontSize-1:8);doc.text(`${blockOrItem.displayName} (${toMMSS(blockOrItem.calculatedDurationSeconds||0)})`,pageWidth/2,currentY,{align:"center"});currentY+=(itemTitleFontSize-1>8?itemTitleFontSize-1:8)*1.6;if(idx<setlistStructure.length-1)currentY+=itemLineHeight*.2}else if(blockOrItem.isSong){doc.setFont("helvetica",'normal');doc.setFontSize(itemTitleFontSize);doc.text(blockOrItem.displayName,pageWidth/2,currentY,{align:"center"});currentY+=itemLineHeight}});doc.save(`${cleanFileName}_Basico.pdf`)}
async function genPersonalPDF(setlistStructure,setlistDynamicName,rawFileNameForPdf,songTitleFontSizeParam){const{jsPDF}=window.jspdf;const doc=new jsPDF({orientation:"portrait",unit:"pt",format:"a4"});const pageWidth=doc.internal.pageSize.getWidth();const pageHeight=doc.internal.pageSize.getHeight();const songTitleFontSize=parseInt(songTitleFontSizeParam,10)||14;const cleanFileName=sanitizeForPdfFilename(rawFileNameForPdf)||"setlist";let carnevaleeRegistered=await registerFontWithDoc(doc,PDF_FONT_PATHS.carnevalee,'Carnevalee_Freakshow.ttf',PDF_FONT_NAMES.carnevalee);let backgroundImageData=null;try{backgroundImageData=await getBackgroundImageDataURL();doc.addImage(backgroundImageData,'PNG',0,0,pageWidth,pageHeight)}catch(e){console.error("No se pudo aÃ±adir la plantilla de fondo al PDF Personal:",e);doc.rect(10,10,pageWidth-20,pageHeight-20,'S')} doc.setTextColor(0,0,0);const contentMarginTop=120;const contentMarginSides=60;const contentMarginBottom=100;let currentY=contentMarginTop;const setlistNameFontSize=22;const setHeaderFontSize=16;const breakTextFontSize=Math.max(8,songTitleFontSize-2);const songTitleLineHeight=songTitleFontSize*1.5;const setHeaderLineHeight=setHeaderFontSize*1.5;const breakTextLineHeight=breakTextFontSize*1.5;doc.setFont(carnevaleeRegistered?PDF_FONT_NAMES.carnevalee:"times",'normal');doc.setFontSize(setlistNameFontSize);doc.text(decodeHtmlEntities(setlistDynamicName),pageWidth/2,currentY,{align:"center"});currentY+=setlistNameFontSize+30; setlistStructure.forEach((blockOrItem,idx)=>{let estimatedBlockHeight=songTitleLineHeight;if(blockOrItem.isSetHeader)estimatedBlockHeight=setHeaderLineHeight+(blockOrItem.songs?blockOrItem.songs.length*songTitleLineHeight:0);else if(blockOrItem.isBreak)estimatedBlockHeight=breakTextLineHeight;if(currentY+estimatedBlockHeight>pageHeight-contentMarginBottom&&idx>0){doc.addPage();if(backgroundImageData){doc.addImage(backgroundImageData,'PNG',0,0,pageWidth,pageHeight)} currentY=contentMarginTop} if(blockOrItem.isSetHeader){if(idx>0)currentY+=songTitleLineHeight*.3;doc.setFont("helvetica",'bold');doc.setFontSize(setHeaderFontSize);doc.text(`${blockOrItem.displayName} (${toMMSS(blockOrItem.calculatedBlockDurationSeconds||0)})`,pageWidth/2,currentY,{align:"center"});currentY+=setHeaderLineHeight;if(blockOrItem.songs){blockOrItem.songs.forEach(song=>{if(currentY+songTitleLineHeight>pageHeight-contentMarginBottom){doc.addPage();if(backgroundImageData)doc.addImage(backgroundImageData,'PNG',0,0,pageWidth,pageHeight);currentY=contentMarginTop} doc.setFont("helvetica",'normal');doc.setFontSize(songTitleFontSize);doc.text(song.displayName,pageWidth/2,currentY,{align:"center"});currentY+=songTitleLineHeight})}}else if(blockOrItem.isBreak){if(idx>0)currentY+=songTitleLineHeight*.2;doc.setFont("helvetica",'italic');doc.setFontSize(breakTextFontSize);doc.text(`${blockOrItem.displayName} (${toMMSS(blockOrItem.calculatedDurationSeconds||0)})`,pageWidth/2,currentY,{align:"center"});currentY+=breakTextLineHeight;if(idx<setlistStructure.length-1)currentY+=songTitleLineHeight*.2}else if(blockOrItem.isSong){doc.setFont("helvetica",'normal');doc.setFontSize(songTitleFontSize);doc.text(blockOrItem.displayName,pageWidth/2,currentY,{align:"center"});currentY+=songTitleLineHeight}});doc.save(`${cleanFileName}_Personal_${songTitleFontSize}pt.pdf`)}

/* ---------- 10. BandHelper & Detalles Concierto ---------- */
let processTableAttempts = 0; const MAX_PROCESS_ATTEMPTS = 20;Â Â 
function processBandHelperTable() { const container=document.getElementById('bandhelper-concerts-container');if(!container){console.error("processBandHelperTable: Contenedor 'bandhelper-concerts-container' no encontrado.");return} const table=container.querySelector("table");const loadingMessage=document.getElementById("bandhelper-loading-message");if(!table){processTableAttempts++;if(processTableAttempts<MAX_PROCESS_ATTEMPTS){setTimeout(processBandHelperTable,500)}else{console.error("processBandHelperTable: Tabla de BandHelper NO encontrada despuÃ©s de",MAX_PROCESS_ATTEMPTS,"intentos.");if(loadingMessage){loadingMessage.textContent="No se pudieron mostrar los conciertos (tabla no generada por BandHelper).";loadingMessage.style.display="block"}}}else{if(loadingMessage)loadingMessage.style.display="none";if(table.dataset.processed==="true"){return} table.dataset.processed="true";let headerRow=table.querySelector("thead tr");const desiredHeaders=["Fecha/Hora","Evento","Lugar","Cal","Info"];if(!table.tHead){table.createTHead()} headerRow=table.tHead.rows[0]||table.tHead.insertRow(0);headerRow.innerHTML='';desiredHeaders.forEach(text=>{const th=document.createElement('th');th.textContent=text;if(text==="Cal")th.classList.add("calendar-col-header");if(text==="Info")th.classList.add("details-col-header");headerRow.appendChild(th)});const dataRowsSource=table.querySelector("tbody")?Array.from(table.querySelectorAll("tbody tr")):[];dataRowsSource.forEach(row=>{const originalCells=Array.from(row.cells);row.innerHTML='';const dateCellFullText=originalCells[0]?.textContent.trim()||"";const eventTitleFromCell=originalCells[1]?.textContent.trim().split('\n')[0].trim()||"Evento Sin TÃ­tulo";const locationText=originalCells[3]?.textContent.trim().split('\n')[0].trim()||originalCells[2]?.textContent.trim().split('\n')[0].trim()||"";row.insertCell().textContent=dateCellFullText;row.insertCell().textContent=eventTitleFromCell;row.insertCell().textContent=locationText;const calendarDisplayCell=row.insertCell();calendarDisplayCell.className="calendar-col";calendarDisplayCell.style.textAlign="center";const detailDisplayCell=row.insertCell();detailDisplayCell.className="details-col-header";detailDisplayCell.style.textAlign="center";const dateForId=dateCellFullText.split(',')[0].trim();const concertId=sanitizeFirebaseKey(`${dateForId}_${eventTitleFromCell}`);const detailsBtn=document.createElement("button");detailsBtn.className="details-btn";detailsBtn.innerHTML="â¡ï¸";detailsBtn.title="Ver/Editar Detalles del Concierto";detailsBtn.onclick=()=>openConcertDetailModal(concertId,dateCellFullText,eventTitleFromCell,locationText);detailDisplayCell.appendChild(detailsBtn);let icsDate=new Date().toISOString().split('T')[0];let startTimeForICS="20:00";let durationSecondsForICS=2*3600;const dateMatch=dateCellFullText.match(/(\d{2})\/(\d{2})\/(\d{2})/);const singleTimeMatch=dateCellFullText.match(/,\s*(\d{1,2}:\d{2})/);if(dateMatch){let year=parseInt(dateMatch[3],10);year+=(year<70?2000:1900);icsDate=`${year}-${dateMatch[2]}-${dateMatch[1]}`} const timeRangeMatch=dateCellFullText.match(/(\d{1,2}:\d{2})\s*a\s*(\d{1,2}:\d{2})/);if(timeRangeMatch){startTimeForICS=timeRangeMatch[1];durationSecondsForICS=calculateDuration(timeRangeMatch[1],timeRangeMatch[2]);if(durationSecondsForICS<=0)durationSecondsForICS=2*3600}else if(singleTimeMatch){startTimeForICS=singleTimeMatch[1]} const locationForICS=locationText||eventTitleFromCell;const descriptionForICS=`Concierto de El SÃ³tano del Doctor en ${locationForICS}. Evento: ${eventTitleFromCell}.`;const calendarBtn=document.createElement('button');calendarBtn.className='calendar-btn';calendarBtn.title='AÃ±adir a mi calendario';calendarBtn.innerHTML='<svg viewBox="0 0 24 24"><path d="M12 4V2m0 20v-2m8-8h2m-20 0h-2m15.071-3.071l-1.414-1.414M5.343 17.657l-1.414-1.414m0-10.486l1.414-1.414m12.728 12.728l-1.414 1.414"/><rect x="4" y="6" width="16" height="12" rx="2"/></svg>';calendarBtn.onclick=()=>generateICS(`Concierto: ${eventTitleFromCell}`,icsDate,startTimeForICS,locationForICS,descriptionForICS,durationSecondsForICS);calendarDisplayCell.appendChild(calendarBtn)})}}
const concertDetailModal = document.getElementById('concert-details-modal'); const concertDetailMessage = document.getElementById('concert-detail-message');
async function openConcertDetailModal(concertId, concertFullDateText, concertTitle, concertLocationOriginal) {
Â  Â  const concertDetailMessage = document.getElementById('concert-detail-message');
Â  Â  concertDetailMessage.textContent = "";
Â  Â  concertDetailMessage.className = "success-message";
Â  Â  document.body.style.overflow = 'hidden';
Â  Â  document.getElementById('concert-detail-id').value = concertId;
Â  Â Â 
Â  Â  const concertTitleDisplay = document.getElementById('concert-detail-title-display');
Â  Â  if (concertTitleDisplay) {
Â  Â  Â  Â  const datePartOnly = concertFullDateText.split(',')[0].trim();
Â  Â  Â  Â  concertTitleDisplay.innerHTML = `${decodeHtmlEntities(concertTitle) || "TÃ­tulo no disponible"} <span class="concert-date">(${datePartOnly || 'Fecha no disp.'})</span>`
Â  Â  }
Â  Â Â 
Â  Â  // Limpiar campos
Â  Â  document.getElementById('concert-detail-location').value = '';
Â  Â  document.getElementById('concert-detail-sound-company').value = '';Â 
Â  Â  document.getElementById('concert-detail-soundsetup').value = '';
Â  Â  document.getElementById('concert-detail-instrumentssetup').value = '';
Â  Â  document.getElementById('concert-detail-soundcheck').value = '';
Â  Â  document.getElementById('concert-detail-showtime').value = '';
Â  Â  document.getElementById('concert-detail-notes').value = '';
Â  Â  document.getElementById('concert-detail-gmaps-link').value = '';
Â  Â Â 
Â  Â  const openGmapsBtn = document.getElementById('open-gmaps-link-btn');
Â  Â  openGmapsBtn.style.display = 'none';
Â  Â  openGmapsBtn.onclick = null;

Â  Â  // Preparar listas
Â  Â  const musiciansListDiv = document.getElementById('musicians-attendance-list');
Â  Â  const techListDiv = document.getElementById('technicians-attendance-list');
Â  Â  musiciansListDiv.innerHTML = 'Cargando...';
Â  Â  techListDiv.innerHTML = 'Cargando...';

Â  Â  const techRolesList = ["TÃ©cnico de Sonido", "Montador", "TÃ©cnico de Luces", "Road Manager", "Backliner"];

Â  Â  if (users && users.length > 0) {
Â  Â  Â  Â  musiciansListDiv.innerHTML = '';
Â  Â  Â  Â  techListDiv.innerHTML = '';

Â  Â  Â  Â  users.forEach(user => {
Â  Â  Â  Â  Â  Â  const userDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  userDiv.style.display = 'flex';Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  userDiv.style.alignItems = 'center';Â  Â Â 
Â  Â  Â  Â  Â  Â  userDiv.style.marginBottom = '8px';Â  Â  Â 

Â  Â  Â  Â  Â  Â  const checkboxId = `user-att-${sanitizeFirebaseKey(user.nickname || user.name)}-${concertId}`;
Â  Â  Â  Â  Â  Â  userDiv.innerHTML = ` <input type="checkbox" id="${checkboxId}" name="concertAttendees" value="${user.nickname || user.name}" style="margin-right: 8px;"> <label for="${checkboxId}" style="margin:0; cursor:pointer;">${user.name} (${user.nickname})</label> `;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // LÃ“GICA DE SEPARACIÃ“N:
Â  Â  Â  Â  Â  Â  const isTech = user.roles.some(r => techRolesList.includes(r));

Â  Â  Â  Â  Â  Â  if (isTech) {
Â  Â  Â  Â  Â  Â  Â  Â  techListDiv.appendChild(userDiv);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  musiciansListDiv.appendChild(userDiv);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  if (musiciansListDiv.children.length === 0) musiciansListDiv.innerHTML = 'No hay mÃºsicos listados.';
Â  Â  Â  Â  if (techListDiv.children.length === 0) techListDiv.innerHTML = 'No hay tÃ©cnicos listados.';
Â  Â  } else {
Â  Â  Â  Â  musiciansListDiv.innerHTML = 'No hay usuarios registrados.';
Â  Â  Â  Â  techListDiv.innerHTML = '';
Â  Â  }

Â  Â  try {
Â  Â  Â  Â  const details = await withRetry(() => loadDoc('concert_details', concertId, {}));
Â  Â  Â  Â  if (details && Object.keys(details).length > 0) {
Â  Â  Â  Â  Â  Â  document.getElementById('concert-detail-location').value = details.locationDetails || '';
Â  Â  Â  Â  Â  Â  document.getElementById('concert-detail-sound-company').value = details.soundCompany || '';Â 
Â  Â  Â  Â  Â  Â  document.getElementById('concert-detail-soundsetup').value = details.soundSetupTime || '';
Â  Â  Â  Â  Â  Â  document.getElementById('concert-detail-instrumentssetup').value = details.instrumentsSetupTime || '';
Â  Â  Â  Â  Â  Â  document.getElementById('concert-detail-soundcheck').value = details.soundcheckTime || '';
Â  Â  Â  Â  Â  Â  document.getElementById('concert-detail-showtime').value = details.showTime || '';
Â  Â  Â  Â  Â  Â  document.getElementById('concert-detail-notes').value = details.generalNotes || '';
Â  Â  Â  Â  Â  Â  const gmapsLink = details.googleMapsLink || '';
Â  Â  Â  Â  Â  Â  document.getElementById('concert-detail-gmaps-link').value = gmapsLink;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (gmapsLink) {
Â  Â  Â  Â  Â  Â  Â  Â  openGmapsBtn.style.display = 'inline-block';
Â  Â  Â  Â  Â  Â  Â  Â  openGmapsBtn.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentLink = document.getElementById('concert-detail-gmaps-link').value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentLink) window.open(currentLink, '_blank')
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  openGmapsBtn.style.display = 'none'
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (details.attendees && Array.isArray(details.attendees)) {
Â  Â  Â  Â  Â  Â  Â  Â  details.attendees.forEach(attendeeName => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const checkbox = document.querySelector(`input[name="concertAttendees"][value="${attendeeName}"]`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (checkbox) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  checkbox.checked = true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  openGmapsBtn.style.display = 'none'
Â  Â  Â  Â  }
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Error al intentar cargar detalles del concierto desde Firestore:", error);
Â  Â  Â  Â  concertDetailMessage.className = "error-message";
Â  Â  Â  Â  concertDetailMessage.textContent = `Error al cargar detalles: ${error.message}.`;
Â  Â  Â  Â  openGmapsBtn.style.display = 'none'
Â  Â  }
Â  Â  concertDetailModal.classList.add('show')
}
document.getElementById('save-concert-details').onclick = async () => {
Â  Â  const concertId = document.getElementById('concert-detail-id').value;
Â  Â  const concertDetailMessage = document.getElementById('concert-detail-message');
Â  Â Â 
Â  Â  if (!concertId) {
Â  Â  Â  Â  concertDetailMessage.className = "error-message";
Â  Â  Â  Â  concertDetailMessage.textContent = "Error: ID de concierto no encontrado. No se puede guardar.";
Â  Â  Â  Â  return
Â  Â  }
Â  Â Â 
Â  Â  const selectedAttendees = [];
Â  Â  document.querySelectorAll('input[name="concertAttendees"]:checked').forEach(checkbox => {
Â  Â  Â  Â  selectedAttendees.push(checkbox.value)
Â  Â  });
Â  Â Â 
Â  Â  const gmapsLinkValue = document.getElementById('concert-detail-gmaps-link').value.trim();
Â  Â Â 
Â  Â  const concertData = {
Â  Â  Â  Â  locationDetails: document.getElementById('concert-detail-location').value.trim(),
Â  Â  Â  Â  soundCompany: document.getElementById('concert-detail-sound-company').value.trim(), // NUEVO GUARDAR
Â  Â  Â  Â  soundSetupTime: document.getElementById('concert-detail-soundsetup').value,
Â  Â  Â  Â  instrumentsSetupTime: document.getElementById('concert-detail-instrumentssetup').value,
Â  Â  Â  Â  soundcheckTime: document.getElementById('concert-detail-soundcheck').value,
Â  Â  Â  Â  showTime: document.getElementById('concert-detail-showtime').value,
Â  Â  Â  Â  generalNotes: document.getElementById('concert-detail-notes').value.trim(),
Â  Â  Â  Â  attendees: selectedAttendees,
Â  Â  Â  Â  googleMapsLink: gmapsLinkValue,
Â  Â  Â  Â  lastUpdated: new Date().toISOString()
Â  Â  };
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  await withRetry(() => saveDoc('concert_details', concertId, concertData, true));
Â  Â  Â  Â  concertDetailMessage.className = "success-message";
Â  Â  Â  Â  concertDetailMessage.textContent = "Detalles guardados correctamente.";
Â  Â  Â  Â Â 
Â  Â  Â  Â  const openGmapsBtn = document.getElementById('open-gmaps-link-btn');
Â  Â  Â  Â  if (gmapsLinkValue) {
Â  Â  Â  Â  Â  Â  openGmapsBtn.style.display = 'inline-block';
Â  Â  Â  Â  Â  Â  openGmapsBtn.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const currentLink = document.getElementById('concert-detail-gmaps-link').value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  if (currentLink) window.open(currentLink, '_blank')
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  openGmapsBtn.style.display = 'none'
Â  Â  Â  Â  }
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Error al guardar detalles del concierto en Firestore:", error);
Â  Â  Â  Â  concertDetailMessage.className = "error-message";
Â  Â  Â  Â  concertDetailMessage.textContent = `Error al guardar: ${error.message}.`
Â  Â  }
};

document.getElementById('close-concert-details-modal').onclick = () => { closeAll(); };

/* ---------- 11. MenÃº & pantallas ---------- */
const sidebar = document.getElementById("sidebar-menu"), overlay = document.getElementById("overlay"); const PASSWORD = "Sotano2014"; let isAuthenticated = false;
function closeAll() { document.querySelectorAll(".config-screen").forEach(s=>{s.style.display="none"});document.querySelectorAll(".modal-backdrop").forEach(s=>{s.classList.remove("show")});sidebar.classList.remove("show");overlay.classList.remove("show");document.getElementById("config-submenu").style.display="none";if(typeof resetUserForm==="function")resetUserForm();if(typeof resetRehearsalForm==="function")resetRehearsalForm();document.querySelectorAll("#user-message, #rehearsal-message, #setlist-message, #concert-detail-message, #rehearsal-detail-message, #suggestion-message, #audio-link-message").forEach(el=>el.textContent="");document.body.style.overflow=''}
document.getElementById("hamburger-btn").onclick = () => { sidebar.classList.add("show"); overlay.classList.add("show"); };
document.getElementById("menu-cerrar").onclick = e => { e.preventDefault(); closeAll(); }; overlay.onclick = closeAll;
const setupMenuLink = (menuId, targetId) => { const link=document.getElementById(menuId);if(link){link.onclick=e=>{e.preventDefault();closeAll();const targetElement=document.getElementById(targetId);if(targetElement){const headerOffset=document.querySelector('header').offsetHeight||60;const elementPosition=targetElement.getBoundingClientRect().top;const offsetPosition=elementPosition+window.pageYOffset-headerOffset-10;window.scrollTo({top:offsetPosition,behavior:"smooth"})} else{console.warn(`Elemento ${targetId} no encontrado.`)}}}else{console.warn(`Enlace ${menuId} no encontrado.`)} };
setupMenuLink("menu-rehearsals-setlist-section", "setlists"); setupMenuLink("menu-rehearsals-section", "rehearsals"); setupMenuLink("menu-second-setlist-section", "second-setlist"); setupMenuLink("menu-star-setlist-section", "star-setlist"); setupMenuLink("menu-concerts-section", "calendario");
setupMenuLink("menu-calendar-view", "vista-calendario-mensual");
setupMenuLink("menu-suggestions", "suggestions");

// --- CONFIGURACIÃ“N MENÃš SUGGESTIONS ---
document.getElementById("menu-suggestions").onclick = e => {Â 
Â  Â  e.preventDefault();Â 
Â  Â  openConfigScreen("suggestions-screen");
Â  Â  renderSuggestions();Â 
};
document.getElementById("close-suggestions").onclick = () => {
Â  Â  document.getElementById("suggestions-screen").style.display = "none";
};

document.getElementById("menu-config").onclick = e => { e.preventDefault();const submenu=document.getElementById("config-submenu");if(!isAuthenticated){const password=prompt("iDoctor Dice: Â¡Â¡Â¡Si no sabes no toques!!! Pon la contraseÃ±a:");if(password&&password.toLowerCase()===PASSWORD.toLowerCase()){isAuthenticated=true;submenu.style.display=submenu.style.display==="block"?"none":"block"}else{alert("ContraseÃ±a incorrecta.");return}}else{submenu.style.display=submenu.style.display==="block"?"none":"block"}};
const openConfigScreen = (screenId) => { if(!isAuthenticated&&screenId!=='user-list-screen'&&screenId!=='stats-screen'&&screenId!=='suggestions-screen'){const password=prompt("iDoctor Dice: Â¡Â¡Â¡Si no sabes no toques!!! Pon la contraseÃ±a:");if(password&&password.toLowerCase()===PASSWORD.toLowerCase()){isAuthenticated=true} else{alert("ContraseÃ±a incorrecta.");return false}} if(isAuthenticated||screenId==='user-list-screen'||screenId==='stats-screen'||screenId==='suggestions-screen'){closeAll();const screen=document.getElementById(screenId);if(screen){screen.style.display="block";if(screenId==='user-list-screen'){renderUsers()} screen.scrollTop=0}else{console.error(`Pantalla ${screenId} no encontrada.`)}} return true};Â 
document.getElementById("menu-setlist-config").onclick = e => { e.preventDefault();if(openConfigScreen("setlist-config-screen")){document.getElementById("setlist1-name").value=setlistConfig.setlist1.name;document.getElementById("setlist1-url").value=setlistConfig.setlist1.url==="URL_POR_CONFIGURAR_1"?"":setlistConfig.setlist1.url;document.getElementById("setlist2-name").value=setlistConfig.setlist2.name;const setlist2Url=setlistConfig.setlist2.url.replace("https://www.bandhelper.com/feed/set_list/","");document.getElementById("setlist2-url").value=setlist2Url==="URL_POR_CONFIGURAR_2"?"":setlist2Url;document.getElementById("setlistStar-name").value=setlistConfig.setlistStar.name;document.getElementById("setlistStar-url").value=setlistConfig.setlistStar.url==="URL_POR_CONFIGURAR_STAR"?"":setlistConfig.setlistStar.url}};
document.getElementById("close-setlist-config").onclick = () => { document.getElementById("setlist-config-screen").style.display = "none"; document.getElementById("setlist-message").textContent = ""; };
document.getElementById("guardar-setlist-config").onclick = async () => { const msg=document.getElementById("setlist-message");msg.textContent="";const n1=document.getElementById("setlist1-name").value.trim(),u1=document.getElementById("setlist1-url").value.trim();const n2=document.getElementById("setlist2-name").value.trim(),raw2=document.getElementById("setlist2-url").value.trim();const nStar=document.getElementById("setlistStar-name").value.trim(),uStar=document.getElementById("setlistStar-url").value.trim();if(!n1||!u1||!n2||!raw2||!nStar||!uStar){msg.className="error-message";msg.textContent="Completa todos los campos.";return} try{setlistConfig.setlist1={name:n1,url:u1};setlistConfig.setlist2={name:n2,url:raw2.startsWith("http")?raw2:`https://www.bandhelper.com/feed/set_list/${raw2}`};setlistConfig.setlistStar={name:nStar,url:uStar};await saveSetlistConfig();await Promise.all([cargarPrimerSetlist(),cargarSegundoSetlist(),cargarStarSetlist()]);document.getElementById("setlist-config-screen").style.display="none"}catch(e){msg.className="error-message";msg.textContent="Error al guardar: "+e.message}};
document.getElementById("menu-user-mgmt").onclick = e => { e.preventDefault(); openConfigScreen("user-mgmt-screen"); };
document.getElementById("close-user-mgmt").onclick = () => { document.getElementById("user-mgmt-screen").style.display = "none"; document.getElementById("user-message").textContent = ""; resetUserForm(); };
document.getElementById("add-user").onclick = async () => { const msg=document.getElementById("user-message");msg.textContent="";const name=document.getElementById("user-name").value.trim(),nickname=document.getElementById("user-nickname").value.trim();const roles=Array.from(document.getElementById("user-role").selectedOptions).map(o=>o.value);if(!name||!nickname||roles.length===0){msg.className="error-message";msg.textContent="Nombre, apodo y rol son obligatorios.";return} try{if(editingUserIndex!==null){const oldName=users[editingUserIndex].name;users[editingUserIndex]={name,nickname,roles};if(oldName!==name){rehearsals.forEach(r=>{if(Array.isArray(r.attendance)){r.attendance.forEach(a=>{if(a.name===oldName)a.name=name})}});await saveRehearsals()} msg.textContent="Usuario actualizado."}else{users.push({name,nickname,roles});msg.textContent="Usuario aÃ±adido."} await saveUsers();msg.className="success-message";resetUserForm()}catch(e){msg.className="error-message";msg.textContent="Error al guardar: "+e.message}};
document.getElementById("cancel-edit-user").onclick = () => { resetUserForm(); document.getElementById("user-message").textContent = ""; };
document.getElementById("menu-rehearsal").onclick = e => { e.preventDefault(); openConfigScreen("rehearsal-screen"); };
document.getElementById("close-rehearsal").onclick = () => { document.getElementById("rehearsal-screen").style.display = "none"; document.getElementById("rehearsal-message").textContent = ""; resetRehearsalForm(); };
document.getElementById("add-rehearsal").onclick = async () => { const msg=document.getElementById("rehearsal-message");msg.textContent="";const date=document.getElementById("rehearsal-date").value,startTime=document.getElementById("rehearsal-start-time").value,endTime=document.getElementById("rehearsal-end-time").value,loc=document.getElementById("rehearsal-location").value.trim();if(!date||!startTime||!endTime||!loc){msg.className="error-message";msg.textContent="Completa campos.";return} if(calculateDuration(startTime,endTime)<=0){msg.className="error-error-message";msg.textContent="Hora fin posterior a inicio.";return} try{const newData={date,startTime,endTime,location:loc,attendance:[]};if(editingRehearsalIndex!==null){newData.attendance=rehearsals[editingRehearsalIndex].attendance||[];rehearsals[editingRehearsalIndex]=newData;msg.textContent="Ensayo actualizado."}else{rehearsals.push(newData);msg.textContent="Ensayo aÃ±adido."} await saveRehearsals();msg.className="success-message";resetRehearsalForm()}catch(e){msg.className="error-message";msg.textContent="Error al guardar: "+e.message}};
document.getElementById("cancel-edit-rehearsal").onclick = () => { resetRehearsalForm(); document.getElementById("rehearsal-message").textContent = ""; };
document.getElementById("menu-stats").onclick = e => { e.preventDefault(); if(openConfigScreen("stats-screen")){ updateMonthFilter(); renderStats(); }};
document.getElementById("close-stats").onclick = () => document.getElementById("stats-screen").style.display = "none";
document.getElementById("stats-month-filter").addEventListener("change", renderStats);
document.getElementById("menu-user-list-display").onclick = e => { e.preventDefault(); openConfigScreen("user-list-screen"); };
document.getElementById("close-user-list-screen").onclick = () => { document.getElementById("user-list-screen").style.display = "none"; };
// **NUEVA FUNCIÃ“N DE MENÃš**
document.getElementById("menu-audio-links").onclick = async e => { 
    e.preventDefault(); 
    if(openConfigScreen("audio-link-management-screen")){
        // Aseguramos que la Ãºltima lista de canciones maestra se cargue antes de renderizar la tabla
        await loadSetlistMasterSongs();
        renderAudioLinksTable(); 
    }
};
document.getElementById("close-audio-link-management").onclick = async () => { 
    document.getElementById("audio-link-management-screen").style.display = "none"; 
    document.getElementById("audio-link-message").textContent = "";
    // Una vez cerrada la gestiÃ³n de links, volvemos a cargar las setlists para que usen los nuevos links
    await Promise.all([cargarPrimerSetlist(), cargarSegundoSetlist(), cargarStarSetlist()]);
};

// --- GESTIÃ“N DE PROPUESTAS (SUGGESTIONS) ---
let suggestions = [];

// Listener de Firestore para propuestas (incluye eliminadas)
if (typeof db !== 'undefined') {
Â  Â  db.collection('suggestions').onSnapshot(snapshot => {
Â  Â  Â  Â  suggestions = [];
Â  Â  Â  Â  snapshot.forEach(doc => {
Â  Â  Â  Â  Â  Â  suggestions.push({ id: doc.id, ...doc.data() });
Â  Â  Â  Â  });
Â  Â  Â  Â  renderSuggestions();
Â  Â  Â  Â  renderAdminSuggestions(); // TambiÃ©n actualiza la tabla de admin
Â  Â  });
}

document.getElementById("add-suggestion-btn").onclick = async () => {
Â  Â  const userSelector = document.getElementById('user-identity-selector');
Â  Â  const currentUser = userSelector.value;
Â  Â  const title = document.getElementById('suggestion-title').value.trim();
Â  Â  const artist = document.getElementById('suggestion-artist').value.trim();
Â  Â  const link = document.getElementById('suggestion-link').value.trim();
Â  Â  const msg = document.getElementById('suggestion-message');
Â  Â Â 
Â  Â  msg.textContent = "";

Â  Â  if (!currentUser) {
Â  Â  Â  Â  alert("Por favor, selecciona quiÃ©n eres en el desplegable de arriba.");
Â  Â  Â  Â  userSelector.focus();
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  if (!title || !artist) {
Â  Â  Â  Â  msg.textContent = "TÃ­tulo y Artista son obligatorios.";
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const newSuggestion = {
Â  Â  Â  Â  title,
Â  Â  Â  Â  artist,
Â  Â  Â  Â  link,
Â  Â  Â  Â  proposedBy: currentUser,
Â  Â  Â  Â  proposedAt: new Date().toISOString(),
Â  Â  Â  Â  votes: {}, // { "Juan": 5, "Fer": 3 }
Â  Â  Â  Â  averageRating: 0,
Â  Â  Â  Â  status: 'active'
Â  Â  };

Â  Â  try {
Â  Â  Â  Â  await db.collection('suggestions').add(newSuggestion);
Â  Â  Â  Â  document.getElementById('suggestion-title').value = "";
Â  Â  Â  Â  document.getElementById('suggestion-artist').value = "";
Â  Â  Â  Â  document.getElementById('suggestion-link').value = "";
Â  Â  Â  Â  alert("Â¡Propuesta enviada!");
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Error al aÃ±adir propuesta:", e);
Â  Â  Â  Â  msg.textContent = "Error: " + e.message;
Â  Â  }
};

async function rateSuggestion(id, rating) {
Â  Â  const userSelector = document.getElementById('user-identity-selector');
Â  Â  const currentUser = userSelector.value;
Â  Â Â 
Â  Â  if (!currentUser) {
Â  Â  Â  Â  alert("Por favor, selecciona quiÃ©n eres arriba para poder votar.");
Â  Â  Â  Â  // Scrollear arriba si estÃ¡ muy abajo
Â  Â  Â  Â  document.getElementById('suggestions-screen').scrollTop = 0;
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const suggestion = suggestions.find(s => s.id === id);
Â  Â  if (!suggestion) return;

Â  Â  const currentVotes = suggestion.votes || {};
Â  Â Â 
Â  Â  // Si ya votaste lo mismo, quitamos el voto (toggle)
Â  Â  if (currentVotes[currentUser] === rating) {
Â  Â  Â  Â  delete currentVotes[currentUser];
Â  Â  } else {
Â  Â  Â  Â  currentVotes[currentUser] = rating;
Â  Â  }

Â  Â  // Recalcular media
Â  Â  const scores = Object.values(currentVotes);
Â  Â  const avg = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;

Â  Â  try {
Â  Â  Â  Â  await db.collection('suggestions').doc(id).update({
Â  Â  Â  Â  Â  Â  votes: currentVotes,
Â  Â  Â  Â  Â  Â  averageRating: avg
Â  Â  Â  Â  });
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Error al votar:", e);
Â  Â  }
}

function renderSuggestions() {
Â  Â  const container = document.getElementById('suggestions-container');
Â  Â  container.innerHTML = "";

Â  Â  const userSelector = document.getElementById('user-identity-selector');
Â  Â  const currentUser = userSelector.value;

Â  Â  // Filtramos solo las activas y ordenamos por valoraciÃ³n media
Â  Â  const activeSuggestions = suggestions
Â  Â  Â  Â  .filter(s => s.status === 'active')
Â  Â  Â  Â  .sort((a, b) => b.averageRating - a.averageRating);

Â  Â  if (activeSuggestions.length === 0) {
Â  Â  Â  Â  container.innerHTML = "<p style='color:#888; font-style:italic;'>No hay propuestas activas.</p>";
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  activeSuggestions.forEach(s => {
Â  Â  Â  Â  const date = new Date(s.proposedAt).toLocaleDateString();
Â  Â  Â  Â  const votes = s.votes || {};
Â  Â  Â  Â  const myVote = currentUser ? votes[currentUser] : 0;
Â  Â  Â  Â  const votersCount = Object.keys(votes).length;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // NUEVO: Detectar si ya ha votado para bloquear interacciÃ³n
Â  Â  Â  Â  const hasVoted = myVote > 0;

Â  Â  Â  Â  // Generar estrellas visuales (promedio)
Â  Â  Â  Â  let starsHtml = '';
Â  Â  Â  Â  for (let i = 1; i <= 5; i++) {
Â  Â  Â  Â  Â  Â  starsHtml += `<span class="star-visual ${i <= Math.round(s.averageRating) ? 'filled' : ''}">â˜…</span>`;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Generar estrellas interactivas (para votar)
Â  Â  Â  Â  let interactiveStarsHtml = '';
Â  Â  Â  Â  // Si ha votado, no ponemos onclick y mostramos estado "bloqueado"
Â  Â  Â  Â  if (hasVoted) {
Â  Â  Â  Â  Â  Â  for (let i = 1; i <= 5; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  interactiveStarsHtml += `<span class="interactive-star ${i <= myVote ? 'active' : ''}" style="cursor:default; opacity:${i <= myVote ? 1 : 0.3};">â˜…</span>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // Si NO ha votado, permitimos click
Â  Â  Â  Â  Â  Â  for (let i = 1; i <= 5; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  interactiveStarsHtml += `<span class="interactive-star" onclick="rateSuggestion('${s.id}', ${i})">â˜…</span>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Detalles de votantes
Â  Â  Â  Â  let votersDetailsHtml = '';
Â  Â  Â  Â  if (votersCount > 0) {
Â  Â  Â  Â  Â  Â  const details = Object.entries(votes).map(([name, score]) => `${name}: ${score}â˜…`).join(', ');
Â  Â  Â  Â  Â  Â  votersDetailsHtml = `<div class="voters-details" id="voters-${s.id}">${details}</div>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  votersDetailsHtml = `<div class="voters-details" id="voters-${s.id}">Nadie ha votado aÃºn.</div>`;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Texto de estado de voto
Â  Â  Â  Â  const voteStatusText = hasVoted ? `<span style="color:#FFD700; font-size:0.9em;">Votado (${myVote}/5)</span>` : `<span class="voting-label">Tu Voto:</span>`;

Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  card.className = 'suggestion-card';
Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="suggestion-header">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="suggestion-title">${s.title}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="suggestion-artist">${s.artist}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="suggestion-meta">Propuesto por: ${s.proposedBy} el ${date}</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="suggestion-body">
Â  Â  Â  Â  Â  Â  Â  Â  ${s.link ? `<a href="${s.link}" target="_blank" style="color:#0cf; font-size:0.8em;">Escuchar (Link)</a>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top:15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="star-rating-display">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="avg-score">${s.averageRating.toFixed(1)}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex;">${starsHtml}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:0.8em; color:#888; margin-left:5px;">(${votersCount} votos)</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="toggle-voters-btn" onclick="document.getElementById('voters-${s.id}').classList.toggle('show')">Ver votaciones</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${votersDetailsHtml}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="suggestion-actions">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="voting-area">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${voteStatusText}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="interactive-stars ${hasVoted ? 'voted' : ''}">${interactiveStarsHtml}</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  container.appendChild(card);
Â  Â  });
}

// --- ADMIN SUGGESTIONS ---
document.getElementById("menu-admin-suggestions").onclick = e => {Â 
Â  Â  e.preventDefault();Â 
Â  Â  openConfigScreen("admin-suggestions-screen");
Â  Â  renderAdminSuggestions();
};
document.getElementById("close-admin-suggestions").onclick = () => {
Â  Â  document.getElementById("admin-suggestions-screen").style.display = "none";
};

function renderAdminSuggestions() {
Â  Â  const tbody = document.getElementById('admin-suggestions-body');
Â  Â  tbody.innerHTML = "";

Â  Â  // Ordenar por fecha (mÃ¡s reciente primero)
Â  Â  const sorted = [...suggestions].sort((a, b) => new Date(b.proposedAt) - new Date(a.proposedAt));

Â  Â  sorted.forEach(s => {
Â  Â  Â  Â  const date = new Date(s.proposedAt).toLocaleDateString();
Â  Â  Â  Â  const isDeleted = s.status === 'deleted';
Â  Â  Â  Â  const rowClass = isDeleted ? 'deleted-row' : '';
Â  Â  Â  Â  const statusText = isDeletedÂ 
Â  Â  Â  Â  Â  Â  ? `Eliminada por ${s.deletedBy || '?'} (${new Date(s.deletedAt).toLocaleDateString()})`Â 
Â  Â  Â  Â  Â  Â  : '<span style="color:#0cf">Activa</span>';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const actionBtn = isDeletedÂ 
Â  Â  Â  Â  Â  Â  ? '-'Â 
Â  Â  Â  Â  Â  Â  : `<button onclick="deleteSuggestion('${s.id}')" style="background:#ff3333; padding:5px; font-size:0.8em;">Eliminar</button>`;

Â  Â  Â  Â  const row = `
Â  Â  Â  Â  Â  Â  <tr class="${rowClass}">
Â  Â  Â  Â  Â  Â  Â  Â  <td>${s.title} (${s.artist})</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${s.proposedBy}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${date}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:0.8em;">${statusText}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${actionBtn}</td>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  `;
Â  Â  Â  Â  tbody.insertAdjacentHTML('beforeend', row);
Â  Â  });
}

async function deleteSuggestion(id) {
Â  Â  const userSelector = document.getElementById('user-identity-selector');
Â  Â  const currentUser = userSelector.value || "Admin"; // Si entra directo, al menos que ponga Admin

Â  Â  if(confirm("Â¿Seguro que quieres eliminar esta propuesta? Se ocultarÃ¡ de la lista principal.")){
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await db.collection('suggestions').doc(id).update({
Â  Â  Â  Â  Â  Â  Â  Â  status: 'deleted',
Â  Â  Â  Â  Â  Â  Â  Â  deletedAt: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  deletedBy: currentUser
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  alert("Propuesta eliminada.");
Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  Â  Â  alert("Error al eliminar.");
Â  Â  Â  Â  }
Â  Â  }
}


/* ---------- 15. GestiÃ³n de Links de Audio (NUEVA LÃ“GICA) ---------- */
let setlistMasterSongs = []; // AlmacenarÃ¡ la lista Ãºnica de canciones

// Carga la lista de canciones Ãºnicas de los 3 setlists para tener una "lista maestra" de nombres
async function loadSetlistMasterSongs() {
    let allSongs = new Map(); // Usamos Map para asegurar unicidad
    
    // FunciÃ³n auxiliar para procesar un setlist (similar a cargarSetlistGenerico pero sin renderizar)
    const fetchAndProcessSetlist = async (configEntry) => {
        try {
            const response = await fetch(configEntry.url);
            if (!response.ok) throw new Error("API error");
            const rawData = await response.json();
            const dataToProcess = Array.isArray(rawData) ? rawData : rawData.items || [];
            
            dataToProcess.forEach(item => {
                if (item && item.type === "song") {
                    const displayName = decodeHtmlEntities(item.title || item.name || "CanciÃ³n sin tÃ­tulo");
                    const songKey = sanitizeFirebaseKey(displayName);
                    if (displayName && !allSongs.has(songKey)) {
                        allSongs.set(songKey, displayName);
                    }
                }
            });
        } catch (e) {
            console.warn(`No se pudo cargar el setlist ${configEntry.name} para lista maestra.`, e);
        }
    };

    // Recogemos canciones de los 3 setlists
    await Promise.all([
        fetchAndProcessSetlist(setlistConfig.setlist1),
        fetchAndProcessSetlist(setlistConfig.setlist2),
        fetchAndProcessSetlist(setlistConfig.setlistStar)
    ]);
    
    setlistMasterSongs = Array.from(allSongs).map(([key, name]) => ({ key, name })).sort((a, b) => a.name.localeCompare(b.name));
}

// Carga los links de audio guardados en Firebase
async function loadAudioLinks() {
    try {
        const doc = await withRetry(() => db.collection('intranet').doc('audio_links').get());
        globalAudioLinks = doc.exists ? (doc.data().links || {}) : {};
        console.log("Audio Links cargados:", globalAudioLinks);
    } catch(e) {
        console.error("Error al cargar Audio Links:", e);
        globalAudioLinks = {};
    }
}

// Guarda un link de audio en Firebase
async function saveAudioLink(key, url) {
    globalAudioLinks[key] = url.trim();
    if (!url.trim()) {
        delete globalAudioLinks[key]; // Si estÃ¡ vacÃ­o, lo eliminamos de la lista
    }

    try {
        await withRetry(() => saveDoc('intranet', 'audio_links', { links: globalAudioLinks }, true));
        return true;
    } catch (e) {
        console.error("Error al guardar link:", e);
        return false;
    }
}

// Renderiza la tabla de gestiÃ³n de links
function renderAudioLinksTable() {
    const tbody = document.getElementById('audio-links-body');
    tbody.innerHTML = '';

    if (setlistMasterSongs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#ff9800;">No se pudo cargar ninguna canciÃ³n de los setlists. AsegÃºrate de que las URLs de configuraciÃ³n son correctas.</td></tr>';
        return;
    }

    setlistMasterSongs.forEach(song => {
        const currentLink = globalAudioLinks[song.key] || '';
        const hasLink = !!currentLink;
        const buttonText = hasLink ? 'Guardar Cambios' : 'AÃ±adir Link';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${song.name}</td>
            <td>
                <input type="url" id="link-${song.key}" value="${currentLink}" placeholder="Ej: https://youtube.com/watch?v=..." style="border: 1px solid ${hasLink ? '#0cf' : '#888'};">
            </td>
            <td>
                <button class="save-link-btn" 
                        data-key="${song.key}" 
                        onclick="handleSaveLink('${song.key}', '${song.name}')">
                    ${buttonText}
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Maneja el guardado del link
async function handleSaveLink(key, name) {
    const input = document.getElementById(`link-${key}`);
    const url = input.value.trim();
    const messageEl = document.getElementById('audio-link-message');
    
    messageEl.textContent = 'Guardando...';
    messageEl.className = 'error-message'; // Reiniciar a error por defecto o amarillo

    const success = await saveAudioLink(key, url);
    
    if (success) {
        messageEl.className = 'success-message';
        messageEl.textContent = `Link para "${name}" guardado con Ã©xito.`;
        
        // Actualiza el borde del input y el botÃ³n
        if(url) {
            input.style.borderColor = '#0cf';
            input.nextElementSibling.textContent = 'Guardar Cambios';
        } else {
            input.style.borderColor = '#888';
            input.nextElementSibling.textContent = 'AÃ±adir Link';
        }
    } else {
        messageEl.className = 'error-message';
        messageEl.textContent = `Error al guardar el link para "${name}".`;
    }
}


/* --- LÃ“GICA MODO DIRECTO (LIVE MODE) --- */
let currentLiveSetlist = [];
let currentLiveIndex = 0;
let wakeLock = null;

// Solicitar Wake Lock (Evitar que se apague la pantalla)
async function requestWakeLock() {
Â  Â  try {
Â  Â  Â  Â  if ('wakeLock' in navigator) {
Â  Â  Â  Â  Â  Â  wakeLock = await navigator.wakeLock.request('screen');
Â  Â  Â  Â  Â  Â  wakeLock.addEventListener('release', () => { console.log('Pantalla desbloqueada'); });
Â  Â  Â  Â  Â  Â  console.log('Pantalla mantenida encendida');
Â  Â  Â  Â  }
Â  Â  } catch (err) {
Â  Â  Â  Â  console.error(`${err.name}, ${err.message}`);
Â  Â  }
}

// Liberar Wake Lock
async function releaseWakeLock() {
Â  Â  if (wakeLock !== null) {
Â  Â  Â  Â  await wakeLock.release();
Â  Â  Â  Â  wakeLock = null;
Â  Â  }
}

function startLiveMode(setlistData) {
Â  Â  currentLiveSetlist = [];

Â  Â  if (Array.isArray(setlistData)) {
Â  Â  Â  Â  setlistData.forEach(item => {
Â  Â  Â  Â  Â  Â  if (item.isSetHeader && Array.isArray(item.songs)) {
Â  Â  Â  Â  Â  Â  Â  Â  currentLiveSetlist = currentLiveSetlist.concat(item.songs);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  else if (item.isSong) {
Â  Â  Â  Â  Â  Â  Â  Â  currentLiveSetlist.push(item);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }
Â  Â Â 
Â  Â  if (currentLiveSetlist.length === 0) {
Â  Â  Â  Â  alert("Este setlist no tiene canciones cargadas o el formato es incorrecto.");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  currentLiveIndex = 0;
Â  Â  renderLiveSong(currentLiveIndex);
Â  Â Â 
Â  Â  const overlay = document.getElementById('live-mode-overlay');
Â  Â  overlay.classList.add('show');
Â  Â Â 
Â  Â  requestWakeLock();
}

function renderLiveSong(index) {
Â  Â  const song = currentLiveSetlist[index];
Â  Â  if (!song) return;

Â  Â  document.getElementById('live-counter').textContent = `${index + 1} / ${currentLiveSetlist.length}`;
Â  Â Â 
Â  Â  const titleEl = document.getElementById('live-song-title');
Â  Â  // decodeHtmlEntities ya se aplicÃ³ al displayName al cargar, asÃ­ que aquÃ­ sale bien
Â  Â  titleEl.textContent = song.displayName;
Â  Â  if (song.displayName.length > 20) { titleEl.style.fontSize = "2.5em"; }Â 
Â  Â  else { titleEl.style.fontSize = "3.5em"; }

Â  Â  // --- CORRECCIÃ“N AQUÃ: Decodificamos los caracteres raros en Key y Tempo ---
Â  Â  const cleanKey = decodeHtmlEntities(song.key || '-');
Â  Â  const cleanTempo = decodeHtmlEntities(song.tempo || '-');
Â  Â  // --------------------------------------------------------------------------

Â  Â  document.getElementById('live-song-key').textContent = `Key: ${cleanKey}`;
Â  Â  document.getElementById('live-song-tempo').textContent = `${cleanTempo} BPM`;

Â  Â  const nextSong = currentLiveSetlist[index + 1];
Â  Â  const nextEl = document.getElementById('live-next-song');
Â  Â Â 
Â  Â  if (nextSong) {
Â  Â  Â  Â  nextEl.textContent = `Siguiente: ${nextSong.displayName}`;
Â  Â  Â  Â  nextEl.style.color = '#555';
Â  Â  } else {
Â  Â  Â  Â  nextEl.textContent = "Â¡FIN DEL SHOW! ğŸ‘";
Â  Â  Â  Â  nextEl.style.color = '#0cf';Â 
Â  Â  }
}

document.getElementById('live-close-btn').onclick = () => {
Â  Â  document.getElementById('live-mode-overlay').classList.remove('show');
Â  Â  releaseWakeLock();
};

document.getElementById('live-next-btn').onclick = () => {
Â  Â  if (currentLiveIndex < currentLiveSetlist.length - 1) {
Â  Â  Â  Â  currentLiveIndex++;
Â  Â  Â  Â  renderLiveSong(currentLiveIndex);
Â  Â  }
};

document.getElementById('live-prev-btn').onclick = () => {
Â  Â  if (currentLiveIndex > 0) {
Â  Â  Â  Â  currentLiveIndex--;
Â  Â  Â  Â  renderLiveSong(currentLiveIndex);
Â  Â  }
};

document.getElementById('live-content-area').onclick = (e) => {
Â  Â  const width = window.innerWidth;
Â  Â  if (e.clientX > width / 2) {
Â  Â  Â  Â  if (currentLiveIndex < currentLiveSetlist.length - 1) {
Â  Â  Â  Â  Â  Â  currentLiveIndex++;
Â  Â  Â  Â  Â  Â  renderLiveSong(currentLiveIndex);
Â  Â  Â  Â  }
Â  Â  }Â 
Â  Â  else {
Â  Â  Â  Â  if (currentLiveIndex > 0) {
Â  Â  Â  Â  Â  Â  currentLiveIndex--;
Â  Â  Â  Â  Â  Â  renderLiveSong(currentLiveIndex);
Â  Â  Â  Â  }
Â  Â  }
};
Â Â 

/* ---------- 14. Jukebox Player (NUEVA FUNCIONALIDAD) ---------- */

/**
 * Intenta normalizar la URL de audio para reproducirla en un iframe (YouTube, Drive) o en un tag <audio>.
 * * @param {string} rawUrl La URL del archivo de audio/video.
 * @returns {string} El HTML para incrustar el reproductor.
 */
function embedUrlToHtml(rawUrl) {
    let url = decodeURIComponent(rawUrl);

    // 1. YouTube
    const youtubeMatch = url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([^&?]+)/);
    if (youtubeMatch) {
        const videoId = youtubeMatch[1];
        // Utilizamos el modo sin cookies (youtube-nocookie)
        // AÃ±adimos 'autoplay=1' para que intente reproducir automÃ¡ticamente
        return `<iframe src="https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1&rel=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>`;
    }

    // 2. Google Drive (necesita un enlace de 'compartir' pÃºblico)
    const driveFileIdMatch = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)\//);
    if (driveFileIdMatch) {
        const fileId = driveFileIdMatch[1];
        // Usamos el enlace de vista previa incrustada
        return `<iframe src="https://drive.google.com/file/d/${fileId}/preview" frameborder="0" allowfullscreen></iframe>`;
    }
    
    // 3. Google Drive (enlace de exportaciÃ³n de audio)
    if (url.includes('drive.google.com/uc?export=download')) {
        return `<iframe src="${url}" frameborder="0" allowfullscreen></iframe>`;
    }


    // 4. Audio Directo (MP3, WAV, OGG)
    // Si la URL es una URL directa (termina en .mp3, .wav, etc.) o simplemente no es YouTube/Drive,
    // usamos el tag <audio> para que tenga los controles que pides.
    if (url.match(/\.(mp3|wav|ogg|m4a|aac|webm|mp4)(\?|$)/i) || !url.includes('http')) {
        // El tag <audio> ofrece controles nativos (play, pause, barra de progreso)
        return `<audio controls autoplay><source src="${url}" type="audio/mpeg">Tu navegador no soporta la reproducciÃ³n directa de audio/video.</audio>`;
    }
    
    // 5. URL no identificada / por defecto (Intentamos iframe por si acaso)
    return `<iframe src="${url}" frameborder="0" allowfullscreen></iframe>`;
}


/**
 * Abre el modal del reproductor de mÃºsica.
 * @param {string} url La URL codificada del archivo de audio/video.
 * @param {string} title El tÃ­tulo de la canciÃ³n.
 */
function openJukeboxPlayer(url, title) {
    const jukeboxModal = document.getElementById('jukebox-player-modal');
    const embedContainer = document.getElementById('jukebox-embed-container');
    const titleEl = document.getElementById('jukebox-song-title');

    titleEl.textContent = `Reproduciendo: ${title}`;
    embedContainer.innerHTML = embedUrlToHtml(url);

    jukeboxModal.classList.add('show');
    document.body.style.overflow = 'hidden';

    // Para mÃ³viles, intentar poner foco en el reproductor (no siempre funciona)
    setTimeout(() => {
        const player = embedContainer.querySelector('iframe, audio');
        if (player && player.focus) {
            player.focus();
        }
    }, 500);
}

document.getElementById('close-jukebox-modal').onclick = () => {
    const jukeboxModal = document.getElementById('jukebox-player-modal');
    const embedContainer = document.getElementById('jukebox-embed-container');
    
    // Detener la reproducciÃ³n borrando el contenido del contenedor
    embedContainer.innerHTML = '';
    
    jukeboxModal.classList.remove('show');
    document.body.style.overflow = '';
};


/* ---------- 12. Carga inicial & LÃ³gica Audio Global y Splash ---------- */
document.addEventListener("DOMContentLoaded", async () => {
Â Â 
Â  // --- LÃ³gica de Audio Global START ---
Â  const siteAudioElement = document.getElementById('site-audio');
Â  const siteAudioControlButton = document.getElementById('site-audio-control-button');Â 
Â  const siteAudioSongs = ['assets/que_mas_da.mp3', 'assets/una_semana.mp3']; // TUS CANCIONES
Â  let currentSiteSongIndex = -1;Â 
Â  let siteAudioFadeInterval = null;
Â  const SITE_AUDIO_FADE_DURATION = 500;Â 
Â  const SITE_AUDIO_TARGET_VOLUME = 0.8;Â 

Â  function stopSiteAudioFade() {
Â  Â  if (siteAudioFadeInterval) {
Â  Â  Â  clearInterval(siteAudioFadeInterval);
Â  Â  Â  siteAudioFadeInterval = null;
Â  Â  }
Â  }

Â  function fadeInSiteAudio(audio, duration, targetVolume) {
Â  Â  stopSiteAudioFade();
Â  Â  if (!audio) return;Â 
Â  Â  if (audio.muted) {Â 
Â  Â  Â  audio.volume = 0;Â 
Â  Â  Â  audio.play().catch(e => console.warn("Error al reproducir en fadeInSiteAudio (muted):", e));
Â  Â  Â  return;
Â  Â  }
Â  Â  audio.volume = 0;
Â  Â  if (audio.paused) { // Solo llama a play si estÃ¡ pausado
Â  Â  Â  Â  audio.play().catch(e => console.warn("Error al reproducir en fadeInSiteAudio:", e));
Â  Â  }
Â  Â Â 
Â  Â  let step = targetVolume / (duration / 50);
Â  Â  let currentVolume = 0;
Â  Â  siteAudioFadeInterval = setInterval(() => {
Â  Â  Â  currentVolume += step;
Â  Â  Â  if (currentVolume >= targetVolume) {
Â  Â  Â  Â  if(audio) audio.volume = targetVolume;Â 
Â  Â  Â  Â  stopSiteAudioFade();
Â  Â  Â  } else if (audio) {Â 
Â  Â  Â  Â  audio.volume = currentVolume;
Â  Â  Â  } else {Â 
Â  Â  Â  Â  stopSiteAudioFade();
Â  Â  Â  }
Â  Â  }, 50);
Â  }

Â  function fadeOutSiteAudio(audio, duration, callback) {
Â  Â  stopSiteAudioFade();
Â  Â  if (!audio) { if (callback) callback(); return; }

Â  Â  if (audio.paused || audio.volume < 0.01) {Â 
Â  Â  Â  if (!audio.paused) audio.pause();
Â  Â  Â  audio.volume = 0;Â 
Â  Â  Â  if (callback) callback();
Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  let currentVolume = audio.volume;
Â  Â  let step = currentVolume / (duration / 50);
Â  Â  siteAudioFadeInterval = setInterval(() => {
Â  Â  Â  currentVolume -= step;
Â  Â  Â  if (currentVolume <= 0.01) {Â 
Â  Â  Â  Â  if (audio) {
Â  Â  Â  Â  Â  Â  audio.volume = 0;
Â  Â  Â  Â  Â  Â  audio.pause();
Â  Â  Â  Â  }
Â  Â  Â  Â  stopSiteAudioFade();
Â  Â  Â  Â  if (callback) callback();
Â  Â  Â  } else if (audio) {
Â  Â  Â  Â  audio.volume = currentVolume;
Â  Â  Â  } else {
Â  Â  Â  Â  stopSiteAudioFade();
Â  Â  Â  }
Â  Â  }, 50);
Â  }

Â  function playNextSiteSong(audioElement) {
Â  Â  if (!audioElement || siteAudioSongs.length === 0) return;
Â  Â  currentSiteSongIndex = (currentSiteSongIndex + 1) % siteAudioSongs.length;
Â  Â  audioElement.src = siteAudioSongs[currentSiteSongIndex];
Â  Â  audioElement.load();

Â  Â  const eventName = 'canplaythrough';
Â  Â Â 
Â  Â  // Eliminamos cualquier listener previo para 'canplaythrough' para evitar duplicados
Â  Â  const playWhenReadyHandler = () => {
Â  Â  Â  if (audioElement) {Â 
Â  Â  Â  Â  fadeInSiteAudio(audioElement, SITE_AUDIO_FADE_DURATION, audioElement.muted ? 0 : SITE_AUDIO_TARGET_VOLUME);
Â  Â  Â  }
Â  Â  };
Â  Â  audioElement.addEventListener(eventName, playWhenReadyHandler, { once: true });
Â  }

Â  if (siteAudioElement && siteAudioControlButton) {
Â  Â  const iconMuted = siteAudioControlButton.querySelector('.icon-muted');
Â  Â  const iconUnmuted = siteAudioControlButton.querySelector('.icon-unmuted');

Â  Â  const updateSiteAudioMuteButton = () => {
Â  Â  Â  if (!siteAudioElement || !iconMuted || !iconUnmuted || !siteAudioControlButton) return;
Â  Â  Â  if (siteAudioElement.muted) {
Â  Â  Â  Â  iconMuted.style.display = 'inline';
Â  Â  Â  Â  iconUnmuted.style.display = 'none';
Â  Â  Â  Â  siteAudioControlButton.title = "Activar sonido";
Â  Â  Â  } else {
Â  Â  Â  Â  iconMuted.style.display = 'none';
Â  Â  Â  Â  iconUnmuted.style.display = 'inline';
Â  Â  Â  Â  siteAudioControlButton.title = "Desactivar sonido";
Â  Â  Â  }
Â  Â  };

Â  Â  siteAudioElement.muted = true;Â 
Â  Â  siteAudioElement.loop = false;Â 
Â  Â  updateSiteAudioMuteButton();
Â  Â  siteAudioControlButton.style.display = 'flex';Â 

Â  Â  currentSiteSongIndex = Math.floor(Math.random() * siteAudioSongs.length);
Â  Â  siteAudioElement.src = siteAudioSongs[currentSiteSongIndex];
Â  Â  siteAudioElement.load();Â 
Â  Â Â 
Â  Â  siteAudioElement.addEventListener('ended', () => {
Â  Â  Â  fadeOutSiteAudio(siteAudioElement, SITE_AUDIO_FADE_DURATION, () => {
Â  Â  Â  Â  playNextSiteSong(siteAudioElement);
Â  Â  Â  });
Â  Â  });

Â  Â  siteAudioControlButton.addEventListener('click', () => {
Â  Â  Â  if (!siteAudioElement) return;
Â  Â  Â  const wasMuted = siteAudioElement.muted;
Â  Â  Â  siteAudioElement.muted = !siteAudioElement.muted;
Â  Â  Â  updateSiteAudioMuteButton();

Â  Â  Â  if (!siteAudioElement.muted) {Â 
Â  Â  Â  Â  Â  if (siteAudioElement.paused || wasMuted) {Â 
Â  Â  Â  Â  Â  Â  Â  if(wasMuted && siteAudioElement.volume > 0 && !siteAudioElement.paused){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â fadeInSiteAudio(siteAudioElement, SITE_AUDIO_FADE_DURATION, SITE_AUDIO_TARGET_VOLUME);
Â  Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  siteAudioElement.volume = 0;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  fadeInSiteAudio(siteAudioElement, SITE_AUDIO_FADE_DURATION, SITE_AUDIO_TARGET_VOLUME);Â 
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  } else {Â 
Â  Â  Â  Â  stopSiteAudioFade();Â 
Â  Â  Â  }
Â  Â  });
Â  }
Â  // --- LÃ³gica de Audio Global END ---


Â  // --- Splash Screen Visual Logic START ---
Â  const splashScreen = document.getElementById('splash-screen');
Â  if (splashScreen) {
Â  Â  const visibleDuration = 1000;Â 
Â  Â  const exitAnimationDuration = 800;Â 

Â  Â  setTimeout(() => {
Â  Â  Â  splashScreen.classList.add('hidden');
Â  Â  Â  // La mÃºsica NO se detiene aquÃ­.
Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  if (splashScreen.parentNode) {
Â  Â  Â  Â  Â  Â splashScreen.style.display = 'none';
Â  Â  Â  Â  }
Â  Â  Â  }, exitAnimationDuration);
Â  Â  }, visibleDuration);
Â  }
Â  // --- Splash Screen Visual Logic END ---

Â  console.log("[DOMContentLoaded] Iniciando carga de la aplicaciÃ³n.");
Â  updateConnectionStatus();
Â  try {
Â  Â  Â  console.log("[DOMContentLoaded] Cargando configuraciÃ³n de setlists, usuarios y ensayos...");
Â  Â  Â  // Carga inicial de links de audio y lista de canciones maestra (antes de renderizar setlists)
      await loadAudioLinks();
      await loadSetlistMasterSongs();

      await Promise.all([loadSetlistConfig(), loadUsers(), loadRehearsals()]);
Â  Â  Â  console.log("[DOMContentLoaded] ConfiguraciÃ³n, usuarios y ensayos cargados.");
Â  } catch (e) { console.error("[DOMContentLoaded] Error en carga inicial de Firestore:", e); }

Â  let items1 = [], items2 = [], itemsStar = [];Â Â 
Â  try {Â Â 
Â  Â  console.log("[DOMContentLoaded] Cargando primer setlist...");
Â  Â  items1 = await cargarPrimerSetlist();Â Â 
Â  Â  console.log("[DOMContentLoaded] Primer setlist cargado:", items1 ? items1.length : 0, "bloques/items.");
Â  } catch (e) { console.error("[DOMContentLoaded] Fallo carga Setlist Ensayo:", e); }
Â Â 
Â  try {Â Â 
Â  Â  console.log("[DOMContentLoaded] Cargando segundo setlist...");
Â  Â  items2 = await cargarSegundoSetlist();Â Â 
Â  Â  console.log("[DOMContentLoaded] Segundo setlist cargado:", items2 ? items2.length : 0, "bloques/items.");
Â  } catch (e) { console.error("[DOMContentLoaded] Fallo carga Setlist PrÃ³x. Concierto:", e); }
Â Â 
Â  try {Â Â 
Â  Â  console.log("[DOMContentLoaded] Cargando setlist estrella...");
Â  Â  itemsStar = await cargarStarSetlist();Â Â 
Â  Â  console.log("[DOMContentLoaded] Setlist estrella cargado:", itemsStar ? itemsStar.length : 0, "bloques/items.");
Â  } catch (e) { console.error("[DOMContentLoaded] Fallo carga Setlist Estrella:", e); }

Â  document.getElementById("download-btn").onclick = () => { if (items1 && items1.length > 0) genPDF(items1, setlistConfig.setlist1.name, setlistConfig.setlist1.name); else alert("No hay elementos en Setlist Ensayo."); };
Â  document.getElementById("download-basic-btn").onclick = () => { if (items1 && items1.length > 0) genBasicPDF(items1, setlistConfig.setlist1.name, setlistConfig.setlist1.name); else alert("No hay elementos en Setlist Ensayo para PDF bÃ¡sico."); };
Â Â 
Â  document.getElementById("download-btn-2").onclick = () => { if (items2 && items2.length > 0) genPDF(items2, setlistConfig.setlist2.name, setlistConfig.setlist2.name); else alert("No hay elementos en Setlist PrÃ³x. Concierto."); };
Â  document.getElementById("download-basic-btn-2").onclick = () => { if (items2 && items2.length > 0) genBasicPDF(items2, setlistConfig.setlist2.name, setlistConfig.setlist2.name); else alert("No hay elementos en Setlist PrÃ³x. Concierto para PDF bÃ¡sico."); };
Â Â 
Â  document.getElementById("download-btn-star").onclick = () => { if (itemsStar && itemsStar.length > 0) genPDF(itemsStar, setlistConfig.setlistStar.name, setlistConfig.setlistStar.name); else alert("No hay elementos en Setlist Estrella."); };
Â  document.getElementById("download-basic-btn-star").onclick = () => { if (itemsStar && itemsStar.length > 0) genBasicPDF(itemsStar, setlistConfig.setlistStar.name, setlistConfig.setlistStar.name); else alert("No hay elementos en Setlist Estrella para PDF bÃ¡sico."); };
Â Â 
Â  document.getElementById("download-personal-btn").onclick = () => {
Â  Â  Â  if (items1 && items1.length > 0) {
Â  Â  Â  Â  Â  const fontSizeInput = prompt("PDF Personal - Introduce el tamaÃ±o de letra para los tÃ­tulos de las canciones (ej: 12, 14, 16):", "14");
Â  Â  Â  Â  Â  if (fontSizeInput) {
Â  Â  Â  Â  Â  Â  Â  const fontSize = parseInt(fontSizeInput, 10);
Â  Â  Â  Â  Â  Â  Â  if (!isNaN(fontSize) && fontSize >= 8 && fontSize <= 30) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  genPersonalPDF(items1, setlistConfig.setlist1.name, setlistConfig.setlist1.name, fontSize);
Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("TamaÃ±o de letra invÃ¡lido. Por favor, introduce un nÃºmero entre 8 y 30.");
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  } else {
Â  Â  Â  Â  Â  alert("No hay elementos en Setlist Ensayo para generar un PDF personal.");
Â  Â  Â  }
Â  };
Â  document.getElementById("download-personal-btn-2").onclick = () => {
Â  Â  Â  if (items2 && items2.length > 0) {
Â  Â  Â  Â  Â  const fontSizeInput = prompt("PDF Personal - Introduce el tamaÃ±o de letra para los tÃ­tulos de las canciones (ej: 12, 14, 16):", "14");
Â  Â  Â  Â  Â  if (fontSizeInput) {
Â  Â  Â  Â  Â  Â  Â  const fontSize = parseInt(fontSizeInput, 10);
Â  Â  Â  Â  Â  Â  Â  if (!isNaN(fontSize) && fontSize >= 8 && fontSize <= 30) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  genPersonalPDF(items2, setlistConfig.setlist2.name, setlistConfig.setlist2.name, fontSize);
Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("TamaÃ±o de letra invÃ¡lido. Por favor, introduce un nÃºmero entre 8 y 30.");
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  } else {
Â  Â  Â  Â  Â  alert("No hay elementos en Setlist PrÃ³ximo Concierto para generar un PDF personal.");
Â  Â  Â  }
Â  };
Â  document.getElementById("download-personal-btn-star").onclick = () => {
Â  Â  Â  if (itemsStar && itemsStar.length > 0) {
Â  Â  Â  Â  Â  const fontSizeInput = prompt("PDF Personal - Introduce el tamaÃ±o de letra para los tÃ­tulos de las canciones (ej: 12, 14, 16):", "14");
Â  Â  Â  Â  Â  if (fontSizeInput) {
Â  Â  Â  Â  Â  Â  Â  const fontSize = parseInt(fontSizeInput, 10);
Â  Â  Â  Â  Â  Â  Â  if (!isNaN(fontSize) && fontSize >= 8 && fontSize <= 30) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  genPersonalPDF(itemsStar, setlistConfig.setlistStar.name, setlistConfig.setlistStar.name, fontSize);
Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("TamaÃ±o de letra invÃ¡lido. Por favor, introduce un nÃºmero entre 8 y 30.");
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  } else {
Â  Â  Â  Â  Â  alert("No hay elementos en Setlist Estrella para generar un PDF personal.");
Â  Â  Â  }
Â  };

Â  console.log("[DOMContentLoaded] Iniciando proceso de tabla BandHelper...");
Â  // --- MutationObserver (REEMPLAZA A SETTIMEOUT) ---
Â  const bhContainer = document.getElementById('bandhelper-concerts-container');
Â  if (bhContainer) {
Â  Â  Â  const observer = new MutationObserver((mutations, obs) => {
Â  Â  Â  Â  Â  const table = bhContainer.querySelector('table');
Â  Â  Â  Â  Â  if (table) {
Â  Â  Â  Â  Â  Â  Â  console.log("BandHelper tabla detectada por MutationObserver.");
Â  Â  Â  Â  Â  Â  Â  processBandHelperTable();
Â  Â  Â  Â  Â  Â  Â  renderVisualCalendar(); // Actualizamos calendario
Â  Â  Â  Â  Â  Â  Â  obs.disconnect(); // Dejamos de observar
Â  Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  observer.observe(bhContainer, { childList: true, subtree: true });
Â  Â  Â Â 
Â  Â  Â  // Fallback por si acaso
Â  Â  Â  setTimeout(() => {Â 
Â  Â  Â  Â  Â  processBandHelperTable();Â 
Â  Â  Â  Â  Â  renderVisualCalendar();
Â  Â  Â  }, 3000);
Â  }

/* ---------- 13. LÃ³gica Calendario Visual (INTERACTIVO) ---------- */
Â  let currentCalDate = new Date();
Â  let globalConcertDetails = {};Â 

Â  // Escuchar base de datos en tiempo real
Â  if (typeof db !== 'undefined') {
Â  Â  Â  db.collection('concert_details').onSnapshot(snapshot => {
Â  Â  Â  Â  Â  snapshot.forEach(doc => {
Â  Â  Â  Â  Â  Â  Â  globalConcertDetails[doc.id] = doc.data();
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  renderVisualCalendar();Â 
Â  Â  Â  });
Â  }

Â  function renderVisualCalendar() {
Â  Â  const grid = document.getElementById('calendar-grid-container');
Â  Â  const monthDisplay = document.getElementById('calendar-month-display');
Â  Â Â 
Â  Â  if (!grid || !monthDisplay) return;

Â  Â  grid.innerHTML = '';Â 
Â  Â  const year = currentCalDate.getFullYear();
Â  Â  const month = currentCalDate.getMonth();
Â  Â Â 
Â  Â  const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
Â  Â  const dayHeaders = ["Lun", "Mar", "MiÃ©", "Jue", "Vie", "SÃ¡b", "Dom"];
Â  Â Â 
Â  Â  monthDisplay.textContent = `${monthNames[month]} ${year}`;

Â  Â  dayHeaders.forEach(day => {
Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  div.className = 'cal-header';
Â  Â  Â  div.textContent = day;
Â  Â  Â  grid.appendChild(div);
Â  Â  });

Â  Â  const firstDayOfMonth = new Date(year, month, 1);
Â  Â  let startDay = firstDayOfMonth.getDay() - 1;Â 
Â  Â  if (startDay === -1) startDay = 6;
Â  Â  const daysInMonth = new Date(year, month + 1, 0).getDate();
Â  Â  const today = new Date();

Â  Â  const events = [];

Â  Â  // --- LÃ“GICA 1: ENSAYOS ---
Â  Â  if (Array.isArray(rehearsals)) {
Â  Â  Â  rehearsals.forEach((r, i) => {
Â  Â  Â  Â  let missingStr = "";
Â  Â  Â  Â  if (r.attendance && Array.isArray(r.attendance)) {
Â  Â  Â  Â  Â  Â  const missingNames = r.attendance
Â  Â  Â  Â  Â  Â  Â  Â  .filter(a => a.attending === "No")
Â  Â  Â  Â  Â  Â  Â  Â  .map(a => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const u = users.find(user => user.name === a.name);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return u ? u.nickname : a.name;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (missingNames.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  missingStr = `<br><span style="color: #fff; font-weight: normal; font-size: 0.9em;">[Faltan: ${missingNames.join(", ")}]</span>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  events.push({
Â  Â  Â  Â  Â  dateStr: r.date,Â 
Â  Â  Â  Â  Â  type: 'ensayo',
Â  Â  Â  Â  Â  title: `Ensayo (${r.startTime} - ${r.endTime})${missingStr}`,
Â  Â  Â  Â  Â  index: i // Index para click handler
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  }

Â  Â  // --- LÃ“GICA 2: CONCIERTOS ---
Â  Â  const concertRows = document.querySelectorAll('#bandhelper-concerts-container table tbody tr');
Â  Â  concertRows.forEach(row => {
Â  Â  Â  const cells = row.cells;
Â  Â  Â  if (cells.length >= 3) {
Â  Â  Â  Â  const dateText = cells[0].textContent.trim();Â 
Â  Â  Â  Â  const titleText = cells[1].textContent.trim();
Â  Â  Â  Â  const locationText = cells[2].textContent.trim();Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  const dateMatch = dateText.match(/(\d{2})\/(\d{2})\/(\d{2})/);
Â  Â  Â  Â  if (dateMatch) {
Â  Â  Â  Â  Â  Â  let y = parseInt(dateMatch[3], 10);
Â  Â  Â  Â  Â  Â  y += (y < 70 ? 2000 : 1900);
Â  Â  Â  Â  Â  Â  const isoDate = `${y}-${dateMatch[2]}-${dateMatch[1]}`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const dateForId = dateText.split(',')[0].trim();
Â  Â  Â  Â  Â  Â  const concertId = sanitizeFirebaseKey(`${dateForId}_${titleText}`);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let missingStr = "";
Â  Â  Â  Â  Â  Â  const details = globalConcertDetails[concertId];

Â  Â  Â  Â  Â  Â  if (details && details.attendees) {
Â  Â  Â  Â  Â  Â  Â  Â  const missingNames = users
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .filter(u => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const val = u.nickname || u.name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return !details.attendees.includes(val);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .map(u => u.nickname);

Â  Â  Â  Â  Â  Â  Â  Â  if (missingNames.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  missingStr = `<br><span style="color: #fff; font-weight: normal; font-size: 0.9em;">[Faltan: ${missingNames.join(", ")}]</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  events.push({
Â  Â  Â  Â  Â  Â  Â  dateStr: isoDate,
Â  Â  Â  Â  Â  Â  Â  type: 'concierto',
Â  Â  Â  Â  Â  Â  Â  title: `${titleText}${missingStr}`,
Â  Â  Â  Â  Â  Â  Â  rawDate: dateText,
Â  Â  Â  Â  Â  Â  Â  rawTitle: titleText,
Â  Â  Â  Â  Â  Â  Â  rawLoc: locationText,
Â  Â  Â  Â  Â  Â  Â  id: concertId
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  });

Â  Â  for (let i = 0; i < startDay; i++) {
Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  div.className = 'cal-day other-month';
Â  Â  Â  grid.appendChild(div);
Â  Â  }

Â  Â  for (let day = 1; day <= daysInMonth; day++) {
Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  div.className = 'cal-day';
Â  Â  Â Â 
Â  Â  Â  if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
Â  Â  Â  Â  div.classList.add('today');
Â  Â  Â  }

Â  Â  Â  const numDiv = document.createElement('div');
Â  Â  Â  numDiv.className = 'cal-day-number';
Â  Â  Â  numDiv.textContent = day;
Â  Â  Â  div.appendChild(numDiv);

Â  Â  Â  const currentIso = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
Â  Â  Â  const dayEvents = events.filter(e => e.dateStr === currentIso);
Â  Â  Â Â 
Â  Â  Â  dayEvents.forEach(evt => {
Â  Â  Â  Â  const evtDiv = document.createElement('div');
Â  Â  Â  Â  evtDiv.className = `cal-event type-${evt.type}`;Â 
Â  Â  Â  Â  evtDiv.innerHTML = evt.title;Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Click para Conciertos
Â  Â  Â  Â  if (evt.type === 'concierto') {
Â  Â  Â  Â  Â  Â  evtDiv.style.cursor = 'pointer';
Â  Â  Â  Â  Â  Â  evtDiv.title = "Click para ver detalles y asistencia";
Â  Â  Â  Â  Â  Â  evtDiv.onclick = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  Â  Â  Â  Â  openConcertDetailModal(evt.id, evt.rawDate, evt.rawTitle, evt.rawLoc);
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }

Â  Â  Â  Â  // Click para Ensayos (NUEVO)
Â  Â  Â  Â  if (evt.type === 'ensayo') {
Â  Â  Â  Â  Â  Â  evtDiv.style.cursor = 'pointer';
Â  Â  Â  Â  Â  Â  evtDiv.title = "Click para ver notas del ensayo";
Â  Â  Â  Â  Â  Â  evtDiv.onclick = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  Â  Â  Â  Â  openRehearsalDetailsModal(evt.index);
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  div.appendChild(evtDiv);
Â  Â  Â  });

Â  Â  Â  grid.appendChild(div);
Â  Â  }
Â  }

Â  const prevBtn = document.getElementById('prev-month-btn');
Â  const nextBtn = document.getElementById('next-month-btn');
Â Â 
Â  if(prevBtn) {
Â  Â  Â  const newPrev = prevBtn.cloneNode(true);
Â  Â  Â  prevBtn.parentNode.replaceChild(newPrev, prevBtn);
Â  Â  Â  newPrev.addEventListener('click', () => {
Â  Â  Â  Â  currentCalDate.setMonth(currentCalDate.getMonth() - 1);
Â  Â  Â  Â  renderVisualCalendar();
Â  Â  Â  });
Â  }
Â Â 
Â  if(nextBtn) {
Â  Â  Â  const newNext = nextBtn.cloneNode(true);
Â  Â  Â  prevBtn.parentNode.replaceChild(newNext, prevBtn);
Â  Â  Â  newNext.addEventListener('click', () => {
Â  Â  Â  Â  currentCalDate.setMonth(currentCalDate.getMonth() + 1);
Â  Â  Â  Â  renderVisualCalendar();
Â  Â  Â  });
Â  }

Â  document.getElementById('header-calendar-btn').onclick = () => {
Â  Â  Â const target = document.getElementById('vista-calendario-mensual');
Â  Â  Â closeAll();
Â  Â  Â if(target) { const headerOffset = 60; const elementPosition = target.getBoundingClientRect().top; const offsetPosition = elementPosition + window.pageYOffset - headerOffset - 10; window.scrollTo({top: offsetPosition, behavior: "smooth"}); }
Â  };

Â  renderVisualCalendar();Â 
Â  setTimeout(renderVisualCalendar, 2000);Â 
Â  setTimeout(renderVisualCalendar, 5000);

Â  console.log("[DOMContentLoaded] Carga de la aplicaciÃ³n completada.");
});
</script>
</body>
</html>
