<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>El Sótano del Doctor – Uso Interno</title>

  <link rel="icon" type="image/x-icon" href="assets/favicon_ElSotanoDr.ico">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">

  <meta property="og:title"       content="El Sótano del Doctor – Uso Interno">
  <meta property="og:description" content="Banda de rock y versiones. Explora nuestro setlist, fechas de conciertos y más.">
  <meta property="og:image"       content="assets/logo_negro copia.jpg">
  <meta property="og:type"        content="website">
  <meta property="og:url"         content="https://idoctor2000.github.io/ElSotanoDelDoctor-Intranet/">
  <meta name="twitter:card"        content="summary_large_image">
  <meta name="twitter:title"       content="El Sótano del Doctor – Uso Interno">
  <meta name="twitter:description" content="Banda de rock y versiones. Explora nuestro setlist, fechas de conciertos y mucho más. ¡Disfruta de la música!">
  <meta name="twitter:image"       content="assets/logo_negro copia.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    /* Estilos CSS (iguales a la v6/v7, por brevedad no se repiten aquí) */
    /* ... Pega aquí los estilos de la versión anterior ... */
    /* Reset y fuente base */
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;padding:0;overflow-x:hidden;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff}
    /* Cabecera */
    header{background:#111;padding:15px 20px;display:flex;align-items:center;justify-content:space-between;position:relative; border-bottom: 1px solid #0cf;}
    .logo img.logo-main{width:160px;height:auto} /* Logo principal */
    .logo-intranet{position:absolute;left:50%;transform:translateX(-50%);height:50px;width:auto} /* Centrar logointranet.png */
    /* Hamburguesa */
    .hamburger{cursor:pointer;border:1px solid #0cf;border-radius:4px;padding:5px}
    .hamburger div{width:25px;height:3px;background:#0cf;margin:4px 0}
    /* Sidebar */
    .sidebar{position:fixed;top:0;left:0;width:250px;height:100%;background:#111;border-right:1px solid #222;
             padding:20px;box-shadow:2px 0 10px rgba(0,255,255,.1);transform:translateX(-250px);transition:transform .3s ease-in-out;z-index:9999; overflow-y: auto;}
    .sidebar.show{transform:translateX(0)}
    .sidebar h2{color:#0cf;margin:0 0 15px 0; text-align: center; border-bottom: 1px solid #0cf; padding-bottom: 10px;}
    .sidebar a{display:block;color:#fff;text-decoration:none;margin:12px 0;padding:8px 5px;border-bottom:1px solid #222; font-size: 0.95em;}
    .sidebar a:hover{color:#0cf; background-color: #222; border-radius: 3px;}
    .sidebar .submenu { margin-left: 15px; border-left: 2px solid #0cf; padding-left: 10px; margin-top: 5px;}
    .sidebar .submenu a { padding: 6px 0; font-size: 0.9em; border-bottom: 1px solid #2a2a2a;}
    /* Overlay */
    #overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:9998;display:none;backdrop-filter: blur(2px);}
    #overlay.show{display:block}
    /* Pantallas modales */
    .config-screen, .modal-screen { /* Unificando clase base para modales */
        display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:10000; /* Aumentado z-index para el modal */
        overflow-y:auto;padding:70px 20px 20px
    }
    .config-screen h2, .modal-screen h2 {color:#0cf;text-align:center;margin:10px 0 20px 0}
    .config-screen h3, .modal-screen h3 {color:#0cf;margin:20px 0 10px; border-bottom: 1px solid #333; padding-bottom: 5px;}
    .config-screen label, .modal-screen label {display:block;margin:10px 0 5px; color: #0cf;}
    .config-screen input,.config-screen select, .config-screen textarea,
    .modal-screen input,.modal-screen select, .modal-screen textarea {
        width:100%;max-width:450px;padding:12px;background:#1a1a1a;color:#fff;
        border:1px solid #0cf;border-radius:5px; margin-bottom: 12px; box-shadow: 0 0 5px rgba(0,204,255,0.2); display: block; /* Para que ocupen el ancho del max-width */ margin-left: auto; margin-right: auto; /* Centrar los inputs */
    }
    .config-screen select[multiple], .modal-screen select[multiple] { height: 150px; }
    .config-screen textarea, .modal-screen textarea { height: 120px; resize: vertical; } /* Ajustado altura para notas */
    .modal-screen textarea#concert-note-general { height: 100px; } /* Altura específica para nota general */
    .modal-screen input[type="time"], .modal-screen input[type="text"] { max-width: 250px; } /* Ancho específico para algunos inputs del modal */


    .config-screen button, .modal-screen button {
        margin-top:25px;padding:12px 22px;background:#0cf;color:#000;border:none;
        border-radius:8px;cursor:pointer;font-weight:bold; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-left: auto; margin-right: auto; /* Centrar botones */
    }
    .config-screen button:hover, .modal-screen button:hover {background:#0ae; box-shadow: 0 0 10px #0cf;}
    .config-screen .close-btn, .modal-screen .close-btn {
        position:absolute;top:15px;right:15px;font-size:1.5em;background:transparent;border:2px solid #0cf;
        color:#0cf;border-radius:50%;padding:0px;cursor:pointer; width:35px; height:35px; line-height:30px; text-align:center; margin:0; /* Resetear margen para el botón de cerrar */
    }
    .config-screen .close-btn:hover, .modal-screen .close-btn:hover {background:#0cf; color:#000; box-shadow: 0 0 8px #0cf;}
    /* Estilos específicos para el modal de notas de concierto */
    #concert-note-edit-modal .modal-content { max-width: 600px; margin: auto; background-color: #111; padding: 20px; border-radius: 8px; border: 1px solid #0cf;}
    #concert-note-info { color: #ccc; font-style: italic; margin-bottom: 15px; text-align: center; font-size: 1.1em; }
    #concert-note-edit-modal label {text-align: left; max-width: 450px; margin-left: auto; margin-right: auto;} /* Alinear labels a la izquierda */


    /* Secciones */
    main section{max-width:1200px;margin:20px auto;padding:25px; background:#0a0a0a; border: 1px solid #1c1c1c; border-radius:10px;box-shadow:0 0 20px rgba(0,204,255,.1);}
    #setlists h2,#rehearsals h2,#second-setlist h2,#calendario h2,#usuarios h2{text-align:center;color:#0cf;margin-bottom:20px; font-size: 1.8em;}
    /* Ajuste para tablas */
    .table-wrapper { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; color: #fff; font-size: .95em; }
    thead{background:#111;color:#0cf; border-bottom: 2px solid #0cf;}
    th,td{padding:12px 15px;border:1px solid #282828;text-align:left;white-space:normal; word-wrap:break-word;}
    tr:nth-child(even){background:#101010}
    tr:hover {background-color: #181818;}
    #second-setlist .table-wrapper table { min-width: 600px; }
    .download-btn{display:block;margin:25px auto 0;padding:12px 25px;font-size:1em;background:#0cf;color:#000;border:none;border-radius:8px;cursor:pointer; font-weight: bold;}
    .download-btn:hover{background:#09b; box-shadow: 0 0 8px #0cf;}
    #total-time,#total-time-2{color:#0cf;margin-top:15px;text-align:center; font-size: 1.1em; font-weight: bold;}
    #second-setlist-name {text-align:center;color:#aaa;margin-top:5px;font-style:italic; font-size: 1.1em;}
    footer{background:#050505;color:#888;text-align:center;padding:15px;border-top:1px solid #0cf; margin-top: 30px;}
    /* Botones de acción, calendario, detalles */
    .calendar-btn, .details-btn { background: none; border: none; cursor: pointer; padding: 5px; margin-left: 10px; vertical-align: middle; }
    .calendar-btn svg { fill: #0cf; width: 22px; height: 22px; transition: fill 0.2s;}
    .calendar-btn:hover svg { fill: #09b; transform: scale(1.1); }
    .details-btn svg { fill: #0af; width: 22px; height: 22px; transition: fill 0.2s;}
    .details-btn:hover svg { fill: #07a; transform: scale(1.1); }
    .action-btn { padding: 6px 12px; margin: 0 5px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s, transform 0.2s; }
    .action-btn:hover {transform: translateY(-1px);}
    .edit-btn { background: #0cf; color: #000; } .edit-btn:hover { background: #09b; }
    .delete-btn { background: #f00; color: #fff; } .delete-btn:hover { background: #d00; }
    .clear-attendance-btn { background: #ff9800; color: #000;} .clear-attendance-btn:hover { background: #e68900;}
    .save-note-btn { background: #0cf; color: #000; margin-top: 5px !important; } .save-note-btn:hover { background: #09b; }
    #cancel-edit-user, #cancel-edit-rehearsal { background: #666; color: #fff; } #cancel-edit-user:hover, #cancel-edit-rehearsal:hover { background: #555; }
    /* Formulario de asistencia */
    .attendance-form { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-top:5px; }
    .attendance-form select { padding: 8px; background: #222; color: #fff; border: 1px solid #333; border-radius: 4px; }
    .attendance-form button { padding: 8px 12px; background: #0cf; color: #000; border: none; border-radius: 4px; cursor: pointer; }
    .attendance-form button:hover { background: #09b; }
    .attendance-summary { margin-top: 10px; font-size: 0.9em; } .attendance-summary span { display: block; margin-bottom: 3px;}
    .attending-yes { color: #0cf; font-weight: bold;} .attending-no { color: #f00; font-weight: bold;}
    .rehearsal-duration { display: block; font-size: 0.9em; color: #aaa; margin-top: 3px;}
    /* Indicador de conexión y mensajes */
    #connection-status { position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.85); color: #fff; padding: 8px 12px; border-radius: 5px; font-size: 0.9em; z-index: 10001; display: none; border: 1px solid #555; } /* Aumentado z-index */
    #connection-status.offline { background: #c00; border-color: #f00;}
    #connection-status.retrying { background: #e68900; border-color: #ff9800;}
    .message { margin-top: 15px; text-align: center; padding: 8px; border-radius: 4px; font-weight: bold;}
    .success-message { color: #000; background-color: #0cf; }
    .error-message { color: #fff; background-color: #d32f2f; }
    /* Estadísticas */
    .stats-table { margin-bottom: 40px; } .stats-table h3 { color: #0cf; margin: 20px 0 10px; text-align: center; }
    .stats-filter { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px; }
    .stats-filter label { color: #0cf; }
    .stats-filter select { padding: 8px; background: #222; color: #fff; border: 1px solid #333; border-radius: 4px; width: auto; max-width: 220px; }
    /* Columnas específicas en tablas */
    #calendario table th:last-child, #calendario table td:last-child { text-align: center; } /* Para centrar la columna de detalles */

    /* Responsive */
    @media(max-width:768px){
      header{padding:10px 15px;} .logo img.logo-main{width:130px} .logo-intranet{height:40px} .hamburger div{width:20px}
      main section {padding: 15px;}
      #setlists h2,#rehearsals h2,#second-setlist h2,#calendario h2,#usuarios h2{font-size: 1.5em;}
      .config-screen, .modal-screen {padding:60px 15px 15px}
      .config-screen input, .config-screen select, .config-screen textarea,
      .modal-screen input, .modal-screen select, .modal-screen textarea {padding:10px; max-width: none;}
      .config-screen button, .modal-screen button {padding:10px 18px;}
      .action-btn, .attendance-form button {width: 100%; margin-bottom: 8px;}
      .attendance-form { flex-direction: column; align-items: stretch; } .attendance-form select { width: 100%; }
      #connection-status { font-size: 0.8em; padding: 6px 10px; bottom: 5px; right: 5px;}
      table { font-size: 0.8em; } th, td { padding: 8px 6px; max-width: 100px; }
    }
  </style>
</head>
<body>
  <div id="connection-status"></div>
  <header>
    <div class="logo"><img src="assets/logo_blanco.png" alt="Logo El Sótano del Doctor" class="logo-main"></div>
    <img src="assets/logointranet.png" alt="Logo Intranet" class="logo-intranet">
    <div class="hamburger" id="hamburger-btn"><div></div><div></div><div></div></div>
  </header>
  <div id="overlay"></div>
  <nav class="sidebar" id="sidebar-menu">
    <h2>Menú Principal</h2>
    <a href="#rehearsals" id="menu-rehearsals-section">Próximos Ensayos</a>
    <a href="#second-setlist" id="menu-second-setlist-section">Setlist Concierto</a>
    <a href="#calendario" id="menu-concerts-section">Próximos Conciertos</a>
    <a href="#" id="menu-stats">Estadísticas</a>
    <a href="#" id="menu-config">Configuración</a>
    <div class="submenu" id="config-submenu" style="display: none;">
      <a href="#" id="menu-setlist-config">Setlists</a>
      <a href="#" id="menu-user-mgmt">Usuarios</a>
      <a href="#" id="menu-rehearsal">Ensayos</a>
      </div>
    <a href="#" id="menu-cerrar">Cerrar Menú</a>
  </nav>
  <div id="setlist-config-screen" class="config-screen">
    <button class="close-btn" id="close-setlist-config" title="Cerrar">&times;</button>
    <h2>Configuración de Setlists</h2>
    <h3>Setlist Próximo Ensayo</h3>
    <label for="setlist1-name">Nombre del Setlist:</label><input id="setlist1-name" placeholder="Ej: Ensayos Verano 2025">
    <label for="setlist1-url">ID/URL del feed:</label><input id="setlist1-url" placeholder="URL completa del feed JSON">
    <h3>Segundo Setlist (ej. Próximo Concierto)</h3>
    <label for="setlist2-name">Nombre del Setlist:</label><input id="setlist2-name" placeholder="Ej: Concierto Sala X">
    <label for="setlist2-url">ID/URL del feed (BandHelper):</label><input id="setlist2-url" placeholder="ID del feed (ej: TXHvyb) o URL completa">
    <button id="guardar-setlist-config">Guardar Configuración</button>
    <p id="setlist-message" class="message"></p>
  </div>
  <div id="user-mgmt-screen" class="config-screen">
    <button class="close-btn" id="close-user-mgmt" title="Cerrar">&times;</button>
    <h2>Gestión de Usuarios</h2>
    <label for="user-name">Nombre:</label><input id="user-name" placeholder="Nombre completo">
    <label for="user-nickname">Apodo:</label><input id="user-nickname" placeholder="Apodo corto (para tablas)">
    <label for="user-role">Roles:</label>
    <select id="user-role" multiple>
      <option value="Batería">Batería</option><option value="Teclados">Teclados</option><option value="Voz">Voz</option>
      <option value="Guitarra eléctrica">Guitarra eléctrica</option><option value="Guitarra Acústica">Guitarra Acústica</option>
      <option value="Bajo">Bajo</option><option value="Percusión">Percusión</option><option value="Saxo">Saxo</option>
      <option value="Dirección Musical">Dirección Musical</option><option value="Técnico de Sonido">Técnico de Sonido</option>
      <option value="Montador">Montador</option><option value="Coros">Coros</option>
    </select>
    <button id="add-user" class="action-btn edit-btn">Añadir Usuario</button>
    <button id="cancel-edit-user" class="action-btn delete-btn" style="display:none; background-color: #555;">Cancelar Edición</button>
    <p id="user-message" class="message"></p>
    <div class="table-wrapper">
        <table id="user-table"><thead><tr><th>Nombre</th><th>Apodo</th><th>Roles</th><th>Acciones</th></tr></thead><tbody id="user-table-body"></tbody></table>
    </div>
  </div>
  <div id="rehearsal-screen" class="config-screen">
    <button class="close-btn" id="close-rehearsal" title="Cerrar">&times;</button>
    <h2>Asignación y Gestión de Ensayos</h2>
    <label for="rehearsal-date">Fecha:</label><input type="date" id="rehearsal-date">
    <label for="rehearsal-start-time">Hora Inicio:</label><input type="time" id="rehearsal-start-time">
    <label for="rehearsal-end-time">Hora Fin:</label><input type="time" id="rehearsal-end-time">
    <label for="rehearsal-location">Lugar:</label><input id="rehearsal-location" placeholder="Ej: Local de Ensayo XYZ">
    <button id="add-rehearsal" class="action-btn edit-btn">Añadir Ensayo</button>
    <button id="cancel-edit-rehearsal" class="action-btn delete-btn" style="display:none; background-color: #555;">Cancelar Edición</button>
    <p id="rehearsal-message" class="message"></p>
    <div class="table-wrapper">
        <table id="rehearsal-table">
          <thead><tr><th>Fecha</th><th>Inicio</th><th>Fin</th><th>Lugar</th><th>Asistencias</th><th>Acciones</th></tr></thead>
          <tbody id="rehearsal-table-body"></tbody>
        </table>
    </div>
  </div>
  <div id="stats-screen" class="config-screen">
    <button class="close-btn" id="close-stats" title="Cerrar">&times;</button>
    <h2>Estadísticas de Ensayos</h2>
    <div class="stats-filter">
      <label for="stats-month-filter">Filtrar por mes:</label>
      <select id="stats-month-filter"><option value="all">Todos los meses</option></select>
    </div>
    <div class="stats-table">
      <h3>Tiempo Ensayado por Mes</h3>
      <div class="table-wrapper"><table id="time-per-month-table"><thead><tr><th>Mes</th><th>Tiempo Total (horas)</th></tr></thead><tbody id="time-per-month-body"></tbody></table></div>
    </div>
    <div class="stats-table">
      <h3>Tiempo Ensayado por Usuario (Asistido)</h3>
      <div class="table-wrapper"><table id="time-per-user-table"><thead><tr><th>Usuario</th><th>Tiempo Total (horas)</th></tr></thead><tbody id="time-per-user-body"></tbody></table></div>
    </div>
    <div class="stats-table">
      <h3>Historial de Ensayos Pasados</h3>
      <div class="table-wrapper"><table id="past-rehearsals-table"><thead><tr><th>Fecha</th><th>Horario</th><th>Lugar</th><th>Asistencias (Apodos)</th></tr></thead><tbody id="past-rehearsals-body"></tbody></table></div>
    </div>
  </div>

  <div id="concert-note-edit-modal" class="modal-screen">
    <div class="modal-content">
        <button class="close-btn" id="close-concert-note-edit-modal" title="Cerrar">&times;</button>
        <h2>Detalles del Concierto</h2>
        <p id="concert-note-info">Concierto: Cargando...</p>
        
        <label for="concert-note-location-details">Detalles Ubicación (ej. entrada, parking, camerinos):</label>
        <textarea id="concert-note-location-details" placeholder="Notas sobre la ubicación..."></textarea>

        <label for="concert-note-soundcheck-time">Hora Prueba de Sonido:</label>
        <input type="time" id="concert-note-soundcheck-time">

        <label for="concert-note-show-time">Hora del Show (confirmada/ajustada):</label>
        <input type="time" id="concert-note-show-time">
        
        <label for="concert-note-general">Notas Generales Adicionales:</label>
        <textarea id="concert-note-general" placeholder="Otras notas importantes..."></textarea>
        
        <button id="save-concert-note-modal-btn">Guardar Detalles</button>
        <p id="concert-note-edit-message" class="message"></p>
    </div>
  </div>

  <main>
    <section id="setlists">
      <h2 id="setlist1-title">Setlist Ensayos</h2>
      <div class="table-wrapper"><table id="setlist-table-main"><thead><tr><th>#</th><th>Título</th><th>Tonalidad</th><th>Tempo</th><th>Duración</th></tr></thead><tbody id="setlist-body"></tbody></table></div>
      <button class="download-btn" id="download-btn">Descargar PDF</button>
      <p id="total-time"></p>
    </section>
    <section id="rehearsals">
      <h2>Próximos Ensayos</h2>
      <div class="table-wrapper"><table id="rehearsal-main-table"><thead><tr><th>Fecha y Duración</th><th>Horario</th><th>Lugar y Calendario</th><th>Confirmar Asistencia</th></tr></thead><tbody id="rehearsal-main-body"></tbody></table></div>
    </section>
    <section id="second-setlist">
      <h2 id="setlist2-title-placeholder">Setlist Próximo Concierto</h2> <p id="second-setlist-name"></p>
      <div class="table-wrapper"><table id="second-list-table"><thead><tr><th>#</th><th>Canción</th><th>Tonalidad</th><th>Tempo</th><th>Duración</th></tr></thead><tbody id="second-body"></tbody></table></div>
      <button class="download-btn" id="download-btn-2">Descargar PDF</button>
      <p id="total-time-2"></p>
    </section>
    <section id="calendario">
      <h2>Próximos Conciertos</h2>
      <div id="bandhelper-concerts">
        <script src="https://www.bandhelper.com/widget/calendar/10353?layout=1&range=6"></script>
      </div>
    </section>
    <section id="usuarios">
      <h2>Usuarios Registrados</h2>
      <div class="table-wrapper"><table id="users-main-table"><thead><tr><th>Nombre</th><th>Apodo</th><th>Roles</th></tr></thead><tbody id="users-body"></tbody></table></div>
    </section>
  </main>
  <footer>© 2025 El Sótano del Doctor. Todos los derechos reservados.</footer>

  <script>
  //<![CDATA[
  /* ---------- 0. Firebase ---------- */
  const firebaseConfig = {
    apiKey: "TU_API_KEY", // ¡¡¡REEMPLAZA ESTO CON TU API KEY REAL!!!
    authDomain: "sotanointranet.firebaseapp.com",
    projectId: "sotanointranet",
    storageBucket: "sotanointranet.appspot.com",
    messagingSenderId: "756955233128",
    appId: "1:756955233128:web:ab36372bdbd895a30e74dd"
  };

  let db;
  let persistencePromise;

  if (firebaseConfig.apiKey === "TU_API_KEY") {
    console.error("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");
    console.error("!!! POR FAVOR, REEMPLAZA 'TU_API_KEY' EN firebaseConfig !!!");
    console.error("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");
  }

  try {
    if (firebase.apps.length === 0) { firebase.initializeApp(firebaseConfig); console.log("Firebase App inicializada."); }
    else { console.log("Firebase App ya inicializada."); }
    db = firebase.firestore();
    persistencePromise = db.enablePersistence({ synchronizeTabs: true })
      .then(() => { console.log("Persistencia Firestore (multi-pestaña) HABILITADA."); })
      .catch(err => { if (err.code === 'failed-precondition') { console.warn("Persistencia (multi) falló, intentando una sola...", err.message); return db.enablePersistence(); } console.error("Error habilitando persistencia (multi):", err); throw err; })
      .then(() => { console.log("Intento de config. de persistencia completado."); })
      .catch(err => { console.error("Error final config. persistencia:", err); });
  } catch (e) {
    console.error("Error GRAVE: Firebase App no pudo inicializarse.", e);
    const statusDiv = document.getElementById("connection-status");
    if (statusDiv) { statusDiv.textContent = "Error GRAVE: Firebase no inicializado."; statusDiv.className = "offline"; statusDiv.style.display = "block"; }
    persistencePromise = Promise.reject(e);
  }

  /* ---------- 1. Utilidades (sin cambios desde v6) ---------- */
  const parseDuration = str => { if (!str) return 0; if (str.includes(":")) { const [m, s = 0] = str.split(":").map(Number); return m * 60 + s; } const n = parseInt(str, 10); return isNaN(n) ? 0 : n; };
  const toMMSS = s => `${Math.floor(s / 60)}:${String(s % 60).padStart(2, "0")}`;
  const toHHMM = s => { const h = Math.floor(s / 3600); const m = Math.floor((s % 3600) / 60); return h ? `${h}h ${String(m).padStart(2, "0")}m` : `${m}m`; };
  const toHours = s => (s / 3600).toFixed(2);
  const clean = s => (s || "").toString().replace(/[^\x00-\xFF]/g, "").trim();
  const calculateDuration = (startTime, endTime) => { if (!startTime || !endTime) return 0; const [startH, startM] = startTime.split(":").map(Number); const [endH, endM] = endTime.split(":").map(Number); const startSeconds = startH * 3600 + startM * 60; const endSeconds = endH * 3600 + endM * 60; let duration = endSeconds - startSeconds; if (duration < 0) duration += 24 * 3600; return duration; };
  const formatDateWithDay = dateStr => { try { const date = new Date(dateStr + "T00:00:00Z"); const days = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"]; const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]; const dayName = days[date.getUTCDay()]; const day = date.getUTCDate(); const monthName = months[date.getUTCMonth()]; return `${dayName} ${day} de ${monthName}`; } catch(e) { console.warn(`Error formateando fecha '${dateStr}':`, e); return dateStr;}};
  const getMonthYear = dateStr => { try {const date = new Date(dateStr + "T00:00:00Z"); const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]; return `${months[date.getUTCMonth()]} ${date.getUTCFullYear()}`; } catch(e) { console.warn(`Error getMonthYear para '${dateStr}':`, e); return "Fecha Inválida";}};
  function generateICS(title, dateISO, startTime, location, description = "", durationSeconds = 7200) {
    console.log("generateICS - Entradas:", { title, dateISO, startTime, location, description, durationSeconds });
    const timeParts = startTime.match(/^(\d{1,2}):(\d{2})$/);
    if (!timeParts) { console.error("generateICS: Formato de hora inválido:", startTime); alert("Formato de hora incorrecto para evento de calendario."); return; }
    const validStartTime = `${String(timeParts[1]).padStart(2, '0')}:${timeParts[2]}`;
    try {
        const startDate = new Date(`${dateISO}T${validStartTime}:00Z`); 
        if (isNaN(startDate.getTime())) { console.error("generateICS: Fecha de inicio inválida:", startDate); alert("Fecha/hora inválida para evento de calendario."); return; }
        const endDate = new Date(startDate.getTime() + durationSeconds * 1000);
        const formatDateForICS = d => d.toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";
        const start = formatDateForICS(startDate); const end = formatDateForICS(endDate);
        const icsContent = ["BEGIN:VCALENDAR", "VERSION:2.0", "PRODID:-//ElSotanoDelDoctor//Intranet//ES", "BEGIN:VEVENT", `UID:${new Date().getTime()}@elsotanodeldoctor.com`, `DTSTAMP:${formatDateForICS(new Date())}`, `DTSTART:${start}`, `DTEND:${end}`, `SUMMARY:${clean(title)}`, `DESCRIPTION:${clean(description)}`, `LOCATION:${clean(location)}`, "END:VEVENT", "END:VCALENDAR"].join("\r\n");
        const blob = new Blob([icsContent], { type: "text/calendar;charset=utf-8" }); const url = URL.createObjectURL(blob);
        const link = document.createElement("a"); link.href = url; link.download = `${clean(title).replace(/[^\w\s]/gi, '').replace(/\s+/g, "_")}.ics`;
        document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
    } catch (e) { console.error("Error en generateICS:", e); alert("Error generando archivo de calendario."); }
  }
  function generateConcertId(date, time, location) { const locNorm = (location || "sin_lugar").toLowerCase().replace(/\s+/g, '_').replace(/[^\w-]/g, ''); const timeNorm = (time || "sin_hora").replace(":", ""); return `${date}_${timeNorm}_${locNorm}`; }

  /* ---------- 1.5. Manejo de conexión (sin cambios) ---------- */
  const connectionStatus = document.getElementById("connection-status"); let isOnline = navigator.onLine;
  function updateConnectionStatus() { isOnline = navigator.onLine; if (!isOnline) { connectionStatus.className = "offline"; connectionStatus.textContent = "Sin conexión. Mostrando datos locales."; connectionStatus.style.display = "block"; } else { connectionStatus.style.display = "none"; connectionStatus.textContent = ""; } }
  window.addEventListener("online", updateConnectionStatus); window.addEventListener("offline", updateConnectionStatus);
  async function withRetry(fn, operationName = 'operación anónima', maxRetries = 3, delay = 2000) { for (let i = 0; i < maxRetries; i++) { try { if (!isOnline && i > 0) { connectionStatus.className = "offline"; connectionStatus.textContent = `Sin conexión. Reintentando ${operationName}...`; connectionStatus.style.display = "block"; } return await fn(); } catch (e) { console.warn(`Intento ${i+1} fallido para ${operationName}:`, e); if (i === maxRetries - 1) { connectionStatus.className = "offline"; connectionStatus.textContent = `Error final en ${operationName} tras ${maxRetries} intentos.`; connectionStatus.style.display = "block"; throw e; } connectionStatus.className = "retrying"; connectionStatus.textContent = `Reintentando ${operationName} (${i + 1}/${maxRetries})...`; connectionStatus.style.display = "block"; await new Promise(resolve => setTimeout(resolve, delay)); } } }

  /* ---------- 2. Acceso Firestore (sin cambios) ---------- */
  async function loadDoc(docId, fallback = {}) { if (!db) { console.error("DB no inicializado. No se puede cargar:", docId); return fallback; } console.log(`Intentando cargar doc: ${docId}`); try { const snap = await db.collection("intranet").doc(docId).get(); if (snap.exists) { console.log(`Doc ${docId} cargado OK.`, snap.data()); return snap.data(); } else { console.warn(`Doc ${docId} NO ENCONTRADO. Usando fallback.`); return fallback; } } catch (e) { console.error(`Error FATAL al cargar doc ${docId}:`, e.message, e); throw e; } }
  async function saveDoc(docId, data) { if (!db) { console.error("DB no inicializado. No se puede guardar:", docId); return false; } console.log(`Intentando guardar doc: ${docId}`); try { await db.collection("intranet").doc(docId).set(data); console.log(`Doc ${docId} guardado OK.`); return true; } catch (e) { console.error(`Error FATAL al guardar doc ${docId}:`, e.message, e); throw e; } }

  /* ---------- SECCIONES (Setlists, Usuarios, Ensayos, etc. con logs en carga - igual a v6) ---------- */
  let setlistConfig = { setlist1: { name: "Setlist Ensayos", url: "" }, setlist2: { name: "Setlist Concierto", url: "" }};
  async function loadSetlistConfig() { console.log("loadSetlistConfig: Iniciando..."); const data = await withRetry(() => loadDoc("setlists", {config: setlistConfig}), "configuración de setlists"); setlistConfig = data.config || setlistConfig; updateTitles(); console.log("loadSetlistConfig: Finalizado. Config:", setlistConfig); }
  function updateTitles() { document.getElementById("setlist1-title").textContent = setlistConfig.setlist1.name; document.getElementById("setlist2-title-placeholder").textContent = setlistConfig.setlist2.name; }
  async function saveSetlistConfig() { updateTitles(); return await withRetry(() => saveDoc("setlists", { config: setlistConfig }), "guardar config setlists");}
  async function cargarPrimerSetlist() { console.log("cargarPrimerSetlist desde:", setlistConfig.setlist1.url); if(!setlistConfig.setlist1.url) { console.warn("URL para primer setlist no definida."); document.getElementById("setlist-body").innerHTML = '<tr><td colspan="5">URL no configurada.</td></tr>'; return [];} try { const response = await fetch(setlistConfig.setlist1.url); if(!response.ok) throw new Error(`HTTP error! status: ${response.status}`); const songs = (await response.json()).filter(i => i.type === "song"); const tbody = document.getElementById("setlist-body"); tbody.innerHTML = ""; let total = 0; songs.forEach((s, i) => { const secs = parseDuration(s.duration); total += secs; tbody.insertAdjacentHTML("beforeend", `<tr><td>${i + 1}</td><td>${s.name || ""}</td><td>${s.key || ""}</td><td>${s.tempo || ""}</td><td>${toMMSS(secs)}</td></tr>`); }); document.getElementById("total-time").textContent = "Tiempo total: " + toHHMM(total); console.log("Primer setlist cargado, canciones:", songs.length); return songs; } catch (e) { console.error("Error cargando primer setlist:", e); document.getElementById("setlist-body").innerHTML = '<tr><td colspan="5">Error al cargar. Revisa la URL y la conexión.</td></tr>'; return []; } }
  async function cargarSegundoSetlist() { console.log("cargarSegundoSetlist desde:", setlistConfig.setlist2.url); if(!setlistConfig.setlist2.url) { console.warn("URL para segundo setlist no definida."); document.getElementById("second-body").innerHTML = '<tr><td colspan="5">URL no configurada.</td></tr>'; return [];} try { const response = await fetch(setlistConfig.setlist2.url); if(!response.ok) throw new Error(`HTTP error! status: ${response.status}`); const data = await response.json(); const songs = Array.isArray(data) ? data.filter(i => i.type === "song") : []; const tbody = document.getElementById("second-body"); tbody.innerHTML = ""; let total = 0; songs.forEach((s, i) => { const secs = parseDuration(s.duration || "0"); total += secs; tbody.insertAdjacentHTML("beforeend", `<tr><td>${i + 1}</td><td>${clean(s.name || "Sin título")}</td><td>${clean(s.key || "-")}</td><td>${clean(s.tempo || "-")}</td><td>${toMMSS(secs)}</td></tr>`); }); document.getElementById("total-time-2").textContent = "Tiempo total: " + toHHMM(total); console.log("Segundo setlist cargado, canciones:", songs.length); return songs; } catch (e) { console.error("Error cargando segundo setlist:", e); document.getElementById("second-body").innerHTML = '<tr><td colspan="5">Error al cargar. Revisa la URL y la conexión.</td></tr>'; document.getElementById("total-time-2").textContent = ""; return []; } }
  
  let users = []; let editingUserIndex = null;
  function renderUsers() { /* ... (Pega aquí tu función renderUsers completa de versiones anteriores) ... */ }
  async function loadUsers() { console.log("loadUsers: Iniciando..."); const data = await withRetry(() => loadDoc("users", {users:[]}), "carga de usuarios"); users = data.users || []; renderUsers(); console.log("loadUsers: Finalizado. Usuarios:", users.length); }
  async function saveUsers() { console.log("Guardando usuarios..."); return await withRetry(() => saveDoc("users", {users}), "guardar usuarios");}
  function resetUserForm() { /* ... (Pega aquí tu función resetUserForm) ... */ }

  let rehearsals = []; let editingRehearsalIndex = null;
  function renderRehearsals() {
    console.log("renderRehearsals: Iniciando con", rehearsals.length, "ensayos.");
    rehearsals.sort((a, b) => new Date(a.date + "T" + a.startTime) - new Date(b.date + "T" + b.startTime)); // Ordenar por fecha y hora
    const tbodyConfig = document.getElementById("rehearsal-table-body");
    const tbodyMain = document.getElementById("rehearsal-main-body");
    tbodyConfig.innerHTML = ""; tbodyMain.innerHTML = "";

    if (rehearsals.length === 0) {
        const emptyMsg = '<tr><td colspan="6" style="text-align:center;">No hay ensayos programados.</td></tr>';
        tbodyConfig.innerHTML = emptyMsg;
        tbodyMain.innerHTML = emptyMsg.replace('colspan="6"', 'colspan="4"'); // Ajustar colspan para la tabla principal
        return;
    }

    const userOptions = users.length > 0 ? users.map(user => `<option value="${user.name}">${user.name} (${user.nickname || ''})</option>`).join("") : `<option value="" disabled>No hay usuarios</option>`;
    const now = new Date();
    const todayDateStr = now.toISOString().split('T')[0];

    rehearsals.forEach((r, i) => {
      const formattedDate = formatDateWithDay(r.date);
      const durationSeconds = calculateDuration(r.startTime, r.endTime);
      const durationText = toHHMM(durationSeconds);
      const attendance = Array.isArray(r.attendance) ? r.attendance : [];
      const attendingYes = attendance.filter(a => a.attending === "Sí").map(a => users.find(u => u.name === a.name)?.nickname || a.name).join(", ") || "Ninguno";
      const attendingNo = attendance.filter(a => a.attending === "No").map(a => users.find(u => u.name === a.name)?.nickname || a.name).join(", ") || "Ninguno";
      const summary = `<div class="attendance-summary"><span class="attending-yes">Asisten: ${attendingYes}</span><span class="attending-no">No asisten: ${attendingNo}</span></div>`;

      tbodyConfig.insertAdjacentHTML("beforeend",
        `<tr>
          <td>${r.date}</td><td>${r.startTime || "N/A"}</td><td>${r.endTime || "N/A"}</td><td>${r.location || "N/A"}</td>
          <td>${summary}</td>
          <td>
            <button class="action-btn edit-btn edit-rehearsal" data-i="${i}">Editar</button>
            <button class="action-btn clear-attendance-btn clear-attendance" data-i="${i}">Limpiar Asist.</button>
            <button class="action-btn delete-btn delete-rehearsal" data-i="${i}">Eliminar</button>
          </td>
        </tr>`);

      const rehearsalDateTime = new Date(r.date + "T" + (r.endTime || "00:00")); // Usar endTime para la comparación
      if (rehearsalDateTime >= now || r.date === todayDateStr) { // Mostrar ensayos de hoy o futuros
        tbodyMain.insertAdjacentHTML("beforeend",
          `<tr>
            <td>${formattedDate} <span class="rehearsal-duration">(${durationText})</span></td>
            <td>${r.startTime || "N/A"} - ${r.endTime || "N/A"}</td>
            <td>${r.location || "N/A"}
              <button class="calendar-btn" title="Añadir a mi calendario" onclick='generateICS("Ensayo: ${clean(r.location)}", "${r.date}", "${r.startTime}", "${clean(r.location)}", "Ensayo de El Sótano del Doctor", ${durationSeconds})'>
                <svg viewBox="0 0 24 24"><path d="M12 4V2m0 20v-2m8-8h2m-20 0h-2m15.071-3.071l-1.414-1.414M5.343 17.657l-1.414-1.414m0-10.486l1.414-1.414m12.728 12.728l-1.414 1.414"/><rect x="4" y="6" width="16" height="12" rx="2"/></svg>
              </button>
            </td>
            <td>
              <div class="attendance-form">
                <select class="attendance-user" data-i="${i}"><option value="" disabled selected>¿Nombre?</option>${userOptions}</select>
                <select class="attendance-response" data-i="${i}"><option value="" disabled selected>¿Asistirás?</option><option value="Sí">Sí</option><option value="No">No</option></select>
                <button class="confirm-attendance" data-i="${i}">Confirmar</button>
              </div>
              ${summary}
            </td>
          </tr>`);
      }
    });
    // Re-añadir listeners a los botones de las tablas de ensayos
    addRehearsalTableListeners();
  }
  function addRehearsalTableListeners() { /* ... (Pega aquí tu función addRehearsalTableListeners completa) ... */ }
  async function loadRehearsals() { console.log("loadRehearsals: Iniciando..."); const data = await withRetry(() => loadDoc("rehearsals", {rehearsals:[]}), "carga de ensayos"); rehearsals = data.rehearsals || []; renderRehearsals(); console.log("loadRehearsals: Finalizado. Ensayos:", rehearsals.length); }
  async function saveRehearsals() { console.log("Guardando rehearsals..."); return await withRetry(() => saveDoc("rehearsals", {rehearsals}), "guardar ensayos");}
  function resetRehearsalForm() { /* ... (Pega aquí tu función resetRehearsalForm) ... */ }
  
  function updateMonthFilter() { /* ... */ } function renderStats() { /* ... */ }
  async function genPDF(songs, title, fileName) { /* ... */ }

  /* ---------- 10. Modificar tabla de BandHelper (igual a v6, con logs) ---------- */
  // ... Pega aquí la función modifyBandHelperTable de la v6 ...
  let parsedBandHelperConcerts = [];
  let bandHelperTableModified = false;
  let bandHelperWidgetLoaded = false; 
  function modifyBandHelperTable() {
    console.log("modifyBandHelperTable: Iniciando...");
    const bandHelperContentDiv = document.getElementById("bandhelper-concerts");
    if (!bandHelperContentDiv) { console.error("Div #bandhelper-concerts no encontrado."); return false; }
    const table = bandHelperContentDiv.querySelector("table");
    if (!table) { console.warn("modifyBandHelperTable: Tabla de BandHelper NO encontrada."); bandHelperWidgetLoaded = true; return false; }
    console.log("modifyBandHelperTable: Tabla encontrada:", table);

    if (table.dataset.processedByIntranet === "true" && bandHelperTableModified) { console.log("modifyBandHelperTable: Tabla ya procesada. Saltando."); return true; }
    parsedBandHelperConcerts = [];

    let head = table.querySelector("thead");
    if (!head) {
        console.warn("modifyBandHelperTable: No se encontró <thead>. Creando uno.");
        head = document.createElement("thead");
        table.insertBefore(head, table.firstChild); 
    }
    let headerRow = head.querySelector("tr");
    if (!headerRow) {
        console.warn("modifyBandHelperTable: No se encontró <tr> en <thead>. Creando uno.");
        headerRow = document.createElement("tr");
        head.appendChild(headerRow);
    }

    if (!headerRow.querySelector("th.th-details")) {
        const firstBodyRow = table.querySelector("tbody tr");
        let existingHeadersCount = headerRow.querySelectorAll("th").length;
        if (existingHeadersCount === 0 && firstBodyRow) { 
            existingHeadersCount = firstBodyRow.querySelectorAll("td").length;
        }
        if (headerRow.children.length === 0 && existingHeadersCount >=3) { 
             headerRow.innerHTML = '<th>Fecha</th><th>Hora</th><th>Lugar</th>'; 
        }
        headerRow.insertAdjacentHTML("beforeend", '<th class="th-details" style="text-align:center;">Detalles</th>');
        console.log("modifyBandHelperTable: Cabecera 'Detalles' AÑADIDA.");
    } else {
        console.log("modifyBandHelperTable: Cabecera 'Detalles' ya existe.");
    }

    const rows = table.querySelectorAll("tbody tr");
    console.log("modifyBandHelperTable: Filas encontradas en tbody:", rows.length);
    if (rows.length === 0) { console.log("modifyBandHelperTable: No hay conciertos listados."); }
    else {
        rows.forEach((row, rowIndex) => {
          const cells = row.querySelectorAll("td");
          if (cells.length < 3) { console.warn(`Fila #${rowIndex} con celdas insuficientes: ${cells.length}`); return; }

          const dateCellText = cells[0].textContent.trim();
          const timeCellText = cells[1].textContent.trim();
          const locationCell = cells[2];
          const locationText = locationCell.textContent.trim() || "Lugar no especificado";

          const dateParts = dateCellText.match(/(\d{1,2})\/(\d{1,2})\/(\d{2,4})/);
          if (!dateParts) { console.warn(`Fila #${rowIndex}: Formato de fecha no reconocido: '${dateCellText}'`); return; }
          let day = parseInt(dateParts[1]), month = parseInt(dateParts[2]) - 1, year = parseInt(dateParts[3]);
          if (year < 100) year += 2000;
          const concertDateObj = new Date(Date.UTC(year, month, day)); 
          const dateISO = concertDateObj.toISOString().split('T')[0];
          
          let time24h = "20:00"; 
          const timeMatch = timeCellText.match(/(\d{1,2}:\d{2})/); 
          if (timeMatch) {
              time24h = timeMatch[1];
          } else {
              console.warn(`Fila #${rowIndex}: Formato de hora no reconocido en '${timeCellText}', usando default ${time24h}`);
          }

          const concertId = generateConcertId(dateISO, time24h, locationText);
          parsedBandHelperConcerts.push({ id: concertId, date: dateISO, time: time24h, location: locationText, displayDate: dateCellText });

          if (!locationCell.querySelector("button.calendar-btn")) {
            const calendarButtonHTML = `<button class="calendar-btn" title="Añadir a mi calendario" onclick='generateICS("Concierto: ${clean(locationText)}", "${dateISO}", "${time24h}", "${clean(locationText)}")'><svg viewBox="0 0 24 24"><path d="M12 4V2m0 20v-2m8-8h2m-20 0h-2m15.071-3.071l-1.414-1.414M5.343 17.657l-1.414-1.414m0-10.486l1.414-1.414m12.728 12.728l-1.414 1.414"/><rect x="4" y="6" width="16" height="12" rx="2"/></svg></button>`;
            if (!locationCell.innerHTML.includes('calendar-btn')) { locationCell.innerHTML += calendarButtonHTML; }
          }

          let detailsCell = row.querySelector("td.td-details");
          if (!detailsCell) {
            detailsCell = document.createElement("td");
            detailsCell.classList.add("td-details");
            detailsCell.style.textAlign = "center";
            if (row.children.length > cells.length) row.appendChild(detailsCell); 
            else row.appendChild(detailsCell);
          }
          if (!detailsCell.querySelector("button.details-btn")) {
              // CORRECCIÓN AQUÍ: Llamar a openConcertNoteModal en lugar de openConcertDetailViewer
              detailsCell.innerHTML = `<button class="details-btn" title="Ver/Editar Detalles" onclick="openConcertNoteModal('${concertId}')"><svg viewBox="0 0 24 24"><path d="M8.59,16.59L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.59Z" /></svg></button>`;
          }
        });
    }
    console.log("modifyBandHelperTable: Conciertos parseados:", parsedBandHelperConcerts.length);
    bandHelperTableModified = true; table.dataset.processedByIntranet = "true"; bandHelperWidgetLoaded = true;
    console.log("modifyBandHelperTable: Finalizada.");
    return true;
  }

  /* ---------- 10.5. Notas de Concierto y Modal (igual a v7) ---------- */
  // ... Pega aquí loadConcertNotes, saveConcertNotes, openConcertNoteModal y los listeners del modal de la v7 ...
  let concertNotes = {}; 
  let currentEditingConcertId = null;
  async function loadConcertNotes() {
    console.log("loadConcertNotes: Iniciando...");
    const data = await withRetry(() => loadDoc("concert_notes_store", { notes: {} }), "carga de notas de concierto");
    concertNotes = data.notes || {}; 
    console.log("loadConcertNotes: Finalizado. Notas:", concertNotes);
  }
  async function saveConcertNotes() {
    console.log("Guardando notas de conciertos...", concertNotes);
    try {
      await withRetry(() => saveDoc("concert_notes_store", { notes: concertNotes }), "guardar notas de concierto");
      return true;
    } catch (e) {
      console.error("Error al guardar notas:", e);
      const msgEl = document.getElementById("concert-note-edit-message");
      if(msgEl){ msgEl.className = "message error-message"; msgEl.textContent = "Error al guardar: " + e.message;}
      throw e;
    }
  }
  function openConcertNoteModal(concertId) {
    console.log("openConcertNoteModal para concertId:", concertId);
    currentEditingConcertId = concertId;
    const concertDataFromWidget = parsedBandHelperConcerts.find(c => c.id === concertId);
    const existingNoteData = concertNotes[concertId] || {}; 

    const modal = document.getElementById("concert-note-edit-modal");
    const infoEl = document.getElementById("concert-note-info");
    const locationDetailsTextarea = document.getElementById("concert-note-location-details");
    const soundcheckTimeInput = document.getElementById("concert-note-soundcheck-time");
    const showTimeInput = document.getElementById("concert-note-show-time");
    const generalNoteTextarea = document.getElementById("concert-note-general");
    const messageEl = document.getElementById("concert-note-edit-message");

    if (!modal || !infoEl || !locationDetailsTextarea || !soundcheckTimeInput || !showTimeInput || !generalNoteTextarea || !messageEl) {
        console.error("Elementos del modal de notas no encontrados.");
        return;
    }
    messageEl.textContent = "";

    if (concertDataFromWidget) {
        infoEl.textContent = `Concierto: ${concertDataFromWidget.displayDate} en ${concertDataFromWidget.location} (Hora original: ${concertDataFromWidget.time})`;
        locationDetailsTextarea.value = existingNoteData.locationUserNotes || "";
        soundcheckTimeInput.value = existingNoteData.soundcheckTime || "";
        showTimeInput.value = existingNoteData.showTimeUser || concertDataFromWidget.time || ""; 
        generalNoteTextarea.value = existingNoteData.generalNote || "";
    } else {
        console.warn("No se encontró información del concierto (widget) para el ID:", concertId);
        infoEl.textContent = "Información del concierto (widget) no disponible.";
        locationDetailsTextarea.value = existingNoteData.locationUserNotes || "";
        soundcheckTimeInput.value = existingNoteData.soundcheckTime || "";
        showTimeInput.value = existingNoteData.showTimeUser || "";
        generalNoteTextarea.value = existingNoteData.generalNote || "";
    }
    modal.style.display = "block";
    overlay.classList.add("show");
  }
  document.getElementById("close-concert-note-edit-modal").onclick = () => {
    document.getElementById("concert-note-edit-modal").style.display = "none";
    overlay.classList.remove("show");
    currentEditingConcertId = null;
  };
  document.getElementById("save-concert-note-modal-btn").onclick = async () => {
    if (!currentEditingConcertId) { console.error("No hay concertId para guardar la nota."); return; }
    const locationDetails = document.getElementById("concert-note-location-details").value.trim();
    const soundcheckTime = document.getElementById("concert-note-soundcheck-time").value;
    const showTimeUser = document.getElementById("concert-note-show-time").value;
    const generalNote = document.getElementById("concert-note-general").value.trim();
    const messageEl = document.getElementById("concert-note-edit-message");
    concertNotes[currentEditingConcertId] = {
        locationUserNotes: locationDetails,
        soundcheckTime: soundcheckTime,
        showTimeUser: showTimeUser,
        generalNote: generalNote
    };
    messageEl.className = "message retrying"; messageEl.textContent = "Guardando detalles...";
    try {
        await saveConcertNotes();
        messageEl.className = "message success-message"; messageEl.textContent = "¡Detalles guardados!";
        setTimeout(() => { messageEl.textContent = ""; }, 2500);
    } catch (e) { console.error("Fallo al guardar detalles desde modal:", e); }
  };

  /* ---------- 11. Menú & pantallas (sin cambios en la lógica interna - igual a v6) ---------- */
  // ... Pega aquí el código de menú y pantallas de la v6 (asegúrate que menu-concert-notes-config NO esté) ...
  const sidebar = document.getElementById("sidebar-menu"), overlay = document.getElementById("overlay");
  const PASSWORD = "Sotano2014"; let isAuthenticated = false;
  function closeAllScreens() { document.querySelectorAll(".config-screen, .modal-screen").forEach(s => s.style.display = "none"); } 
  function closeSidebarAndOverlay() { sidebar.classList.remove("show"); overlay.classList.remove("show"); document.getElementById("config-submenu").style.display = "none"; }
  function closeAll() { closeAllScreens(); closeSidebarAndOverlay(); resetUserForm(); resetRehearsalForm(); }
  document.getElementById("hamburger-btn").onclick = () => { sidebar.classList.add("show"); overlay.classList.add("show"); };
  document.getElementById("menu-cerrar").onclick = e => { e.preventDefault(); closeAll(); };
  overlay.onclick = () => { closeAllScreens(); closeSidebarAndOverlay(); };
  ['menu-rehearsals-section', 'menu-second-setlist-section', 'menu-concerts-section'].forEach(id => { document.getElementById(id).onclick = e => { e.preventDefault(); closeAll(); const targetId = e.target.getAttribute('href').substring(1); document.getElementById(targetId)?.scrollIntoView({ behavior: "smooth" }); }; });
  document.getElementById("menu-config").onclick = e => { e.preventDefault(); if (!isAuthenticated) { const pass = prompt("Contraseña para Configuración:"); if (pass === PASSWORD) { isAuthenticated = true; } else { alert("Contraseña incorrecta."); return; } } document.getElementById("config-submenu").style.display = document.getElementById("config-submenu").style.display === "block" ? "none" : "block"; };
  function openConfigScreen(screenId, loadDataFn) { if (!isAuthenticated) { alert("Acceso denegado."); return; } closeAllScreens(); document.getElementById(screenId).style.display = "block"; overlay.classList.add("show"); if (loadDataFn) loadDataFn(); }
  document.getElementById("menu-setlist-config").onclick = e => { e.preventDefault(); openConfigScreen("setlist-config-screen", () => { document.getElementById("setlist1-name").value = setlistConfig.setlist1.name; document.getElementById("setlist1-url").value = setlistConfig.setlist1.url; document.getElementById("setlist2-name").value = setlistConfig.setlist2.name; document.getElementById("setlist2-url").value = setlistConfig.setlist2.url.replace("https://www.bandhelper.com/feed/set_list/", ""); });};
  document.getElementById("close-setlist-config").onclick = () => { document.getElementById("setlist-config-screen").style.display = "none"; overlay.classList.remove("show"); document.getElementById("setlist-message").textContent = ""; };
  document.getElementById("menu-user-mgmt").onclick = e => { e.preventDefault(); openConfigScreen("user-mgmt-screen"); };
  document.getElementById("menu-rehearsal").onclick = e => { e.preventDefault(); openConfigScreen("rehearsal-screen"); };
  document.getElementById("menu-stats").onclick = e => { e.preventDefault(); openConfigScreen("stats-screen", () => { updateMonthFilter(); renderStats(); }); };
  document.getElementById("close-user-mgmt").onclick = () => { document.getElementById("user-mgmt-screen").style.display = "none"; overlay.classList.remove("show"); resetUserForm(); document.getElementById("user-message").textContent = "";};
  document.getElementById("close-rehearsal").onclick = () => { document.getElementById("rehearsal-screen").style.display = "none"; overlay.classList.remove("show"); resetRehearsalForm(); document.getElementById("rehearsal-message").textContent = "";};
  document.getElementById("close-stats").onclick = () => { document.getElementById("stats-screen").style.display = "none"; overlay.classList.remove("show"); };

  /* ---------- 12. Carga inicial de datos y DOMContentLoaded ---------- */
  // ... (igual a v6) ...
  async function loadInitialData() {
    console.log("loadInitialData: Iniciando...");
    if (!db) { console.warn("loadInitialData: DB no inicializado. Abortando carga de datos de Firestore."); return; }
    const statusDiv = document.getElementById("connection-status");
    try {
      if(statusDiv) { statusDiv.textContent = "Cargando datos..."; statusDiv.className = "retrying"; statusDiv.style.display = "block"; }
      await Promise.all([ loadSetlistConfig(), loadUsers(), loadRehearsals(), loadConcertNotes() ]);
      console.log("loadInitialData: Cargas de Firestore completadas (o intentadas).");
      let songs1 = [], songs2 = [];
      try { songs1 = await cargarPrimerSetlist(); } catch (e) { console.error("Fallo al cargar primer setlist desde URL:", e); }
      try { songs2 = await cargarSegundoSetlist(); } catch (e) { console.error("Fallo al cargar segundo setlist desde URL:", e); }
      document.getElementById("download-btn").onclick = () => { if (songs1.length > 0) genPDF(songs1, setlistConfig.setlist1.name, "setlist_ensayos.pdf"); else alert("No hay canciones en el setlist de ensayos."); };
      document.getElementById("download-btn-2").onclick = () => { if (songs2.length > 0) genPDF(songs2, setlistConfig.setlist2.name, "setlist_concierto.pdf"); else alert("No hay canciones en el setlist de concierto."); };
      if(statusDiv) statusDiv.style.display = "none";
    } catch (e) {
      console.error("loadInitialData: Error crítico durante la carga de datos:", e);
      if(statusDiv) { statusDiv.textContent = "Error al cargar datos. Recarga la página."; statusDiv.className = "offline"; statusDiv.style.display = "block"; }
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    console.log("DOMContentLoaded: Evento disparado.");
    updateConnectionStatus();
    if (persistencePromise) {
        persistencePromise.finally(() => {
            console.log("DOMContentLoaded: Promesa de persistencia finalizada. Procediendo a cargar datos iniciales.");
            loadInitialData();
        });
    } else if (db) {
        console.warn("DOMContentLoaded: persistencePromise no definida, pero db existe. Cargando datos iniciales.");
        loadInitialData();
    } else {
        console.error("DOMContentLoaded: Firebase (db) no está disponible. No se cargarán datos iniciales.");
    }

    const bandHelperContainer = document.getElementById("bandhelper-concerts");
    if (bandHelperContainer) {
        console.log("DOMContentLoaded: Configurando MutationObserver para BandHelper.");
        const observer = new MutationObserver(() => {
            const table = bandHelperContainer.querySelector("table");
            if (table && (!bandHelperTableModified || table.dataset.processedByIntranet !== "true")) {
                console.log("MutationObserver: Tabla BandHelper detectada/cambiada. Intentando modificar...");
                if(modifyBandHelperTable()) { console.log("MutationObserver: Tabla BandHelper modificada."); }
            }
        });
        observer.observe(bandHelperContainer, { childList: true, subtree: true });
    } else { console.error("DOMContentLoaded: Contenedor #bandhelper-concerts NO ENCONTRADO."); }

    setTimeout(() => { if (!bandHelperTableModified) { console.warn("DOMContentLoaded (Fallback 3s): BandHelper no modificado. Intentando..."); modifyBandHelperTable(); }}, 3000);
    setTimeout(() => { if (!bandHelperTableModified) { console.warn("DOMContentLoaded (Fallback 7s): BandHelper AÚN no modificado. ÚLTIMO intento."); modifyBandHelperTable(); }}, 7000);
    console.log("DOMContentLoaded: Configuración finalizada.");
  });
  //]]>
  </script>
</body>
</html>
