<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>El Sótano del Doctor – Uso Interno</title>

  <!-- METADATOS PARA PREVIA EN REDES -->
  <meta property="og:title" content="El Sótano del Doctor – Uso Interno" />
  <meta property="og:description" content="Banda de rock y versiones. Explora nuestro setlist, fechas de conciertos y mucho más. ¡Disfruta de la música!" />
  <meta property="og:image" content="assets/logo_negro copia.jpg" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://tusitioweb.com" />

  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:title" content="El Sótano del Doctor – Uso Interno"/>
  <meta name="twitter:description" content="Banda de rock y versiones. Explora nuestro setlist, fechas de conciertos y mucho más. ¡Disfruta de la música!"/>
  <meta name="twitter:image" content="assets/logo_negro copia.jpg"/>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Librerías jsPDF y autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>

  <style>
    /* Reseteo y box-sizing */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #000;
      color: #fff;
    }

    /* CABECERA */
    header {
      background-color: #111;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo img {
      width: 180px;
      height: auto;
    }

    /* BOTÓN HAMBURGER */
    .hamburger {
      cursor: pointer;
      border: 1px solid #0cf;
      border-radius: 4px;
      padding: 5px;
    }
    .hamburger div {
      width: 25px;
      height: 3px;
      background-color: #0cf;
      margin: 4px 0;
    }

    /* MENÚ LATERAL (SIDEBAR) */
    .sidebar {
      position: fixed;
      top: 0; 
      left: 0;
      width: 250px;
      height: 100%;
      background-color: #111;
      border-right: 1px solid #222;
      padding: 20px;
      box-shadow: 2px 0 10px rgba(0, 255, 255, 0.1);
      transform: translateX(-250px);
      transition: transform 0.3s ease;
      z-index: 9999;
    }
    .sidebar.show {
      transform: translateX(0);
    }
    .sidebar h2 {
      color: #0cf;
      margin-top: 0;
    }
    .sidebar a {
      display: block;
      color: #fff;
      text-decoration: none;
      margin: 10px 0;
      padding: 5px 0;
      border-bottom: 1px solid #222;
    }
    .sidebar a:hover {
      color: #0cf;
    }

    /* OVERLAY (FONDO OSCURO) */
    #overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9998;
      display: none;
    }
    #overlay.show {
      display: block;
    }

    /* PANTALLA DE CONTRASEÑA */
    #password-screen {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      z-index: 10000;
      padding: 20px;
      align-items: center;
      justify-content: center;
    }
    #password-screen.show {
      display: flex;
    }
    #password-screen .password-container {
      background-color: #111;
      padding: 20px;
      border-radius: 10px;
      max-width: 400px;
      width: 100%;
      text-align: center;
    }
    #password-screen h2 {
      color: #0cf;
      margin-bottom: 20px;
    }
    #password-screen input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      background-color: #222;
      color: #fff;
      border: 1px solid #333;
      border-radius: 5px;
    }
    #password-screen button {
      padding: 10px 20px;
      background-color: #0cf;
      color: #000;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #password-screen button:hover {
      background-color: #09b;
    }

    /* PANTALLA DE CONFIGURACIÓN */
    .config-screen {
      display: none; 
      position: fixed; 
      top: 0; left: 0;
      width: 100%; 
      height: 100%;
      background-color: #000; 
      z-index: 9999; 
      overflow-y: auto; 
      padding: 60px 20px 20px 20px;
    }
    .config-screen h2 {
      text-align: center; 
      margin-bottom: 20px;
      color: #0cf;
    }
    .config-screen label {
      display: block;
      margin: 10px 0 5px 0;
    }
    .config-screen input, .config-screen select {
      width: 100%; 
      max-width: 400px; 
      padding: 10px;
      background-color: #222;
      color: #fff;
      border: 1px solid #333;
      border-radius: 5px;
    }
    .config-screen button {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #0cf;
      color: #000;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .config-screen button:hover {
      background-color: #09b;
    }
    .config-screen .close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 1.2em;
      background: none;
      border: 1px solid #0cf;
      color: #0cf;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
    }
    .config-screen .close-btn:hover {
      background-color: #333;
    }

    /* CONTENIDO PRINCIPAL */
    main {
      display: block;
    }
    main section {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* SETLISTS */
    #setlists, #second-setlist {
      background-color: #111;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.1);
      margin-bottom: 40px;
    }
    #setlists h2, #second-setlist h2 {
      text-align: center;
      color: #0cf;
      margin-bottom: 15px;
    }
    #setlists table, #second-list-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      color: #fff;
      font-size: 0.95em;
    }
    #setlists thead, #second-list-table thead {
      background-color: #222;
      color: #0cf;
    }
    #setlists th, #setlists td, #second-list-table th, #second-list-table td {
      padding: 12px;
      border: 1px solid #333;
      text-align: left;
    }
    #setlists tr:nth-child(even), #second-list-table tr:nth-child(even) {
      background-color: #1a1a1a;
    }
    .download-btn {
      display: block;
      margin: 20px auto 0 auto;
      padding: 10px 20px;
      font-size: 1em;
      background-color: #0cf;
      color: #000;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .download-btn:hover {
      background-color: #09b;
    }
    #total-time, #total-time-2 {
      color: #0cf;
      margin-top: 10px;
      text-align: center;
    }

    /* USUARIOS */
    #usuarios {
      background-color: #111;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,255,255,0.1);
      margin-bottom: 40px;
    }
    #usuarios h2 {
      text-align: center;
      color: #0cf;
      margin-bottom: 10px;
    }
    #usuarios table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      color: #fff;
      font-size: 0.95em;
    }
    #usuarios thead {
      background-color: #222;
      color: #0cf;
    }
    #usuarios th, #usuarios td {
      padding: 12px;
      border: 1px solid #333;
      text-align: left;
    }
    #usuarios tr:nth-child(even) {
      background-color: #1a1a1a;
    }

    /* CALENDARIO */
    #calendario {
      background-color: #111;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,255,255,0.1);
      margin-bottom: 40px;
    }
    #calendario h2 {
      text-align: center;
      color: #0cf;
      margin-bottom: 10px;
    }
    #calendario p {
      text-align: center;
      color: #aaa;
      margin-bottom: 20px;
    }

    /* FOOTER */
    footer {
      background-color: #111;
      color: #888;
      text-align: center;
      padding: 10px;
      border-top: 1px solid #222;
    }

    /* MEDIA QUERIES */
    @media (max-width: 768px) {
      .hamburger div {
        width: 20px;
      }
    }
  </style>
</head>

<body>
  <!-- PANTALLA DE CONTRASEÑA -->
  <div id="password-screen">
    <div class="password-container">
      <h2>Introduce la Contraseña</h2>
      <input type="password" id="admin-password" placeholder="Contraseña" />
      <button id="submit-password">Acceder</button>
    </div>
  </div>

  <!-- CABECERA -->
  <header>
    <div class="logo">
      <img src="assets/logo_blanco.png" alt="Logo de El Sótano del Doctor" />
    </div>
    <div class="hamburger" id="hamburger-btn">
      <div></div>
      <div></div>
      <div></div>
    </div>
  </header>

  <!-- OVERLAY -->
  <div id="overlay"></div>

  <!-- MENÚ LATERAL -->
  <nav class="sidebar" id="sidebar-menu">
    <h2>Menú</h2>
    <a href="#" id="menu-setlist-config">Configurar Setlists</a>
    <a href="#" id="menu-user-mgmt">Gestión de Usuarios</a>
    <a href="#" id="menu-rehearsal">Asignar Ensayos</a>
    <a href="#" id="menu-cerrar">Cerrar Menú</a>
  </nav>

  <!-- PANTALLA CONFIGURACIÓN SETLISTS -->
  <div id="setlist-config-screen" class="config-screen">
    <button class="close-btn" id="close-setlist-config">Cerrar</button>
    <h2>Configuración de Setlists</h2>
    <h3>Primer Setlist</h3>
    <label for="setlist1-name">Nombre del Setlist</label>
    <input type="text" id="setlist1-name" placeholder="Ej: Ensayos 2025" />
    <label for="setlist1-url">ID/URL del feed</label>
    <input type="text" id="setlist1-url" placeholder="URL del feed" />
    <h3>Segundo Setlist</h3>
    <label for="setlist2-name">Nombre del Setlist</label>
    <input type="text" id="setlist2-name" placeholder="Ej: Concierto Navidad" />
    <label for="setlist2-url">ID/URL del feed</label>
    <input type="text" id="setlist2-url" placeholder="Ej: TXHvyb o URL completa" />
    <button id="guardar-setlist-config">Guardar Configuración</button>
  </div>

  <!-- PANTALLA GESTIÓN DE USUARIOS -->
  <div id="user-mgmt-screen" class="config-screen">
    <button class="close-btn" id="close-user-mgmt">Cerrar</button>
    <h2>Gestión de Usuarios</h2>
    <label for="user-name">Nombre</label>
    <input type="text" id="user-name" placeholder="Nombre del usuario" />
    <label for="user-role">Rol</label>
    <select id="user-role">
      <option value="admin">Administrador</option>
      <option value="member">Miembro</option>
    </select>
    <button id="add-user">Añadir Usuario</button>
    <table id="user-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Rol</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="user-table-body"></tbody>
    </table>
  </div>

  <!-- PANTALLA ASIGNACIÓN DE ENSAYOS -->
  <div id="rehearsal-screen" class="config-screen">
    <button class="close-btn" id="close-rehearsal">Cerrar</button>
    <h2>Asignación de Ensayos</h2>
    <label for="rehearsal-date">Fecha</label>
    <input type="date" id="rehearsal-date" />
    <label for="rehearsal-time">Hora</label>
    <input type="time" id="rehearsal-time" />
    <label for="rehearsal-location">Lugar</label>
    <input type="text" id="rehearsal-location" placeholder="Ej: Estudio 1" />
    <button id="add-rehearsal">Añadir Ensayo</button>
    <table id="rehearsal-table">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Hora</th>
          <th>Lugar</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="rehearsal-table-body"></tbody>
    </table>
  </div>

  <!-- CONTENIDO PRINCIPAL -->
  <main>
    <!-- 1) PRIMER SETLIST -->
    <section id="setlists">
      <h2 id="setlist1-title">Setlist Ensayos -Año 2025-</h2>
      <p style="text-align:center; color:#aaa;">
        Consulta y exporta el setlist de ensayos en tiempo real.
      </p>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Título</th>
            <th>Tonalidad</th>
            <th>Tempo</th>
            <th>Duración</th>
          </tr>
        </thead>
        <tbody id="setlist-body"></tbody>
      </table>
      <button class="download-btn" id="download-btn">Descargar PDF</button>
      <p id="total-time"></p>
    </section>

    <!-- 2) SEGUNDO SETLIST -->
    <section id="second-setlist">
      <h2 id="setlist2-title">Setlist Próximo Concierto</h2>
      <p style="text-align:center; color:#aaa;">
        Feed actual: <em id="url-actual"></em>
      </p>
      <table id="second-list-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Canción</th>
            <th>Tonalidad</th>
            <th>Tempo</th>
            <th>Duración</th>
          </tr>
        </thead>
        <tbody id="second-body"></tbody>
      </table>
      <button class="download-btn" id="download-btn-2">Descargar PDF</button>
      <p id="total-time-2"></p>
    </section>

    <!-- 3) USUARIOS -->
    <section id="usuarios">
      <h2>Usuarios Registrados</h2>
      <p style="text-align:center; color:#aaa;">
        Lista de usuarios con acceso a la intranet.
      </p>
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Rol</th>
          </tr>
        </thead>
        <tbody id="users-body"></tbody>
      </table>
    </section>

    <!-- 4) CALENDARIO -->
    <section id="calendario">
      <h2>Próximos Conciertos y Ensayos</h2>
      <p>Consulta el calendario actualizado.</p>
      <div>
        <script type="text/javascript" 
          src="https://www.bandhelper.com/widget/calendar/10353?range=6">
        </script>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer>
    © 2025 El Sótano del Doctor. All Rights Reserved.
  </footer>

  <script>
    // Configuración de Firebase con las credenciales proporcionadas
    const firebaseConfig = {
      apiKey: "AIZAsyA7d70p3aEA218PLWE5_DBMFEtoHXfyvNg",
      authDomain: "el-sotano-del-doctor.firebaseapp.com",
      projectId: "el-sotano-del-doctor",
      storageBucket: "el-sotano-del-doctor.firestorestorage.app",
      messagingSenderId: "288654488846",
      appId: "1:288654488846:web:51a7264676afe8ba8635f",
      measurementId: "G-5N8G5GCW1"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Contraseña estática para acceder a las opciones de edición
    const ADMIN_PASSWORD = "elsotano2025"; // Cambia esto por la contraseña que desees

    // Variable para controlar si el usuario ha ingresado la contraseña
    let isAdminAuthenticated = false;

    /*------------------------------------------
      1. FUNCIONES COMUNES
    ------------------------------------------*/
    function parseDurationToSeconds(durationStr) {
      if (!durationStr) return 0;
      if (durationStr.includes(':')) {
        const [min, sec] = durationStr.split(':').map(num => parseInt(num, 10));
        return (min * 60) + (sec || 0);
      } else {
        const seconds = parseInt(durationStr, 10);
        return isNaN(seconds) ? 0 : seconds;
      }
    }
    function formatSecondsToMMSS(totalSeconds) {
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      return `${minutes}:${String(seconds).padStart(2, '0')}`;
    }
    function cleanString(str) {
      if (!str) return '';
      return str.replace(/[^\x00-\xFF]/g, '').trim();
    }

    /*------------------------------------------
      2. CONTROL DE ACCESO CON CONTRASEÑA
    ------------------------------------------*/
    function showPasswordScreen(callback) {
      if (isAdminAuthenticated) {
        callback();
        return;
      }
      const passwordScreen = document.getElementById('password-screen');
      passwordScreen.classList.add('show');
      const submitBtn = document.getElementById('submit-password');
      const passwordInput = document.getElementById('admin-password');

      // Limpiar eventos anteriores para evitar duplicados
      submitBtn.onclick = null;
      passwordInput.onkeypress = null;

      const handleSubmit = () => {
        const password = passwordInput.value;
        if (password === ADMIN_PASSWORD) {
          isAdminAuthenticated = true;
          passwordScreen.classList.remove('show');
          passwordInput.value = '';
          callback();
        } else {
          alert('Contraseña incorrecta.');
          passwordInput.value = '';
        }
      };

      submitBtn.onclick = handleSubmit;
      passwordInput.onkeypress = (e) => {
        if (e.key === 'Enter') handleSubmit();
      };
    }

    /*------------------------------------------
      3. CONFIGURACIÓN DE SETLISTS
    ------------------------------------------*/
    let setlistConfig = {
      setlist1: { name: 'Setlist Ensayos -Año 2025-', url: 'https://cold-limit-811a.jagomezc.workers.dev' },
      setlist2: { name: 'Setlist Próximo Concierto', url: 'https://www.bandhelper.com/feed/set_list/TXHvyb' }
    };

    async function loadSetlistConfig() {
      try {
        const doc = await db.collection('config').doc('setlists').get();
        if (doc.exists) {
          setlistConfig = doc.data();
        }
        updateSetlistTitles();
        cargarPrimerSetlist();
        cargarSegundoSetlist();
      } catch (err) {
        console.error('Error al cargar configuración de setlists:', err);
      }
    }

    async function saveSetlistConfig() {
      try {
        await db.collection('config').doc('setlists').set(setlistConfig);
        updateSetlistTitles();
      } catch (err) {
        console.error('Error al guardar configuración de setlists:', err);
        alert('Error al guardar configuración de setlists.');
      }
    }

    function updateSetlistTitles() {
      document.getElementById('setlist1-title').textContent = setlistConfig.setlist1.name;
      document.getElementById('setlist2-title').textContent = setlistConfig.setlist2.name;
    }

    /*------------------------------------------
      4. PRIMER SETLIST
    ------------------------------------------*/
    async function cargarPrimerSetlist() {
      try {
        const res = await fetch(setlistConfig.setlist1.url);
        const data = await res.json();
        const tbody = document.getElementById('setlist-body');
        tbody.innerHTML = '';
        const songs = data.filter(item => item.type === 'song');
        let totalSeconds = 0;

        songs.forEach((song, i) => {
          const secs = parseDurationToSeconds(song.duration || '');
          const durFmt = formatSecondsToMMSS(secs);
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${i + 1}</td>
            <td>${song.name || ''}</td>
            <td>${song.key || ''}</td>
            <td>${song.tempo || ''}</td>
            <td>${durFmt}</td>
          `;
          tbody.appendChild(row);
          totalSeconds += secs;
        });

        document.getElementById('total-time').textContent =
          'Tiempo total del set: ' + formatSecondsToMMSS(totalSeconds);
        return songs;
      } catch (err) {
        console.error('Error al cargar el primer setlist:', err);
        document.getElementById('setlist-body').innerHTML =
          '<tr><td colspan="5">Error al cargar el primer setlist.</td></tr>';
        return [];
      }
    }

    async function descargarPDFprimerSetlist() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'A4' });
      const songs = await cargarPrimerSetlist();

      try {
        const imgUrl = 'assets/logo_negro copia.jpg';
        const imgRes = await fetch(imgUrl);
        const imgBlob = await imgRes.blob();
        const reader = new FileReader();
        const base64Promise = new Promise((resolve, reject) => {
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
        });
        reader.readAsDataURL(imgBlob);
        const base64Img = await base64Promise;
        doc.addImage(base64Img, 'JPEG', 40, 30, 60, 60);
      } catch (err) {
        console.warn('No se pudo cargar el logo (primer setlist):', err);
      }

      doc.setFontSize(16);
      doc.setTextColor(40);
      doc.text(`Setlist - ${setlistConfig.setlist1.name}`, 120, 50);

      let totalSecs = 0;
      songs.forEach(s => totalSecs += parseDurationToSeconds(s.duration || '0'));
      const totalTime = formatSecondsToMMSS(totalSecs);
      const totalSongs = songs.length;
      doc.setFontSize(12);
      doc.setTextColor(80);
      doc.text(`${totalSongs} canciones, ${totalTime} total`, 120, 70);

      const columns = [
        { header: '#', dataKey: 'num' },
        { header: 'Título', dataKey: 'title' },
        { header: 'Tonalidad', dataKey: 'key' },
        { header: 'Tempo', dataKey: 'tempo' },
        { header: 'Duración', dataKey: 'duration' }
      ];
      const rows = songs.map((song, i) => ({
        num: i + 1,
        title: song.name || '',
        key: song.key || '',
        tempo: song.tempo || '',
        duration: formatSecondsToMMSS(parseDurationToSeconds(song.duration || '0'))
      }));

      doc.autoTable({
        startY: 100,
        head: [columns.map(c => c.header)],
        body: rows.map(r => [r.num, r.title, r.key, r.tempo, r.duration]),
        headStyles: { fillColor: [60, 60, 60], textColor: [255, 255, 255], fontStyle: 'bold' },
        bodyStyles: { fillColor: [245, 245, 245], textColor: [0, 0, 0] },
        alternateRowStyles: { fillColor: [230, 230, 230] },
        styles: { halign: 'left', fontSize: 10, cellPadding: 5 },
        columnStyles: {
          0: { cellWidth: 30 },
          1: { cellWidth: 150 },
          2: { cellWidth: 80 },
          3: { cellWidth: 50 },
          4: { cellWidth: 60 }
        }
      });

      doc.save(`setlist_${setlistConfig.setlist1.name.replace(/\s+/g, '_')}.pdf`);
    }

    /*------------------------------------------
      5. SEGUNDO SETLIST
    ------------------------------------------*/
    async function cargarSegundoSetlist() {
      try {
        const res = await fetch(setlistConfig.setlist2.url);
        const data = await res.json();
        const songs = data.filter(item => item.type === 'song');
        const tbody = document.getElementById('second-body');
        tbody.innerHTML = '';
        let totalSeconds = 0;

        songs.forEach((song, index) => {
          const secs = parseDurationToSeconds(song.duration || '0');
          const nameClean = cleanString(song.name || '');
          const keyClean = cleanString(song.key || '');
          const tempoClean = cleanString(song.tempo || '');
          const durFmt = formatSecondsToMMSS(secs);
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${index + 1}</td>
            <td>${nameClean}</td>
            <td>${keyClean}</td>
            <td>${tempoClean}</td>
            <td>${durFmt}</td>
          `;
          tbody.appendChild(row);
          totalSeconds += secs;
        });

        document.getElementById('url-actual').textContent = setlistConfig.setlist2.url;
        document.getElementById('total-time-2').textContent =
          'Tiempo total del set: ' + formatSecondsToMMSS(totalSeconds);
        return songs;
      } catch (err) {
        console.error('Error al cargar el segundo setlist:', err);
        document.getElementById('second-body').innerHTML =
          '<tr><td colspan="5">Error al cargar el segundo setlist.</td></tr>';
        return [];
      }
    }

    async function descargarPDFsegundoSetlist() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'A4' });
      const songs = await cargarSegundoSetlist();

      try {
        const imgUrl = 'assets/logo_negro copia.jpg';
        const imgRes = await fetch(imgUrl);
        const imgBlob = await imgRes.blob();
        const reader = new FileReader();
        const base64Promise = new Promise((resolve, reject) => {
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
        });
        reader.readAsDataURL(imgBlob);
        const base64Img = await base64Promise;
        doc.addImage(base64Img, 'JPEG', 40, 30, 60, 60);
      } catch (err) {
        console.warn('No se pudo cargar el logo (segundo setlist):', err);
      }

      doc.setFontSize(16);
      doc.setTextColor(40);
      doc.text(`Setlist - ${setlistConfig.setlist2.name}`, 120, 50);

      let totalSecs = 0;
      songs.forEach(song => totalSecs += parseDurationToSeconds(song.duration || '0'));
      const totalTime = formatSecondsToMMSS(totalSecs);
      const totalSongs = songs.length;
      doc.setFontSize(12);
      doc.setTextColor(80);
      doc.text(`${totalSongs} canciones, ${totalTime} total`, 120, 70);

      const columns = [
        { header: '#', dataKey: 'num' },
        { header: 'Canción', dataKey: 'name' },
        { header: 'Tonalidad', dataKey: 'key' },
        { header: 'Tempo', dataKey: 'tempo' },
        { header: 'Duración', dataKey: 'duration' }
      ];
      const rows = songs.map((song, i) => ({
        num: i + 1,
        name: cleanString(song.name || ''),
        key: cleanString(song.key || ''),
        tempo: cleanString(song.tempo || ''),
        duration: formatSecondsToMMSS(parseDurationToSeconds(song.duration || '0'))
      }));

      doc.autoTable({
        startY: 100,
        head: [columns.map(c => c.header)],
        body: rows.map(r => [r.num, r.name, r.key, r.tempo, r.duration]),
        headStyles: { fillColor: [60, 60, 60], textColor: [255, 255, 255], fontStyle: 'bold' },
        bodyStyles: { fillColor: [245, 245, 245], textColor: [0, 0, 0] },
        alternateRowStyles: { fillColor: [230, 230, 230] },
        styles: { halign: 'left', fontSize: 10, cellPadding: 5 },
        columnStyles: {
          0: { cellWidth: 30 },
          1: { cellWidth: 150 },
          2: { cellWidth: 80 },
          3: { cellWidth: 50 },
          4: { cellWidth: 60 }
        }
      });

      doc.save(`setlist_${setlistConfig.setlist2.name.replace(/\s+/g, '_')}.pdf`);
    }

    /*------------------------------------------
      6. GESTIÓN DE USUARIOS
    ------------------------------------------*/
    let users = [];

    async function loadUsers() {
      try {
        const snapshot = await db.collection('users').get();
        users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderUsers();
      } catch (err) {
        console.error('Error al cargar usuarios:', err);
      }
    }

    async function saveUser(user) {
      try {
        await db.collection('users').add(user);
        await loadUsers();
      } catch (err) {
        console.error('Error al guardar usuario:', err);
        alert('Error al guardar usuario.');
      }
    }

    async function deleteUser(id) {
      try {
        await db.collection('users').doc(id).delete();
        await loadUsers();
      } catch (err) {
        console.error('Error al eliminar usuario:', err);
        alert('Error al eliminar usuario.');
      }
    }

    function renderUsers() {
      const tbody = document.getElementById('user-table-body');
      const mainTbody = document.getElementById('users-body');
      tbody.innerHTML = '';
      mainTbody.innerHTML = '';

      users.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${user.name}</td>
          <td>${user.role === 'admin' ? 'Administrador' : 'Miembro'}</td>
          <td><button class="delete-user" data-id="${user.id}">Eliminar</button></td>
        `;
        tbody.appendChild(row);

        const mainRow = document.createElement('tr');
        mainRow.innerHTML = `
          <td>${user.name}</td>
          <td>${user.role === 'admin' ? 'Administrador' : 'Miembro'}</td>
        `;
        mainTbody.appendChild(mainRow);
      });

      document.querySelectorAll('.delete-user').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          deleteUser(id);
        });
      });
    }

    /*------------------------------------------
      7. ASIGNACIÓN DE ENSAYOS
    ------------------------------------------*/
    let rehearsals = [];

    async function loadRehearsals() {
      try {
        const snapshot = await db.collection('rehearsals').orderBy('date').get();
        rehearsals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderRehearsals();
      } catch (err) {
        console.error('Error al cargar ensayos:', err);
      }
    }

    async function saveRehearsal(rehearsal) {
      try {
        await db.collection('rehearsals').add(rehearsal);
        await loadRehearsals();
      } catch (err) {
        console.error('Error al guardar ensayo:', err);
        alert('Error al guardar ensayo.');
      }
    }

    async function deleteRehearsal(id) {
      try {
        await db.collection('rehearsals').doc(id).delete();
        await loadRehearsals();
      } catch (err) {
        console.error('Error al eliminar ensayo:', err);
        alert('Error al eliminar ensayo.');
      }
    }

    function renderRehearsals() {
      const tbody = document.getElementById('rehearsal-table-body');
      tbody.innerHTML = '';

      rehearsals.forEach(rehearsal => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${rehearsal.date}</td>
          <td>${rehearsal.time}</td>
          <td>${rehearsal.location}</td>
          <td><button class="delete-rehearsal" data-id="${rehearsal.id}">Eliminar</button></td>
        `;
        tbody.appendChild(row);
      });

      document.querySelectorAll('.delete-rehearsal').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          deleteRehearsal(id);
        });
      });
    }

    /*------------------------------------------
      8. MENÚ Y CONFIGURACIÓN
    ------------------------------------------*/
    const hamburgerBtn = document.getElementById('hamburger-btn');
    const sidebarMenu = document.getElementById('sidebar-menu');
    const overlay = document.getElementById('overlay');

    function closeAllScreens() {
      document.querySelectorAll('.config-screen').forEach(screen => {
        screen.style.display = 'none';
      });
      sidebarMenu.classList.remove('show');
      overlay.classList.remove('show');
      document.getElementById('password-screen').classList.remove('show');
    }

    hamburgerBtn.addEventListener('click', () => {
      sidebarMenu.classList.add('show');
      overlay.classList.add('show');
    });

    document.getElementById('menu-cerrar').addEventListener('click', (e) => {
      e.preventDefault();
      closeAllScreens();
    });

    overlay.addEventListener('click', closeAllScreens);

    // Configuración de Setlists
    document.getElementById('menu-setlist-config').addEventListener('click', (e) => {
      e.preventDefault();
      showPasswordScreen(() => {
        closeAllScreens();
        const screen = document.getElementById('setlist-config-screen');
        screen.style.display = 'block';
        document.getElementById('setlist1-name').value = setlistConfig.setlist1.name;
        document.getElementById('setlist1-url').value = setlistConfig.setlist1.url;
        document.getElementById('setlist2-name').value = setlistConfig.setlist2.name;
        document.getElementById('setlist2-url').value = setlistConfig.setlist2.url.replace('https://www.bandhelper.com/feed/set_list/', '');
      });
    });

    document.getElementById('close-setlist-config').addEventListener('click', () => {
      document.getElementById('setlist-config-screen').style.display = 'none';
    });

    document.getElementById('guardar-setlist-config').addEventListener('click', () => {
      const setlist1Name = document.getElementById('setlist1-name').value.trim();
      const setlist1Url = document.getElementById('setlist1-url').value.trim();
      const setlist2Name = document.getElementById('setlist2-name').value.trim();
      let setlist2Url = document.getElementById('setlist2-url').value.trim();

      if (!setlist1Name || !setlist1Url || !setlist2Name || !setlist2Url) {
        alert('Por favor, completa todos los campos.');
        return;
      }

      setlistConfig.setlist1.name = setlist1Name;
      setlistConfig.setlist1.url = setlist1Url;
      setlistConfig.setlist2.name = setlist2Name;
      if (!setlist2Url.startsWith('http')) {
        setlist2Url = `https://www.bandhelper.com/feed/set_list/${setlist2Url}`;
      }
      setlistConfig.setlist2.url = setlist2Url;

      saveSetlistConfig();
      cargarPrimerSetlist();
      cargarSegundoSetlist();
      document.getElementById('setlist-config-screen').style.display = 'none';
    });

    // Gestión de Usuarios
    document.getElementById('menu-user-mgmt').addEventListener('click', (e) => {
      e.preventDefault();
      showPasswordScreen(() => {
        closeAllScreens();
        document.getElementById('user-mgmt-screen').style.display = 'block';
      });
    });

    document.getElementById('close-user-mgmt').addEventListener('click', () => {
      document.getElementById('user-mgmt-screen').style.display = 'none';
    });

    document.getElementById('add-user').addEventListener('click', () => {
      const name = document.getElementById('user-name').value.trim();
      const role = document.getElementById('user-role').value;

      if (!name) {
        alert('Por favor, introduce un nombre.');
        return;
      }

      saveUser({ name, role });
      document.getElementById('user-name').value = '';
    });

    // Asignación de Ensayos
    document.getElementById('menu-rehearsal').addEventListener('click', (e) => {
      e.preventDefault();
      showPasswordScreen(() => {
        closeAllScreens();
        document.getElementById('rehearsal-screen').style.display = 'block';
      });
    });

    document.getElementById('close-rehearsal').addEventListener('click', () => {
      document.getElementById('rehearsal-screen').style.display = 'none';
    });

    document.getElementById('add-rehearsal').addEventListener('click', () => {
      const date = document.getElementById('rehearsal-date').value;
      const time = document.getElementById('rehearsal-time').value;
      const location = document.getElementById('rehearsal-location').value.trim();

      if (!date || !time || !location) {
        alert('Por favor, completa todos los campos.');
        return;
      }

      saveRehearsal({ date, time, location });
      document.getElementById('rehearsal-date').value = '';
      document.getElementById('rehearsal-time').value = '';
      document.getElementById('rehearsal-location').value = '';
    });

    /*------------------------------------------
      9. CARGA INICIAL
    ------------------------------------------*/
    function loadAllData() {
      loadSetlistConfig();
      loadUsers();
      loadRehearsals();
    }

    document.getElementById('download-btn').addEventListener('click', descargarPDFprimerSetlist);
    document.getElementById('download-btn-2').addEventListener('click', descargarPDFsegundoSetlist);

    // Cargar datos al iniciar sin mostrar la pantalla de contraseña
    window.onload = () => {
      document.getElementById('password-screen').classList.remove('show');
      loadAllData();
    };
  </script>
</body>
</html>
