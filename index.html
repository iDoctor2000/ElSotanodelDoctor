<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>El Sótano del Doctor – Uso Interno</title>

  <!-- METADATOS PARA PREVIA EN REDES -->
  <meta property="og:title" content="El Sótano del Doctor – Uso Interno" />
  <meta property="og:description" content="Banda de rock y versiones. Explora nuestro setlist, fechas de conciertos y mucho más. ¡Disfruta de la música!" />
  <meta property="og:image" content="assets/logo_negro copia.jpg" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://tusitioweb.com" />

  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:title" content="El Sótano del Doctor – Uso Interno"/>
  <meta name="twitter:description" content="Banda de rock y versiones. Explora nuestro setlist, fechas de conciertos y mucho más. ¡Disfruta de la música!"/>
  <meta name="twitter:image" content="assets/logo_negro copia.jpg"/>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- jsPDF + autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <!-- ====== ESTILOS ====== -->
  <style>
    *,*::before,*::after{box-sizing:border-box}html,body{margin:0;padding:0;overflow-x:hidden}
    body{font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff}
    header{background:#111;padding:10px 20px;display:flex;align-items:center;justify-content:space-between}
    .logo img{width:180px;height:auto}
    .hamburger{cursor:pointer;border:1px solid #0cf;border-radius:4px;padding:5px}
    .hamburger div{width:25px;height:3px;background:#0cf;margin:4px 0}
    .sidebar{position:fixed;top:0;left:0;width:250px;height:100%;background:#111;border-right:1px solid #222;
             padding:20px;box-shadow:2px 0 10px rgba(0,255,255,.1);transform:translateX(-250px);transition:.3s;z-index:9999}
    .sidebar.show{transform:translateX(0)}
    .sidebar h2{color:#0cf;margin:0}
    .sidebar a{display:block;color:#fff;text-decoration:none;margin:10px 0;padding:5px 0;border-bottom:1px solid #222}
    .sidebar a:hover{color:#0cf}
    #overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:9998;display:none}
    #overlay.show{display:block}
    .config-screen{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:9999;
                   overflow-y:auto;padding:60px 20px 20px}
    .config-screen h2{color:#0cf;text-align:center;margin:0 0 20px}
    .config-screen label{display:block;margin:10px 0 5px}
    .config-screen input,.config-screen select{width:100%;max-width:400px;padding:10px;background:#222;color:#fff;
                                              border:1px solid #333;border-radius:5px}
    .config-screen button{margin-top:20px;padding:10px 20px;background:#0cf;color:#000;border:none;border-radius:8px;cursor:pointer}
    .config-screen button:hover{background:#09b}.config-screen .close-btn{position:absolute;top:20px;right:20px;font-size:1.2em;
    background:none;border:1px solid #0cf;color:#0cf;border-radius:4px;padding:5px 10px;cursor:pointer}
    .config-screen .close-btn:hover{background:#333}
    main section{max-width:1200px;margin:0 auto;padding:20px}
    #setlists,#second-setlist,#usuarios,#calendario{background:#111;padding:20px;border-radius:10px;box-shadow:0 0 20px rgba(0,255,255,.1);margin-bottom:40px}
    #setlists h2,#second-setlist h2,#usuarios h2,#calendario h2{text-align:center;color:#0cf;margin-bottom:15px}
    table{width:100%;border-collapse:collapse;margin-top:20px;color:#fff;font-size:.95em}
    thead{background:#222;color:#0cf}th,td{padding:12px;border:1px solid #333;text-align:left}
    tr:nth-child(even){background:#1a1a1a}.download-btn{display:block;margin:20px auto 0;padding:10px 20px;font-size:1em;
    background:#0cf;color:#000;border:none;border-radius:8px;cursor:pointer}
    .download-btn:hover{background:#09b}#total-time,#total-time-2{color:#0cf;margin-top:10px;text-align:center}
    footer{background:#111;color:#888;text-align:center;padding:10px;border-top:1px solid #222}
    @media(max-width:768px){.hamburger div{width:20px}}
  </style>
</head>

<body>
  <!-- ====== CABECERA ====== -->
  <header>
    <div class="logo"><img src="assets/logo_blanco.png" alt="Logo"></div>
    <div class="hamburger" id="hamburger-btn"><div></div><div></div><div></div></div>
  </header>

  <!-- ====== MENÚ LATERAL ====== -->
  <div id="overlay"></div>
  <nav class="sidebar" id="sidebar-menu">
    <h2>Menú</h2>
    <a href="#" id="menu-setlist-config">Configurar Setlists</a>
    <a href="#" id="menu-user-mgmt">Gestión de Usuarios</a>
    <a href="#" id="menu-rehearsal">Asignar Ensayos</a>
    <a href="#" id="menu-cerrar">Cerrar Menú</a>
  </nav>

  <!-- ====== PANTALLAS DE CONFIGURACIÓN ====== -->
  <!-- Setlists -->
  <div id="setlist-config-screen" class="config-screen">
    <button class="close-btn" id="close-setlist-config">Cerrar</button>
    <h2>Configuración de Setlists</h2>
    <h3>Primer Setlist</h3>
    <label>Nombre</label><input id="setlist1-name" placeholder="Ej: Ensayos 2025">
    <label>ID/URL feed</label><input id="setlist1-url" placeholder="URL">
    <h3>Segundo Setlist</h3>
    <label>Nombre</label><input id="setlist2-name" placeholder="Ej: Concierto Navidad">
    <label>ID/URL feed</label><input id="setlist2-url" placeholder="Ej: TXHvyb o URL completa">
    <button id="guardar-setlist-config">Guardar Configuración</button>
  </div>

  <!-- Usuarios -->
  <div id="user-mgmt-screen" class="config-screen">
    <button class="close-btn" id="close-user-mgmt">Cerrar</button>
    <h2>Gestión de Usuarios</h2>
    <label>Nombre</label><input id="user-name" placeholder="Nombre">
    <label>Rol</label>
    <select id="user-role"><option value="admin">Administrador</option><option value="member">Miembro</option></select>
    <button id="add-user">Añadir Usuario</button>
    <table id="user-table"><thead><tr><th>Nombre</th><th>Rol</th><th>Acciones</th></tr></thead><tbody id="user-table-body"></tbody></table>
  </div>

  <!-- Ensayos -->
  <div id="rehearsal-screen" class="config-screen">
    <button class="close-btn" id="close-rehearsal">Cerrar</button>
    <h2>Asignación de Ensayos</h2>
    <label>Fecha</label><input type="date" id="rehearsal-date">
    <label>Hora</label><input type="time" id="rehearsal-time">
    <label>Lugar</label><input id="rehearsal-location" placeholder="Ej: Estudio 1">
    <button id="add-rehearsal">Añadir Ensayo</button>
    <table id="rehearsal-table"><thead><tr><th>Fecha</th><th>Hora</th><th>Lugar</th><th>Acciones</th></tr></thead><tbody id="rehearsal-table-body"></tbody></table>
  </div>

  <!-- ====== CONTENIDO PRINCIPAL ====== -->
  <main>
    <!-- Primer setlist -->
    <section id="setlists">
      <h2 id="setlist1-title">Setlist Ensayos -Año 2025-</h2>
      <p style="text-align:center;color:#aaa">Consulta y exporta el setlist de ensayos en tiempo real.</p>
      <table><thead><tr><th>#</th><th>Título</th><th>Tonalidad</th><th>Tempo</th><th>Duración</th></tr></thead><tbody id="setlist-body"></tbody></table>
      <button class="download-btn" id="download-btn">Descargar PDF</button>
      <p id="total-time"></p>
    </section>

    <!-- Segundo setlist -->
    <section id="second-setlist">
      <h2 id="setlist2-title">Setlist Próximo Concierto</h2>
      <p style="text-align:center;color:#aaa">Feed actual: <em id="url-actual"></em></p>
      <table id="second-list-table"><thead><tr><th>#</th><th>Canción</th><th>Tonalidad</th><th>Tempo</th><th>Duración</th></tr></thead><tbody id="second-body"></tbody></table>
      <button class="download-btn" id="download-btn-2">Descargar PDF</button>
      <p id="total-time-2"></p>
    </section>

    <!-- Usuarios -->
    <section id="usuarios">
      <h2>Usuarios Registrados</h2>
      <p style="text-align:center;color:#aaa">Lista de usuarios con acceso a la intranet.</p>
      <table><thead><tr><th>Nombre</th><th>Rol</th></tr></thead><tbody id="users-body"></tbody></table>
    </section>

    <!-- Calendario -->
    <section id="calendario">
      <h2>Próximos Conciertos y Ensayos</h2>
      <p>Consulta el calendario actualizado.</p>
      <script src="https://www.bandhelper.com/widget/calendar/10353?layout=1&range=6"></script>
    </section>
  </main>

  <footer>© 2025 El Sótano del Doctor. All Rights Reserved.</footer>

  <!-- ============ JAVASCRIPT UNIFICADO ============ -->
  <script type="module">
    /* ---------- Firebase ---------- */
    import { initializeApp }      from "https://www.gstatic.com/firebasejs/11.7.0/firebase-app.js";
    import { getFirestore, doc,
             getDoc, setDoc      } from "https://www.gstatic.com/firebasejs/11.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey:            "AIzaSyCEP44xNINCkIejgNvcYafJsALnO0y4dfw",
      authDomain:        "sotanointranet.firebaseapp.com",
      projectId:         "sotanointranet",
      storageBucket:     "sotanointranet.appspot.com",
      messagingSenderId: "756955233128",
      appId:             "1:756955233128:web:ab36372bdbd895a30e74dd"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const loadDoc = async (id, fallback) => {
      const snap = await getDoc(doc(db, "intranet", id));
      return snap.exists() ? snap.data() : fallback;
    };
    const saveDoc = (id, data) => setDoc(doc(db, "intranet", id), data);

    /* ---------- Utilidades ---------- */
    const parseDuration = str => {
      if(!str) return 0;
      if(str.includes(":")){const [m,s=0]=str.split(":").map(Number);return m*60+s;}
      const n=parseInt(str,10);return isNaN(n)?0:n;
    };
    const toMMSS  = s => `${Math.floor(s/60)}:${String(s%60).padStart(2,"0")}`;
    const toHHMM  = s => {const h=Math.floor(s/3600),m=Math.floor((s%3600)/60);return h?`${h}h ${String(m).padStart(2,"0")}m`:`${m}m`;};
    const clean   = s => (s||"").replace(/[^\x00-\xFF]/g,"").trim();

    /* ---------- Configuración inicial ---------- */
    let setlistConfig = {
      setlist1:{name:"Setlist Ensayos -Año 2025-",url:"https://cold-limit-811a.jagomezc.workers.dev"},
      setlist2:{name:"Setlist Próximo Concierto", url:"https://www.bandhelper.com/feed/set_list/TXHvyb"}
    };
    const updateTitles = () => {
      document.getElementById("setlist1-title").textContent=setlistConfig.setlist1.name;
      document.getElementById("setlist2-title").textContent=setlistConfig.setlist2.name;
    };
    const loadSetlistConfig = async () => { setlistConfig=await loadDoc("setlists",setlistConfig); updateTitles(); };
    const saveSetlistConfig = () => { updateTitles(); saveDoc("setlists",setlistConfig); };

    /* ---------- Primer setlist ---------- */
    async function cargarPrimerSetlist(){
      try{
        const data = (await (await fetch(setlistConfig.setlist1.url)).json())
                      .filter(i=>i.type==="song");
        const tbody=document.getElementById("setlist-body");tbody.innerHTML="";
        let total=0;
        data.forEach((s,i)=>{
          const secs=parseDuration(s.duration);total+=secs;
          tbody.insertAdjacentHTML("beforeend",
            `<tr><td>${i+1}</td><td>${s.name||""}</td><td>${s.key||""}</td><td>${s.tempo||""}</td><td>${toMMSS(secs)}</td></tr>`);
        });
        document.getElementById("total-time").textContent="Tiempo total del set: "+toHHMM(total);
        return data;
      }catch(e){console.error(e);document.getElementById("setlist-body").innerHTML=
                '<tr><td colspan="5">Error al cargar el primer setlist.</td></tr>';return [];}
    }

    /* ---------- Segundo setlist ---------- */
    async function cargarSegundoSetlist(){
      try{
        const data = (await (await fetch(setlistConfig.setlist2.url)).json())
                      .filter(i=>i.type==="song");
        const tbody=document.getElementById("second-body");tbody.innerHTML="";
        let total=0;
        data.forEach((s,i)=>{
          const secs=parseDuration(s.duration);total+=secs;
          tbody.insertAdjacentHTML("beforeend",
            `<tr><td>${i+1}</td><td>${clean(s.name)}</td><td>${clean(s.key)}</td><td>${clean(s.tempo)}</td><td>${toMMSS(secs)}</td></tr>`);
        });
        document.getElementById("url-actual").textContent=setlistConfig.setlist2.url;
        document.getElementById("total-time-2").textContent="Tiempo total del set: "+toMMSS(total);
        return data;
      }catch(e){console.error(e);document.getElementById("second-body").innerHTML=
                '<tr><td colspan="5">Error al cargar el segundo setlist.</td></tr>';return [];}
    }

    /* ---------- Usuarios ---------- */
    let users=[];
    const renderUsers=()=>{
      const tbody=document.getElementById("user-table-body"),main=document.getElementById("users-body");
      tbody.innerHTML=main.innerHTML="";
      users.forEach((u,i)=>{
        tbody.insertAdjacentHTML("beforeend",
          `<tr><td>${u.name}</td><td>${u.role==="admin"?"Administrador":"Miembro"}</td>
           <td><button class="delete-user" data-i="${i}">Eliminar</button></td></tr>`);
        main.insertAdjacentHTML("beforeend",
          `<tr><td>${u.name}</td><td>${u.role==="admin"?"Administrador":"Miembro"}</td></tr>`);
      });
      tbody.querySelectorAll(".delete-user").forEach(b=>b.onclick=()=>{users.splice(b.dataset.i,1);saveUsers();});
    };
    const loadUsers = async ()=>{users=await loadDoc("users",[]);renderUsers();};
    const saveUsers = ()=>{saveDoc("users",users);renderUsers();};

    /* ---------- Ensayos ---------- */
    let rehearsals=[];
    const renderRehearsals=()=>{
      const tbody=document.getElementById("rehearsal-table-body");tbody.innerHTML="";
      rehearsals.forEach((r,i)=>{
        tbody.insertAdjacentHTML("beforeend",
          `<tr><td>${r.date}</td><td>${r.time}</td><td>${r.location}</td>
           <td><button class="delete-rehearsal" data-i="${i}">Eliminar</button></td></tr>`);
      });
      tbody.querySelectorAll(".delete-rehearsal").forEach(b=>b.onclick=()=>{rehearsals.splice(b.dataset.i,1);saveRehearsals();});
    };
    const loadRehearsals = async ()=>{rehearsals=await loadDoc("rehearsals",[]);renderRehearsals();};
    const saveRehearsals = ()=>{saveDoc("rehearsals",rehearsals);renderRehearsals();};

    /* ---------- PDF ---------- */
    const genPDF = async (songs,title,fileName) =>{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation:"portrait",unit:"pt",format:"A4"});
      try{
        const img=await (await fetch("assets/logo_negro copia.jpg")).blob();
        const base=await new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(img);});
        doc.addImage(base,"JPEG",40,30,60,60);
      }catch{}
      doc.setFontSize(16);doc.text(`Setlist - ${title}`,120,50);
      const totalTime=toMMSS(songs.reduce((a,s)=>a+parseDuration(s.duration),0));
      doc.setFontSize(12);doc.text(`${songs.length} canciones, ${totalTime} total`,120,70);
      doc.autoTable({
        startY:100,
        head:[["#","Título","Tonalidad","Tempo","Duración"]],
        body:songs.map((s,i)=>[i+1,s.name||"",s.key||"",s.tempo||"",toMMSS(parseDuration(s.duration))]),
        headStyles:{fillColor:[60,60,60],textColor:[255,255,255],fontStyle:"bold"},
        styles:{fontSize:10,cellPadding:5}
      });
      doc.save(fileName);
    };

    /* ---------- Menú y pantallas ---------- */
    const sidebar=document.getElementById("sidebar-menu"),overlay=document.getElementById("overlay");
    const closeAll=()=>{document.querySelectorAll(".config-screen").forEach(s=>s.style.display="none");
                        sidebar.classList.remove("show");overlay.classList.remove("show");};
    document.getElementById("hamburger-btn").onclick=()=>{sidebar.classList.add("show");overlay.classList.add("show");};
    document.getElementById("menu-cerrar").onclick=e=>{e.preventDefault();closeAll();};
    overlay.onclick=closeAll;

    /* Setlists screen */
    document.getElementById("menu-setlist-config").onclick=e=>{
      e.preventDefault();closeAll();
      const s=document.getElementById("setlist-config-screen");s.style.display="block";
      document.getElementById("setlist1-name").value=setlistConfig.setlist1.name;
      document.getElementById("setlist1-url").value =setlistConfig.setlist1.url;
      document.getElementById("setlist2-name").value=setlistConfig.setlist2.name;
      document.getElementById("setlist2-url").value =setlistConfig.setlist2.url.replace("https://www.bandhelper.com/feed/set_list/","");
    };
    document.getElementById("close-setlist-config").onclick=()=>document.getElementById("setlist-config-screen").style.display="none";
    document.getElementById("guardar-setlist-config").onclick=()=>{
      const n1=document.getElementById("setlist1-name").value.trim(),
            u1=document.getElementById("setlist1-url").value.trim(),
            n2=document.getElementById("setlist2-name").value.trim(),
            u2raw=document.getElementById("setlist2-url").value.trim();
      if(!n1||!u1||!n2||!u2raw){alert("Completa todos los campos");return;}
      setlistConfig.setlist1={name:n1,url:u1};
      setlistConfig.setlist2={name:n2,url:u2raw.startsWith("http")?u2raw:`https://www.bandhelper.com/feed/set_list/${u2raw}`};
      saveSetlistConfig();
      cargarPrimerSetlist();cargarSegundoSetlist();
      document.getElementById("setlist-config-screen").style.display="none";
    };

    /* Usuarios screen */
    document.getElementById("menu-user-mgmt").onclick=e=>{e.preventDefault();closeAll();document.getElementById("user-mgmt-screen").style.display="block";};
    document.getElementById("close-user-mgmt").onclick=()=>document.getElementById("user-mgmt-screen").style.display="none";
    document.getElementById("add-user").onclick=()=>{
      const name=document.getElementById("user-name").value.trim(),
            role=document.getElementById("user-role").value;
      if(!name){alert("Introduce un nombre");return;}
      users.push({name,role});saveUsers();document.getElementById("user-name").value="";
    };

    /* Ensayos screen */
    document.getElementById("menu-rehearsal").onclick=e=>{e.preventDefault();closeAll();document.getElementById("rehearsal-screen").style.display="block";};
    document.getElementById("close-rehearsal").onclick=()=>document.getElementById("rehearsal-screen").style.display="none";
    document.getElementById("add-rehearsal").onclick=()=>{
      const date=document.getElementById("rehearsal-date").value,
            time=document.getElementById("rehearsal-time").value,
            loc =document.getElementById("rehearsal-location").value.trim();
      if(!date||!time||!loc){alert("Completa todos los campos");return;}
      rehearsals.push({date,time,location:loc});saveRehearsals();
      document.getElementById("rehearsal-date").value=document.getElementById("rehearsal-time").value=
      document.getElementById("rehearsal-location").value="";
    };

    /* ---------- Carga inicial ---------- */
    window.addEventListener("DOMContentLoaded", async ()=>{
      await Promise.all([loadSetlistConfig(),loadUsers(),loadRehearsals()]);
      const [songs1,songs2] = await Promise.all([cargarPrimerSetlist(),cargarSegundoSetlist()]);
      document.getElementById("download-btn" ).onclick=()=>genPDF(songs1,setlistConfig.setlist1.name,"setlist_primer.pdf");
      document.getElementById("download-btn-2").onclick=()=>genPDF(songs2,setlistConfig.setlist2.name,"setlist_segundo.pdf");
    });
  </script>
</body>
</html>