<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>El Sótano del Doctor – Uso Interno</title>

  <!-- Favicon -->
  <link rel="icon" type="favicon_ElSotanoDr.ico" href="assets/favicon_ElSotanoDr.ico">
  <link rel="logo_negro copia.png" href="assets/logo_negro copia.png">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">

  <!-- Metadatos -->
  <meta property="og:title" content="El Sótano del Doctor – Uso Interno">
  <meta property="og:description" content="Banda de rock y versiones. Explora nuestro setlist, fechas de conciertos y más.">
  <meta property="og:image" content="assets/logo_negro copia.jpg">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://tusitioweb.com">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="El Sótano del Doctor – Uso Interno">
  <meta name="twitter:description" content="Banda de rock y versiones. Explora nuestro setlist, fechas de conciertos y mucho más. ¡Disfruta de la música!">
  <meta name="twitter:image" content="assets/logo_negro copia.jpg">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Librerías externas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Estilos -->
  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;padding:0;overflow-x:hidden;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff}
    header{background:#111;padding:20px;display:flex;align-items:center;justify-content:space-between;position:relative}
    .logo img.logo-main{width:180px;height:auto}
    .logo-intranet{position:absolute;left:50%;transform:translateX(-50%);height:60px;width:auto}
    .hamburger{cursor:pointer;border:1px solid #0cf;border-radius:4px;padding:5px}
    .hamburger div{width:25px;height:3px;background:#0cf;margin:4px 0}
    .sidebar{position:fixed;top:0;left:0;width:250px;height:100%;background:#111;border-right:1px solid #222;padding:20px;
             transform:translateX(-250px);transition:.3s;z-index:9999}
    .sidebar.show{transform:translateX(0)}
    .sidebar h2{color:#0cf;margin:0}
    .sidebar a{display:block;color:#fff;text-decoration:none;margin:10px 0;padding:5px 0;border-bottom:1px solid #222}
    .sidebar a:hover{color:#0cf}
    .sidebar .submenu{margin-left:15px;display:none}
    .sidebar .submenu.show{display:block}
    .sidebar .submenu a{font-size:0.95em}
    #overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:9998;display:none}
    #overlay.show{display:block}
    main section{max-width:1200px;margin:0 auto;padding:20px}
    #setlists,#rehearsals,#second-setlist,#calendario,#timeline,#usuarios{background:#111;padding:20px;border-radius:10px;
            box-shadow:0 0 20px rgba(0,255,255,.1);margin-bottom:40px}
    #setlists h2,#rehearsals h2,#second-setlist h2,#calendario h2,#timeline h2,#usuarios h2{text-align:center;color:#0cf;margin-bottom:15px}
    .table-wrapper{width:100%;overflow-x:auto;display:flex;justify-content:center}
    table{width:100%;max-width:100%;border-collapse:collapse;margin-top:20px;color:#fff;font-size:.95em;margin-left:auto;margin-right:auto}
    thead{background:#222;color:#0cf}
    th,td{padding:12px;border:1px solid #333;text-align:left;white-space:normal;word-wrap:break-word}
    tr:nth-child(even){background:#1a1a1a}
    .download-btn{display:block;margin:20px auto 0;padding:10px 20px;background:#0cf;color:#000;border:none;border-radius:8px;cursor:pointer}
    .download-btn:hover{background:#09b}
    #total-time,#total-time-2{color:#0cf;margin-top:10px;text-align:center}
    #second-setlist-name{text-align:center;color:#aaa;margin-top:5px;font-style:italic}
    #timeline ul{list-style-type:none;padding:0}
    #timeline li{margin-bottom:10px}
    #timeline .rehearsal{font-style:italic}
    #timeline .concert{font-weight:bold}
    @media(max-width:768px){
      .hamburger div{width:20px}
      .logo img.logo-main{width:150px}
      .logo-intranet{height:50px}
      table{font-size:0.85em}
      th,td{padding:8px}
    }
  </style>
</head>

<body>
  <header>
    <div class="logo">
      <img src="assets/logo_blanco.png" alt="Logo" class="logo-main">
    </div>
    <img src="assets/logointranet.png" alt="Logo Intranet" class="logo-intranet">
    <div class="hamburger" id="hamburger-btn"><div></div><div></div><div></div></div>
  </header>

  <div id="overlay"></div>
  <nav class="sidebar" id="sidebar-menu">
    <h2>Menú</h2>
    <a href="#rehearsals">Próximos Ensayos</a>
    <a href="#second-setlist">Setlist Próximo Concierto</a>
    <a href="#calendario">Próximos Conciertos</a>
    <a href="#timeline">Línea Temporal</a>
    <a href="#" id="menu-config">Configuración</a>
    <div class="submenu" id="config-submenu">
      <a href="#" id="menu-setlist-config">Configurar Setlists</a>
    </div>
    <a href="#" id="menu-cerrar">Cerrar Menú</a>
  </nav>

  <main>
    <section id="setlists">
      <h2 id="setlist1-title">Setlist Ensayos -Año 2025-</h2>
      <div class="table-wrapper">
        <table><thead><tr><th>#</th><th>Título</th><th>Tonalidad</th><th>Tempo</th><th>Duración</th></tr></thead><tbody id="setlist-body"></tbody></table>
      </div>
      <button class="download-btn" id="download-btn">Descargar PDF</button>
      <p id="total-time"></p>
    </section>

    <section id="rehearsals">
      <h2>Próximos Ensayos</h2>
      <div class="table-wrapper">
        <table><thead><tr><th>Fecha</th><th>Hora</th><th>Lugar</th></tr></thead><tbody id="rehearsal-main-body"></tbody></table>
      </div>
    </section>

    <section id="second-setlist">
      <h2>Setlist Próximo Concierto</h2>
      <p id="second-setlist-name"></p>
      <div class="table-wrapper">
        <table><thead><tr><th>#</th><th>Canción</th><th>Tonalidad</th><th>Tempo</th><th>Duración</th></tr></thead><tbody id="second-body"></tbody></table>
      </div>
      <button class="download-btn" id="download-btn-2">Descargar PDF</button>
      <p id="total-time-2"></p>
    </section>

    <section id="calendario">
      <h2>Próximos Conciertos</h2>
      <div id="bandhelper-concerts">
        <script src="https://www.bandhelper.com/widget/calendar/10353?layout=1&range=6"></script>
      </div>
    </section>

    <section id="timeline">
      <h2>Línea Temporal de Eventos</h2>
      <ul id="timeline-list"></ul>
    </section>

    <section id="usuarios">
      <h2>Usuarios Registrados</h2>
      <div class="table-wrapper">
        <table><thead><tr><th>Nombre</th><th>Apodo</th><th>Roles</th></tr></thead><tbody id="users-body"></tbody></table>
      </div>
    </section>
  </main>

  <footer>© 2025 El Sótano del Doctor. All Rights Reserved.</footer>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyCEP44xNINCkIejgNvcYafJsALnO0y4dfw",
    authDomain: "sotanointranet.firebaseapp.com",
    projectId: "sotanointranet",
    messagingSenderId: "756955233128",
    appId: "1:756955233128:web:ab36372bdbd895a30e74dd"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const parseDuration = str => {
    if (!str) return 0;
    if (str.includes(":")) { const [m, s = 0] = str.split(":").map(Number); return m * 60 + s; }
    const n = parseInt(str, 10); return isNaN(n) ? 0 : n;
  };
  const toMMSS = s => `${Math.floor(s / 60)}:${String(s % 60).padStart(2, "0")}`;
  const toHHMM = s => {
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    return h ? `${h}h ${String(m).padStart(2, "0")}m` : `${m}m`;
  };
  const clean = s => (s || "").replace(/[^\x00-\xFF]/g, "").trim();
  const formatDateWithDay = dateStr => {
    const date = new Date(dateStr);
    const days = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];
    const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    return `${days[date.getDay()]} ${date.getDate()} de ${months[date.getMonth()]}`;
  };

  async function loadDoc(id, fallback) {
    try {
      const snap = await db.collection("intranet").doc(id).get();
      return snap.exists ? snap.data() : fallback;
    } catch (e) {
      console.error(`Error al cargar documento ${id}:`, e);
      return fallback;
    }
  }

  async function saveDoc(id, data) {
    try {
      await db.collection("intranet").doc(id).set(data);
      return true;
    } catch (e) {
      console.error(`Error al guardar documento ${id}:`, e);
      return false;
    }
  }

  let setlistConfig = {
    setlist1: { name: "Setlist Ensayos -Año 2025-", url: "https://cold-limit-811a.jagomezc.workers.dev" },
    setlist2: { name: "Setlist Próximo Concierto", url: "https://www.bandhelper.com/feed/set_list/TXHvyb" }
  };

  async function loadSetlistConfig() {
    const data = await loadDoc("setlists", { config: setlistConfig });
    setlistConfig = data.config || setlistConfig;
    document.getElementById("setlist1-title").textContent = setlistConfig.setlist1.name;
    document.getElementById("second-setlist-name").textContent = setlistConfig.setlist2.name;
  }

  async function cargarPrimerSetlist() {
    try {
      const response = await fetch(setlistConfig.setlist1.url);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const data = await response.json();
      const songs = Array.isArray(data) ? data.filter(i => i.type === "song") : [];
      const tbody = document.getElementById("setlist-body");
      tbody.innerHTML = "";
      let total = 0;
      songs.forEach((s, i) => {
        const secs = parseDuration(s.duration || "0");
        total += secs;
        tbody.insertAdjacentHTML("beforeend",
          `<tr><td>${i + 1}</td><td>${clean(s.name || "Sin título")}</td><td>${clean(s.key || "-")}</td><td>${clean(s.tempo || "-")}</td><td>${toMMSS(secs)}</td></tr>`);
      });
      document.getElementById("total-time").textContent = "Tiempo total del set: " + toHHMM(total);
      return songs;
    } catch (e) {
      console.error("Error cargando primer setlist:", e);
      document.getElementById("setlist-body").innerHTML = '<tr><td colspan="5">Error al cargar el setlist. Verifica la URL.</td></tr>';
      return [];
    }
  }

  async function cargarSegundoSetlist() {
    try {
      const response = await fetch(setlistConfig.setlist2.url);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const data = await response.json();
      const songs = Array.isArray(data) ? data.filter(i => i.type === "song") : [];
      const tbody = document.getElementById("second-body");
      tbody.innerHTML = "";
      let total = 0;
      songs.forEach((s, i) => {
        const secs = parseDuration(s.duration || "0");
        total += secs;
        tbody.insertAdjacentHTML("beforeend",
          `<tr><td>${i + 1}</td><td>${clean(s.name || "Sin título")}</td><td>${clean(s.key || "-")}</td><td>${clean(s.tempo || "-")}</td><td>${toMMSS(secs)}</td></tr>`);
      });
      document.getElementById("total-time-2").textContent = "Tiempo total del set: " + toHHMM(total);
      return songs;
    } catch (e) {
      console.error("Error cargando segundo setlist:", e);
      document.getElementById("second-body").innerHTML = '<tr><td colspan="5">Error al cargar el setlist. Verifica la URL.</td></tr>';
      return [];
    }
  }

  let rehearsals = [];
  async function loadRehearsals() {
    const data = await loadDoc("rehearsals", { rehearsals: [] });
    rehearsals = Array.isArray(data.rehearsals) ? data.rehearsals : [];
    const tbody = document.getElementById("rehearsal-main-body");
    tbody.innerHTML = "";
    const now = new Date();
    rehearsals.filter(r => new Date(r.date) >= now).forEach(r => {
      tbody.insertAdjacentHTML("beforeend",
        `<tr><td>${formatDateWithDay(r.date)}</td><td>${r.startTime} - ${r.endTime}</td><td>${r.location}</td></tr>`);
    });
  }

  let concerts = [
    { date: "2025-12-20", name: "Concierto Navidad" },
    { date: "2025-06-15", name: "Concierto Verano" }
  ]; // Simulados, reemplaza con tus datos reales

  function renderTimeline() {
    const timelineList = document.getElementById("timeline-list");
    timelineList.innerHTML = "";
    const rehearsalEvents = rehearsals.map(r => ({
      date: r.date,
      type: "rehearsal",
      text: `Ensayo - ${formatDateWithDay(r.date)}`
    }));
    const concertEvents = concerts.map(c => ({
      date: c.date,
      type: "concert",
      text: `Concierto - ${formatDateWithDay(c.date)}`
    }));
    const allEvents = [...rehearsalEvents, ...concertEvents].sort((a, b) => new Date(a.date) - new Date(b.date));
    allEvents.forEach(event => {
      const li = document.createElement("li");
      li.className = event.type;
      li.textContent = event.text;
      timelineList.appendChild(li);
    });
  }

  async function genPDF(songs, title, fileName) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "A4" });
    doc.setFontSize(16);
    doc.text(`Setlist - ${title}`, 40, 50);
    const totalTime = toMMSS(songs.reduce((a, s) => a + parseDuration(s.duration || "0"), 0));
    doc.setFontSize(12);
    doc.text(`${songs.length} canciones, ${totalTime} total`, 40, 70);
    doc.autoTable({
      startY: 100,
      head: [["#", "Título", "Tonalidad", "Tempo", "Duración"]],
      body: songs.map((s, i) => [i + 1, clean(s.name || ""), clean(s.key || ""), clean(s.tempo || ""), toMMSS(parseDuration(s.duration || "0"))]),
      headStyles: { fillColor: [60, 60, 60], textColor: [255, 255, 255] },
      styles: { fontSize: 10, cellPadding: 5 }
    });
    doc.save(fileName);
  }

  const sidebar = document.getElementById("sidebar-menu"), overlay = document.getElementById("overlay");
  document.getElementById("hamburger-btn").onclick = () => {
    sidebar.classList.add("show");
    overlay.classList.add("show");
  };
  document.getElementById("menu-cerrar").onclick = e => {
    e.preventDefault();
    sidebar.classList.remove("show");
    overlay.classList.remove("show");
    document.getElementById("config-submenu").classList.remove("show");
  };
  overlay.onclick = () => {
    sidebar.classList.remove("show");
    overlay.classList.remove("show");
    document.getElementById("config-submenu").classList.remove("show");
  };
  document.getElementById("menu-config").onclick = e => {
    e.preventDefault();
    const submenu = document.getElementById("config-submenu");
    submenu.classList.toggle("show");
  };

  document.addEventListener("DOMContentLoaded", async () => {
    await loadSetlistConfig();
    await loadRehearsals();
    let songs1 = await cargarPrimerSetlist();
    let songs2 = await cargarSegundoSetlist();
    renderTimeline();

    document.getElementById("download-btn").onclick = () => {
      if (songs1.length) genPDF(songs1, setlistConfig.setlist1.name, "setlist_ensayos.pdf");
      else alert("No hay canciones para descargar.");
    };
    document.getElementById("download-btn-2").onclick = () => {
      if (songs2.length) genPDF(songs2, setlistConfig.setlist2.name, "setlist_concierto.pdf");
      else alert("No hay canciones para descargar.");
    };
  });
  </script>
</body>
</html>
