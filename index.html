<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>El Sótano del Doctor</title>

    <!-- Open Graph para redes sociales -->
    <meta property="og:title" content="El Sótano del Doctor" />
    <meta property="og:description" content="Web oficial de ensayos y eventos proximos." />
    <meta property="og:image" content="https://idoctor2000.github.io/ElSotanodelDoctor/assets/logo_negro copia.jpg" />
    <meta property="og:url" content="https://idoctor2000.github.io/ElSotanodelDoctor/" />
    <meta property="og:type" content="website" />

    <!-- Para Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="El Sótano del Doctor" />
    <meta name="twitter:description" content="Web oficial de ensayos y eventos proximos." />
    <meta name="twitter:image" content="https://idoctor2000.github.io/ElSotanodelDoctor/assets/logo_negro copia.jpg" />

    <link rel="icon" href="assets/favicon_el_sotano_dr.ico" type="image/x-icon">

    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #111;
            padding: 20px;
            text-align: center;
        }
        header img {
            width: 300px;
            height: auto;
        }
        main {
            padding: 20px;
        }
        section {
            margin-bottom: 50px;
            padding: 20px;
            background-color: #111;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.1);
        }
        h2 {
            border-bottom: 2px solid #0cf;
            color: #0cf;
            padding-bottom: 10px;
            font-size: 1.8em;
            text-align: center;
        }
        p {
            color: #aaa;
            font-size: 1em;
            line-height: 1.5;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            color: #fff;
            font-size: 0.95em;
        }
        thead {
            background-color: #222;
            color: #0cf;
        }
        th, td {
            padding: 12px;
            border: 1px solid #333;
            text-align: left;
        }
        tr:nth-child(even) {
            background-color: #1a1a1a;
        }
        #download-btn {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 1em;
            background-color: #0cf;
            color: #000;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        footer {
            background-color: #111;
            color: #888;
            text-align: center;
            padding: 20px;
            font-size: 0.9em;
            border-top: 1px solid #222;
        }
    </style>
</head>
<body>
    <header>
        <img src="assets/logo_blanco.png" alt="El Sótano del Doctor logo" />
    </header>
    <main>
        <section id="setlists">
            <h2>🎼 Setlists Ensayos 2025 🎶</h2>
            <p>Consulta los setlists en tiempo real desde BandHelper:</p>
            <table>
                <thead>
                    <tr>
                        <th>Título</th>
                        <th>Tonalidad</th>
                        <th>Tempo</th>
                        <th>Duración</th>
                    </tr>
                </thead>
                <tbody id="setlist-body"></tbody>
            </table>

            <button id="download-btn">📥 Descargar PDF del setlist</button>
            <!-- Aquí se insertará automáticamente el párrafo con el tiempo total del set -->
            <p style="margin-top:10px; font-size: 0.9em; color: #888;">🎧 Setlist actualizado en tiempo real desde la app</p>
        </section>

        <section id="calendario" style="padding: 30px; margin-bottom: 50px;">
            <h2 style="text-align: center; color: #0cf;">📅 Próximos conciertos</h2>
            <p style="text-align: center; color: #aaa;">Consulta nuestro calendario actualizado desde BandHelper</p>
            <div style="background-color: #111; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,255,255,0.1);">
                <script type="text/javascript" src="https://www.bandhelper.com/widget/calendar/10353?range=6"></script>
            </div>
        </section>
    </main>
    <footer>
        © 2025 El Sótano del Doctor. Todos los derechos reservados.
    </footer>

    <!-- Librerías jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script>
        const url = 'https://cold-limit-811a.jagomezc.workers.dev';

        // Función para convertir la duración "mm:ss" a segundos
        function parseDurationToSeconds(durationStr) {
            if (!durationStr || !durationStr.includes(":")) return 0;
            const [min, sec] = durationStr.split(":").map(num => parseInt(num, 10));
            return (min * 60) + (sec || 0);
        }

        // Función para formatear los segundos totales a "mm:ss"
        function formatSecondsToMMSS(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            // Aseguramos que sean 2 dígitos en segundos
            return `${minutes}:${String(seconds).padStart(2, '0')}`;
        }

        async function cargarSetlist() {
            try {
                const res = await fetch(url);
                const data = await res.json();
                const tbody = document.getElementById('setlist-body');
                tbody.innerHTML = '';

                // Filtramos los elementos tipo "song"
                const songs = data.filter(item => item.type === 'song');

                let totalSeconds = 0;

                songs.forEach(song => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${song.name || ''}</td>
                        <td>${song.key || ''}</td>
                        <td>${song.tempo || ''}</td>
                        <td>${song.duration || ''}</td>
                    `;
                    tbody.appendChild(row);

                    // Sumamos las duraciones, en caso de formato "mm:ss"
                    totalSeconds += parseDurationToSeconds(song.duration);
                });

                // Calculamos el tiempo total y lo mostramos
                const totalDuration = formatSecondsToMMSS(totalSeconds);

                // Buscamos el <section> del setlist
                const setlistSection = document.getElementById('setlists');

                // Creamos o actualizamos un <p> para el tiempo total
                let totalTimeParagraph = document.getElementById('total-time');
                if (!totalTimeParagraph) {
                    totalTimeParagraph = document.createElement('p');
                    totalTimeParagraph.id = 'total-time';
                    totalTimeParagraph.style.color = '#0cf';
                    totalTimeParagraph.style.marginTop = '10px';
                    totalTimeParagraph.style.textAlign = 'center';
                    setlistSection.appendChild(totalTimeParagraph);
                }

                totalTimeParagraph.textContent = `Tiempo total del set: ${totalDuration}`;

                return songs;
            } catch (err) {
                console.error('Error al cargar el setlist:', err);
                document.getElementById('setlist-body').innerHTML = '<tr><td colspan="4">Error al cargar el setlist.</td></tr>';
                return [];
            }
        }

        async function descargarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(14);
            doc.text("Setlist - El Sótano del Doctor", 20, 20);

            // Cargamos los datos y sumamos la duración
            const songs = await cargarSetlist();

            // Construimos la tabla para el PDF
            const columns = ["Título", "Tonalidad", "Tempo", "Duración"];
            const rows = songs.map(s => [
                s.name || '',
                s.key || '',
                s.tempo || '',
                s.duration || ''
            ]);

            doc.autoTable({
                head: [columns],
                body: rows,
                startY: 30,
                styles: { halign: 'left' },
                headStyles: { fillColor: [0, 255, 255], textColor: 0 }
            });

            doc.save("setlist_ElSotanoDelDoctor.pdf");
        }

        // Evento para el botón de descargar
        document.getElementById('download-btn').addEventListener('click', descargarPDF);

        // Cargamos la lista de canciones y calculamos duraciones al cargar la página
        cargarSetlist();
    </script>
</body>
</html>
