<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>El Sótano del Doctor – Uso Interno</title>

  <!-- METADATOS PARA PREVIA EN REDES -->
  <meta property="og:title" content="El Sótano del Doctor – Uso Interno" />
  <meta property="og:description" content="Banda de rock y versiones. Explora nuestro setlist, fechas de conciertos y mucho más. ¡Disfruta de la música!" />
  <meta property="og:image" content="assets/logo_negro copia.jpg" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://tusitioweb.com" />

  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:title" content="El Sótano del Doctor – Uso Interno"/>
  <meta name="twitter:description" content="Banda de rock y versiones. Explora nuestro setlist, fechas de conciertos y mucho más. ¡Disfruta de la música!"/>
  <meta name="twitter:image" content="assets/logo_negro copia.jpg"/>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Librerías jsPDF y autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js"></script>

  <style>
    /* Reseteo y box-sizing */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #000;
      color: #fff;
    }

    /* CABECERA */
    header {
      background-color: #111;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo img {
      width: 180px;
      height: auto;
    }

    /* BOTÓN HAMBURGER */
    .hamburger {
      cursor: pointer;
      border: 1px solid #0cf;
      border-radius: 4px;
      padding: 5px;
    }
    .hamburger div {
      width: 25px;
      height: 3px;
      background-color: #0cf;
      margin: 4px 0;
    }

    /* MENÚ LATERAL (SIDEBAR) */
    .sidebar {
      position: fixed;
      top: 0; 
      left: 0;
      width: 250px;
      height: 100%;
      background-color: #111;
      border-right: 1px solid #222;
      padding: 20px;
      box-shadow: 2px 0 10px rgba(0, 255, 255, 0.1);
      transform: translateX(-250px);
      transition: transform 0.3s ease;
      z-index: 9999;
    }
    .sidebar.show {
      transform: translateX(0);
    }
    .sidebar h2 {
      color: #0cf;
      margin-top: 0;
    }
    .sidebar a {
      display: block;
      color: #fff;
      text-decoration: none;
      margin: 10px 0;
      padding: 5px 0;
      border-bottom: 1px solid #222;
    }
    .sidebar a:hover {
      color: #0cf;
    }

    /* OVERLAY (FONDO OSCURO) */
    #overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9998;
      display: none;
    }
    #overlay.show {
      display: block;
    }

    /* PANTALLA DE CONFIGURACIÓN */
    .config-screen {
      display: none; 
      position: fixed; 
      top: 0; left: 0;
      width: 100%; 
      height: 100%;
      background-color: #000; 
      z-index: 9999; 
      overflow-y: auto; 
      padding: 60px 20px 20px 20px;
    }
    .config-screen h2 {
      text-align: center; 
      margin-bottom: 20px;
      color: #0cf;
    }
    .config-screen label {
      display: block;
      margin: 10px 0 5px 0;
    }
    .config-screen input, .config-screen select {
      width: 100%; 
      max-width: 400px; 
      padding: 10px;
      background-color: #222;
      color: #fff;
      border: 1px solid #333;
      border-radius: 5px;
    }
    .config-screen button {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #0cf;
      color: #000;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .config-screen button:hover {
      background-color: #09b;
    }
    .config-screen .close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 1.2em;
      background: none;
      border: 1px solid #0cf;
      color: #0cf;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
    }
    .config-screen .close-btn:hover {
      background-color: #333;
    }

    /* CONTENIDO PRINCIPAL */
    main section {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* SETLISTS */
    #setlists, #second-setlist {
      background-color: #111;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.1);
      margin-bottom: 40px;
    }
    #setlists h2, #second-setlist h2 {
      text-align: center;
      color: #0cf;
      margin-bottom: 15px;
    }
    #setlists table, #second-list-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      color: #fff;
      font-size: 0.95em;
    }
    #setlists thead, #second-list-table thead {
      background-color: #222;
      color: #0cf;
    }
    #setlists th, #setlists td, #second-list-table th, #second-list-table td {
      padding: 12px;
      border: 1px solid #333;
      text-align: left;
    }
    #setlists tr:nth-child(even), #second-list-table tr:nth-child(even) {
      background-color: #1a1a1a;
    }
    .download-btn {
      display: block;
      margin: 20px auto 0 auto;
      padding: 10px 20px;
      font-size: 1em;
      background-color: #0cf;
      color: #000;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .download-btn:hover {
      background-color: #09b;
    }
    #total-time, #total-time-2 {
      color: #0cf;
      margin-top: 10px;
      text-align: center;
    }

    /* USUARIOS */
    #usuarios {
      background-color: #111;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,255,255,0.1);
      margin-bottom: 40px;
    }
    #usuarios h2 {
      text-align: center;
      color: #0cf;
      margin-bottom: 10px;
    }
    #usuarios table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      color: #fff;
      font-size: 0.95em;
    }
    #usuarios thead {
      background-color: #222;
      color: #0cf;
    }
    #usuarios th, #usuarios td {
      padding: 12px;
      border: 1px solid #333;
      text-align: left;
    }
    #usuarios tr:nth-child(even) {
      background-color: #1a1a1a;
    }

    /* ENSAYOS */
    #rehearsals {
      background-color: #111;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,255,255,0.1);
      margin-bottom: 40px;
    }
    #rehearsals h2 {
      text-align: center;
      color: #0cf;
      margin-bottom: 10px;
    }
    #rehearsals table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      color: #fff;
      font-size: 0.95em;
    }
    #rehearsals thead {
      background-color: #222;
      color: #0cf;
    }
    #rehearsals th, #rehearsals td {
      padding: 12px;
      border: 1px solid #333;
      text-align: left;
    }
    #rehearsals tr:nth-child(even) {
      background-color: #1a1a1a;
    }

    /* CALENDARIO */
    #calendario {
      background-color: #111;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,255,255,0.1);
      margin-bottom: 40px;
    }
    #calendario h2 {
      text-align: center;
      color: #0cf;
      margin-bottom: 10px;
    }
    #calendario p {
      text-align: center;
      color: #aaa;
      margin-bottom: 20px;
    }

    /* FOOTER */
    footer {
      background-color: #111;
      color: #888;
      text-align: center;
      padding: 10px;
      border-top: 1px solid #222;
    }

    /* MEDIA QUERIES */
    @media (max-width: 768px) {
      .hamburger div {
        width: 20px;
      }
    }
  </style>
</head>

<body>
  <!-- CABECERA -->
  <header>
    <div class="logo">
      <img src="assets/logo_blanco.png" alt="Logo de El Sótano del Doctor" />
    </div>
    <div class="hamburger" id="hamburger-btn">
      <div></div>
      <div></div>
      <div></div>
    </div>
  </header>

  <!-- OVERLAY -->
  <div id="overlay"></div>

  <!-- MENÚ LATERAL -->
  <nav class="sidebar" id="sidebar-menu">
    <h2>Menú</h2>
    <a href="#" id="menu-setlist-config">Configurar Setlists</a>
    <a href="#" id="menu-user-mgmt">Gestión de Usuarios</a>
    <a href="#" id="menu-rehearsal">Asignar Ensayos</a>
    <a href="#" id="menu-cerrar">Cerrar Menú</a>
  </nav>

  <!-- PANTALLA CONFIGURACIÓN SETLISTS -->
  <div id="setlist-config-screen" class="config-screen">
    <button class="close-btn" id="close-setlist-config">Cerrar</button>
    <h2>Configuración de Setlists</h2>
    <h3>Segundo Setlist</h3>
    <label for="setlist2-name">Nombre del Setlist</label>
    <input type="text" id="setlist2-name" placeholder="Ej: Concierto Navidad" />
    <label for="setlist2-url">ID/URL del feed</label>
    <input type="text" id="setlist2-url" placeholder="Ej: TXHvyb o URL completa" />
    <button id="guardar-setlist-config">Guardar Configuración</button>
  </div>

  <!-- PANTALLA GESTIÓN DE USUARIOS -->
  <div id="user-mgmt-screen" class="config-screen">
    <button class="close-btn" id="close-user-mgmt">Cerrar</button>
    <h2>Gestión de Usuarios</h2>
    <label for="user-name">Nombre</label>
    <input type="text" id="user-name" placeholder="Nombre del usuario" />
    <label for="user-role">Rol</label>
    <select id="user-role">
      <option value="admin">Administrador</option>
      <option value="member">Miembro</option>
    </select>
    <label for="user-mission">Misión</label>
    <select id="user-mission" multiple>
      <option value="Cantante">Cantante</option>
      <option value="Batería">Batería</option>
      <option value="Bajo">Bajo</option>
      <option value="Teclados">Teclados</option>
      <option value="Dirección Musical">Dirección Musical</option>
      <option value="Saxo">Saxo</option>
      <option value="Coros">Coros</option>
      <option value="Guitarra Rítmica">Guitarra Rítmica</option>
      <option value="Guitarra Acústica">Guitarra Acústica</option>
      <option value="Guitarra Solista">Guitarra Solista</option>
      <option value="Técnico de Sonido">Técnico de Sonido</option>
    </select>
    <button id="add-user">Añadir Usuario</button>
    <table id="user-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Rol</th>
          <th>Misión</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="user-table-body"></tbody>
    </table>
  </div>

  <!-- PANTALLA ASIGNACIÓN DE ENSAYOS -->
  <div id="rehearsal-screen" class="config-screen">
    <button class="close-btn" id="close-rehearsal">Cerrar</button>
    <h2>Asignación de Ensayos</h2>
    <label for="rehearsal-date">Fecha</label>
    <input type="date" id="rehearsal-date" />
    <label for="rehearsal-time">Hora</label>
    <input type="time" id="rehearsal-time" />
    <label for="rehearsal-location">Lugar</label>
    <input type="text" id="rehearsal-location" placeholder="Ej: Estudio 1" />
    <button id="add-rehearsal">Añadir Ensayo</button>
    <table id="rehearsal-table">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Hora</th>
          <th>Lugar</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="rehearsal-table-body"></tbody>
    </table>
  </div>

  <!-- CONTENIDO PRINCIPAL -->
  <main>
    <!-- 1) PRIMER SETLIST -->
    <section id="setlists">
      <h2 id="setlist1-title">Setlist Ensayos -Año 2025-</h2>
      <p style="text-align:center; color:#aaa;">
        Consulta y exporta el setlist de ensayos en tiempo real.
      </p>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Título</th>
            <th>Tonalidad</th>
            <th>Tempo</th>
            <th>Duración</th>
          </tr>
        </thead>
        <tbody id="setlist-body"></tbody>
      </table>
      <button class="download-btn" id="download-btn">Descargar PDF</button>
      <p id="total-time"></p>
    </section>

    <!-- 2) SEGUNDO SETLIST -->
    <section id="second-setlist">
      <h2 id="setlist2-title">Setlist Próximo Concierto</h2>
      <p style="text-align:center; color:#aaa;">
        Feed actual: <em id="url-actual"></em>
      </p>
      <table id="second-list-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Canción</th>
            <th>Tonalidad</th>
            <th>Tempo</th>
            <th>Duración</th>
          </tr>
        </thead>
        <tbody id="second-body"></tbody>
      </table>
      <button class="download-btn" id="download-btn-2">Descargar PDF</button>
      <p id="total-time-2"></p>
    </section>

    <!-- 3) USUARIOS -->
    <section id="usuarios">
      <h2>Usuarios Registrados</h2>
      <p style="text-align:center; color:#aaa;">
        Lista de usuarios con acceso a la intranet.
      </p>
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Rol</th>
            <th>Misión</th>
          </tr>
        </thead>
        <tbody id="users-body"></tbody>
      </table>
    </section>

    <!-- 4) ENSAYOS -->
    <section id="rehearsals">
      <h2>Próximos Ensayos</h2>
      <p style="text-align:center; color:#aaa;">
        Lista de próximos ensayos.
      </p>
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Lugar</th>
          </tr>
        </thead>
        <tbody id="rehearsals-body"></tbody>
      </table>
    </section>

    <!-- 5) CALENDARIO -->
    <section id="calendario">
      <h2>Próximos Conciertos</h2>
      <p>Consulta el calendario actualizado.</p>
      <div>
        <script type="text/javascript" 
          src="https://www.bandhelper.com/widget/calendar/10353?range=6">
        </script>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer>
    © 2025 El Sótano del Doctor. All Rights Reserved.
  </footer>

  <script>
    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIZAsyA7d70p3aEA218PLWE5_DBMFEtoHXfyvNg",
      authDomain: "el-sotano-del-doctor.firebaseapp.com",
      projectId: "el-sotano-del-doctor",
      storageBucket: "el-sotano-del-doctor.firestorestorage.app",
      messagingSenderId: "288654488846",
      appId: "1:288654488846:web:51a7264676afe8ba8635f",
      measurementId: "G-5N8G5GCW1"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /*------------------------------------------
      1. FUNCIONES COMUNES
    ------------------------------------------*/
    function parseDurationToSeconds(durationStr) {
      if (!durationStr) return 0;
      if (durationStr.includes(':')) {
        const [min, sec] = durationStr.split(':').map(num => parseInt(num, 10));
        return (min * 60) + (sec || 0);
      } else {
        const seconds = parseInt(durationStr, 10);
        return isNaN(seconds) ? 0 : seconds;
      }
    }
    function formatSecondsToMMSS(totalSeconds) {
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      return `${minutes}:${String(seconds).padStart(2, '0')}`;
    }
    function cleanString(str) {
      if (!str) return '';
      return str.replace(/[^\x00-\xFF]/g, '').trim();
    }

    /*------------------------------------------
      2. CONFIGURACIÓN DE SETLISTS
    ------------------------------------------*/
    let setlistConfig = {
      setlist1: { name: 'Setlist Ensayos -Año 2025-', url: 'https://cold-limit-811a.jagomezc.workers.dev' },
      setlist2: { name: 'Setlist Próximo Concierto', url: 'https://www.bandhelper.com/feed/set_list/TXHvyb' }
    };

    async function loadSetlistConfig() {
      try {
        const doc = await db.collection('config').doc('setlists').get();
        if (doc.exists) {
          setlistConfig = doc.data();
        } else {
          // Valores por defecto si no existe el documento
          await db.collection('config').doc('setlists').set(setlistConfig);
        }
        updateSetlistTitles();
      } catch (err) {
        console.error('Error al cargar configuración de setlists:', err);
      }
    }

    async function saveSetlistConfig() {
      try {
        await db.collection('config').doc('setlists').set(setlistConfig);
        updateSetlistTitles();
      } catch (err) {
        console.error('Error al guardar configuración de setlists:', err);
        alert('Error al guardar configuración de setlists.');
      }
    }

    function updateSetlistTitles() {
      document.getElementById('setlist1-title').textContent = setlistConfig.setlist1.name;
      document.getElementById('setlist2-title').textContent = setlistConfig.setlist2.name;
    }

    /*------------------------------------------
      3. PRIMER SETLIST
    ------------------------------------------*/
    async function cargarPrimerSetlist() {
      try {
        document.getElementById('setlist-body').innerHTML = '<tr><td colspan="5">Cargando...</td></tr>';
        const res = await fetch(setlistConfig.setlist1.url);
        const data = await res.json();
        const tbody = document.getElementById('setlist-body');
        tbody.innerHTML = '';
        const songs = data.filter(item => item.type === 'song');
        let totalSeconds = 0;

        songs.forEach((song, i) => {
          const secs = parseDurationToSeconds(song.duration || '');
          const durFmt = formatSecondsToMMSS(secs);
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${i + 1}</td>
            <td>${song.name || ''}</td>
            <td>${song.key || ''}</td>
            <td>${song.tempo || ''}</td>
            <td>${durFmt}</td>
          `;
          tbody.appendChild(row);
          totalSeconds += secs;
        });

        document.getElementById('total-time').textContent =
          'Tiempo total del set: ' + formatSecondsToMMSS(totalSeconds);
        return songs;
      } catch (err) {
        console.error('Error al cargar el primer setlist:', err);
        document.getElementById('setlist-body').innerHTML =
          '<tr><td colspan="5">Error al cargar el primer setlist.</td></tr>';
        return [];
      }
    }

    async function descargarPDFprimerSetlist() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'A4' });
      const songs = await cargarPrimerSetlist();

      try {
        const imgUrl = 'assets/logo_negro copia.jpg';
        const imgRes = await fetch(imgUrl);
        const imgBlob = await imgRes.blob();
        const reader = new FileReader();
        const base64Promise = new Promise((resolve, reject) => {
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
        });
        reader.readAsDataURL(imgBlob);
        const base64Img = await base64Promise;
        doc.addImage(base64Img, 'JPEG', 40, 30, 60, 60);
      } catch (err) {
        console.warn('No se pudo cargar el logo (primer setlist):', err);
      }

      doc.setFontSize
