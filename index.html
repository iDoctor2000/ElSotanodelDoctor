<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>El Sótano del Doctor</title>

    <!-- ... Head original ... -->

    <style>
        /* Tus estilos originales */
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #111;
            padding: 20px;
            text-align: center;
        }
        header img {
            width: 300px;
            height: auto;
        }
        main {
            padding: 20px;
        }
        section {
            margin-bottom: 50px;
            padding: 20px;
            background-color: #111;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.1);
        }
        h2 {
            border-bottom: 2px solid #0cf;
            color: #0cf;
            padding-bottom: 10px;
            font-size: 1.8em;
            text-align: center;
        }
        p {
            color: #aaa;
            font-size: 1em;
            line-height: 1.5;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            color: #fff;
            font-size: 0.95em;
        }
        thead {
            background-color: #222;
            color: #0cf;
        }
        th, td {
            padding: 12px;
            border: 1px solid #333;
            text-align: left;
        }
        tr:nth-child(even) {
            background-color: #1a1a1a;
        }
        #download-btn {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 1em;
            background-color: #0cf;
            color: #000;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        footer {
            background-color: #111;
            color: #888;
            text-align: center;
            padding: 20px;
            font-size: 0.9em;
            border-top: 1px solid #222;
        }
    </style>
</head>
<body>
    <header>
        <img src="assets/logo_blanco.png" alt="El Sótano del Doctor logo" />
    </header>
    <main>
        <section id="setlists">
            <h2>🎼 Setlists Ensayos 2025 🎶</h2>
            <p>Consulta los setlists en tiempo real desde BandHelper:</p>
            <table>
                <thead>
                    <tr>
                        <th>Título</th>
                        <th>Tonalidad</th>
                        <th>Tempo</th>
                        <th>Duración</th>
                    </tr>
                </thead>
                <tbody id="setlist-body"></tbody>
            </table>

            <button id="download-btn">📥 Descargar PDF del setlist</button>
            <p style="margin-top:10px; font-size: 0.9em; color: #888;">🎧 Setlist actualizado en tiempo real desde la app</p>
        </section>

        <section id="calendario" style="padding: 30px; margin-bottom: 50px;">
            <h2 style="text-align: center; color: #0cf;">📅 Próximos conciertos</h2>
            <p style="text-align: center; color: #aaa;">Consulta nuestro calendario actualizado desde BandHelper</p>
            <div style="background-color: #111; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,255,255,0.1);">
                <script type="text/javascript" src="https://www.bandhelper.com/widget/calendar/10353?range=6"></script>
            </div>
        </section>
    </main>
    <footer>
        © 2025 El Sótano del Doctor. Todos los derechos reservados.
    </footer>

    <!-- Librerías jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script>
        const url = 'https://cold-limit-811a.jagomezc.workers.dev';

        // Aquí pon tu propio LOGO en Base64 (este es un placeholder):
        const LOGO_BASE64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABS0lEQVR4nKWSv0uUURSGnx2/GAZdjB0skEBBeihzUDa0QLC0sgp0WA0YZtQpKyoE5NGwoZHZOr0RtEJMoBVKriytTHhHXP+Oyze3o/H85c+aczgCgKcYvpCqzCeR6Lx46HNBaEPoWqJ7F/i3gkcMLWcTUYR6O4zh51Gl8B1h2j+S4rERZxdh+Gd20p7b+VZ7gdCIEO6vslR0K3+IftDc88319HbB3HksmhWR0pU1pZqx81LB2HuR+pINwN0mn7rqvp23Y2AglccCyiHn6SxLa7cBYb6yUm80qt1PFyfvf0IPo3DXOpIcLBttx6AOc5D6K6bT43gGxbnY5rzNPU8XWp+gdY2FUvEF4wa1DpG95HJ6ZbDYzgDX+pT8z5agQAAAABJRU5ErkJggg==";

        // Función que interpreta "mm:ss" o un número de segundos
        function parseDurationToSeconds(durationStr) {
            if (!durationStr) return 0;
            if (durationStr.includes(":")) {
                const [min, sec] = durationStr.split(":").map(num => parseInt(num, 10));
                return (min * 60) + (sec || 0);
            } else {
                const seconds = parseInt(durationStr, 10);
                return isNaN(seconds) ? 0 : seconds;
            }
        }

        // Función para convertir segundos a "mm:ss"
        function formatSecondsToMMSS(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${String(seconds).padStart(2, '0')}`;
        }

        // Cargar setlist y pintar tabla
        async function cargarSetlist() {
            try {
                const res = await fetch(url);
                const data = await res.json();
                const tbody = document.getElementById('setlist-body');
                tbody.innerHTML = '';

                const songs = data.filter(item => item.type === 'song');
                let totalSeconds = 0;

                songs.forEach(song => {
                    const rawDuration = song.duration || ''; 
                    const durationInSeconds = parseDurationToSeconds(rawDuration);
                    const durationFormatted = formatSecondsToMMSS(durationInSeconds);

                    // Creamos la fila
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${song.name || ''}</td>
                        <td>${song.key || ''}</td>
                        <td>${song.tempo || ''}</td>
                        <td>${durationFormatted}</td>
                    `;
                    tbody.appendChild(row);

                    totalSeconds += durationInSeconds;
                });

                // Tiempo total
                const totalDuration = formatSecondsToMMSS(totalSeconds);
                const setlistSection = document.getElementById('setlists');

                let totalTimeParagraph = document.getElementById('total-time');
                if (!totalTimeParagraph) {
                    totalTimeParagraph = document.createElement('p');
                    totalTimeParagraph.id = 'total-time';
                    totalTimeParagraph.style.color = '#0cf';
                    totalTimeParagraph.style.marginTop = '10px';
                    totalTimeParagraph.style.textAlign = 'center';
                    setlistSection.appendChild(totalTimeParagraph);
                }
                totalTimeParagraph.textContent = `Tiempo total del set: ${totalDuration}`;

                return songs;
            } catch (err) {
                console.error('Error al cargar el setlist:', err);
                document.getElementById('setlist-body').innerHTML = '<tr><td colspan="4">Error al cargar el setlist.</td></tr>';
                return [];
            }
        }

        // Generar PDF vistoso
        async function descargarPDF() {
            // 1. Obtenemos la lista de canciones
            const songs = await cargarSetlist();

            // 2. Calculamos la duración total
            let totalSeconds = 0;
            songs.forEach(s => {
                const durSeg = parseDurationToSeconds(s.duration);
                totalSeconds += durSeg;
            });
            const totalFormatted = formatSecondsToMMSS(totalSeconds);

            // 3. Configuramos jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'pt',
                format: 'A4'
            });

            // Metadatos opcionales
            doc.setProperties({
                title: "Setlist - El Sótano del Doctor",
                subject: "Setlist generado automáticamente",
                author: "El Sótano del Doctor"
            });

            // 4. Insertamos logo (Base64). Ajusta X, Y, width, height a tu gusto
            doc.addImage(LOGO_BASE64, 'PNG', 40, 20, 60, 60);

            // 5. Título y subtítulo
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            doc.text("Setlist - El Sótano del Doctor", 130, 40);

            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Tiempo total del set: ${totalFormatted}`, 130, 60);

            const startYpos = 100;

            // 6. Preparamos la tabla
            // Columnas
            const columns = [
                { header: 'Título', dataKey: 'name' },
                { header: 'Tonalidad', dataKey: 'key' },
                { header: 'Tempo', dataKey: 'tempo' },
                { header: 'Duración', dataKey: 'duration' }
            ];

            // Filas
            const rows = songs.map(song => {
                // De nuevo parseamos por si hay formato en segundos
                const durSeg = parseDurationToSeconds(song.duration || '');
                const durFormatted = formatSecondsToMMSS(durSeg);
                return {
                    name: song.name || '',
                    key: song.key || '',
                    tempo: song.tempo || '',
                    duration: durFormatted
                };
            });

            // 7. autoTable con tema 'striped'
            doc.autoTable({
                startY: startYpos,
                head: [columns.map(col => col.header)],
                body: rows.map(row => Object.values(row)),
                theme: 'striped',
                headStyles: {
                    fillColor: [0, 255, 255], // cian
                    textColor: [0, 0, 0],
                    fontSize: 12,
                    fontStyle: 'bold'
                },
                bodyStyles: {
                    fontSize: 11,
                    cellPadding: 6
                },
                alternateRowStyles: {
                    fillColor: [240, 240, 240]
                },
                columnStyles: {
                    0: { cellWidth: 170 },
                    1: { cellWidth: 70 },
                    2: { cellWidth: 60 },
                    3: { cellWidth: 70 }
                },
                margin: { left: 40, right: 40 }
            });

            // 8. Pie de página con número de páginas
            const pageCount = doc.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(
                    `Página ${i} de ${pageCount}`,
                    doc.internal.pageSize.getWidth() - 80,
                    doc.internal.pageSize.getHeight() - 20
                );
            }

            // 9. Guardamos
            doc.save("setlist_ElSotanoDelDoctor.pdf");
        }

        // Evento del botón y carga inicial
        document.getElementById('download-btn').addEventListener('click', descargarPDF);
        cargarSetlist(); 
    </script>
</body>
</html>