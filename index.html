<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>El Sótano del Doctor - PDF mejorado</title>
</head>
<body>
    <h1>Ejemplo de PDF con estilo</h1>
    <button id="download-btn">Descargar PDF vistoso</button>

    <!-- jsPDF y jsPDF-Autotable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script>
      // EJEMPLO DE LOGO EN BASE64 (PNG). Sustitúyelo por tu cadena real
      const LOGO_BASE64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAA...";

      // Datos de ejemplo para la tabla. Tú obtendrás 'songs' con fetch
      const songsEjemplo = [
        { name: "Canción 1", key: "C", tempo: "120", duration: "3:30" },
        { name: "Canción 2", key: "Am", tempo: "130", duration: "4:10" },
        { name: "Canción 3", key: "G", tempo: "90",  duration: "2:50" },
        // ...
      ];

      function parseDurationToSeconds(durationStr) {
        if (!durationStr) return 0;
        if (durationStr.includes(":")) {
          const [min, sec] = durationStr.split(":").map(num => parseInt(num, 10));
          return (min * 60) + (sec || 0);
        } else {
          const seconds = parseInt(durationStr, 10);
          return isNaN(seconds) ? 0 : seconds;
        }
      }

      function formatSecondsToMMSS(totalSeconds) {
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${minutes}:${String(seconds).padStart(2, '0')}`;
      }

      // Generar PDF
      async function descargarPDF() {
        // Normalmente aquí harías tu fetch a la API y tendrías 'songs' reales
        // const res = await fetch("TU_URL");
        // const data = await res.json();
        // const songs = data.filter(item => item.type === 'song');

        // Para la demo, uso songsEjemplo:
        const songs = songsEjemplo;

        // Calculamos la duración total
        let totalSeconds = 0;
        songs.forEach(s => {
          totalSeconds += parseDurationToSeconds(s.duration);
        });
        const totalFormatted = formatSecondsToMMSS(totalSeconds);

        // Configuración inicial de jsPDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: 'portrait',
          unit: 'pt',   // points (más preciso para maquetación)
          format: 'A4'  // o 'letter'
        });
        
        // Propiedades del PDF (opcional)
        doc.setProperties({
          title: "Setlist - El Sótano del Doctor",
          subject: "Setlist generado automáticamente",
          author: "El Sótano del Doctor"
        });

        // Insertamos el LOGO (base64). Ajusta posición y tamaño a tu gusto
        // x=40, y=20, width=80, height=80 (por ejemplo)
        doc.addImage(LOGO_BASE64, 'PNG', 40, 20, 60, 60);

        // TÍTULO (dejamos hueco para el logo)
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(18);
        doc.text("Setlist - El Sótano del Doctor", 130, 40); 
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text(`Tiempo total: ${totalFormatted}`, 130, 60);

        // Ajustamos la posición inicial de la tabla (startY) para no pisar el logo
        const startYpos = 100; 

        // Preparamos las columnas y filas para autoTable
        const columns = [
          { header: 'Título', dataKey: 'name' },
          { header: 'Tonalidad', dataKey: 'key' },
          { header: 'Tempo', dataKey: 'tempo' },
          { header: 'Duración', dataKey: 'duration' }
        ];
        const rows = songs.map(s => ({
          name: s.name || '',
          key: s.key || '',
          tempo: s.tempo || '',
          duration: s.duration || ''
        }));

        // autoTable con tema striped
        doc.autoTable({
          startY: startYpos,
          head: [columns.map(col => col.header)],
          body: rows.map(r => Object.values(r)),
          theme: 'striped', // "striped", "grid" o "plain"
          headStyles: {
            fillColor: [0, 255, 255],  // cian
            textColor: [0, 0, 0],
            fontSize: 12,
            fontStyle: 'bold'
          },
          bodyStyles: {
            fontSize: 11,
            cellPadding: 6
          },
          alternateRowStyles: {
            fillColor: [240, 240, 240] // gris clarito
          },
          // Mapeamos ancho de columnas si quieres
          columnStyles: {
            0: { cellWidth: 150 }, // Título
            1: { cellWidth: 80 },
            2: { cellWidth: 60 },
            3: { cellWidth: 80 }
          },
          // Dimensiones totales
          tableWidth: 'auto',
          margin: { left: 40, right: 40 }
        });

        // Añadimos pie de página (opcional)
        const pageCount = doc.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(10);
          doc.setTextColor(100);
          doc.text(`Página ${i} de ${pageCount}`, doc.internal.pageSize.getWidth() - 80, doc.internal.pageSize.getHeight() - 20);
        }

        // Guardamos el PDF
        doc.save("setlist_ElSotanoDelDoctor.pdf");
      }

      // Escuchar el botón
      document.getElementById('download-btn').addEventListener('click', descargarPDF);
    </script>
</body>
</html>