<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>El Sótano del Doctor – Uso Interno</title>

  <!-- METADATOS PARA VISTA PREVIA EN REDES (Open Graph / Telegram / WhatsApp) -->
  <meta property="og:title" content="El Sótano del Doctor – Uso Interno" />
  <meta property="og:description" content="Banda de rock y versiones. Explora nuestro setlist, fechas de conciertos y mucho más. ¡Disfruta de la música!" />
  <meta property="og:image" content="assets/logo_negro copia.jpg" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://tusitioweb.com" />
  <!-- Ajusta la URL a la que usarás realmente (si es accesible externamente) -->

  <!-- (Opcional) Metadatos Twitter Card -->
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:title" content="El Sótano del Doctor – Uso Interno"/>
  <meta name="twitter:description" content="Banda de rock y versiones. Explora nuestro setlist, fechas de conciertos y mucho más. ¡Disfruta de la música!"/>
  <meta name="twitter:image" content="assets/logo_negro copia.jpg"/>

  <!-- Ajuste para que sea responsive en móvil -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Librerías jsPDF para exportar el setlist a PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* Estilos mínimos para el cuerpo */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #000; /* Fondo negro */
      color: #fff;            /* Texto blanco */
    }

    /* Encabezado */
    header {
      background-color: #111;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    header img {
      width: 180px;
      height: auto;
    }

    /* Sección Setlist */
    section {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    #setlists {
      background-color: #111;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.1);
      margin-bottom: 40px;
    }
    #setlists h2 {
      text-align: center;
      color: #0cf;
      margin-bottom: 15px;
    }
    #setlists table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      color: #fff;
      font-size: 0.95em;
    }
    #setlists thead {
      background-color: #222;
      color: #0cf;
    }
    #setlists th, #setlists td {
      padding: 12px;
      border: 1px solid #333;
      text-align: left;
    }
    #setlists tr:nth-child(even) {
      background-color: #1a1a1a;
    }
    #download-btn {
      display: block;
      margin: 20px auto 0 auto;
      padding: 10px 20px;
      font-size: 1em;
      background-color: #0cf;
      color: #000;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #total-time {
      color: #0cf;
      margin-top: 10px;
      text-align: center;
    }

    /* Sección Calendario BandHelper */
    #calendario {
      background-color: #111;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,255,255,0.1);
      margin-bottom: 40px;
    }
    #calendario h2 {
      text-align: center;
      color: #0cf;
      margin-bottom: 10px;
    }
    #calendario p {
      text-align: center;
      color: #aaa;
      margin-bottom: 20px;
    }

    /* Footer */
    footer {
      background-color: #111;
      color: #888;
      text-align: center;
      padding: 10px;
      border-top: 1px solid #222;
    }
  </style>
</head>
<body>
  <!-- Encabezado con logo BLANCO para fondo negro -->
  <header>
    <img src="assets/logo_blanco.png" alt="Logo de El Sótano del Doctor" />
  </header>

  <!-- Contenedor principal -->
  <main>
    <!-- Sección SETLISTS -->
    <section id="setlists">
      <h2>Setlist Ensayos 2025</h2>
      <p style="text-align:center; color:#aaa;">
        Consulta y exporta el setlist en tiempo real (uso interno).
      </p>
      <table>
        <thead>
          <tr>
            <th>Título</th>
            <th>Tonalidad</th>
            <th>Tempo</th>
            <th>Duración</th>
          </tr>
        </thead>
        <tbody id="setlist-body">
          <!-- Filas generadas dinámicamente por JavaScript -->
        </tbody>
      </table>
      <button id="download-btn">Descargar PDF del setlist</button>
      <p id="total-time"></p>
    </section>

    <!-- Sección Calendario de Conciertos -->
    <section id="calendario">
      <h2>Próximos Conciertos</h2>
      <p>Consulta el calendario actualizado de forma interna.</p>
      <div>
        <!-- Script de BandHelper o widget insertado aquí -->
        <script type="text/javascript" src="https://www.bandhelper.com/widget/calendar/10353?range=6"></script>
      </div>
    </section>
  </main>

  <!-- Footer mínimo -->
  <footer>
    © 2025 El Sótano del Doctor. Uso interno.
  </footer>

  <!-- =========================
       Scripts principales
  ========================== -->

  <!-- (1) Carga y manejo del SETLIST en tiempo real -->
  <script>
    const url = 'https://cold-limit-811a.jagomezc.workers.dev';

    function parseDurationToSeconds(durationStr) {
      if (!durationStr) return 0;
      // Si incluye ":", interpretamos mm:ss
      if (durationStr.includes(':')) {
        const [min, sec] = durationStr.split(':').map(num => parseInt(num, 10));
        return (min * 60) + (sec || 0);
      } else {
        // Si no, es un número de segundos
        const seconds = parseInt(durationStr, 10);
        return isNaN(seconds) ? 0 : seconds;
      }
    }

    function formatSecondsToMMSS(totalSeconds) {
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      return `${minutes}:${String(seconds).padStart(2, '0')}`;
    }

    async function cargarSetlist() {
      try {
        const res = await fetch(url);
        const data = await res.json();
        const tbody = document.getElementById('setlist-body');
        tbody.innerHTML = '';

        // Filtramos solo los items que sean "song"
        const songs = data.filter(item => item.type === 'song');
        let totalSeconds = 0;

        songs.forEach(song => {
          const rawDuration = song.duration || '';
          const durationInSeconds = parseDurationToSeconds(rawDuration);
          const durationFormatted = formatSecondsToMMSS(durationInSeconds);

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${song.name || ''}</td>
            <td>${song.key || ''}</td>
            <td>${song.tempo || ''}</td>
            <td>${durationFormatted}</td>
          `;
          tbody.appendChild(row);

          totalSeconds += durationInSeconds;
        });

        // Mostramos tiempo total
        const totalTimeParagraph = document.getElementById('total-time');
        totalTimeParagraph.textContent =
          'Tiempo total del set: ' + formatSecondsToMMSS(totalSeconds);

        return songs;
      } catch (err) {
        console.error('Error al cargar el setlist:', err);
        document.getElementById('setlist-body').innerHTML =
          '<tr><td colspan="4">Error al cargar el setlist.</td></tr>';
        return [];
      }
    }

    // (2) Exportar setlist a PDF
    async function descargarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text('Setlist - El Sótano del Doctor (Interno)', 20, 20);

      const songs = await cargarSetlist(); // Actualiza/obtiene el setlist

      const columns = ['Título', 'Tonalidad', 'Tempo', 'Duración'];
      const rows = songs.map(s => {
        const durationInSeconds = parseDurationToSeconds(s.duration || '');
        const durationFormatted = formatSecondsToMMSS(durationInSeconds);
        return [
          s.name || '',
          s.key || '',
          s.tempo || '',
          durationFormatted
        ];
      });

      doc.autoTable({
        head: [columns],
        body: rows,
        startY: 30,
        styles: { halign: 'left' },
        headStyles: { fillColor: [0, 255, 255], textColor: 0 }
      });

      doc.save('setlist_ElSotanoDelDoctor.pdf');
    }

    // (3) Listeners y carga inicial
    document.getElementById('download-btn').addEventListener('click', descargarPDF);
    cargarSetlist(); // Cargar al iniciar
  </script>
</body>
</html>
