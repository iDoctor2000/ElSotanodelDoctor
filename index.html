<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>El Sótano del Doctor</title>

    <!-- ... Head original ... -->

    <style>
        /* Tus estilos originales */
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #111;
            padding: 20px;
            text-align: center;
        }
        header img {
            width: 300px;
            height: auto;
        }
        main {
            padding: 20px;
        }
        section {
            margin-bottom: 50px;
            padding: 20px;
            background-color: #111;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.1);
        }
        h2 {
            border-bottom: 2px solid #0cf;
            color: #0cf;
            padding-bottom: 10px;
            font-size: 1.8em;
            text-align: center;
        }
        p {
            color: #aaa;
            font-size: 1em;
            line-height: 1.5;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            color: #fff;
            font-size: 0.95em;
        }
        thead {
            background-color: #222;
            color: #0cf;
        }
        th, td {
            padding: 12px;
            border: 1px solid #333;
            text-align: left;
        }
        tr:nth-child(even) {
            background-color: #1a1a1a;
        }
        #download-btn {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 1em;
            background-color: #0cf;
            color: #000;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        footer {
            background-color: #111;
            color: #888;
            text-align: center;
            padding: 20px;
            font-size: 0.9em;
            border-top: 1px solid #222;
        }
    </style>
</head>
<body>
    <header>
        <img src="assets/logo_blanco.png" alt="El Sótano del Doctor logo" />
    </header>
    <main>
        <section id="setlists">
            <h2>🎼 Setlists Ensayos 2025 🎶</h2>
            <p>Consulta los setlists en tiempo real desde BandHelper:</p>
            <table>
                <thead>
                    <tr>
                        <th>Título</th>
                        <th>Tonalidad</th>
                        <th>Tempo</th>
                        <th>Duración</th>
                    </tr>
                </thead>
                <tbody id="setlist-body"></tbody>
            </table>

            <button id="download-btn">📥 Descargar PDF del setlist</button>
            <p style="margin-top:10px; font-size: 0.9em; color: #888;">🎧 Setlist actualizado en tiempo real desde la app</p>
        </section>

        <section id="calendario" style="padding: 30px; margin-bottom: 50px;">
            <h2 style="text-align: center; color: #0cf;">📅 Próximos conciertos</h2>
            <p style="text-align: center; color: #aaa;">Consulta nuestro calendario actualizado desde BandHelper</p>
            <div style="background-color: #111; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,255,255,0.1);">
                <script type="text/javascript" src="https://www.bandhelper.com/widget/calendar/10353?range=6"></script>
            </div>
        </section>
    </main>
    <footer>
        © 2025 El Sótano del Doctor. Todos los derechos reservados.
    </footer>

    <!-- Librerías jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script>
        const url = 'https://cold-limit-811a.jagomezc.workers.dev';

        // Función que interpreta "mm:ss" o un número de segundos
        function parseDurationToSeconds(durationStr) {
            if (!durationStr) return 0;
            // Si hay ":", tratamos como "mm:ss"
            if (durationStr.includes(":")) {
                const [min, sec] = durationStr.split(":").map(num => parseInt(num, 10));
                return (min * 60) + (sec || 0);
            } else {
                // Si no hay ":", es un número de segundos
                const seconds = parseInt(durationStr, 10);
                return isNaN(seconds) ? 0 : seconds;
            }
        }

        // Función para convertir segundos a "mm:ss"
        function formatSecondsToMMSS(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${String(seconds).padStart(2, '0')}`;
        }

        async function cargarSetlist() {
            try {
                const res = await fetch(url);
                const data = await res.json();
                const tbody = document.getElementById('setlist-body');
                tbody.innerHTML = '';

                const songs = data.filter(item => item.type === 'song');
                let totalSeconds = 0;

                songs.forEach(song => {
                    // Aquí parseamos la duración original
                    const rawDuration = song.duration || ''; 
                    const durationInSeconds = parseDurationToSeconds(rawDuration);
                    const durationFormatted = formatSecondsToMMSS(durationInSeconds);

                    // Construimos la fila
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${song.name || ''}</td>
                        <td>${song.key || ''}</td>
                        <td>${song.tempo || ''}</td>
                        <td>${durationFormatted}</td>
                    `;
                    tbody.appendChild(row);

                    // Sumamos la duración
                    totalSeconds += durationInSeconds;
                });

                // Calculamos y mostramos el tiempo total
                const totalDuration = formatSecondsToMMSS(totalSeconds);
                const setlistSection = document.getElementById('setlists');

                let totalTimeParagraph = document.getElementById('total-time');
                if (!totalTimeParagraph) {
                    totalTimeParagraph = document.createElement('p');
                    totalTimeParagraph.id = 'total-time';
                    totalTimeParagraph.style.color = '#0cf';
                    totalTimeParagraph.style.marginTop = '10px';
                    totalTimeParagraph.style.textAlign = 'center';
                    setlistSection.appendChild(totalTimeParagraph);
                }
                totalTimeParagraph.textContent = `Tiempo total del set: ${totalDuration}`;

                return songs;
            } catch (err) {
                console.error('Error al cargar el setlist:', err);
                document.getElementById('setlist-body').innerHTML = '<tr><td colspan="4">Error al cargar el setlist.</td></tr>';
                return [];
            }
        }

        async function descargarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(14);
            doc.text("Setlist - El Sótano del Doctor", 20, 20);

            // Obtenemos la lista (y sumamos la duración de paso)
            const songs = await cargarSetlist();

            const columns = ["Título", "Tonalidad", "Tempo", "Duración"];
            const rows = songs.map(s => {
                // Volvemos a formatear para el PDF
                const durationInSeconds = parseDurationToSeconds(s.duration || '');
                const durationFormatted = formatSecondsToMMSS(durationInSeconds);
                return [
                    s.name || '',
                    s.key || '',
                    s.tempo || '',
                    durationFormatted
                ];
            });

            doc.autoTable({
                head: [columns],
                body: rows,
                startY: 30,
                styles: { halign: 'left' },
                headStyles: { fillColor: [0, 255, 255], textColor: 0 }
            });

            doc.save("setlist_ElSotanoDelDoctor.pdf");
        }

        // Listeners y carga inicial
        document.getElementById('download-btn').addEventListener('click', descargarPDF);
        cargarSetlist(); 
    </script>
</body>
</html>
