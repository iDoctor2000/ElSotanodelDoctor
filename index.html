<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>El Sótano del Doctor – Uso Interno</title>

  <!-- Favicon -->
  <link rel="icon" type="favicon_ElSotanoDr.ico" href="assets/favicon_ElSotanoDr.ico">
  <link rel="logo_negro copia.png" href="assets/logo_negro copia.png">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">

  <!-- Metadatos -->
  <meta property="og:title" content="El Sótano del Doctor – Uso Interno">
  <meta property="og:description" content="Banda de rock y versiones. Explora nuestro setlist, fechas de conciertos y más.">
  <meta property="og:image" content="assets/logo_negro copia.jpg">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://tusitioweb.com">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="El Sótano del Doctor – Uso Interno">
  <meta name="twitter:description" content="Banda de rock y versiones. Explora nuestro setlist, fechas de conciertos y mucho más. ¡Disfruta de la música!">
  <meta name="twitter:image" content="assets/logo_negro copia.jpg">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Librerías externas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Estilos -->
  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;padding:0;overflow-x:hidden;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff}
    header{background:#111;padding:20px;display:flex;align-items:center;justify-content:space-between;position:relative}
    .logo img.logo-main{width:180px;height:auto}
    .logo-intranet{position:absolute;left:50%;transform:translateX(-50%);height:60px;width:auto}
    .hamburger{cursor:pointer;border:1px solid #0cf;border-radius:4px;padding:5px}
    .hamburger div{width:25px;height:3px;background:#0cf;margin:4px 0}
    .sidebar{position:fixed;top:0;left:0;width:250px;height:100%;background:#111;border-right:1px solid #222;padding:20px;
             transform:translateX(-250px);transition:.3s;z-index:9999}
    .sidebar.show{transform:translateX(0)}
    .sidebar h2{color:#0cf;margin:0}
    .sidebar a{display:block;color:#fff;text-decoration:none;margin:10px 0;padding:5px 0;border-bottom:1px solid #222}
    .sidebar a:hover{color:#0cf}
    .sidebar .submenu{margin-left:15px;display:none}
    .sidebar .submenu.show{display:block}
    .sidebar .submenu a{font-size:0.95em}
    #overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:9998;display:none}
    #overlay.show{display:block}
    main section{max-width:1200px;margin:0 auto;padding:20px}
    #setlists,#rehearsals,#second-setlist,#calendario,#timeline,#usuarios{background:#111;padding:20px;border-radius:10px;
            box-shadow:0 0 20px rgba(0,255,255,.1);margin-bottom:40px}
    #setlists h2,#rehearsals h2,#second-setlist h2,#calendario h2,#timeline h2,#usuarios h2{text-align:center;color:#0cf;margin-bottom:15px}
    .table-wrapper{width:100%;overflow-x:auto;display:flex;justify-content:center}
    table{width:100%;max-width:100%;border-collapse:collapse;margin-top:20px;color:#fff;font-size:.95em;margin-left:auto;margin-right:auto}
    thead{background:#222;color:#0cf}
    th,td{padding:12px;border:1px solid #333;text-align:left;white-space:normal;word-wrap:break-word}
    tr:nth-child(even){background:#1a1a1a}
    .download-btn,.action-btn{display:block;margin:20px auto 0;padding:10px 20px;background:#0cf;color:#000;border:none;border-radius:8px;cursor:pointer}
    .action-btn{background:#f00}
    .action-btn.edit{background:#0cf}
    #total-time,#total-time-2{color:#0cf;margin-top:10px;text-align:center}
    #second-setlist-name{text-align:center;color:#aaa;margin-top:5px;font-style:italic}
    #timeline-container{overflow-x:auto;white-space:nowrap;padding:20px 0}
    #timeline{display:flex;flex-direction:row;align-items:center;height:150px;position:relative}
    .event{margin:0 20px;position:relative}
    .event span{display:inline-block;transform:rotate(-45deg);transform-origin:bottom left;font-size:0.9em;white-space:nowrap}
    .rehearsal span{font-style:italic}
    .concert span{font-weight:bold}
    .config-screen{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:9999;
                   overflow-y:auto;padding:80px 20px 20px}
    .config-screen h2{color:#0cf;text-align:center;margin:20px 0}
    .config-screen label{display:block;margin:10px 0 5px}
    .config-screen input,.config-screen select{width:100%;max-width:400px;padding:10px;background:#222;color:#fff;
                                              border:1px solid #333;border-radius:5px}
    .config-screen select[multiple]{height:150px}
    .config-screen button{margin-top:30px;padding:10px 20px;background:#0cf;color:#000;border:none;border-radius:8px;cursor:pointer}
    .config-screen .close-btn{position:absolute;top:20px;right:20px;font-size:1.2em;background:none;border:1px solid #0cf;
                              color:#0cf;border-radius:4px;padding:5px 10px;cursor:pointer}
    .attendance-form{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .attendance-form select,.attendance-form button{padding:5px;background:#222;color:#fff;border:1px solid #333;border-radius:4px}
    .attendance-form button{background:#0cf;color:#000}
    .attendance-summary{margin-top:10px;font-size:0.9em}
    .attendance-summary span{display:block}
    .attending-yes{color:#0cf}
    .attending-no{color:#f00}
    @media(max-width:768px){
      .hamburger div{width:20px}
      .logo img.logo-main{width:150px}
      .logo-intranet{height:50px}
      table{font-size:0.85em}
      th,td{padding:8px}
      .attendance-form{flex-direction:column;align-items:flex-start}
      .attendance-form select{width:100%}
    }
  </style>
</head>

<body>
  <header>
    <div class="logo">
      <img src="assets/logo_blanco.png" alt="Logo" class="logo-main">
    </div>
    <img src="assets/logointranet.png" alt="Logo Intranet" class="logo-intranet">
    <div class="hamburger" id="hamburger-btn"><div></div><div></div><div></div></div>
  </header>

  <div id="overlay"></div>
  <nav class="sidebar" id="sidebar-menu">
    <h2>Menú</h2>
    <a href="#rehearsals">Próximos Ensayos</a>
    <a href="#second-setlist">Setlist Próximo Concierto</a>
    <a href="#calendario">Próximos Conciertos</a>
    <a href="#timeline">Línea Temporal</a>
    <a href="#" id="menu-config">Configuración</a>
    <div class="submenu" id="config-submenu">
      <a href="#" id="menu-setlist-config">Configurar Setlists</a>
      <a href="#" id="menu-user-mgmt">Gestión de Usuarios</a>
      <a href="#" id="menu-rehearsal">Asignar Ensayos</a>
    </div>
    <a href="#" id="menu-cerrar">Cerrar Menú</a>
  </nav>

  <!-- Pantallas de configuración -->
  <div id="setlist-config-screen" class="config-screen">
    <button class="close-btn" id="close-setlist-config">Cerrar</button>
    <h2>Configuración de Setlists</h2>
    <label>Nombre Setlist 1</label><input id="setlist1-name" placeholder="Ej: Ensayos 2025">
    <label>URL Setlist 1</label><input id="setlist1-url" placeholder="URL">
    <label>Nombre Setlist 2</label><input id="setlist2-name" placeholder="Ej: Concierto Navidad">
    <label>URL Setlist 2</label><input id="setlist2-url" placeholder="Ej: TXHvyb">
    <button id="guardar-setlist-config">Guardar Configuración</button>
  </div>

  <div id="user-mgmt-screen" class="config-screen">
    <button class="close-btn" id="close-user-mgmt">Cerrar</button>
    <h2>Gestión de Usuarios</h2>
    <label>Nombre</label><input id="user-name" placeholder="Nombre">
    <label>Apodo</label><input id="user-nickname" placeholder="Apodo (corto)">
    <label>Roles</label>
    <select id="user-role" multiple>
      <option value="Batería">Batería</option>
      <option value="Teclados">Teclados</option>
      <option value="Voz">Voz</option>
      <option value="Guitarra eléctrica">Guitarra eléctrica</option>
      <option value="Guitarra Acústica">Guitarra Acústica</option>
      <option value="Bajo">Bajo</option>
      <option value="Percusión">Percusión</option>
      <option value="Saxo">Saxo</option>
      <option value="Dirección Musical">Dirección Musical</option>
      <option value="Técnico de Sonido">Técnico de Sonido</option>
      <option value="Montador">Montador</option>
      <option value="Coros">Coros</option>
    </select>
    <button id="add-user">Añadir Usuario</button>
    <button id="cancel-edit-user" style="display:none;">Cancelar Edición</button>
    <p id="user-message" class="error-message"></p>
    <table id="user-table"><thead><tr><th>Nombre</th><th>Apodo</th><th>Roles</th><th>Acciones</th></tr></thead><tbody id="user-table-body"></tbody></table>
  </div>

  <div id="rehearsal-screen" class="config-screen">
    <button class="close-btn" id="close-rehearsal">Cerrar</button>
    <h2>Asignación de Ensayos</h2>
    <label>Fecha</label><input type="date" id="rehearsal-date">
    <label>Hora Inicio</label><input type="time" id="rehearsal-start-time">
    <label>Hora Fin</label><input type="time" id="rehearsal-end-time">
    <label>Lugar</label><input id="rehearsal-location" placeholder="Ej: Estudio 1">
    <button id="add-rehearsal">Añadir Ensayo</button>
    <button id="cancel-edit-rehearsal" style="display:none;">Cancelar Edición</button>
    <p id="rehearsal-message" class="error-message"></p>
    <table id="rehearsal-table">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Hora Inicio</th>
          <th>Hora Fin</th>
          <th>Lugar</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="rehearsal-table-body"></tbody>
    </table>
  </div>

  <main>
    <section id="setlists">
      <h2 id="setlist1-title">Setlist Ensayos -Año 2025-</h2>
      <div class="table-wrapper">
        <table><thead><tr><th>#</th><th>Título</th><th>Tonalidad</th><th>Tempo</th><th>Duración</th></tr></thead><tbody id="setlist-body"></tbody></table>
      </div>
      <button class="download-btn" id="download-btn">Descargar PDF</button>
      <p id="total-time"></p>
    </section>

    <section id="rehearsals">
      <h2>Próximos Ensayos</h2>
      <div class="table-wrapper">
        <table id="rehearsal-main-table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Lugar</th>
              <th>Confirmar Asistencia</th>
            </tr>
          </thead>
          <tbody id="rehearsal-main-body"></tbody>
        </table>
      </div>
    </section>

    <section id="second-setlist">
      <h2>Setlist Próximo Concierto</h2>
      <p id="second-setlist-name"></p>
      <div class="table-wrapper">
        <table id="second-list-table"><thead><tr><th>#</th><th>Canción</th><th>Tonalidad</th><th>Tempo</th><th>Duración</th></tr></thead><tbody id="second-body"></tbody></table>
      </div>
      <button class="download-btn" id="download-btn-2">Descargar PDF</button>
      <p id="total-time-2"></p>
    </section>

    <section id="calendario">
      <h2>Próximos Conciertos</h2>
      <div id="bandhelper-concerts">
        <script src="https://www.bandhelper.com/widget/calendar/10353?layout=1&range=6"></script>
      </div>
    </section>

    <section id="timeline">
      <h2>Línea Temporal de Eventos</h2>
      <div id="timeline-container">
        <div id="timeline"></div>
      </div>
    </section>

    <section id="usuarios">
      <h2>Usuarios Registrados</h2>
      <div class="table-wrapper">
        <table><thead><tr><th>Nombre</th><th>Apodo</th><th>Roles</th></tr></thead><tbody id="users-body"></tbody></table>
      </div>
    </section>
  </main>

  <footer>© 2025 El Sótano del Doctor. All Rights Reserved.</footer>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyCEP44xNINCkIejgNvcYafJsALnO0y4dfw",
    authDomain: "sotanointranet.firebaseapp.com",
    projectId: "sotanointranet",
    messagingSenderId: "756955233128",
    appId: "1:756955233128:web:ab36372bdbd895a30e74dd"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const parseDuration = str => {
    if (!str) return 0;
    if (str.includes(":")) { const [m, s = 0] = str.split(":").map(Number); return m * 60 + s; }
    const n = parseInt(str, 10); return isNaN(n) ? 0 : n;
  };
  const toMMSS = s => `${Math.floor(s / 60)}:${String(s % 60).padStart(2, "0")}`;
  const toHHMM = s => {
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    return h ? `${h}h ${String(m).padStart(2, "0")}m` : `${m}m`;
  };
  const clean = s => (s || "").replace(/[^\x00-\xFF]/g, "").trim();
  const formatDateWithDay = dateStr => {
    const date = new Date(dateStr);
    const days = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];
    const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    return `${days[date.getDay()]} ${date.getDate()} de ${months[date.getMonth()]}`;
  };

  async function loadDoc(id, fallback) {
    try {
      const snap = await db.collection("intranet").doc(id).get();
      return snap.exists ? snap.data() : fallback;
    } catch (e) {
      console.error(`Error al cargar documento ${id}:`, e);
      return fallback;
    }
  }

  async function saveDoc(id, data) {
    try {
      await db.collection("intranet").doc(id).set(data);
      console.log(`Documento ${id} guardado correctamente.`);
      return true;
    } catch (e) {
      console.error(`Error al guardar documento ${id}:`, e);
      return false;
    }
  }

  let setlistConfig = {
    setlist1: { name: "Setlist Ensayos -Año 2025-", url: "https://cold-limit-811a.jagomezc.workers.dev" },
    setlist2: { name: "Setlist Próximo Concierto", url: "https://www.bandhelper.com/feed/set_list/TXHvyb" }
  };

  async function loadSetlistConfig() {
    const data = await loadDoc("setlists", { config: setlistConfig });
    setlistConfig = data.config || setlistConfig;
    document.getElementById("setlist1-title").textContent = setlistConfig.setlist1.name;
    document.getElementById("second-setlist-name").textContent = setlistConfig.setlist2.name;
  }

  async function cargarPrimerSetlist() {
    try {
      const response = await fetch(setlistConfig.setlist1.url);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const data = await response.json();
      const songs = Array.isArray(data) ? data.filter(i => i.type === "song") : [];
      const tbody = document.getElementById("setlist-body");
      tbody.innerHTML = "";
      let total = 0;
      songs.forEach((s, i) => {
        const secs = parseDuration(s.duration || "0");
        total += secs;
        tbody.insertAdjacentHTML("beforeend",
          `<tr><td>${i + 1}</td><td>${clean(s.name || "Sin título")}</td><td>${clean(s.key || "-")}</td><td>${clean(s.tempo || "-")}</td><td>${toMMSS(secs)}</td></tr>`);
      });
      document.getElementById("total-time").textContent = "Tiempo total del set: " + toHHMM(total);
      return songs;
    } catch (e) {
      console.error("Error cargando primer setlist:", e);
      document.getElementById("setlist-body").innerHTML = '<tr><td colspan="5">Error al cargar el setlist. Verifica la URL.</td></tr>';
      return [];
    }
  }

  async function cargarSegundoSetlist() {
    try {
      const response = await fetch(setlistConfig.setlist2.url);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const data = await response.json();
      const songs = Array.isArray(data) ? data.filter(i => i.type === "song") : [];
      const tbody = document.getElementById("second-body");
      tbody.innerHTML = "";
      let total = 0;
      songs.forEach((s, i) => {
        const secs = parseDuration(s.duration || "0");
        total += secs;
        tbody.insertAdjacentHTML("beforeend",
          `<tr><td>${i + 1}</td><td>${clean(s.name || "Sin título")}</td><td>${clean(s.key || "-")}</td><td>${clean(s.tempo || "-")}</td><td>${toMMSS(secs)}</td></tr>`);
      });
      document.getElementById("total-time-2").textContent = "Tiempo total del set: " + toHHMM(total);
      return songs;
    } catch (e) {
      console.error("Error cargando segundo setlist:", e);
      document.getElementById("second-body").innerHTML = '<tr><td colspan="5">Error al cargar el setlist. Verifica la URL.</td></tr>';
      return [];
    }
  }

  let users = [];
  let editingUserIndex = null;

  async function loadUsers() {
    const data = await loadDoc("users", { users: [] });
    users = Array.isArray(data.users) ? data.users : [];
    renderUsers();
  }

  function renderUsers() {
    const tbody = document.getElementById("user-table-body");
    const main = document.getElementById("users-body");
    tbody.innerHTML = main.innerHTML = "";
    users.forEach((u, i) => {
      if (!u || typeof u !== 'object' || !u.name || !u.nickname || !Array.isArray(u.roles)) {
        console.warn(`Usuario inválido en la posición ${i}:`, u);
        return;
      }
      const rolesDisplay = u.roles.join(", ");
      tbody.insertAdjacentHTML("beforeend",
        `<tr>
          <td>${u.name}</td>
          <td>${u.nickname}</td>
          <td>${rolesDisplay}</td>
          <td>
            <button data-i="${i}" class="edit-user action-btn edit">Editar</button>
            <button data-i="${i}" class="delete-user action-btn">Eliminar</button>
          </td>
        </tr>`);
      main.insertAdjacentHTML("beforeend",
        `<tr><td>${u.name}</td><td>${u.nickname}</td><td>${rolesDisplay}</td></tr>`);
    });

    tbody.querySelectorAll(".delete-user").forEach(btn =>
      btn.onclick = async () => {
        const index = btn.dataset.i;
        if (confirm(`¿Estás seguro de que deseas eliminar al usuario "${users[index].name}"?`)) {
          users.splice(index, 1);
          await saveUsers();
        }
      });

    tbody.querySelectorAll(".edit-user").forEach(btn =>
      btn.onclick = () => {
        editingUserIndex = btn.dataset.i;
        const user = users[editingUserIndex];
        document.getElementById("user-name").value = user.name;
        document.getElementById("user-nickname").value = user.nickname;
        const roleSelect = document.getElementById("user-role");
        Array.from(roleSelect.options).forEach(option => {
          option.selected = user.roles.includes(option.value);
        });
        const addButton = document.getElementById("add-user");
        addButton.textContent = "Guardar Cambios";
        document.getElementById("cancel-edit-user").style.display = "inline-block";
      });
  }

  async function saveUsers() {
    const success = await saveDoc("users", { users });
    if (success) {
      renderUsers();
      alert("Usuarios guardados correctamente.");
    } else {
      alert("Error al guardar usuarios.");
    }
  }

  function resetUserForm() {
    document.getElementById("user-name").value = "";
    document.getElementById("user-nickname").value = "";
    const roleSelect = document.getElementById("user-role");
    Array.from(roleSelect.options).forEach(option => option.selected = false);
    const addButton = document.getElementById("add-user");
    addButton.textContent = "Añadir Usuario";
    document.getElementById("cancel-edit-user").style.display = "none";
    editingUserIndex = null;
  }

  let rehearsals = [];
  let editingRehearsalIndex = null;

  async function loadRehearsals() {
    const data = await loadDoc("rehearsals", { rehearsals: [] });
    rehearsals = Array.isArray(data.rehearsals) ? data.rehearsals : [];
    renderRehearsals();
  }

  function renderRehearsals() {
    const tbodyConfig = document.getElementById("rehearsal-table-body");
    const tbodyMain = document.getElementById("rehearsal-main-body");
    tbodyConfig.innerHTML = tbodyMain.innerHTML = "";
    const now = new Date();
    const userOptions = users.map(u => `<option value="${u.name}">${u.name}</option>`).join("");

    rehearsals.forEach((r, i) => {
      const formattedDate = formatDateWithDay(r.date);
      tbodyConfig.insertAdjacentHTML("beforeend",
        `<tr>
          <td>${r.date}</td>
          <td>${r.startTime}</td>
          <td>${r.endTime}</td>
          <td>${r.location}</td>
          <td>
            <button data-i="${i}" class="edit-rehearsal action-btn edit">Editar</button>
            <button data-i="${i}" class="delete-rehearsal action-btn">Eliminar</button>
          </td>
        </tr>`);

      if (new Date(r.date) >= now) {
        const attendance = r.attendance || [];
        const yes = attendance.filter(a => a.response === "Sí").map(a => a.user).join(", ");
        const no = attendance.filter(a => a.response === "No").map(a => a.user).join(", ");
        const summary = `
          <div class="attendance-summary">
            <span class="attending-yes">Asisten: ${yes || "Ninguno"}</span>
            <span class="attending-no">No asisten: ${no || "Ninguno"}</span>
          </div>
        `;

        tbodyMain.insertAdjacentHTML("beforeend",
          `<tr>
            <td>${formattedDate}</td>
            <td>${r.startTime} - ${r.endTime}</td>
            <td>${r.location}</td>
            <td>
              <div class="attendance-form">
                <select class="attendance-user" data-i="${i}">
                  <option value="">Selecciona usuario</option>
                  ${userOptions}
                </select>
                <select class="attendance-response" data-i="${i}">
                  <option value="">¿Asistirás?</option>
                  <option value="Sí">Sí</option>
                  <option value="No">No</option>
                </select>
                <button class="confirm-attendance" data-i="${i}">Confirmar</button>
              </div>
              ${summary}
            </td>
          </tr>`);
      }
    });

    // Añadir eventos a botones de editar y eliminar en configuración
    tbodyConfig.querySelectorAll(".edit-rehearsal").forEach(btn =>
      btn.onclick = () => {
        editingRehearsalIndex = btn.dataset.i;
        const rehearsal = rehearsals[editingRehearsalIndex];
        document.getElementById("rehearsal-date").value = rehearsal.date;
        document.getElementById("rehearsal-start-time").value = rehearsal.startTime;
        document.getElementById("rehearsal-end-time").value = rehearsal.endTime;
        document.getElementById("rehearsal-location").value = rehearsal.location;
        const addButton = document.getElementById("add-rehearsal");
        addButton.textContent = "Guardar Cambios";
        document.getElementById("cancel-edit-rehearsal").style.display = "inline-block";
      });

    tbodyConfig.querySelectorAll(".delete-rehearsal").forEach(btn =>
      btn.onclick = async () => {
        const index = btn.dataset.i;
        if (confirm(`¿Estás seguro de que deseas eliminar el ensayo del día ${rehearsals[index].date}?`)) {
          rehearsals.splice(index, 1);
          await saveRehearsals();
        }
      });

    // Añadir eventos a botones de confirmar asistencia
    document.querySelectorAll(".confirm-attendance").forEach(btn => {
      btn.onclick = async () => {
        const index = btn.dataset.i;
        const userSelect = document.querySelector(`.attendance-user[data-i="${index}"]`);
        const responseSelect = document.querySelector(`.attendance-response[data-i="${index}"]`);
        const user = userSelect.value;
        const response = responseSelect.value;
        if (!user || !response) {
          alert("Selecciona usuario y respuesta");
          return;
        }
        const rehearsal = rehearsals[index];
        if (!rehearsal.attendance) rehearsal.attendance = [];
        const existing = rehearsal.attendance.find(a => a.user === user);
        if (existing) {
          existing.response = response;
        } else {
          rehearsal.attendance.push({ user, response });
        }
        await saveRehearsals();
        renderRehearsals(); // Actualizar resumen
      };
    });
  }

  async function saveRehearsals() {
    const success = await saveDoc("rehearsals", { rehearsals });
    if (success) {
      renderRehearsals();
      alert("Ensayos guardados correctamente.");
    } else {
      alert("Error al guardar ensayos.");
    }
  }

  function resetRehearsalForm() {
    document.getElementById("rehearsal-date").value = "";
    document.getElementById("rehearsal-start-time").value = "";
    document.getElementById("rehearsal-end-time").value = "";
    document.getElementById("rehearsal-location").value = "";
    const addButton = document.getElementById("add-rehearsal");
    addButton.textContent = "Añadir Ensayo";
    document.getElementById("cancel-edit-rehearsal").style.display = "none";
    editingRehearsalIndex = null;
  }

  let concerts = [
    { date: "2025-12-20", name: "Concierto Navidad" },
    { date: "2025-06-15", name: "Concierto Verano" }
  ]; // Simulados, reemplaza con tus datos reales

  function renderTimeline() {
    const timeline = document.getElementById("timeline");
    timeline.innerHTML = "";
    const rehearsalEvents = rehearsals.map(r => ({
      date: r.date,
      type: "rehearsal",
      text: `Ensayo - ${formatDateWithDay(r.date)}`
    }));
    const concertEvents = concerts.map(c => ({
      date: c.date,
      type: "concert",
      text: `Concierto - ${c.name} - ${formatDateWithDay(c.date)}`
    }));
    const allEvents = [...rehearsalEvents, ...concertEvents].sort((a, b) => new Date(a.date) - new Date(b.date));

    allEvents.forEach(event => {
      const div = document.createElement("div");
      div.className = `event ${event.type}`;
      div.innerHTML = `<span>${event.text}</span>`;
      timeline.appendChild(div);
    });
  }

  async function genPDF(songs, title, fileName) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "A4" });
    doc.setFontSize(16);
    doc.text(`Setlist - ${title}`, 40, 50);
    const totalTime = toMMSS(songs.reduce((a, s) => a + parseDuration(s.duration || "0"), 0));
    doc.setFontSize(12);
    doc.text(`${songs.length} canciones, ${totalTime} total`, 40, 70);
    doc.autoTable({
      startY: 100,
      head: [["#", "Título", "Tonalidad", "Tempo", "Duración"]],
      body: songs.map((s, i) => [i + 1, clean(s.name || ""), clean(s.key || ""), clean(s.tempo || ""), toMMSS(parseDuration(s.duration || "0"))]),
      headStyles: { fillColor: [60, 60, 60], textColor: [255, 255, 255] },
      styles: { fontSize: 10, cellPadding: 5 }
    });
    doc.save(fileName);
  }

  const sidebar = document.getElementById("sidebar-menu"), overlay = document.getElementById("overlay");
  document.getElementById("hamburger-btn").onclick = () => {
    sidebar.classList.add("show");
    overlay.classList.add("show");
  };
  document.getElementById("menu-cerrar").onclick = e => {
    e.preventDefault();
    closeAll();
    sidebar.classList.remove("show");
    overlay.classList.remove("show");
    document.getElementById("config-submenu").classList.remove("show");
  };
  overlay.onclick = () => {
    closeAll();
    sidebar.classList.remove("show");
    overlay.classList.remove("show");
    document.getElementById("config-submenu").classList.remove("show");
  };
  document.getElementById("menu-config").onclick = e => {
    e.preventDefault();
    const submenu = document.getElementById("config-submenu");
    submenu.classList.toggle("show");
  };

  document.getElementById("menu-setlist-config").onclick = e => {
    e.preventDefault();
    closeAll();
    const s = document.getElementById("setlist-config-screen");
    s.style.display = "block";
    document.getElementById("setlist1-name").value = setlistConfig.setlist1.name;
    document.getElementById("setlist1-url").value = setlistConfig.setlist1.url;
    document.getElementById("setlist2-name").value = setlistConfig.setlist2.name;
    document.getElementById("setlist2-url").value = setlistConfig.setlist2.url.replace("https://www.bandhelper.com/feed/set_list/", "");
  };

  document.getElementById("close-setlist-config").onclick = () => {
    document.getElementById("setlist-config-screen").style.display = "none";
  };

  document.getElementById("guardar-setlist-config").onclick = async () => {
    const n1 = document.getElementById("setlist1-name").value.trim(),
          u1 = document.getElementById("setlist1-url").value.trim(),
          n2 = document.getElementById("setlist2-name").value.trim(),
          raw = document.getElementById("setlist2-url").value.trim();
    if (!n1 || !u1 || !n2 || !raw) {
      alert("Completa todos los campos");
      return;
    }
    setlistConfig.setlist1 = { name: n1, url: u1 };
    setlistConfig.setlist2 = { name: n2, url: raw.startsWith("http") ? raw : `https://www.bandhelper.com/feed/set_list/${raw}` };
    if (await saveDoc("setlists", { config: setlistConfig })) {
      await Promise.all([cargarPrimerSetlist(), cargarSegundoSetlist()]);
      document.getElementById("setlist-config-screen").style.display = "none";
      alert("Configuración guardada correctamente");
    } else {
      alert("Error al guardar configuración");
    }
  };

  document.getElementById("menu-user-mgmt").onclick = e => {
    e.preventDefault();
    closeAll();
    document.getElementById("user-mgmt-screen").style.display = "block";
    loadUsers();
  };

  document.getElementById("close-user-mgmt").onclick = () => {
    document.getElementById("user-mgmt-screen").style.display = "none";
    resetUserForm();
  };

  document.getElementById("add-user").onclick = async () => {
    const name = document.getElementById("user-name").value.trim();
    const nickname = document.getElementById("user-nickname").value.trim();
    const roleSelect = document.getElementById("user-role");
    const roles = Array.from(roleSelect.selectedOptions).map(option => option.value);
    if (!name || !nickname || roles.length === 0) {
      alert("Completa todos los campos");
      return;
    }
    if (editingUserIndex !== null) {
      users[editingUserIndex] = { name, nickname, roles };
      editingUserIndex = null;
    } else {
      users.push({ name, nickname, roles });
    }
    await saveUsers();
    resetUserForm();
  };

  document.getElementById("cancel-edit-user").onclick = () => {
    resetUserForm();
  };

  document.getElementById("menu-rehearsal").onclick = e => {
    e.preventDefault();
    closeAll();
    document.getElementById("rehearsal-screen").style.display = "block";
    loadRehearsals();
  };

  document.getElementById("close-rehearsal").onclick = () => {
    document.getElementById("rehearsal-screen").style.display = "none";
    resetRehearsalForm();
  };

  document.getElementById("add-rehearsal").onclick = async () => {
    const date = document.getElementById("rehearsal-date").value;
    const startTime = document.getElementById("rehearsal-start-time").value;
    const endTime = document.getElementById("rehearsal-end-time").value;
    const location = document.getElementById("rehearsal-location").value.trim();
    if (!date || !startTime || !endTime || !location) {
      alert("Completa todos los campos");
      return;
    }
    if (editingRehearsalIndex !== null) {
      rehearsals[editingRehearsalIndex] = { date, startTime, endTime, location, attendance: rehearsals[editingRehearsalIndex].attendance || [] };
      editingRehearsalIndex = null;
    } else {
      rehearsals.push({ date, startTime, endTime, location, attendance: [] });
    }
    await saveRehearsals();
    resetRehearsalForm();
  };

  document.getElementById("cancel-edit-rehearsal").onclick = () => {
    resetRehearsalForm();
  };

  function closeAll() {
    document.querySelectorAll(".config-screen").forEach(s => s.style.display = "none");
  }

  document.addEventListener("DOMContentLoaded", async () => {
    await loadSetlistConfig();
    await loadUsers();
    await loadRehearsals();
    let songs1 = await cargarPrimerSetlist();
    let songs2 = await cargarSegundoSetlist();
    renderTimeline();

    document.getElementById("download-btn").onclick = () => {
      if (songs1.length) genPDF(songs1, setlistConfig.setlist1.name, "setlist_ensayos.pdf");
      else alert("No hay canciones para descargar.");
    };
    document.getElementById("download-btn-2").onclick = () => {
      if (songs2.length) genPDF(songs2, setlistConfig.setlist2.name, "setlist_concierto.pdf");
      else alert("No hay canciones para descargar.");
    };
  });
  </script>
</body>
</html>
